<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel da Cl√≠nica</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111827; --line:rgba(255,255,255,.12);
      --text:#e7eefc; --muted:#aab7d6; --pri:#0ea5e9; --bad:#ef4444; --ok:#22c55e;
      --r:14px;
    }
    body{margin:0; font-family:system-ui, Arial; background:var(--bg); color:var(--text);}
    header{display:flex; justify-content:space-between; align-items:center; gap:12px; padding:16px; border-bottom:1px solid var(--line);}
    h1{margin:0; font-size:1.1rem;}
    .muted{color:var(--muted); font-size:.92rem;}
    main{padding:16px; display:grid; gap:14px; max-width:1000px; margin:0 auto;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--r); padding:14px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end;}
    .row > *{flex:1; min-width:160px;}
    label{display:block; margin:0 0 6px; color:var(--muted); font-size:.9rem;}
    input, select{
      width:100%; padding:12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); outline:none;
    }
    button{
      padding:12px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); font-weight:700; cursor:pointer;
    }
    .primary{border-color:rgba(14,165,233,.35); background:rgba(14,165,233,.18);}
    .danger{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.18);}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--line); font-size:.85rem;}
    .pill.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.12);}
    .pill.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12);}
    .list{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    .item{border:1px solid var(--line); background:rgba(255,255,255,.03); border-radius:14px; padding:12px;}
    .itemTop{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .actions button{flex:0 0 auto;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    @media(max-width:800px){ .grid2{grid-template-columns:1fr;} }
    .sum{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .sum .cardMini{flex:1; min-width:200px; border:1px solid var(--line); border-radius:14px; padding:10px; background:rgba(255,255,255,.03);}
    small{color:var(--muted);}
  </style>
</head>
<body>

<header>
  <div>
    <h1>Painel da Cl√≠nica</h1>
    <div id="today" class="muted"></div>
  </div>
  <div style="display:flex; gap:8px; flex-wrap:wrap;">
    <button id="exportCsv">Exportar CSV (m√™s)</button>
    <button id="exportJson">Exportar JSON</button>
    <button id="logout" class="danger">Sair</button>
  </div>
</header>

<main>
  <section class="card">
    <div class="row">
      <div>
        <label>Data do atendimento</label>
        <input id="date" type="date"/>
      </div>
      <div>
        <label>Buscar (nome)</label>
        <input id="search" placeholder="Ex: Miguel, √çsis..." />
      </div>
      <div>
        <button id="clearDay" class="danger" type="button">Limpar lista do dia</button>
      </div>
    </div>

    <div class="sum">
      <div class="cardMini">
        <b>Resumo do dia</b>
        <div class="muted" id="sumDay">‚Äî</div>
      </div>
      <div class="cardMini">
        <b>Cobran√ßa do dia</b>
        <div class="muted" id="sumMoney">‚Äî</div>
      </div>
    </div>
  </section>

  <section class="card">
    <b>Adicionar sess√£o do dia</b>
    <div class="grid2">
      <div>
        <label>Paciente</label>
        <input id="pName" placeholder="Nome da crian√ßa/paciente" />
      </div>
      <div>
        <label>Hor√°rio (opcional)</label>
        <input id="pTime" placeholder="Ex: 14:30" />
      </div>

      <div>
        <label>Sess√£o</label>
        <select id="pDid">
          <option value="realizou">Realizou</option>
          <option value="nao">N√£o realizou</option>
        </select>
      </div>
      <div>
        <label>Se n√£o realizou: justificativa</label>
        <select id="pJust">
          <option value="na">‚Äî</option>
          <option value="justificada">Justificada</option>
          <option value="nao_justificada">N√£o justificada</option>
        </select>
      </div>

      <div>
        <label>Pagamento</label>
        <select id="pPaid">
          <option value="nao_pago">N√£o pago</option>
          <option value="pago">Pago</option>
        </select>
      </div>
      <div>
        <label>Valor (manual)</label>
        <input id="pValue" inputmode="decimal" placeholder="Ex: 80,00" />
      </div>
    </div>

    <div class="row">
      <button id="add" class="primary" type="button">Adicionar</button>
      <button id="resetAll" class="danger" type="button">Zerar tudo (cuidado)</button>
    </div>

    <small>
      Observa√ß√£o: isso salva no aparelho/navegador. Para backup/cobran√ßa, use Exportar.
    </small>
  </section>

  <section class="card">
    <b>Lista do dia</b>
    <div id="list" class="list"></div>
  </section>
</main>

<script>
  // ======= (Opcional) trava simples do login =======
  // Se voc√™ estiver usando o login.html que eu mandei antes, isso protege a entrada b√°sica.
  function mustAuth(){
    try{
      const data = JSON.parse(localStorage.getItem("clinica_auth") || "{}");
      if(!data.ok || Date.now() > data.until) throw new Error();
    }catch{
      // se n√£o quiser trava, comente a linha abaixo
      location.href = "./index.html";
    }
  }
  mustAuth();

  // ======= Storage =======
  const KEY = "clinica_sessions_v1"; // guarda tudo
  const $ = (id) => document.getElementById(id);

  function loadAll(){
    try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch { return []; }
  }
  function saveAll(rows){
    localStorage.setItem(KEY, JSON.stringify(rows));
  }
  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }
  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function fmtBRL(value){
    const n = Number(value);
    if(Number.isNaN(n)) return "‚Äî";
    return n.toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
  }
  function parseMoney(txt){
    if(!txt) return 0;
    const s = String(txt).trim().replace(/\./g,"").replace(",",".");
    const n = Number(s);
    return Number.isNaN(n) ? 0 : n;
  }
  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // ======= UI state =======
  $("date").value = todayISO();
  $("today").textContent = new Intl.DateTimeFormat("pt-BR", { dateStyle:"full" }).format(new Date());

  function getMonthPrefix(dateISO){
    // "2026-02" para filtrar export do m√™s
    return dateISO.slice(0,7);
  }

  function dayRows(){
    const date = $("date").value;
    const q = $("search").value.trim().toLowerCase();
    return loadAll()
      .filter(r => r.date === date)
      .filter(r => !q || (r.name || "").toLowerCase().includes(q))
      .sort((a,b) => (a.time || "").localeCompare(b.time || ""));
  }

  function badgeFor(r){
    if(r.did === "realizou") return `<span class="pill ok">‚úÖ Realizou</span>`;
    if(r.did === "nao"){
      if(r.just === "justificada") return `<span class="pill">‚ö†Ô∏è N√£o realizou (Just.)</span>`;
      if(r.just === "nao_justificada") return `<span class="pill bad">‚ùå N√£o realizou (Sem just.)</span>`;
      return `<span class="pill bad">‚ùå N√£o realizou</span>`;
    }
    return `<span class="pill">‚Äî</span>`;
  }

  function payBadge(r){
    return r.paid === "pago"
      ? `<span class="pill ok">üí∞ Pago</span>`
      : `<span class="pill bad">üí∏ N√£o pago</span>`;
  }

  function render(){
    const list = $("list");
    list.innerHTML = "";
    const rows = dayRows();

    if(!rows.length){
      list.innerHTML = `<div class="item"><b>Sem sess√µes cadastradas para este dia.</b><div class="muted">Adicione acima.</div></div>`;
      updateSummary([]);
      return;
    }

    rows.forEach(r => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="itemTop">
          <div>
            <b>${r.time ? escapeHtml(r.time) + " ‚Äî " : ""}${escapeHtml(r.name)}</b>
            <div class="muted">${badgeFor(r)} ${payBadge(r)} <span class="pill">Valor: ${fmtBRL(r.value)}</span></div>
          </div>
          <div class="muted">ID: ${escapeHtml(r.id)}</div>
        </div>

        <div class="actions">
          <button data-act="toggleDid" data-id="${r.id}">Alternar realizou/n√£o</button>
          <button data-act="toggleJust" data-id="${r.id}">Justificada/N√£o</button>
          <button data-act="togglePaid" data-id="${r.id}">Pago/N√£o pago</button>
          <button data-act="editValue" data-id="${r.id}">Editar valor</button>
          <button data-act="del" data-id="${r.id}" class="danger">Excluir</button>
        </div>
      `;
      list.appendChild(div);
    });

    list.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", () => action(btn.dataset.act, btn.dataset.id));
    });

    updateSummary(rows);
  }

  function updateSummary(rows){
    const total = rows.length;
    const realizou = rows.filter(r => r.did === "realizou").length;
    const faltou = rows.filter(r => r.did === "nao").length;
    const semJust = rows.filter(r => r.did === "nao" && r.just === "nao_justificada").length;

    const pagos = rows.filter(r => r.paid === "pago").length;
    const naoPagos = rows.filter(r => r.paid !== "pago").length;

    const totalPago = rows.filter(r => r.paid === "pago").reduce((s,r)=> s + (Number(r.value)||0), 0);
    const totalAberto = rows.filter(r => r.paid !== "pago").reduce((s,r)=> s + (Number(r.value)||0), 0);

    $("sumDay").textContent =
      `Total: ${total} | Realizou: ${realizou} | N√£o realizou: ${faltou} | Sem justificativa: ${semJust}`;

    $("sumMoney").textContent =
      `Pagos: ${pagos} (${fmtBRL(totalPago)}) | Em aberto: ${naoPagos} (${fmtBRL(totalAberto)})`;
  }

  function action(act, id){
    const all = loadAll();
    const idx = all.findIndex(x => x.id === id);
    if(idx < 0) return;

    const r = all[idx];

    if(act === "del"){
      all.splice(idx,1);
      saveAll(all);
      render();
      return;
    }

    if(act === "toggleDid"){
      if(r.did === "realizou"){
        r.did = "nao";
        if(!r.just || r.just === "na") r.just = "nao_justificada";
      }else{
        r.did = "realizou";
        r.just = "na";
      }
    }

    if(act === "toggleJust"){
      if(r.did !== "nao"){
        // se n√£o faltou, n√£o faz sentido justificar
        r.did = "nao";
      }
      if(r.just === "justificada") r.just = "nao_justificada";
      else r.just = "justificada";
    }

    if(act === "togglePaid"){
      r.paid = (r.paid === "pago") ? "nao_pago" : "pago";
    }

    if(act === "editValue"){
      const cur = (Number(r.value)||0).toFixed(2).replace(".",",");
      const nv = prompt("Digite o valor (ex: 80,00):", cur);
      if(nv !== null){
        r.value = parseMoney(nv);
      }
    }

    all[idx] = r;
    saveAll(all);
    render();
  }

  // ======= Add =======
  $("add").addEventListener("click", () => {
    const date = $("date").value;
    const name = $("pName").value.trim();
    const time = $("pTime").value.trim();
    const did = $("pDid").value; // realizou | nao
    const just = $("pJust").value; // na | justificada | nao_justificada
    const paid = $("pPaid").value; // pago | nao_pago
    const value = parseMoney($("pValue").value);

    if(!date || !name){
      alert("Preencha pelo menos Data e Paciente.");
      return;
    }

    const row = {
      id: uid(),
      date,
      name,
      time,
      did: (did === "nao" ? "nao" : "realizou"),
      just: (did === "nao" ? (just === "na" ? "nao_justificada" : just) : "na"),
      paid,
      value
    };

    const all = loadAll();
    all.push(row);
    saveAll(all);

    $("pName").value = "";
    $("pTime").value = "";
    $("pValue").value = "";
    $("pDid").value = "realizou";
    $("pJust").value = "na";
    $("pPaid").value = "nao_pago";

    render();
  });

  // ======= Clear day / reset all =======
  $("clearDay").addEventListener("click", () => {
    const date = $("date").value;
    if(!confirm("Tem certeza que deseja apagar TODAS as sess√µes deste dia?")) return;
    const all = loadAll().filter(r => r.date !== date);
    saveAll(all);
    render();
  });

  $("resetAll").addEventListener("click", () => {
    if(!confirm("Isso apaga TODOS os registros (todos os dias). Tem certeza?")) return;
    localStorage.removeItem(KEY);
    render();
  });

  // ======= Date & search =======
  $("date").addEventListener("change", render);
  $("search").addEventListener("input", render);

  // ======= Export =======
  function toCsv(rows){
    const header = ["date","time","name","did","just","paid","value"].join(",");
    const lines = rows.map(r => [
      r.date,
      (r.time||"").replaceAll(","," "),
      (r.name||"").replaceAll(","," "),
      r.did,
      r.just,
      r.paid,
      String(Number(r.value)||0).replace(".",".")
    ].join(","));
    return [header, ...lines].join("\n");
  }

  $("exportJson").addEventListener("click", () => {
    const all = loadAll();
    const blob = new Blob([JSON.stringify(all, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "clinica_registros.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $("exportCsv").addEventListener("click", () => {
    const month = getMonthPrefix($("date").value); // export do m√™s selecionado
    const all = loadAll().filter(r => (r.date||"").startsWith(month));
    const csv = toCsv(all);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `clinica_${month}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // ======= Logout =======
  $("logout").addEventListener("click", () => {
    localStorage.removeItem("clinica_auth");
    location.href = "./index.html";
  });

  render();
</script>

</body>
</html>
