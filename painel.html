<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel da Cl√≠nica</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111827; --line:rgba(255,255,255,.12);
      --text:#e7eefc; --muted:#aab7d6; --pri:#0ea5e9; --bad:#ef4444; --ok:#22c55e;
      --r:14px;
    }
    body{margin:0; font-family:system-ui, Arial; background:var(--bg); color:var(--text);}
    header{display:flex; justify-content:space-between; align-items:center; gap:12px; padding:16px; border-bottom:1px solid var(--line); flex-wrap:wrap;}
    h1{margin:0; font-size:1.1rem;}
    .muted{color:var(--muted); font-size:.92rem;}
    main{padding:16px; display:grid; gap:14px; max-width:1200px; margin:0 auto;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--r); padding:14px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end;}
    .row > *{flex:1; min-width:160px;}
    label{display:block; margin:0 0 6px; color:var(--muted); font-size:.9rem;}
    input, select, textarea{
      width:100%; padding:12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); outline:none; box-sizing:border-box;
    }
    textarea{resize:vertical;}
    button{
      padding:12px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); font-weight:700; cursor:pointer;
    }
    .primary{border-color:rgba(14,165,233,.35); background:rgba(14,165,233,.18);}
    .danger{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.18);}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--line); font-size:.85rem; margin-right:6px; margin-top:6px;}
    .pill.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.12);}
    .pill.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12);}
    .tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tab{border:1px solid var(--line); background:rgba(255,255,255,.04); }
    .tab.active{border-color:rgba(14,165,233,.45); background:rgba(14,165,233,.18);}
    .list{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    .item{border:1px solid var(--line); background:rgba(255,255,255,.03); border-radius:14px; padding:12px;}
    .itemTop{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .actions button{flex:0 0 auto;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    @media(max-width:900px){ .grid2{grid-template-columns:1fr;} }
    .sum{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .sum .cardMini{flex:1; min-width:220px; border:1px solid var(--line); border-radius:14px; padding:10px; background:rgba(255,255,255,.03);}
    small{color:var(--muted);}
    .hidden{display:none !important;}
    .split{display:grid; grid-template-columns: 1fr 1.2fr; gap:12px;}
    @media(max-width:1000px){ .split{grid-template-columns:1fr;} }
    .btnSmall{padding:8px 10px; font-size:.9rem;}
  </style>
</head>
<body>

<header>
  <div>
    <h1>Painel da Cl√≠nica</h1>
    <div id="today" class="muted"></div>
  </div>

  <div class="tabs">
    <button class="tab active" id="tabDaily" type="button">Di√°rio</button>
    <button class="tab" id="tabPatients" type="button">Pacientes</button>
  </div>

  <div style="display:flex; gap:8px; flex-wrap:wrap;">
    <button id="exportCsv">Exportar CSV (m√™s)</button>
    <button id="exportJson">Exportar JSON</button>
    <button id="logout" class="danger">Sair</button>
  </div>
</header>

<main>

  <!-- ====== DI√ÅRIO ====== -->
  <section id="viewDaily" class="card">
    <div class="row">
      <div>
        <label>Data do atendimento</label>
        <input id="date" type="date"/>
      </div>
      <div>
        <label>Buscar (nome)</label>
        <input id="search" placeholder="Ex: Miguel, √çsis..." />
      </div>
      <div>
        <button id="clearDay" class="danger" type="button">Limpar lista do dia</button>
      </div>
    </div>

    <div class="sum">
      <div class="cardMini">
        <b>Resumo do dia</b>
        <div class="muted" id="sumDay">‚Äî</div>
      </div>
      <div class="cardMini">
        <b>Cobran√ßa do dia</b>
        <div class="muted" id="sumMoney">‚Äî</div>
      </div>
    </div>

    <hr style="border:none; border-top:1px solid var(--line); margin:14px 0;">

    <b>Adicionar sess√£o do dia</b>

    <div class="grid2">
      <div>
        <label>Paciente (cadastro)</label>
        <select id="pPatient"></select>
        <small>Se n√£o aparecer, cadastre em <b>Pacientes</b>.</small>
      </div>

      <div>
        <label>Hor√°rio (opcional)</label>
        <input id="pTime" placeholder="Ex: 14:30" />
      </div>

      <div>
        <label>Sess√£o</label>
        <select id="pDid">
          <option value="realizou">Realizou</option>
          <option value="nao">N√£o realizou</option>
        </select>
      </div>

      <div>
        <label>Se n√£o realizou: justificativa</label>
        <select id="pJust">
          <option value="na">‚Äî</option>
          <option value="justificada">Justificada</option>
          <option value="nao_justificada">N√£o justificada</option>
        </select>
      </div>

      <div>
        <label>Pagamento</label>
        <select id="pPaid">
          <option value="nao_pago">N√£o pago</option>
          <option value="pago">Pago</option>
        </select>
      </div>

      <div>
        <label>Valor (manual)</label>
        <input id="pValue" inputmode="decimal" placeholder="Ex: 80,00" />
        <small id="hintDefault" class="muted"></small>
      </div>
    </div>

    <div class="row">
      <button id="addSession" class="primary" type="button">Adicionar sess√£o</button>
      <button id="resetAll" class="danger" type="button">Zerar tudo (cuidado)</button>
    </div>

    <div class="list" id="dayList"></div>
  </section>

  <!-- ====== PACIENTES (PASTAS) ====== -->
  <section id="viewPatients" class="card hidden">
    <div class="split">

      <!-- Cadastro -->
      <div class="card">
        <b>Cadastrar paciente</b>

        <div class="grid2">
          <div>
            <label>Nome do paciente</label>
            <input id="cName" placeholder="Ex: Jo√£o Miguel" />
          </div>
          <div>
            <label>Respons√°vel (opcional)</label>
            <input id="cResp" placeholder="Nome do respons√°vel" />
          </div>
          <div>
            <label>WhatsApp (opcional)</label>
            <input id="cPhone" placeholder="Ex: 67999999999" />
            <small>Sem espa√ßos, s√≥ n√∫meros.</small>
          </div>
          <div>
            <label>Valor padr√£o (opcional)</label>
            <input id="cDefaultValue" inputmode="decimal" placeholder="Ex: 80,00" />
          </div>
        </div>

        <label style="margin-top:10px;">Observa√ß√µes (opcional)</label>
        <textarea id="cNotes" rows="3" placeholder="Ex: foco /s/ e /z/, ceceio..."></textarea>

        <div class="row">
          <button id="addPatient" class="primary" type="button">Adicionar paciente</button>
        </div>

        <small>Depois clique no paciente na lista para abrir a ‚Äúpasta‚Äù.</small>
      </div>

      <!-- Pastas -->
      <div class="card">
        <div id="foldersPane">
          <b>Pastas de pacientes</b>
          <div class="row" style="margin-top:10px;">
            <div>
              <label>Pesquisar</label>
              <input id="pSearch" placeholder="Digite parte do nome..." />
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end; align-items:end;">
              <button id="onlyDebtFolders" class="btnSmall" type="button">Mostrar s√≥ com d√©bito</button>
            </div>
          </div>
          <div id="patientFolders" class="list"></div>
        </div>

        <!-- Pasta aberta -->
        <div id="folderOpenPane" class="hidden">
          <div class="row" style="align-items:center;">
            <button id="backToFolders" type="button">‚Üê Voltar</button>
            <div style="flex:3;">
              <b id="openPatientTitle">Paciente</b>
              <div class="muted" id="openPatientMeta"></div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
              <button id="openWhats" type="button">WhatsApp</button>
              <button id="exportPatient" type="button">Exportar paciente</button>
              <button id="renamePatient" type="button">Renomear</button>
              <button id="deletePatient" class="danger" type="button">Excluir</button>
            </div>
          </div>

          <div class="sum">
            <div class="cardMini">
              <b>Resumo</b>
              <div class="muted" id="patientSummary">‚Äî</div>
            </div>
            <div class="cardMini">
              <b>Filtros</b>
              <div class="muted" id="filterLabel">Todos</div>
              <div class="actions" style="margin-top:8px;">
                <button id="toggleOnlyUnpaid" class="btnSmall" type="button">S√≥ n√£o pagos: OFF</button>
              </div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <b>Ano</b>
            <div class="actions" id="yearButtons" style="margin-top:8px;"></div>
          </div>

          <div style="margin-top:12px;">
            <b>M√™s</b>
            <div class="actions" id="monthButtons" style="margin-top:8px;"></div>
          </div>

          <div class="list" id="patientHistory"></div>
        </div>
      </div>

    </div>
  </section>

</main>

<script>
  // ======= trava simples do login =======
  function mustAuth(){
    try{
      const data = JSON.parse(localStorage.getItem("clinica_auth") || "{}");
      if(!data.ok || Date.now() > data.until) throw new Error();
    }catch{
      location.href = "./index.html";
    }
  }
  mustAuth();

  // ======= Keys =======
  const KEY_SESS = "clinica_sessions_v3";
  const KEY_PAT  = "clinica_patients_v1";
  const $ = (id) => document.getElementById(id);

  // ======= Utils =======
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function parseMoney(txt){
    if(!txt) return 0;
    const s = String(txt).trim().replace(/\./g,"").replace(",",".");
    const n = Number(s);
    return Number.isNaN(n) ? 0 : n;
  }
  function fmtBRL(value){
    const n = Number(value);
    if(Number.isNaN(n)) return "‚Äî";
    return n.toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
  }
  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function loadPatients(){
    try{ return JSON.parse(localStorage.getItem(KEY_PAT) || "[]"); } catch { return []; }
  }
  function savePatients(p){ localStorage.setItem(KEY_PAT, JSON.stringify(p)); }

  function loadSessions(){
    try{ return JSON.parse(localStorage.getItem(KEY_SESS) || "[]"); } catch { return []; }
  }
  function saveSessions(s){ localStorage.setItem(KEY_SESS, JSON.stringify(s)); }

  function getPatientById(id){
    return loadPatients().find(p => p.id === id);
  }

  // ======= Tabs =======
  function setTab(tab){
    const isDaily = tab === "daily";
    $("viewDaily").classList.toggle("hidden", !isDaily);
    $("viewPatients").classList.toggle("hidden", isDaily);
    $("tabDaily").classList.toggle("active", isDaily);
    $("tabPatients").classList.toggle("active", !isDaily);
  }
  $("tabDaily").addEventListener("click", ()=> setTab("daily"));
  $("tabPatients").addEventListener("click", ()=> setTab("patients"));

  // ======= Header date =======
  $("date").value = todayISO();
  $("today").textContent = new Intl.DateTimeFormat("pt-BR", { dateStyle:"full" }).format(new Date());

  // ======= Badges =======
  function badgeFor(r){
    if(r.did === "realizou") return `<span class="pill ok">‚úÖ Realizou</span>`;
    if(r.did === "nao"){
      if(r.just === "justificada") return `<span class="pill">‚ö†Ô∏è N√£o realizou (Just.)</span>`;
      if(r.just === "nao_justificada") return `<span class="pill bad">‚ùå N√£o realizou (Sem just.)</span>`;
      return `<span class="pill bad">‚ùå N√£o realizou</span>`;
    }
    return `<span class="pill">‚Äî</span>`;
  }
  function payBadge(r){
    return r.paid === "pago"
      ? `<span class="pill ok">üí∞ Pago</span>`
      : `<span class="pill bad">üí∏ N√£o pago</span>`;
  }

  // ======= Select de pacientes no Di√°rio =======
  function renderPatientSelectDaily(){
    const pats = loadPatients().sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    const selDaily = $("pPatient");
    selDaily.innerHTML = "";

    if(!pats.length){
      selDaily.innerHTML = `<option value="">(Cadastre pacientes)</option>`;
      $("hintDefault").textContent = "";
      return;
    }

    pats.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      selDaily.appendChild(opt);
    });

    updateDefaultHint();
  }

  function updateDefaultHint(){
    const pid = $("pPatient").value;
    const p = getPatientById(pid);
    if(p && p.defaultValue && Number(p.defaultValue) > 0){
      $("hintDefault").textContent = `Valor padr√£o: ${fmtBRL(p.defaultValue)} (voc√™ pode digitar outro valor).`;
    }else{
      $("hintDefault").textContent = "";
    }
  }
  $("pPatient").addEventListener("change", updateDefaultHint);

  // ======= Di√°rio =======
  function daySessions(){
    const date = $("date").value;
    const q = $("search").value.trim().toLowerCase();
    const all = loadSessions().filter(s => s.date === date);

    return all
      .map(s => ({...s, patient: getPatientById(s.patientId)}))
      .filter(s => !q || ((s.patient?.name||"").toLowerCase().includes(q)))
      .sort((a,b)=> (a.time||"").localeCompare(b.time||""));
  }

  function updateDaySummary(rows){
    const total = rows.length;
    const realizou = rows.filter(r => r.did === "realizou").length;
    const faltou = rows.filter(r => r.did === "nao").length;
    const semJust = rows.filter(r => r.did === "nao" && r.just === "nao_justificada").length;

    const pagos = rows.filter(r => r.paid === "pago").length;
    const naoPagos = rows.filter(r => r.paid !== "pago").length;

    const totalPago = rows.filter(r => r.paid === "pago").reduce((s,r)=> s + (Number(r.value)||0), 0);
    const totalAberto = rows.filter(r => r.paid !== "pago").reduce((s,r)=> s + (Number(r.value)||0), 0);

    $("sumDay").textContent = `Total: ${total} | Realizou: ${realizou} | N√£o realizou: ${faltou} | Sem justificativa: ${semJust}`;
    $("sumMoney").textContent = `Pagos: ${pagos} (${fmtBRL(totalPago)}) | Em aberto: ${naoPagos} (${fmtBRL(totalAberto)})`;
  }

  function renderDaily(){
    const list = $("dayList");
    list.innerHTML = "";
    const rows = daySessions();

    if(!rows.length){
      list.innerHTML = `<div class="item"><b>Sem sess√µes cadastradas para este dia.</b><div class="muted">Adicione acima.</div></div>`;
      updateDaySummary([]);
      return;
    }

    rows.forEach(r=>{
      const pName = r.patient?.name || "(Paciente removido)";
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="itemTop">
          <div>
            <b>${r.time ? escapeHtml(r.time) + " ‚Äî " : ""}${escapeHtml(pName)}</b>
            <div class="muted">
              ${badgeFor(r)} ${payBadge(r)}
              <span class="pill">Valor: ${fmtBRL(r.value)}</span>
            </div>
          </div>
          <div class="muted">ID: ${escapeHtml(r.id)}</div>
        </div>

        <div class="actions">
          <button data-act="toggleDid" data-id="${r.id}">Alternar realizou/n√£o</button>
          <button data-act="toggleJust" data-id="${r.id}">Justificada/N√£o</button>
          <button data-act="togglePaid" data-id="${r.id}">Pago/N√£o pago</button>
          <button data-act="editValue" data-id="${r.id}">Editar valor</button>
          <button data-act="del" data-id="${r.id}" class="danger">Excluir</button>
        </div>
      `;
      list.appendChild(div);
    });

    list.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=> sessionAction(btn.dataset.act, btn.dataset.id));
    });

    updateDaySummary(rows);
  }

  function sessionAction(act, id){
    const all = loadSessions();
    const idx = all.findIndex(x => x.id === id);
    if(idx < 0) return;

    const r = all[idx];

    if(act === "del"){
      all.splice(idx,1);
      saveSessions(all);
      renderDaily();
      renderPatientFolders(); // atualiza d√©bitos nas pastas
      if(openedPatientId) renderPatientHistoryFolder();
      return;
    }
    if(act === "toggleDid"){
      if(r.did === "realizou"){
        r.did = "nao";
        if(!r.just || r.just === "na") r.just = "nao_justificada";
      }else{
        r.did = "realizou";
        r.just = "na";
      }
    }
    if(act === "toggleJust"){
      if(r.did !== "nao") r.did = "nao";
      r.just = (r.just === "justificada") ? "nao_justificada" : "justificada";
    }
    if(act === "togglePaid"){
      r.paid = (r.paid === "pago") ? "nao_pago" : "pago";
    }
    if(act === "editValue"){
      const cur = (Number(r.value)||0).toFixed(2).replace(".",",");
      const nv = prompt("Digite o valor (ex: 80,00):", cur);
      if(nv !== null) r.value = parseMoney(nv);
    }

    all[idx] = r;
    saveSessions(all);
    renderDaily();
    renderPatientFolders();
    if(openedPatientId) renderPatientHistoryFolder();
  }

  // Adicionar sess√£o
  $("addSession").addEventListener("click", ()=>{
    const date = $("date").value;
    const patientId = $("pPatient").value;
    const time = $("pTime").value.trim();
    const did = $("pDid").value;
    const just = $("pJust").value;
    const paid = $("pPaid").value;

    if(!date || !patientId){
      alert("Selecione a data e o paciente.");
      return;
    }

    let value = parseMoney($("pValue").value);

    const row = {
      id: uid(),
      date,
      patientId,
      time,
      did: (did === "nao" ? "nao" : "realizou"),
      just: (did === "nao" ? (just === "na" ? "nao_justificada" : just) : "na"),
      paid,
      value
    };

    const all = loadSessions();
    all.push(row);
    saveSessions(all);

    $("pTime").value = "";
    $("pValue").value = "";
    $("pDid").value = "realizou";
    $("pJust").value = "na";
    $("pPaid").value = "nao_pago";

    renderDaily();
    renderPatientFolders();
    if(openedPatientId) renderPatientHistoryFolder();
  });

  $("date").addEventListener("change", renderDaily);
  $("search").addEventListener("input", renderDaily);

  $("clearDay").addEventListener("click", ()=>{
    const date = $("date").value;
    if(!confirm("Apagar TODAS as sess√µes deste dia?")) return;
    const all = loadSessions().filter(s => s.date !== date);
    saveSessions(all);
    renderDaily();
    renderPatientFolders();
    if(openedPatientId) renderPatientHistoryFolder();
  });

  $("resetAll").addEventListener("click", ()=>{
    if(!confirm("Isso apaga TODOS os pacientes e registros. Tem certeza?")) return;
    localStorage.removeItem(KEY_SESS);
    localStorage.removeItem(KEY_PAT);
    openedPatientId = null;
    renderPatientSelectDaily();
    renderDaily();
    renderPatientFolders();
    closePatientFolder(true);
  });

  // ======= Export geral =======
  function getMonthPrefix(dateISO){ return dateISO.slice(0,7); }
  function toCsv(rows){
    const header = ["date","time","patient","did","just","paid","value"].join(",");
    const lines = rows.map(r=>{
      const p = getPatientById(r.patientId);
      return [
        r.date,
        (r.time||"").replaceAll(","," "),
        ((p?.name)||"").replaceAll(","," "),
        r.did,
        r.just,
        r.paid,
        String(Number(r.value)||0)
      ].join(",");
    });
    return [header, ...lines].join("\n");
  }

  $("exportJson").addEventListener("click", ()=>{
    const data = { patients: loadPatients(), sessions: loadSessions() };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "clinica_backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $("exportCsv").addEventListener("click", ()=>{
    const month = getMonthPrefix($("date").value);
    const rows = loadSessions().filter(r => (r.date||"").startsWith(month));
    const csv = toCsv(rows);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `clinica_${month}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // ======= Logout =======
  $("logout").addEventListener("click", ()=>{
    localStorage.removeItem("clinica_auth");
    location.href = "./index.html";
  });

  // ======= PACIENTES: cadastro =======
  $("addPatient").addEventListener("click", ()=>{
    const name = $("cName").value.trim();
    if(!name){ alert("Digite o nome do paciente."); return; }

    const p = {
      id: uid(),
      name,
      resp: $("cResp").value.trim(),
      phone: $("cPhone").value.trim(),
      defaultValue: parseMoney($("cDefaultValue").value),
      notes: $("cNotes").value.trim(),
      createdAt: Date.now()
    };

    const pats = loadPatients();
    pats.push(p);
    savePatients(pats);

    $("cName").value = "";
    $("cResp").value = "";
    $("cPhone").value = "";
    $("cDefaultValue").value = "";
    $("cNotes").value = "";

    renderPatientSelectDaily();
    renderPatientFolders();
    alert("Paciente cadastrado!");
  });

  // ======= PASTAS + FILTROS (m√™s/ano/n√£o pagos) =======
  const MONTHS = [
    {m:"01", t:"Jan"}, {m:"02", t:"Fev"}, {m:"03", t:"Mar"}, {m:"04", t:"Abr"},
    {m:"05", t:"Mai"}, {m:"06", t:"Jun"}, {m:"07", t:"Jul"}, {m:"08", t:"Ago"},
    {m:"09", t:"Set"}, {m:"10", t:"Out"}, {m:"11", t:"Nov"}, {m:"12", t:"Dez"},
  ];

  let openedPatientId = null;
  let openedMonth = "ALL"; // "ALL" ou "01".."12"
  let openedYear = "ALL";  // "ALL" ou "2026"...
  let onlyUnpaid = false;  // filtro dentro da pasta
  let onlyDebtFolders = false; // filtro nas pastas

  $("pSearch").addEventListener("input", renderPatientFolders);

  $("onlyDebtFolders").addEventListener("click", ()=>{
    onlyDebtFolders = !onlyDebtFolders;
    $("onlyDebtFolders").textContent = onlyDebtFolders ? "Mostrar todos" : "Mostrar s√≥ com d√©bito";
    $("onlyDebtFolders").classList.toggle("primary", onlyDebtFolders);
    renderPatientFolders();
  });

  function renderPatientFolders(){
    const q = $("pSearch").value.trim().toLowerCase();
    const pats = loadPatients()
      .filter(p => !q || (p.name||"").toLowerCase().includes(q))
      .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

    const box = $("patientFolders");
    box.innerHTML = "";

    if(!pats.length){
      box.innerHTML = `<div class="item"><b>Nenhum paciente.</b><div class="muted">Cadastre ao lado.</div></div>`;
      return;
    }

    const allSess = loadSessions();

    const filtered = pats.filter(p=>{
      if(!onlyDebtFolders) return true;
      const rows = allSess.filter(s => s.patientId === p.id);
      const aberto = rows.filter(r => r.paid !== "pago").reduce((s,r)=> s + (Number(r.value)||0), 0);
      return aberto > 0;
    });

    if(!filtered.length){
      box.innerHTML = `<div class="item"><b>Sem pacientes com d√©bito.</b><div class="muted">Desative o filtro para ver todos.</div></div>`;
      return;
    }

    filtered.forEach(p=>{
      const rows = allSess.filter(s => s.patientId === p.id);
      const aberto = rows.filter(r => r.paid !== "pago").reduce((s,r)=> s + (Number(r.value)||0), 0);
      const faltasSemJust = rows.filter(r => r.did==="nao" && r.just==="nao_justificada").length;

      const div = document.createElement("div");
      div.className = "item";
      div.style.cursor = "pointer";
      div.innerHTML = `
        <div class="itemTop">
          <div>
            <b>üìÅ ${escapeHtml(p.name)}</b>
            <div class="muted">
              <span class="pill bad">Em aberto: ${fmtBRL(aberto)}</span>
              <span class="pill bad">Sem just.: ${faltasSemJust}</span>
            </div>
          </div>
          <div class="muted">${rows.length} registros</div>
        </div>
        <div class="muted" style="margin-top:8px;">Toque para abrir a pasta</div>
      `;
      div.addEventListener("click", ()=> openPatientFolder(p.id));
      box.appendChild(div);
    });
  }

  function openPatientFolder(pid){
    openedPatientId = pid;
    openedMonth = "ALL";
    openedYear = "ALL";
    onlyUnpaid = false;
    $("toggleOnlyUnpaid").textContent = "S√≥ n√£o pagos: OFF";
    $("toggleOnlyUnpaid").classList.remove("primary");

    $("foldersPane").classList.add("hidden");
    $("folderOpenPane").classList.remove("hidden");

    renderOpenPatientHeader();
    renderYearButtons();
    renderMonthButtons();
    renderPatientHistoryFolder();
  }

  function closePatientFolder(silent=false){
    openedPatientId = null;
    openedMonth = "ALL";
    openedYear = "ALL";
    onlyUnpaid = false;
    $("folderOpenPane").classList.add("hidden");
    $("foldersPane").classList.remove("hidden");
    if(!silent) renderPatientFolders();
  }

  $("backToFolders").addEventListener("click", ()=> closePatientFolder());

  function renderOpenPatientHeader(){
    const p = getPatientById(openedPatientId);
    if(!p) return closePatientFolder();

    $("openPatientTitle").textContent = `üìÅ ${p.name}`;
    const meta = [];
    if(p.resp) meta.push(`Resp.: ${p.resp}`);
    if(p.phone) meta.push(`Whats: ${p.phone}`);
    if(p.defaultValue) meta.push(`Valor padr√£o: ${fmtBRL(p.defaultValue)}`);
    if(p.notes) meta.push(`Obs.: ${p.notes}`);
    $("openPatientMeta").textContent = meta.join(" ‚Ä¢ ") || "‚Äî";
  }

  function yearsAvailableForPatient(pid){
    const years = new Set(loadSessions().filter(s=>s.patientId===pid).map(s => (s.date||"").slice(0,4)));
    const arr = Array.from(years).filter(Boolean).sort((a,b)=> b.localeCompare(a));
    // se n√£o tiver, mostra ano atual como op√ß√£o tamb√©m
    const cur = String(new Date().getFullYear());
    if(!arr.includes(cur)) arr.unshift(cur);
    return arr;
  }

  function renderYearButtons(){
    const box = $("yearButtons");
    box.innerHTML = "";

    const btnAll = document.createElement("button");
    btnAll.textContent = "Todos";
    btnAll.className = (openedYear==="ALL") ? "primary" : "";
    btnAll.addEventListener("click", ()=>{
      openedYear = "ALL";
      updateFilterLabel();
      renderYearButtons();
      renderPatientHistoryFolder();
    });
    box.appendChild(btnAll);

    yearsAvailableForPatient(openedPatientId).forEach(y=>{
      const b = document.createElement("button");
      b.textContent = y;
      b.className = (openedYear===y) ? "primary" : "";
      b.addEventListener("click", ()=>{
        openedYear = y;
        updateFilterLabel();
        renderYearButtons();
        renderPatientHistoryFolder();
      });
      box.appendChild(b);
    });
  }

  function renderMonthButtons(){
    const box = $("monthButtons");
    box.innerHTML = "";

    const btnAll = document.createElement("button");
    btnAll.textContent = "Todos";
    btnAll.className = (openedMonth==="ALL") ? "primary" : "";
    btnAll.addEventListener("click", ()=>{
      openedMonth = "ALL";
      updateFilterLabel();
      renderMonthButtons();
      renderPatientHistoryFolder();
    });
    box.appendChild(btnAll);

    MONTHS.forEach(x=>{
      const b = document.createElement("button");
      b.textContent = x.t;
      b.className = (openedMonth===x.m) ? "primary" : "";
      b.addEventListener("click", ()=>{
        openedMonth = x.m;
        updateFilterLabel();
        renderMonthButtons();
        renderPatientHistoryFolder();
      });
      box.appendChild(b);
    });
  }

  function updateFilterLabel(){
    const parts = [];
    if(openedYear !== "ALL") parts.push(`Ano ${openedYear}`);
    if(openedMonth !== "ALL") parts.push(`M√™s ${MONTHS.find(m=>m.m===openedMonth)?.t || openedMonth}`);
    if(onlyUnpaid) parts.push("S√≥ n√£o pagos");
    $("filterLabel").textContent = parts.length ? parts.join(" ‚Ä¢ ") : "Todos";
  }

  $("toggleOnlyUnpaid").addEventListener("click", ()=>{
    onlyUnpaid = !onlyUnpaid;
    $("toggleOnlyUnpaid").textContent = onlyUnpaid ? "S√≥ n√£o pagos: ON" : "S√≥ n√£o pagos: OFF";
    $("toggleOnlyUnpaid").classList.toggle("primary", onlyUnpaid);
    updateFilterLabel();
    renderPatientHistoryFolder();
  });

  function renderPatientHistoryFolder(){
    const hist = $("patientHistory");
    hist.innerHTML = "";

    const p = getPatientById(openedPatientId);
    if(!p) return closePatientFolder();

    let rows = loadSessions().filter(s => s.patientId === openedPatientId);

    if(openedYear !== "ALL"){
      rows = rows.filter(r => (r.date||"").slice(0,4) === openedYear);
    }
    if(openedMonth !== "ALL"){
      rows = rows.filter(r => (r.date||"").slice(5,7) === openedMonth);
    }
    if(onlyUnpaid){
      rows = rows.filter(r => r.paid !== "pago");
    }

    rows.sort((a,b)=> (b.date||"").localeCompare(a.date||""));

    const total = rows.length;
    const faltasSemJust = rows.filter(r => r.did==="nao" && r.just==="nao_justificada").length;
    const pago = rows.filter(r => r.paid==="pago").reduce((s,r)=> s + (Number(r.value)||0), 0);
    const aberto = rows.filter(r => r.paid!=="pago").reduce((s,r)=> s + (Number(r.value)||0), 0);

    $("patientSummary").textContent =
      `Registros: ${total} | Sem justificativa: ${faltasSemJust} | Pago: ${fmtBRL(pago)} | Em aberto: ${fmtBRL(aberto)}`;
    updateFilterLabel();

    if(!rows.length){
      hist.innerHTML = `<div class="item"><b>Sem registros neste filtro.</b><div class="muted">Tente outro m√™s/ano ou ‚ÄúTodos‚Äù.</div></div>`;
      return;
    }

    rows.slice(0, 80).forEach(r=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="itemTop">
          <div>
            <b>${escapeHtml(r.date)}${r.time ? " ‚Äî " + escapeHtml(r.time) : ""}</b>
            <div class="muted">
              ${badgeFor(r)} ${payBadge(r)} <span class="pill">Valor: ${fmtBRL(r.value)}</span>
            </div>
          </div>
          <div class="muted">ID: ${escapeHtml(r.id)}</div>
        </div>
        <div class="actions">
          <button data-act="togglePaid" data-id="${r.id}">Pago/N√£o pago</button>
          <button data-act="editValue" data-id="${r.id}">Editar valor</button>
          <button data-act="del" data-id="${r.id}" class="danger">Excluir</button>
        </div>
      `;
      div.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=> sessionAction(btn.dataset.act, btn.dataset.id));
      });
      hist.appendChild(div);
    });
  }

  // A√ß√µes da pasta
  $("openWhats").addEventListener("click", ()=>{
    const p = getPatientById(openedPatientId);
    if(!p || !p.phone) return alert("Esse paciente n√£o tem WhatsApp cadastrado.");
    const msg = encodeURIComponent("Ol√°, tudo bem?");
    window.open(`https://wa.me/55${p.phone}?text=${msg}`, "_blank");
  });

  $("exportPatient").addEventListener("click", ()=>{
    const p = getPatientById(openedPatientId);
    if(!p) return;
    const sessions = loadSessions().filter(s => s.patientId === openedPatientId);
    const data = { patient: p, sessions };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `paciente_${(p.name||"").replace(/\s+/g,"_")}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $("renamePatient").addEventListener("click", ()=>{
    const pats = loadPatients();
    const idx = pats.findIndex(x => x.id === openedPatientId);
    if(idx < 0) return;
    const nv = prompt("Novo nome do paciente:", pats[idx].name || "");
    if(!nv) return;
    pats[idx].name = nv.trim();
    savePatients(pats);
    renderPatientSelectDaily();
    renderPatientFolders();
    renderOpenPatientHeader();
  });

  $("deletePatient").addEventListener("click", ()=>{
    if(!confirm("Excluir paciente? (os registros dele tamb√©m ser√£o removidos)")) return;
    savePatients(loadPatients().filter(p => p.id !== openedPatientId));
    saveSessions(loadSessions().filter(s => s.patientId !== openedPatientId));
    renderPatientSelectDaily();
    closePatientFolder();
  });

  // ======= Init =======
  renderPatientSelectDaily();
  renderDaily();
  renderPatientFolders();
</script>

</body>
</html>
