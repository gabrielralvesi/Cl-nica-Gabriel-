<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Gabriel Alves - Fonoaudiologia Infantil</title>
    
    <!-- Google API Client -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        /* ===== PALETA DE CORES ===== */
        :root {
            --primary: #2C7A5A;
            --primary-dark: #1E5F43;
            --primary-light: #4CAF7A;
            --secondary: #162B32;
            --accent: #E8C66A;
            --bg: #0F1A1F;
            --card: #1E2E36;
            --line: rgba(255, 255, 255, 0.1);
            --text: #FFFFFF;
            --muted: #B0C4CE;
            --bad: #EF4444;
            --ok: #2C7A5A;
            --warn: #E8C66A;
            --info: #4A90E2;
            --token: #E8C66A;
            --r: 14px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        .hidden {
            display: none !important;
        }

        .muted {
            color: var(--muted);
            font-size: 0.92rem;
        }

        .pill {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 999px;
            border: 1px solid var(--line);
            font-size: 0.85rem;
            margin-right: 6px;
            margin-top: 6px;
            background: rgba(255, 255, 255, 0.03);
        }

        .pill.ok {
            border-color: var(--primary);
            background: rgba(44, 122, 90, 0.15);
        }

        .pill.bad {
            border-color: var(--bad);
            background: rgba(239, 68, 68, 0.15);
        }

        .pill.token {
            border-color: var(--accent);
            background: rgba(232, 198, 106, 0.15);
        }

        button {
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            min-height: 44px;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        button.primary {
            border-color: var(--primary);
            background: rgba(44, 122, 90, 0.25);
        }

        button.danger {
            border-color: var(--bad);
            background: rgba(239, 68, 68, 0.18);
        }

        button.small {
            padding: 8px 12px;
            font-size: 0.9rem;
            min-height: 36px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            outline: none;
            font-family: inherit;
            font-size: 0.95rem;
            min-height: 44px;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(44, 122, 90, 0.2);
        }

        label {
            display: block;
            margin: 0 0 6px;
            color: var(--muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--line);
            flex-wrap: wrap;
            background: var(--card);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .logo-text h2 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--primary-light);
        }

        .logo-text p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--muted);
        }

        .backup-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            background: rgba(44, 122, 90, 0.1);
            border: 1px solid rgba(44, 122, 90, 0.3);
            border-radius: 40px;
            padding: 6px 12px;
        }

        .drive-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .drive-status.online {
            background: #22c55e;
            box-shadow: 0 0 5px #22c55e;
        }

        .drive-status.offline {
            background: #ef4444;
        }

        .drive-status.syncing {
            background: #e8c66a;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tab {
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.04);
            padding: 10px 16px;
        }

        .tab.active {
            border-color: var(--primary);
            background: rgba(44, 122, 90, 0.18);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--r);
            padding: 18px;
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .grid3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        @media (max-width: 900px) {
            .grid2, .grid3 {
                grid-template-columns: 1fr;
            }
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .item {
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.03);
            border-radius: 14px;
            padding: 15px;
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .split {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 15px;
        }

        @media (max-width: 1000px) {
            .split {
                grid-template-columns: 1fr;
            }
        }

        .photo-preview {
            width: 120px;
            height: 120px;
            border-radius: 60px;
            border: 3px solid var(--primary);
            object-fit: cover;
        }

        .photo-preview.small {
            width: 40px;
            height: 40px;
        }

        .time-item {
            display: flex;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid var(--line);
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 18px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .schedWrap {
            overflow-x: auto;
            border: 1px solid var(--line);
            border-radius: 14px;
            max-height: 600px;
        }

        table.sched {
            border-collapse: collapse;
            width: 100%;
            min-width: 900px;
        }

        .sched th, .sched td {
            border: 1px solid var(--line);
            padding: 12px;
        }

        .sched th {
            background: rgba(255, 255, 255, 0.04);
            position: sticky;
            top: 0;
        }

        .timeCell {
            position: sticky;
            left: 0;
            background: rgba(255, 255, 255, 0.04);
            font-weight: 800;
        }

        .slotGreen { background: rgba(44, 122, 90, 0.15); border-left: 4px solid var(--primary); }
        .slotAmber { background: rgba(232, 198, 106, 0.15); border-left: 4px solid var(--accent); }
        .slotRed { background: rgba(239, 68, 68, 0.15); border-left: 4px solid var(--bad); }
        .slotBlue { background: rgba(74, 144, 226, 0.15); border-left: 4px solid var(--info); }

        .weekday-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.06);
            cursor: pointer;
            margin-right: 5px;
        }

        .weekday-btn.selected {
            background: var(--primary);
            color: white;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 20px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 12px;
            background: var(--card);
            border: 1px solid var(--primary);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .shortcuts-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 40px;
            padding: 10px 18px;
            cursor: pointer;
            z-index: 100;
        }

        /* Timeline de Evolu√ß√£o */
        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            position: relative;
            padding: 20px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .timeline-date {
            font-size: 0.9rem;
            color: var(--primary-light);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .timeline-content {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .timeline-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Contador de Sess√µes */
        .session-counter {
            background: rgba(44, 122, 90, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(44, 122, 90, 0.3);
        }

        .counter-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-light);
        }

        .counter-numbers {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .counter-numbers span:first-child {
            color: var(--text);
        }

        .counter-numbers span:last-child {
            color: var(--primary);
            font-weight: bold;
        }

        .counter-percent {
            text-align: right;
            font-size: 0.9rem;
            color: var(--accent);
            margin-top: 5px;
        }

        /* Badge de Pacote */
        .pack-badge {
            display: inline-block;
            background: rgba(44, 122, 90, 0.2);
            border: 1px solid var(--primary);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.85rem;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Modal de Evolu√ß√£o -->
    <div id="evolucaoModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="margin-bottom:15px;">üìù Registrar Evolu√ß√£o</h3>
            <div style="margin:15px 0;">
                <label>Data</label>
                <input type="date" id="evolucaoData" />
            </div>
            <div style="margin:15px 0;">
                <label>Evolu√ß√£o do paciente</label>
                <textarea id="evolucaoTexto" rows="5" placeholder="Descreva a evolu√ß√£o, atividades realizadas, observa√ß√µes importantes..."></textarea>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button id="cancelEvolucao" class="small">Cancelar</button>
                <button id="saveEvolucao" class="primary small">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Evolu√ß√£o -->
    <div id="editEvolucaoModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="margin-bottom:15px;">‚úèÔ∏è Editar Evolu√ß√£o</h3>
            <div style="margin:15px 0;">
                <label>Data</label>
                <input type="date" id="editEvolucaoData" />
            </div>
            <div style="margin:15px 0;">
                <label>Evolu√ß√£o do paciente</label>
                <textarea id="editEvolucaoTexto" rows="5" placeholder="Descreva a evolu√ß√£o..."></textarea>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button id="cancelEditEvolucao" class="small">Cancelar</button>
                <button id="saveEditEvolucao" class="primary small">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURA√á√ïES ==========
        const CLINIC_NAME = "Gabriel Alves";
        const CLINIC_SUBTITLE = "Fonoaudiologia Infantil";
        const CLINIC_CRFA = "CRFa 5-13766";
        const DRIVE_FILE_NAME = "clinica_dados.json";
        const DRIVE_FOLDER_NAME = "ClinicaFono";
        
        const DAYS = ["Seg", "Ter", "Qua", "Qui", "Sex", "S√°b", "Dom"];
        
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let gapiReady = false;
        let driveStatus = 'offline';
        let autoSaveTimer = null;
        let openedPatientId = null;
        let currentTokenSessionId = null;
        let currentPackPatientId = null;
        let debtFilterActive = false;
        let currentEvolucaoId = null;
        
        // Dados
        let patients = [];
        let sessions = [];
        let schedule = { times: defaultTimes(), recurring: {} };
        let tokens = {};
        let packs = {};
        let evolucoes = {}; // { patientId: [ {id, date, text} ] }

        // ========== FUN√á√ïES UTILIT√ÅRIAS ==========
        function $(id) { return document.getElementById(id); }

        function uid() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function todayISO() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
        }

        function nowTime() {
            const d = new Date();
            return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
        }

        function parseMoney(val) {
            if (!val) return 0;
            return Number(String(val).replace(/\./g, "").replace(",", ".")) || 0;
        }

        function fmtMoney(val) {
            return Number(val || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        }

        function escapeHtml(str) {
            return String(str || "")
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function showAlert(message, type = "info") {
            const alert = document.createElement("div");
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alert.style.background = type === "success" ? "rgba(44,122,90,.2)" : "rgba(44,122,90,.2)";
            alert.style.borderColor = "#2C7A5A";
            document.body.appendChild(alert);
            
            setTimeout(() => alert.remove(), 3000);
        }

        function updateDriveStatus(status) {
            driveStatus = status;
            const statusEl = $("driveStatus");
            if (statusEl) {
                statusEl.className = `drive-status ${status}`;
            }
        }

        function recurKey(day, time) { return `${day}|${time}`; }

        function defaultTimes() {
            return ["07:00", "07:40", "08:20", "09:00", "09:40", "10:20", "11:00", "13:20", "14:00", "14:40", "15:20", "16:00", "16:40", "17:20"];
        }

        // ========== GOOGLE DRIVE INTEGRA√á√ÉO ==========
        
        function initGoogleDrive() {
            gapi.load('client:auth2', async () => {
                await gapi.client.init({
                    apiKey: 'AIzaSyCgYKpI9u_2JYqXkZnYvYqXkZnYvYqXkZnY',
                    clientId: '123456789-abc123.apps.googleusercontent.com',
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                    scope: 'https://www.googleapis.com/auth/drive.file'
                });

                const auth = gapi.auth2.getAuthInstance();
                if (auth.isSignedIn.get()) {
                    gapiReady = true;
                    updateDriveStatus('online');
                    loadFromDrive();
                } else {
                    try {
                        await auth.signIn();
                        gapiReady = true;
                        updateDriveStatus('online');
                        loadFromDrive();
                    } catch (e) {
                        updateDriveStatus('offline');
                    }
                }
            });
        }

        window.loginToDrive = async function() {
            try {
                const auth = gapi.auth2.getAuthInstance();
                await auth.signIn();
                gapiReady = true;
                updateDriveStatus('online');
                showAlert("‚úÖ Conectado ao Google Drive!", "success");
                loadFromDrive();
            } catch (e) {
                showAlert("‚ùå Erro ao conectar ao Google Drive", "error");
            }
        };

        async function saveToDrive() {
            if (!gapiReady) return;
            
            updateDriveStatus('syncing');
            
            try {
                const data = {
                    patients,
                    sessions,
                    schedule,
                    tokens,
                    packs,
                    evolucoes,
                    lastSync: new Date().toISOString()
                };

                let fileId = await findOrCreateFile();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const reader = new FileReader();
                
                reader.onload = async () => {
                    const base64 = reader.result.split(',')[1];
                    
                    await gapi.client.request({
                        path: `/upload/drive/v3/files/${fileId}`,
                        method: 'PATCH',
                        params: { uploadType: 'media' },
                        headers: { 'Content-Type': 'application/json' },
                        body: base64
                    });
                    
                    updateDriveStatus('online');
                    showAlert("‚úÖ Dados salvos no Google Drive!", "success");
                };
                
                reader.readAsDataURL(blob);
                
            } catch (e) {
                console.error('Erro ao salvar no Drive:', e);
                updateDriveStatus('offline');
                showAlert("‚ùå Erro ao salvar no Google Drive", "error");
            }
        }

        async function loadFromDrive() {
            if (!gapiReady) return;
            
            updateDriveStatus('syncing');
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${DRIVE_FILE_NAME}' and 'root' in parents and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (response.result.files.length > 0) {
                    const fileId = response.result.files[0].id;
                    
                    const fileResponse = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });
                    
                    const data = fileResponse.result;
                    
                    if (data.patients) patients = data.patients;
                    if (data.sessions) sessions = data.sessions;
                    if (data.schedule) schedule = data.schedule;
                    if (data.tokens) tokens = data.tokens;
                    if (data.packs) packs = data.packs;
                    if (data.evolucoes) evolucoes = data.evolucoes;
                    
                    showAlert("‚úÖ Dados carregados do Google Drive!", "success");
                    
                    renderAll();
                }
                
                updateDriveStatus('online');
                
            } catch (e) {
                console.error('Erro ao carregar do Drive:', e);
                updateDriveStatus('offline');
            }
        }

        async function findOrCreateFile() {
            const response = await gapi.client.drive.files.list({
                q: `name='${DRIVE_FILE_NAME}' and 'root' in parents and trashed=false`,
                fields: 'files(id, name)',
                spaces: 'drive'
            });

            if (response.result.files.length > 0) {
                return response.result.files[0].id;
            }

            const createResponse = await gapi.client.drive.files.create({
                resource: {
                    name: DRIVE_FILE_NAME,
                    mimeType: 'application/json',
                    parents: ['root']
                }
            });

            return createResponse.result.id;
        }

        function startAutoSave() {
            if (autoSaveTimer) clearInterval(autoSaveTimer);
            autoSaveTimer = setInterval(() => {
                saveToDrive();
            }, 30000);
        }

        // ========== FUN√á√ïES DE CRUD ==========
        
        function getPatientById(id) {
            return patients.find(p => p.id === id);
        }

        function getPatientPack(patientId) {
            return packs[patientId] || null;
        }

        function getTokenForSession(sessionId) {
            return tokens[sessionId] || null;
        }

        function getPatientEvolucoes(patientId) {
            return evolucoes[patientId] || [];
        }

        function calculateSessionsProgress(patientId, startDate, totalSessions) {
            const patientSessions = sessions.filter(s => 
                s.patientId === patientId && 
                s.did === "realizou" &&
                s.date >= startDate
            );
            return {
                completed: patientSessions.length,
                remaining: Math.max(0, totalSessions - patientSessions.length),
                percent: totalSessions > 0 ? (patientSessions.length / totalSessions) * 100 : 0
            };
        }

        function calculateTotalSessions(patientId) {
            const patientSessions = sessions.filter(s => 
                s.patientId === patientId && 
                s.did === "realizou"
            );
            return patientSessions.length;
        }

        // ========== FUN√á√ïES DE EVOLU√á√ÉO ==========
        
        window.openEvolucaoModal = function() {
            if (!openedPatientId) return;
            
            $("evolucaoData").value = todayISO();
            $("evolucaoTexto").value = "";
            $("evolucaoModal").classList.remove("hidden");
        };

        window.saveEvolucao = function() {
            if (!openedPatientId) return;
            
            const data = $("evolucaoData").value;
            const texto = $("evolucaoTexto").value.trim();
            
            if (!texto) {
                showAlert("‚ùå Escreva a evolu√ß√£o do paciente", "error");
                return;
            }
            
            if (!evolucoes[openedPatientId]) {
                evolucoes[openedPatientId] = [];
            }
            
            evolucoes[openedPatientId].push({
                id: uid(),
                date: data,
                text: texto,
                createdAt: new Date().toISOString()
            });
            
            // Ordenar por data (mais recente primeiro)
            evolucoes[openedPatientId].sort((a, b) => b.date.localeCompare(a.date));
            
            $("evolucaoModal").classList.add("hidden");
            
            renderEvolucoes();
            saveToDrive();
            showAlert("‚úÖ Evolu√ß√£o registrada!", "success");
        };

        window.editEvolucao = function(evolucaoId) {
            if (!openedPatientId) return;
            
            const evolucao = evolucoes[openedPatientId]?.find(e => e.id === evolucaoId);
            if (!evolucao) return;
            
            currentEvolucaoId = evolucaoId;
            $("editEvolucaoData").value = evolucao.date;
            $("editEvolucaoTexto").value = evolucao.text;
            $("editEvolucaoModal").classList.remove("hidden");
        };

        window.saveEditEvolucao = function() {
            if (!openedPatientId || !currentEvolucaoId) return;
            
            const data = $("editEvolucaoData").value;
            const texto = $("editEvolucaoTexto").value.trim();
            
            if (!texto) {
                showAlert("‚ùå Escreva a evolu√ß√£o do paciente", "error");
                return;
            }
            
            const index = evolucoes[openedPatientId]?.findIndex(e => e.id === currentEvolucaoId);
            if (index !== -1) {
                evolucoes[openedPatientId][index].date = data;
                evolucoes[openedPatientId][index].text = texto;
                evolucoes[openedPatientId][index].updatedAt = new Date().toISOString();
                
                // Reordenar
                evolucoes[openedPatientId].sort((a, b) => b.date.localeCompare(a.date));
            }
            
            $("editEvolucaoModal").classList.add("hidden");
            currentEvolucaoId = null;
            
            renderEvolucoes();
            saveToDrive();
            showAlert("‚úÖ Evolu√ß√£o atualizada!", "success");
        };

        window.deleteEvolucao = function(evolucaoId) {
            if (!openedPatientId) return;
            
            if (!confirm("Excluir esta evolu√ß√£o?")) return;
            
            evolucoes[openedPatientId] = evolucoes[openedPatientId]?.filter(e => e.id !== evolucaoId);
            
            if (evolucoes[openedPatientId]?.length === 0) {
                delete evolucoes[openedPatientId];
            }
            
            renderEvolucoes();
            saveToDrive();
            showAlert("üóëÔ∏è Evolu√ß√£o exclu√≠da!", "success");
        };

        function renderEvolucoes() {
            const container = $("evolucoesList");
            if (!container || !openedPatientId) return;
            
            const patientEvolucoes = getPatientEvolucoes(openedPatientId);
            
            if (patientEvolucoes.length === 0) {
                container.innerHTML = '<div class="muted" style="text-align:center; padding:20px;">Nenhuma evolu√ß√£o registrada</div>';
                return;
            }
            
            container.innerHTML = patientEvolucoes.map(ev => `
                <div class="timeline-item">
                    <div class="timeline-date">üìÖ ${new Date(ev.date).toLocaleDateString("pt-BR")}</div>
                    <div class="timeline-content">${escapeHtml(ev.text).replace(/\n/g, '<br>')}</div>
                    <div class="timeline-actions">
                        <button class="small" onclick="editEvolucao('${ev.id}')">‚úèÔ∏è Editar</button>
                        <button class="small danger" onclick="deleteEvolucao('${ev.id}')">üóëÔ∏è Excluir</button>
                    </div>
                </div>
            `).join('');
        }

        // ========== RENDERIZA√á√ÉO ==========
        function renderAll() {
            renderPatientSelect();
            renderDaily();
            renderPatientFolders();
            renderSchedule();
            renderDashboard();
            generateReports();
            
            if (openedPatientId) {
                openPatientFolder(openedPatientId);
            }
        }

        function renderPatientSelect() {
            const sel = $("pPatient");
            if (!sel) return;
            
            sel.innerHTML = patients.length ?
                patients.map(p => `<option value="${p.id}">${escapeHtml(p.name)}${p.serviceType === 'cassems' ? ' (Cassems)' : ''}</option>`).join("") :
                `<option value="">(Cadastre pacientes)</option>`;
        }

        function renderDaily() {
            const date = $("date")?.value || todayISO();
            const search = $("search")?.value.toLowerCase() || "";
            
            const daySessions = sessions.filter(s => s.date === date);
            
            const filtered = daySessions.filter(s => {
                const p = getPatientById(s.patientId);
                return !search || (p?.name || "").toLowerCase().includes(search);
            });

            $("cassemsHoje").textContent = filtered.filter(s => {
                const p = getPatientById(s.patientId);
                return p?.serviceType === "cassems";
            }).length;

            $("tokensEnviadosHoje").textContent = filtered.filter(s => {
                const token = tokens[s.id];
                return token?.status === "enviado";
            }).length;

            $("tokensPendentesHoje").textContent = filtered.filter(s => {
                const token = tokens[s.id];
                return !token || token?.status === "pendente";
            }).length;

            const list = $("dayList");
            if (!list) return;
            
            list.innerHTML = filtered.map(s => {
                const p = getPatientById(s.patientId);
                const token = tokens[s.id];
                
                let tokenIndicator = '';
                if (p?.serviceType === 'cassems') {
                    if (token?.status === 'enviado') {
                        tokenIndicator = `<span class="pill token">‚úÖ Token: ${token.code || 'Enviado'}</span>`;
                    } else {
                        tokenIndicator = `<span class="pill token">‚è≥ Token pendente</span>`;
                    }
                }

                return `
                <div class="item">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <b>${s.time || "‚Äî"} - ${escapeHtml(p?.name || "?")}</b>
                            <div class="muted">
                                ${s.did === "realizou" ? "‚úÖ Realizou" : "‚ùå N√£o realizou"}
                                ${s.just === "justificada" ? "(Justificada)" : s.just === "nao_justificada" ? "(Sem just.)" : ""}
                            </div>
                            ${tokenIndicator}
                        </div>
                        <div>
                            <span class="pill ${s.paid === "pago" ? "ok" : "bad"}">${s.paid === "pago" ? "üí∞ Pago" : "üí∏ N√£o pago"}</span>
                            <span class="pill">${fmtMoney(s.value)}</span>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="small" onclick="toggleSessionDid('${s.id}')">üîÑ Alternar</button>
                        <button class="small" onclick="toggleSessionPaid('${s.id}')">üí∞ Pagamento</button>
                        ${p?.serviceType === 'cassems' ? `<button class="small" onclick="openTokenModal('${s.id}', '${p.name}', '${s.date}')">üé´ Token</button>` : ''}
                        <button class="small danger" onclick="deleteSession('${s.id}')">üóëÔ∏è Excluir</button>
                    </div>
                </div>
            `;
            }).join("") || "<div class='muted'>Nenhuma sess√£o neste dia</div>";

            $("sumDay").innerHTML = `Total: ${filtered.length}`;
            $("sumMoney").innerHTML = `Total: ${fmtMoney(filtered.reduce((s, r) => s + (Number(r.value) || 0), 0))}`;
            $("sumAbsences").innerHTML = filtered.filter(s => s.did === "nao").length.toString();
        }

        function renderPatientFolders() {
            const search = $("pSearch")?.value.toLowerCase() || "";
            let filteredPatients = patients.filter(p => !search || p.name.toLowerCase().includes(search));

            if (debtFilterActive) {
                filteredPatients = filteredPatients.filter(p => {
                    const patientSessions = sessions.filter(s => s.patientId === p.id && s.paid !== "pago");
                    return patientSessions.length > 0;
                });
            }

            const container = $("patientFolders");
            if (!container) return;

            container.innerHTML = filteredPatients.map(p => {
                const patientSessions = sessions.filter(s => s.patientId === p.id);
                const debt = patientSessions.filter(s => s.paid !== "pago").reduce((sum, s) => sum + (Number(s.value) || 0), 0);
                const pack = getPatientPack(p.id);
                const totalSessoes = patientSessions.filter(s => s.did === "realizou").length;
                
                return `
                <div class="item" onclick="openPatientFolder('${p.id}')" style="cursor:pointer;">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <b>üìÅ ${escapeHtml(p.name)} ${p.serviceType === 'cassems' ? 'üé´' : ''} ${pack ? 'üì¶' : ''}</b>
                            <div class="muted">
                                ${p.serviceType || "Particular"} ‚Ä¢ ${totalSessoes} sess√µes realizadas
                                ${pack ? ` ‚Ä¢ Pacote ${pack.totalSessions}` : ''}
                            </div>
                        </div>
                        <div>
                            ${debt > 0 ? `<span class="pill bad">üí∞ ${fmtMoney(debt)}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join("") || "<div class='muted'>Nenhum paciente</div>";
        }

        window.openPatientFolder = function(id) {
            openedPatientId = id;
            const p = getPatientById(id);
            const pack = getPatientPack(id);
            const totalSessoes = sessions.filter(s => s.patientId === id && s.did === "realizou").length;
            
            $("foldersPane").classList.add("hidden");
            $("folderOpenPane").classList.remove("hidden");
            $("openPatientTitle").textContent = `üìÅ ${p?.name || "Paciente"}`;

            // Contador de Sess√µes
            let contadorHtml = `
                <div class="session-counter">
                    <div class="counter-title">üìä Sess√µes Realizadas</div>
                    <div class="counter-numbers">
                        <span>Total:</span>
                        <span>${totalSessoes} sess√µes</span>
                    </div>
            `;

            if (pack) {
                const progress = calculateSessionsProgress(id, pack.startDate, pack.totalSessions);
                contadorHtml += `
                    <div class="counter-numbers">
                        <span>Pacote ${pack.totalSessions}:</span>
                        <span>${progress.completed}/${pack.totalSessions}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width:${progress.percent}%;"></div>
                    </div>
                    <div class="counter-percent">
                        ${progress.remaining} restantes ‚Ä¢ ${progress.percent.toFixed(0)}% conclu√≠do
                    </div>
                `;
            } else {
                contadorHtml += `<div class="muted">Sem pacote ativo</div>`;
            }

            contadorHtml += `</div>`;
            
            $("pacoteProgresso").innerHTML = contadorHtml;

            // Abas da pasta
            $("folderTabs").innerHTML = `
                <div style="display:flex; gap:10px; margin:20px 0; border-bottom:1px solid var(--line); padding-bottom:10px;">
                    <button class="tab active" id="tabHistorico" onclick="showTab('historico')">üìã Hist√≥rico</button>
                    <button class="tab" id="tabEvolucao" onclick="showTab('evolucao')">üìà Evolu√ß√£o</button>
                </div>
                <div id="tabHistoricoContent">
                    <div id="patientHistory" class="list"></div>
                </div>
                <div id="tabEvolucaoContent" class="hidden">
                    <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0;">üìù Evolu√ß√£o do Caso</h3>
                        <button class="small primary" onclick="openEvolucaoModal()">‚ûï Nova Evolu√ß√£o</button>
                    </div>
                    <div id="evolucoesList" class="timeline"></div>
                </div>
            `;

            // Hist√≥rico de sess√µes
            const patientSessions = sessions.filter(s => s.patientId === id).sort((a, b) => b.date.localeCompare(a.date));
            
            $("patientHistory").innerHTML = patientSessions.map(s => {
                const token = tokens[s.id];
                return `
                <div class="item">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <b>${new Date(s.date).toLocaleDateString("pt-BR")} ${s.time ? "√†s " + s.time : ""}</b>
                            <div class="muted">
                                ${s.did === "realizou" ? "‚úÖ Realizou" : "‚ùå N√£o realizou"} ‚Ä¢ 
                                ${s.paid === "pago" ? "üí∞ Pago" : "üí∏ N√£o pago"} ‚Ä¢ 
                                ${fmtMoney(s.value)}
                            </div>
                            ${token ? `<div class="muted">üé´ Token: ${token.code || '‚Äî'}</div>` : ''}
                        </div>
                    </div>
                </div>
            `}).join("") || "<div class='muted'>Nenhum hist√≥rico</div>";

            // Renderizar evolu√ß√µes
            renderEvolucoes();
        };

        window.showTab = function(tab) {
            $("tabHistorico")?.classList.toggle("active", tab === "historico");
            $("tabEvolucao")?.classList.toggle("active", tab === "evolucao");
            $("tabHistoricoContent")?.classList.toggle("hidden", tab !== "historico");
            $("tabEvolucaoContent")?.classList.toggle("hidden", tab !== "evolucao");
        };

        window.closePatientFolder = function() {
            openedPatientId = null;
            $("folderOpenPane")?.classList.add("hidden");
            $("foldersPane")?.classList.remove("hidden");
        };

        function renderSchedule() {
            const times = (schedule.times || []).sort();
            const table = $("schedTable");
            if (!table) return;

            let html = "<thead><tr><th class='timeCell'>Hor√°rio</th>";
            DAYS.forEach(day => html += `<th>${day}</th>`);
            html += "</tr></thead><tbody>";

            for (const time of times) {
                html += `<tr><td class="timeCell">${escapeHtml(time)}</td>`;

                for (let day = 0; day < 7; day++) {
                    const key = recurKey(day, time);
                    const entry = schedule.recurring?.[key];

                    if (entry) {
                        const patient = getPatientById(entry.patientId);
                        const colorClass = entry.serviceType === "cassems" ? "slotGreen" : 
                                          entry.serviceType === "particular" ? "slotAmber" : "slotBlue";
                        
                        let progressHtml = "";
                        if (entry.plannedTotal > 1) {
                            const sessionsCount = sessions.filter(s =>
                                s.patientId === entry.patientId &&
                                s.did === "realizou" &&
                                s.date >= entry.startDate
                            ).length;
                            progressHtml = `<div class="muted" style="font-size:0.8rem;">${sessionsCount}/${entry.plannedTotal}</div>`;
                        }

                        html += `<td class="${colorClass}">
                            <div style="font-weight:600;">${escapeHtml(patient?.name || "?")}</div>
                            <div class="muted">${entry.serviceType}</div>
                            ${progressHtml}
                        </td>`;
                    } else {
                        html += `<td class="slotRed" style="cursor:pointer;" onclick="scheduleClickHandler(${day}, '${time}')">
                            <div style="opacity:0.7;">üü• Vago</div>
                        </td>`;
                    }
                }
                html += "</tr>";
            }

            html += "</tbody>";
            table.innerHTML = html;
        }

        window.scheduleClickHandler = function(day, time) {
            const key = recurKey(day, time);
            const current = schedule.recurring?.[key];

            if (current) {
                const patient = getPatientById(current.patientId);
                if (confirm(`Remover ${patient?.name} deste hor√°rio?`)) {
                    delete schedule.recurring[key];
                    renderSchedule();
                    saveToDrive();
                    showAlert("‚úÖ Hor√°rio liberado!", "success");
                }
            } else {
                const patientList = patients.map((p, i) => `${i+1} - ${p.name}`).join("\n");
                const choice = prompt(
                    `Agendar em ${DAYS[day]} √†s ${time}\n\n` +
                    `Digite o N√öMERO do paciente:\n${patientList}\n\n` +
                    `Ou 0 para cancelar`
                );

                if (choice && choice !== "0") {
                    const idx = parseInt(choice) - 1;
                    if (idx >= 0 && idx < patients.length) {
                        const patient = patients[idx];
                        
                        if (!schedule.recurring) schedule.recurring = {};
                        schedule.recurring[key] = {
                            patientId: patient.id,
                            serviceType: patient.serviceType || "particular",
                            startDate: todayISO(),
                            plannedTotal: patient.billingType === "pack4" ? 4 : 
                                         patient.billingType === "pack8" ? 8 : 1
                        };

                        renderSchedule();
                        saveToDrive();
                        showAlert(`‚úÖ ${patient.name} agendado!`, "success");
                    }
                }
            }
        };

        function renderDashboard() {
            const hoje = todayISO();
            const hojeSessions = sessions.filter(s => s.date === hoje);
            
            $("dashHoje").textContent = hojeSessions.length;
            
            const realizadasHoje = hojeSessions.filter(s => s.did === "realizou").length;
            const faltasHoje = hojeSessions.filter(s => s.did === "nao").length;
            $("dashHojeDetalhe").innerHTML = `‚úÖ ${realizadasHoje} ‚Ä¢ ‚ùå ${faltasHoje}`;

            const faturamentoHoje = hojeSessions
                .filter(s => s.did === "realizou" && s.paid === "pago")
                .reduce((sum, s) => sum + (Number(s.value) || 0), 0);
            
            $("dashFaturamento").textContent = fmtMoney(faturamentoHoje);

            const currentMonth = hoje.slice(0,7);
            const monthSessions = sessions.filter(s => s.date.startsWith(currentMonth));
            const monthFaltas = monthSessions.filter(s => s.did === "nao").length;
            const taxa = monthSessions.length ? (monthFaltas / monthSessions.length * 100).toFixed(1) : 0;
            
            $("dashTaxaFaltas").textContent = `${taxa}%`;
            $("dashProgresso").style.width = `${taxa}%`;
        }

        function generateReports() {
            $("activePatients").innerHTML = patients.length.toString();
        }

        // ========== A√á√ïES DE PACIENTE ==========
        
        window.addPatient = async function() {
            const name = $("cName")?.value.trim();
            if (!name) return showAlert("‚ùå Nome √© obrigat√≥rio", "error");

            const timeSlots = getTimeSlots();
            if (timeSlots.length === 0) {
                return showAlert("‚ùå Adicione pelo menos um hor√°rio", "error");
            }

            const frequency = parseInt($("cFrequency")?.value || "1");
            
            const patient = {
                id: uid(),
                name,
                birth: $("cBirth")?.value || "",
                cpf: $("cCpf")?.value || "",
                resp: $("cResp")?.value || "",
                phone: $("cPhone")?.value || "",
                email: $("cEmail")?.value || "",
                serviceType: $("cServiceType")?.value || "particular",
                defaultValue: parseMoney($("cDefaultValue")?.value),
                billingType: $("cBillingType")?.value || "pack4",
                frequency: frequency,
                timeSlots: timeSlots,
                notes: $("cNotes")?.value || "",
                anamnese: { queixa: "", historico: "", obs: "" },
                createdAt: new Date().toISOString()
            };

            patients.push(patient);

            if (patient.billingType !== "individual") {
                timeSlots.forEach(slot => {
                    if (!schedule.times.includes(slot.time)) {
                        schedule.times.push(slot.time);
                    }
                    
                    for (let i = 0; i < (patient.billingType === "pack4" ? 4 : 8); i++) {
                        const startDate = new Date();
                        let daysToAdd = i * (frequency === 2 ? 3 : 7);
                        const sessionDate = new Date();
                        sessionDate.setDate(startDate.getDate() + daysToAdd);
                        
                        const key = recurKey(slot.day, slot.time);
                        
                        if (!schedule.recurring[key]) {
                            schedule.recurring[key] = {
                                patientId: patient.id,
                                serviceType: patient.serviceType,
                                startDate: todayISO(),
                                plannedTotal: patient.billingType === "pack4" ? 4 : 8
                            };
                        }
                    }
                });
                
                schedule.times.sort();
            }

            // Limpar formul√°rio
            $("cName").value = "";
            $("cBirth").value = "";
            $("cCpf").value = "";
            $("cResp").value = "";
            $("cPhone").value = "";
            $("cEmail").value = "";
            $("cDefaultValue").value = "";
            $("cNotes").value = "";
            
            renderAll();
            saveToDrive();
            showAlert("‚úÖ Paciente cadastrado com sucesso!", "success");
        };

        window.toggleDebtFilter = function() {
            debtFilterActive = !debtFilterActive;
            const btn = $("onlyDebtFolders");
            if (btn) btn.classList.toggle("primary", debtFilterActive);
            renderPatientFolders();
        };

        // ========== A√á√ïES DE SESS√ÉO ==========
        
        window.addSession = async function() {
            const date = $("date")?.value;
            const patientId = $("pPatient")?.value;
            const time = $("pTime")?.value;
            const did = $("pDid")?.value;
            const just = $("pJust")?.value;
            const paid = $("pPaid")?.value;
            const manualValue = $("pValue")?.value;

            if (!date || !patientId) return showAlert("‚ùå Selecione data e paciente", "error");

            const p = getPatientById(patientId);
            let value = manualValue ? parseMoney(manualValue) : (p?.defaultValue || 0);
            if (p?.serviceType === "cassems") value = 26;

            const session = {
                id: uid(),
                date, 
                patientId, 
                time,
                did: did,
                just: did === "nao" ? (just === "na" ? "nao_justificada" : just) : "na",
                paid, 
                value
            };

            sessions.push(session);

            if (p?.serviceType === "cassems") {
                tokens[session.id] = {
                    sessionId: session.id,
                    date: date,
                    patientName: p.name,
                    code: '',
                    status: 'pendente'
                };
            }

            $("pTime").value = "";
            $("pValue").value = "";
            
            renderAll();
            saveToDrive();
            showAlert("‚úÖ Sess√£o adicionada!", "success");
        };

        window.toggleSessionDid = async function(id) {
            const session = sessions.find(s => s.id === id);
            if (!session) return;
            
            session.did = session.did === "realizou" ? "nao" : "realizou";
            if (session.did === "nao" && !session.just) {
                session.just = "nao_justificada";
            }
            
            renderAll();
            saveToDrive();
            showAlert("‚úÖ Sess√£o atualizada!", "success");
        };

        window.toggleSessionPaid = async function(id) {
            const session = sessions.find(s => s.id === id);
            if (!session) return;
            
            session.paid = session.paid === "pago" ? "nao_pago" : "pago";
            
            renderAll();
            saveToDrive();
            showAlert("üí∞ Status de pagamento atualizado!", "success");
        };

        window.deleteSession = async function(id) {
            if (!confirm("Excluir esta sess√£o?")) return;
            
            sessions = sessions.filter(s => s.id !== id);
            delete tokens[id];
            
            renderAll();
            saveToDrive();
            showAlert("üóëÔ∏è Sess√£o exclu√≠da!", "success");
        };

        window.openTokenModal = function(sessionId, patientName, sessionDate) {
            currentTokenSessionId = sessionId;
            const token = tokens[sessionId];
            
            $("tokenDate").value = sessionDate;
            $("tokenPatient").value = patientName;
            $("tokenCode").value = token?.code || '';
            $("tokenStatus").value = token?.status || 'pendente';
            
            $("tokenModal").classList.remove("hidden");
        };

        window.saveToken = function() {
            if (!currentTokenSessionId) return;
            
            tokens[currentTokenSessionId] = {
                sessionId: currentTokenSessionId,
                date: $("tokenDate")?.value,
                patientName: $("tokenPatient")?.value,
                code: $("tokenCode")?.value,
                status: $("tokenStatus")?.value
            };
            
            $("tokenModal").classList.add("hidden");
            renderAll();
            saveToDrive();
            showAlert("‚úÖ Token registrado!", "success");
        };

        // ========== GERENCIAMENTO DE HOR√ÅRIOS ==========
        window.addTimeSlot = function() {
            const container = $("timeSlotsContainer");
            if (!container) return;
            
            const timeSlotHtml = `
                <div class="time-item">
                    <select class="time-slot-day" style="flex:1;">
                        <option value="">Dia</option>
                        <option value="0">Seg</option>
                        <option value="1">Ter</option>
                        <option value="2">Qua</option>
                        <option value="3">Qui</option>
                        <option value="4">Sex</option>
                        <option value="5">S√°b</option>
                        <option value="6">Dom</option>
                    </select>
                    <input type="time" class="time-slot-hour" placeholder="07:40" step="600" style="flex:1;" />
                    <button class="small icon-btn" onclick="removeTimeSlot(this)">‚úï</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', timeSlotHtml);
        };

        window.removeTimeSlot = function(btn) {
            btn.closest('.time-item')?.remove();
        };

        function getTimeSlots() {
            const slots = [];
            document.querySelectorAll('.time-item').forEach(item => {
                const day = item.querySelector('.time-slot-day')?.value;
                const hour = item.querySelector('.time-slot-hour')?.value;
                if (day && hour) {
                    slots.push({ day: parseInt(day), time: hour });
                }
            });
            return slots;
        }

        // ========== INICIALIZA√á√ÉO ==========
        function init() {
            renderApp();
            
            $("date").value = todayISO();
            $("schedRef").value = todayISO();
            $("today").innerHTML = new Date().toLocaleDateString("pt-BR", {
                weekday: "long", year: "numeric", month: "long", day: "numeric"
            });

            // Configurar modais
            $("cancelEvolucao")?.addEventListener("click", () => {
                $("evolucaoModal").classList.add("hidden");
            });

            $("saveEvolucao")?.addEventListener("click", saveEvolucao);

            $("cancelEditEvolucao")?.addEventListener("click", () => {
                $("editEvolucaoModal").classList.add("hidden");
                currentEvolucaoId = null;
            });

            $("saveEditEvolucao")?.addEventListener("click", saveEditEvolucao);

            $("cancelToken")?.addEventListener("click", () => {
                $("tokenModal").classList.add("hidden");
                currentTokenSessionId = null;
            });

            $("saveToken")?.addEventListener("click", saveToken);

            // Iniciar Google Drive
            initGoogleDrive();
            startAutoSave();
        }

        function renderApp() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <section id="appWrap">
                    <header>
                        <div class="logo-container">
                            <div class="logo-icon">GA</div>
                            <div class="logo-text">
                                <h2>${CLINIC_NAME}</h2>
                                <p>${CLINIC_SUBTITLE}</p>
                                <small>${CLINIC_CRFA}</small>
                            </div>
                        </div>

                        <div style="display:flex; align-items:center; gap:10px;">
                            <div id="today" class="muted"></div>
                            <button id="loginDrive" class="small" onclick="loginToDrive()">üîå Conectar Drive</button>
                        </div>

                        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                            <div class="backup-bar">
                                <span class="muted">üíæ Drive:</span>
                                <span id="driveStatus" class="drive-status offline"></span>
                                <button class="small" onclick="saveToDrive()">üíæ Salvar agora</button>
                            </div>

                            <div class="tabs">
                                <button class="tab active" id="tabDashboard" onclick="setTab('dashboard')">üìä Dashboard</button>
                                <button class="tab" id="tabDaily" onclick="setTab('daily')">üìÖ Di√°rio</button>
                                <button class="tab" id="tabPatients" onclick="setTab('patients')">üë• Pacientes</button>
                                <button class="tab" id="tabSchedule" onclick="setTab('schedule')">üìÜ Agendamento</button>
                            </div>
                        </div>
                    </header>

                    <main>
                        <!-- DASHBOARD -->
                        <section id="viewDashboard" class="card">
                            <h2>üìä Dashboard</h2>
                            <div class="dashboard-grid">
                                <div class="stat-card">
                                    <div>Pacientes Hoje</div>
                                    <div class="stat-value" id="dashHoje">0</div>
                                    <div class="muted" id="dashHojeDetalhe"></div>
                                </div>
                                <div class="stat-card">
                                    <div>Faturamento Hoje</div>
                                    <div class="stat-value" id="dashFaturamento">R$ 0</div>
                                    <div class="muted" id="dashFaturamentoDetalhe"></div>
                                </div>
                                <div class="stat-card">
                                    <div>Taxa de Faltas</div>
                                    <div class="stat-value" id="dashTaxaFaltas">0%</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="dashProgresso" style="width:0%"></div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div>Pacientes Ativos</div>
                                    <div class="stat-value" id="activePatients">0</div>
                                </div>
                            </div>
                        </section>

                        <!-- Di√°rio -->
                        <section id="viewDaily" class="card hidden">
                            <div class="row">
                                <div>
                                    <label>Data do atendimento</label>
                                    <input id="date" type="date" onchange="renderDaily()" />
                                </div>
                                <div>
                                    <label>Buscar paciente</label>
                                    <input id="search" placeholder="Nome..." oninput="renderDaily()" />
                                </div>
                            </div>

                            <div class="grid3" style="margin:15px 0;">
                                <div class="cardMini">
                                    <b>üé´ Pacientes Cassems</b>
                                    <div id="cassemsHoje" class="stat-value" style="font-size:1.5rem;">0</div>
                                </div>
                                <div class="cardMini">
                                    <b>‚úÖ Tokens Enviados</b>
                                    <div id="tokensEnviadosHoje" class="stat-value" style="font-size:1.5rem; color:#2C7A5A;">0</div>
                                </div>
                                <div class="cardMini">
                                    <b>‚è≥ Pendentes</b>
                                    <div id="tokensPendentesHoje" class="stat-value" style="font-size:1.5rem; color:#E8C66A;">0</div>
                                </div>
                            </div>

                            <hr>

                            <b>‚ûï Adicionar sess√£o</b>
                            <div class="grid2">
                                <div>
                                    <label>Paciente</label>
                                    <select id="pPatient"></select>
                                </div>
                                <div>
                                    <label>Hor√°rio</label>
                                    <input id="pTime" placeholder="14:30" />
                                </div>
                                <div>
                                    <label>Sess√£o</label>
                                    <select id="pDid">
                                        <option value="realizou">‚úÖ Realizou</option>
                                        <option value="nao">‚ùå N√£o realizou</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Justificativa</label>
                                    <select id="pJust">
                                        <option value="na">‚Äî</option>
                                        <option value="justificada">üìù Justificada</option>
                                        <option value="nao_justificada">‚ö†Ô∏è N√£o justificada</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Pagamento</label>
                                    <select id="pPaid">
                                        <option value="nao_pago">üí∏ N√£o pago</option>
                                        <option value="pago">üí∞ Pago</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Valor (R$)</label>
                                    <input id="pValue" placeholder="80,00" />
                                </div>
                            </div>

                            <div class="row">
                                <button id="addSession" class="primary" onclick="addSession()">‚ûï Adicionar</button>
                            </div>

                            <div class="list" id="dayList"></div>
                        </section>

                        <!-- Pacientes -->
                        <section id="viewPatients" class="card hidden">
                            <div class="split">
                                <div class="card">
                                    <b>üë§ Cadastro de Paciente</b>
                                    
                                    <div class="grid2" style="margin-top:15px;">
                                        <div>
                                            <label>Nome completo *</label>
                                            <input id="cName" placeholder="Jo√£o Silva" />
                                        </div>
                                        <div>
                                            <label>Data nascimento</label>
                                            <input id="cBirth" type="date" />
                                        </div>
                                        <div>
                                            <label>CPF</label>
                                            <input id="cCpf" placeholder="000.000.000-00" />
                                        </div>
                                        <div>
                                            <label>Respons√°vel</label>
                                            <input id="cResp" placeholder="Nome do respons√°vel" />
                                        </div>
                                        <div>
                                            <label>WhatsApp</label>
                                            <input id="cPhone" placeholder="67999999999" />
                                        </div>
                                        <div>
                                            <label>E-mail</label>
                                            <input id="cEmail" type="email" placeholder="paciente@email.com" />
                                        </div>
                                        <div>
                                            <label>Conv√™nio</label>
                                            <select id="cServiceType">
                                                <option value="particular">Particular</option>
                                                <option value="cassems">Cassems</option>
                                                <option value="unimed">Unimed</option>
                                                <option value="outros">Outros</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>Valor padr√£o (R$)</label>
                                            <input id="cDefaultValue" placeholder="80,00" />
                                        </div>
                                        <div>
                                            <label>Tipo de cobran√ßa</label>
                                            <select id="cBillingType">
                                                <option value="pack4">üì¶ Pacote 4 sess√µes</option>
                                                <option value="pack8">üì¶ Pacote 8 sess√µes</option>
                                                <option value="individual">üí≥ Individual</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>Frequ√™ncia semanal</label>
                                            <select id="cFrequency">
                                                <option value="1">1x por semana</option>
                                                <option value="2">2x por semana</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div style="margin-top:20px;">
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                            <label>Hor√°rios de atendimento</label>
                                            <button type="button" class="small primary" onclick="addTimeSlot()">‚ûï Adicionar hor√°rio</button>
                                        </div>
                                        <div id="timeSlotsContainer" class="time-list">
                                            <div class="time-item">
                                                <select class="time-slot-day" style="flex:1;">
                                                    <option value="">Dia</option>
                                                    <option value="0">Seg</option>
                                                    <option value="1">Ter</option>
                                                    <option value="2">Qua</option>
                                                    <option value="3">Qui</option>
                                                    <option value="4">Sex</option>
                                                    <option value="5">S√°b</option>
                                                    <option value="6">Dom</option>
                                                </select>
                                                <input type="time" class="time-slot-hour" placeholder="07:40" step="600" style="flex:1;" />
                                            </div>
                                        </div>
                                    </div>

                                    <label style="margin-top:20px;">Observa√ß√µes iniciais</label>
                                    <textarea id="cNotes" rows="2" placeholder="Observa√ß√µes relevantes..."></textarea>

                                    <div class="row" style="margin-top:15px;">
                                        <button id="addPatient" class="primary" onclick="addPatient()">üíæ Salvar paciente</button>
                                    </div>
                                </div>

                                <div class="card">
                                    <div id="foldersPane">
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                            <b>üìÅ Pastas</b>
                                            <div style="display:flex; gap:8px;">
                                                <input id="pSearch" placeholder="Buscar paciente..." style="width:200px;" oninput="renderPatientFolders()" />
                                                <button id="onlyDebtFolders" class="small" onclick="toggleDebtFilter()">üí∏ Com d√©bito</button>
                                            </div>
                                        </div>
                                        <div id="patientFolders" class="list"></div>
                                    </div>

                                    <div id="folderOpenPane" class="hidden">
                                        <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                                            <button id="backToFolders" class="small" onclick="closePatientFolder()">‚Üê Voltar</button>
                                            <div style="flex:1;">
                                                <b id="openPatientTitle">Paciente</b>
                                                <div class="muted" id="openPatientMeta"></div>
                                            </div>
                                        </div>

                                        <div id="pacoteProgresso"></div>
                                        <div id="folderTabs"></div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Agendamento -->
                        <section id="viewSchedule" class="card hidden">
                            <div class="row">
                                <div>
                                    <label>Data refer√™ncia</label>
                                    <input id="schedRef" type="date" onchange="renderSchedule()" />
                                </div>
                                <div>
                                    <label>Adicionar hor√°rio</label>
                                    <div style="display:flex; gap:8px;">
                                        <input id="newTime" placeholder="07:00" />
                                        <button id="addTime" class="small primary" onclick="addTime()">‚ûï</button>
                                    </div>
                                </div>
                            </div>

                            <div class="schedWrap">
                                <table class="sched" id="schedTable"></table>
                            </div>
                        </section>
                    </main>
                </section>

                <!-- Modais -->
                <div id="tokenModal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <h3>üé´ Registrar Token Cassems</h3>
                        
                        <div style="margin:15px 0;">
                            <label>Data da sess√£o</label>
                            <input type="date" id="tokenDate" readonly />
                        </div>
                        <div style="margin:15px 0;">
                            <label>Paciente</label>
                            <input type="text" id="tokenPatient" readonly />
                        </div>
                        <div style="margin:15px 0;">
                            <label>Token de autoriza√ß√£o</label>
                            <input type="text" id="tokenCode" placeholder="Ex: CASS-123456" />
                        </div>
                        <div style="margin:15px 0;">
                            <label>Status do token</label>
                            <select id="tokenStatus">
                                <option value="enviado">‚úÖ Enviado</option>
                                <option value="pendente">‚è≥ Pendente</option>
                                <option value="problema">‚ùå Problema no token</option>
                            </select>
                        </div>
                        
                        <div style="display:flex; gap:10px; justify-content:flex-end;">
                            <button id="cancelToken" class="small">Cancelar</button>
                            <button id="saveToken" class="primary small">Salvar Token</button>
                        </div>
                    </div>
                </div>
            `;
        }

        window.setTab = function(tab) {
            $("viewDashboard").classList.toggle("hidden", tab !== "dashboard");
            $("viewDaily").classList.toggle("hidden", tab !== "daily");
            $("viewPatients").classList.toggle("hidden", tab !== "patients");
            $("viewSchedule").classList.toggle("hidden", tab !== "schedule");

            [$("tabDashboard"), $("tabDaily"), $("tabPatients"), $("tabSchedule")].forEach(t => {
                if (t) t.classList.remove("active");
            });
            
            const activeTab = $(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            if (activeTab) activeTab.classList.add("active");
        };

        window.addTime = function() {
            const time = $("newTime")?.value.trim();
            if (!time) return;
            if (!/^\d{1,2}:\d{2}$/.test(time)) {
                return showAlert("‚ùå Formato inv√°lido. Use HH:MM", "error");
            }

            if (!schedule.times.includes(time)) {
                schedule.times.push(time);
                schedule.times.sort();
                renderSchedule();
                saveToDrive();
                showAlert(`‚úÖ Hor√°rio ${time} adicionado!`, "success");
            }
            $("newTime").value = "";
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
