<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ClÃ­nicaHub Pro â€” Sistema Completo</title>
  <style>
    :root{
      --bg:#0a0f1c; --card:#141b2b; --line:rgba(255,255,255,.12);
      --text:#e2eaff; --muted:#9aa9c7; --pri:#0ea5e9; --bad:#ef4444; --ok:#22c55e;
      --warn:#f59e0b; --info:#8b5cf6;
      --r:14px;
    }
    *{box-sizing:border-box; margin:0; padding:0;}
    body{
      margin:0; font-family:system-ui, -apple-system, 'Segoe UI', Roboto; 
      background:var(--bg); color:var(--text); line-height:1.5;
    }
    a{color:inherit}
    .hidden{display:none !important;}
    .muted{color:var(--muted); font-size:.92rem;}
    small.muted{color:var(--muted);}
    
    /* Cards e badges */
    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px; 
      border:1px solid var(--line); font-size:.85rem; margin-right:6px; margin-top:6px;
    }
    .pill.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.12);}
    .pill.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12);}
    .pill.info{border-color:rgba(139,92,246,.35); background:rgba(139,92,246,.12);}
    .pill.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.12);}
    .pill.pri{border-color:rgba(14,165,233,.35); background:rgba(14,165,233,.12);}

    /* BotÃµes */
    button{
      padding:12px 16px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); font-weight:600; 
      cursor:pointer; transition:.2s; font-size:.95rem;
    }
    button:hover{background:rgba(255,255,255,.12);}
    button.primary{
      border-color:rgba(14,165,233,.5); background:rgba(14,165,233,.25);
    }
    button.primary:hover{background:rgba(14,165,233,.35);}
    button.danger{
      border-color:rgba(239,68,68,.5); background:rgba(239,68,68,.18);
    }
    button.danger:hover{background:rgba(239,68,68,.28);}
    button.small{padding:8px 12px; font-size:.9rem;}

    /* FormulÃ¡rios */
    input, select, textarea{
      width:100%; padding:12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); outline:none;
      font-family:inherit; font-size:.95rem;
    }
    input:focus, select:focus, textarea:focus{
      border-color:rgba(14,165,233,.5); box-shadow:0 0 0 2px rgba(14,165,233,.2);
    }
    textarea{resize:vertical; min-height:80px;}
    label{display:block; margin:0 0 6px; color:var(--muted); font-size:.9rem;}
    hr{border:none; border-top:1px solid var(--line); margin:14px 0;}

    /* Layout principal */
    header{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:16px 24px; border-bottom:1px solid var(--line); flex-wrap:wrap;
      background:rgba(0,0,0,.2);
    }
    h1{margin:0; font-size:1.3rem; display:flex; align-items:center; gap:8px;}
    main{padding:20px; display:grid; gap:20px; max-width:1400px; margin:0 auto;}
    
    .card{
      background:var(--card); border:1px solid var(--line); 
      border-radius:var(--r); padding:18px;
    }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:end;}
    .row > *{flex:1 1 200px;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;}
    @media(max-width:900px){ .grid2{grid-template-columns:1fr;} }
    
    .sum{
      display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;
    }
    .sum .cardMini{
      flex:1 1 250px; border:1px solid var(--line); border-radius:14px; 
      padding:14px; background:rgba(255,255,255,.03);
    }
    
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      padding:10px 16px;
    }
    .tab.active{
      border-color:rgba(14,165,233,.45); background:rgba(14,165,233,.18);
    }
    
    .list{display:flex; flex-direction:column; gap:10px; margin-top:15px;}
    .item{
      border:1px solid var(--line); background:rgba(255,255,255,.03); 
      border-radius:14px; padding:15px;
    }
    .item:hover{background:rgba(255,255,255,.05);}
    .itemTop{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .actions{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;
    }
    .split{
      display:grid; grid-template-columns: 1fr 1.2fr; gap:15px;
    }
    @media(max-width:1000px){ .split{grid-template-columns:1fr;} }

    /* Backup bar */
    .backup-bar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      background:rgba(14,165,233,.1); border:1px solid rgba(14,165,233,.3);
      border-radius:40px; padding:8px 15px; margin-right:10px;
    }
    .backup-bar button{padding:6px 12px; background:rgba(255,255,255,.08);}

    /* Scheduler */
    .schedWrap{overflow:auto; border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.02);}
    table.sched{border-collapse:collapse; width:100%; min-width:900px;}
    .sched th, .sched td{border:1px solid rgba(255,255,255,.10); padding:12px; vertical-align:top;}
    .sched th{background:rgba(255,255,255,.04); position:sticky; top:0; z-index:2;}
    .sched td{min-width:160px; cursor:pointer;}
    .timeCell{position:sticky; left:0; z-index:1; background:rgba(255,255,255,.04); font-weight:800;}
    .slotBox{border-radius:10px; padding:12px;}
    .slotGreen{background:rgba(34,197,94,.15); border:1px solid rgba(34,197,94,.35);}
    .slotAmber{background:rgba(245,158,11,.15); border:1px solid rgba(245,158,11,.35);}
    .slotRed{background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.35);}
    .slotBlue{background:rgba(14,165,233,.15); border:1px solid rgba(14,165,233,.35);}
    .iconAlert{font-size:1.1rem; margin-right:5px;}

    /* Timeline */
    .timeline{
      border-left:2px solid var(--pri); margin-left:10px; padding-left:20px;
    }
    .timeline-item{
      border-left:2px solid var(--line); padding:15px; margin-bottom:15px;
      background:rgba(255,255,255,.02); border-radius:0 12px 12px 0;
    }
    .timeline-date{color:var(--pri); font-weight:600; margin-bottom:5px;}

    /* Modal */
    .modal-overlay{
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,.7); backdrop-filter:blur(3px);
      display:flex; align-items:center; justify-content:center; z-index:1000;
    }
    .modal-content{
      background:var(--card); border:1px solid var(--line);
      border-radius:20px; padding:25px; max-width:600px; width:90%;
      max-height:80vh; overflow-y:auto;
    }

    /* Alertas */
    .alert{
      padding:12px 16px; border-radius:12px; margin:10px 0;
      background:rgba(14,165,233,.15); border:1px solid rgba(14,165,233,.3);
    }
    .alert-success{background:rgba(34,197,94,.15); border-color:rgba(34,197,94,.3);}
    .alert-warning{background:rgba(245,158,11,.15); border-color:rgba(245,158,11,.3);}
    .alert-error{background:rgba(239,68,68,.15); border-color:rgba(239,68,68,.3);}
  </style>
</head>

<body>

<!-- Painel Principal -->
<section id="appWrap">
  <header>
    <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
      <h1>ğŸ¥ ClÃ­nicaHub Pro</h1>
      <div id="today" class="muted"></div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <!-- Barra de Backup -->
      <div class="backup-bar">
        <span class="muted">ğŸ’¾ Backup:</span>
        <button id="backupNow" class="small" title="Baixar backup agora">â¬‡ï¸ Baixar</button>
        <button id="restoreBackup" class="small" title="Restaurar de um arquivo">ğŸ“‚ Restaurar</button>
        <button id="autoBackupToggle" class="small pri">ğŸ”µ Auto: ON</button>
      </div>

      <div class="tabs">
        <button class="tab active" id="tabDaily">ğŸ“… DiÃ¡rio</button>
        <button class="tab" id="tabPatients">ğŸ‘¥ Pacientes</button>
        <button class="tab" id="tabSchedule">ğŸ“† Agendamento</button>
        <button class="tab" id="tabReports">ğŸ“Š RelatÃ³rios</button>
      </div>
    </div>
  </header>

  <main>
    <!-- DiÃ¡rio (igual antes, mas melhorado) -->
    <section id="viewDaily" class="card">
      <!-- ... conteÃºdo do diÃ¡rio (mantido igual) ... -->
      <div class="row">
        <div>
          <label>Data do atendimento</label>
          <input id="date" type="date"/>
        </div>
        <div>
          <label>Buscar paciente</label>
          <input id="search" placeholder="Nome..." />
        </div>
        <div style="display:flex; gap:8px;">
          <button id="findInDay" class="small primary">ğŸ” Procurar</button>
          <button id="clearDay" class="small danger">ğŸ—‘ï¸ Limpar dia</button>
        </div>
      </div>

      <div class="sum">
        <div class="cardMini">
          <b>Resumo do dia</b>
          <div class="muted" id="sumDay">â€”</div>
        </div>
        <div class="cardMini">
          <b>Financeiro</b>
          <div class="muted" id="sumMoney">â€”</div>
        </div>
        <div class="cardMini">
          <b>Faltas hoje</b>
          <div class="muted" id="sumAbsences">â€”</div>
        </div>
      </div>

      <hr>

      <b>â• Adicionar sessÃ£o</b>
      <div class="grid2">
        <div>
          <label>Paciente</label>
          <select id="pPatient"></select>
        </div>
        <div>
          <label>HorÃ¡rio</label>
          <input id="pTime" placeholder="14:30" />
        </div>
        <div>
          <label>SessÃ£o</label>
          <select id="pDid">
            <option value="realizou">âœ… Realizou</option>
            <option value="nao">âŒ NÃ£o realizou</option>
          </select>
        </div>
        <div>
          <label>Justificativa</label>
          <select id="pJust">
            <option value="na">â€”</option>
            <option value="justificada">ğŸ“ Justificada</option>
            <option value="nao_justificada">âš ï¸ NÃ£o justificada</option>
          </select>
        </div>
        <div>
          <label>Pagamento</label>
          <select id="pPaid">
            <option value="nao_pago">ğŸ’¸ NÃ£o pago</option>
            <option value="pago">ğŸ’° Pago</option>
          </select>
        </div>
        <div>
          <label>Valor (R$)</label>
          <input id="pValue" placeholder="80,00" />
          <small id="hintDefault" class="muted"></small>
        </div>
      </div>

      <div class="row">
        <button id="addSession" class="primary">â• Adicionar</button>
        <button id="resetAll" class="danger">âš ï¸ Zerar tudo</button>
      </div>

      <div class="list" id="dayList"></div>
    </section>

    <!-- Pacientes com HistÃ³rico de EvoluÃ§Ã£o -->
    <section id="viewPatients" class="card hidden">
      <div class="split">
        <!-- Cadastro -->
        <div class="card">
          <b>ğŸ‘¤ Cadastro de Paciente</b>
          <div class="grid2" style="margin-top:15px;">
            <div>
              <label>Nome completo *</label>
              <input id="cName" placeholder="JoÃ£o Silva" />
            </div>
            <div>
              <label>Data nascimento</label>
              <input id="cBirth" type="date" />
            </div>
            <div>
              <label>CPF</label>
              <input id="cCpf" placeholder="000.000.000-00" />
            </div>
            <div>
              <label>ResponsÃ¡vel</label>
              <input id="cResp" placeholder="Nome do responsÃ¡vel" />
            </div>
            <div>
              <label>WhatsApp</label>
              <input id="cPhone" placeholder="67999999999" />
            </div>
            <div>
              <label>E-mail</label>
              <input id="cEmail" type="email" placeholder="paciente@email.com" />
            </div>
            <div>
              <label>ConvÃªnio</label>
              <select id="cServiceType">
                <option value="particular">Particular</option>
                <option value="cassems">Cassems</option>
                <option value="unimed">Unimed</option>
                <option value="outros">Outros</option>
              </select>
            </div>
            <div>
              <label>Valor padrÃ£o (R$)</label>
              <input id="cDefaultValue" placeholder="80,00" />
            </div>
            <div>
              <label>Tipo de cobranÃ§a</label>
              <select id="cBillingType">
                <option value="pack4">ğŸ“¦ Pacote 4 sessÃµes</option>
                <option value="pack8">ğŸ“¦ Pacote 8 sessÃµes</option>
                <option value="individual">ğŸ’³ Individual</option>
              </select>
            </div>
            <div>
              <label>HorÃ¡rio fixo</label>
              <div style="display:flex; gap:8px;">
                <select id="cFixDay" style="flex:1;">
                  <option value="">Dia</option>
                  <option value="0">Seg</option>
                  <option value="1">Ter</option>
                  <option value="2">Qua</option>
                  <option value="3">Qui</option>
                  <option value="4">Sex</option>
                </select>
                <input id="cFixHour" placeholder="07:40" style="flex:1;" />
              </div>
            </div>
          </div>

          <label style="margin-top:15px;">ObservaÃ§Ãµes iniciais</label>
          <textarea id="cNotes" rows="2" placeholder="ObservaÃ§Ãµes relevantes..."></textarea>

          <div class="row" style="margin-top:15px;">
            <button id="addPatient" class="primary">ğŸ’¾ Salvar paciente</button>
          </div>
        </div>

        <!-- Pastas e HistÃ³rico -->
        <div class="card">
          <div id="foldersPane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
              <b>ğŸ“ Pastas</b>
              <div style="display:flex; gap:8px;">
                <input id="pSearch" placeholder="Buscar paciente..." style="width:200px;" />
                <button id="onlyDebtFolders" class="small">ğŸ’¸ Com dÃ©bito</button>
              </div>
            </div>
            <div id="patientFolders" class="list"></div>
          </div>

          <div id="folderOpenPane" class="hidden">
            <!-- CabeÃ§alho da pasta -->
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:15px;">
              <button id="backToFolders" class="small">â† Voltar</button>
              <div style="flex:1;">
                <b id="openPatientTitle">Paciente</b>
                <div class="muted" id="openPatientMeta"></div>
              </div>
              <div style="display:flex; gap:8px;">
                <button id="btnEvolucao" class="small primary">ğŸ“ˆ EvoluÃ§Ã£o</button>
                <button id="btnAnamnese" class="small info">ğŸ“‹ Anamnese</button>
                <button id="openWhats" class="small">ğŸ“± WhatsApp</button>
                <button id="renamePatient" class="small">âœï¸ Renomear</button>
                <button id="deletePatient" class="small danger">ğŸ—‘ï¸ Excluir</button>
              </div>
            </div>

            <!-- Abas da pasta -->
            <div style="display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid var(--line); padding-bottom:10px;">
              <button class="tab active" id="tabHistory">ğŸ“‹ HistÃ³rico</button>
              <button class="tab" id="tabEvolution">ğŸ“ˆ EvoluÃ§Ã£o</button>
              <button class="tab" id="tabGoals">ğŸ¯ Metas</button>
              <button class="tab" id="tabFiles">ğŸ“ Arquivos</button>
            </div>

            <!-- ConteÃºdo das abas -->
            <div id="tabHistoryContent">
              <div class="sum">
                <div class="cardMini"><b>Resumo</b><div id="patientSummary" class="muted">â€”</div></div>
                <div class="cardMini"><b>Filtros</b><div id="filterLabel">Todos</div></div>
              </div>

              <div style="margin:15px 0;">
                <b>Ano</b>
                <div class="actions" id="yearButtons"></div>
                <b style="margin-top:10px; display:block;">MÃªs</b>
                <div class="actions" id="monthButtons"></div>
              </div>

              <div class="list" id="patientHistory"></div>
            </div>

            <div id="tabEvolutionContent" class="hidden">
              <div style="margin-bottom:15px;">
                <b>ğŸ“ˆ HistÃ³rico de EvoluÃ§Ã£o</b>
                <button id="addEvolucao" class="small primary" style="float:right;">â• Nova evoluÃ§Ã£o</button>
              </div>
              <div id="evolutionList" class="timeline"></div>
            </div>

            <div id="tabGoalsContent" class="hidden">
              <div style="margin-bottom:15px;">
                <b>ğŸ¯ Metas TerapÃªuticas</b>
                <button id="addMeta" class="small primary" style="float:right;">â• Nova meta</button>
              </div>
              <div id="goalsList" class="list"></div>
            </div>

            <div id="tabFilesContent" class="hidden">
              <div style="margin-bottom:15px;">
                <b>ğŸ“ Arquivos do Paciente</b>
                <button id="uploadFile" class="small primary" style="float:right;">ğŸ“¤ Upload</button>
              </div>
              <div id="filesList" class="list"></div>
            </div>

            <!-- Modal Anamnese (mantido) -->
            <div id="anamneseModal" class="hidden" style="margin-top:20px;">
              <!-- ... conteÃºdo da anamnese igual ... -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Agendamento Melhorado -->
    <section id="viewSchedule" class="card hidden">
      <div class="row">
        <div>
          <label>Data referÃªncia</label>
          <input id="schedRef" type="date" />
        </div>
        <div>
          <label>Adicionar horÃ¡rio</label>
          <div style="display:flex; gap:8px;">
            <input id="newTime" placeholder="07:00" />
            <button id="addTime" class="small primary">â•</button>
          </div>
        </div>
        <div>
          <label>Visualizar</label>
          <select id="schedView">
            <option value="week">ğŸ“… Semanal</option>
            <option value="month">ğŸ“† Mensal</option>
          </select>
        </div>
      </div>

      <div class="schedWrap">
        <table class="sched" id="schedTable"></table>
      </div>

      <div class="muted" style="margin-top:15px; padding:10px; background:rgba(255,255,255,.03); border-radius:12px;">
        <span class="pill ok">ğŸŸ¢ Cassems</span>
        <span class="pill warn">ğŸŸ¡ Particular</span>
        <span class="pill info">ğŸŸ£ Unimed/Outros</span>
        <span class="pill bad">ğŸ”´ Vago</span>
        <span class="pill">âš ï¸ Falta 1</span>
        <span class="pill">ğŸ Ãšltima</span>
      </div>
    </section>

    <!-- RelatÃ³rios -->
    <section id="viewReports" class="card hidden">
      <h2 style="margin-bottom:20px;">ğŸ“Š RelatÃ³rios e EstatÃ­sticas</h2>
      
      <div class="grid2">
        <div class="cardMini">
          <b>Resumo do MÃªs</b>
          <div id="monthSummary" class="muted" style="margin-top:10px;">Carregando...</div>
        </div>
        <div class="cardMini">
          <b>Taxa de Faltas</b>
          <div id="absenceRate" class="muted" style="margin-top:10px;">Carregando...</div>
        </div>
        <div class="cardMini">
          <b>Faturamento</b>
          <div id="revenueStats" class="muted" style="margin-top:10px;">Carregando...</div>
        </div>
        <div class="cardMini">
          <b>Pacientes Ativos</b>
          <div id="activePatients" class="muted" style="margin-top:10px;">Carregando...</div>
        </div>
      </div>

      <div style="margin-top:20px;">
        <b>Pacientes com maior dÃ©bito</b>
        <div id="topDebtors" class="list" style="margin-top:10px;"></div>
      </div>

      <div style="margin-top:20px; display:flex; gap:10px;">
        <button id="exportPDF" class="primary">ğŸ“„ Exportar PDF</button>
        <button id="exportExcel" class="primary">ğŸ“Š Exportar Excel</button>
      </div>
    </section>
  </main>
</section>

<!-- Modal de Backup/Restore -->
<div id="backupModal" class="modal-overlay hidden">
  <div class="modal-content">
    <h3 style="margin-bottom:15px;">ğŸ’¾ Restaurar Backup</h3>
    <p class="muted">Selecione um arquivo de backup (.json) para restaurar. Isso substituirÃ¡ todos os dados atuais.</p>
    <input type="file" id="backupFile" accept=".json" style="margin:15px 0;" />
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button id="cancelBackup" class="small">Cancelar</button>
      <button id="confirmRestore" class="danger small">Restaurar</button>
    </div>
  </div>
</div>

<!-- Modal de EvoluÃ§Ã£o -->
<div id="evolucaoModal" class="modal-overlay hidden">
  <div class="modal-content">
    <h3>ğŸ“ˆ Nova EvoluÃ§Ã£o</h3>
    <div style="margin:15px 0;">
      <label>Data</label>
      <input type="date" id="evoDate" />
    </div>
    <div style="margin:15px 0;">
      <label>EvoluÃ§Ã£o do paciente</label>
      <textarea id="evoText" rows="4" placeholder="Descreva a evoluÃ§Ã£o, observaÃ§Ãµes, dificuldades..."></textarea>
    </div>
    <div style="margin:15px 0;">
      <label>Meta trabalhada</label>
      <select id="evoGoal">
        <option value="">â€” Selecione uma meta â€”</option>
      </select>
    </div>
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button id="cancelEvo" class="small">Cancelar</button>
      <button id="saveEvo" class="primary small">Salvar</button>
    </div>
  </div>
</div>

<!-- Modal de Meta -->
<div id="metaModal" class="modal-overlay hidden">
  <div class="modal-content">
    <h3>ğŸ¯ Nova Meta</h3>
    <div style="margin:15px 0;">
      <label>DescriÃ§Ã£o da meta</label>
      <input type="text" id="metaDesc" placeholder="Ex: Produzir som de /r/ em palavras" />
    </div>
    <div style="margin:15px 0;">
      <label>Prazo</label>
      <input type="date" id="metaPrazo" />
    </div>
    <div style="margin:15px 0;">
      <label>Status</label>
      <select id="metaStatus">
        <option value="em_andamento">â³ Em andamento</option>
        <option value="concluida">âœ… ConcluÃ­da</option>
        <option value="cancelada">âŒ Cancelada</option>
      </select>
    </div>
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button id="cancelMeta" class="small">Cancelar</button>
      <button id="saveMeta" class="primary small">Salvar</button>
    </div>
  </div>
</div>

<script>
  // ========== CONFIGURAÃ‡Ã•ES E UTILITÃRIOS ==========
  const KEYS = {
    PATIENTS: "clinica_pro_patients",
    SESSIONS: "clinica_pro_sessions",
    SCHEDULE: "clinica_pro_schedule",
    EVOLUTION: "clinica_pro_evolution",
    GOALS: "clinica_pro_goals",
    FILES: "clinica_pro_files",
    BACKUP: "clinica_pro_backup"
  };

  const DAYS = ["Seg", "Ter", "Qua", "Qui", "Sex", "SÃ¡b", "Dom"];
  const MONTHS = [
    "Jan", "Fev", "Mar", "Abr", "Mai", "Jun",
    "Jul", "Ago", "Set", "Out", "Nov", "Dez"
  ];

  let autoBackup = localStorage.getItem("autoBackup") !== "false";
  let openedPatientId = null;

  const $ = id => document.getElementById(id);

  // ========== FUNÃ‡Ã•ES ÃšTEIS ==========
  function uid() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }

  function todayISO() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function parseMoney(val) {
    if (!val) return 0;
    return Number(String(val).replace(/\./g, "").replace(",", ".")) || 0;
  }

  function fmtMoney(val) {
    return Number(val || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  function escapeHtml(str) {
    return String(str || "")
      .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }

  // ========== PERSISTÃŠNCIA COM BACKUP AUTOMÃTICO ==========
  function saveData(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
    if (autoBackup && key !== KEYS.BACKUP) {
      createAutoBackup();
    }
  }

  function loadData(key, defaultValue = null) {
    try {
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : defaultValue;
    } catch {
      return defaultValue;
    }
  }

  // ========== BACKUP ==========
  function createBackup() {
    const backup = {
      version: "1.0",
      date: new Date().toISOString(),
      data: {
        patients: loadData(KEYS.PATIENTS, []),
        sessions: loadData(KEYS.SESSIONS, []),
        schedule: loadData(KEYS.SCHEDULE, { times: defaultTimes(), recurring: {} }),
        evolution: loadData(KEYS.EVOLUTION, {}),
        goals: loadData(KEYS.GOALS, {})
      }
    };
    return backup;
  }

  function createAutoBackup() {
    const backups = loadData(KEYS.BACKUP, []);
    const newBackup = createBackup();
    backups.unshift(newBackup);
    if (backups.length > 10) backups.pop(); // mantÃ©m sÃ³ os 10 Ãºltimos
    saveData(KEYS.BACKUP, backups);
  }

  function downloadBackup() {
    const backup = createBackup();
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `clinica_backup_${todayISO()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function restoreFromFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const backup = JSON.parse(e.target.result);
        if (backup.version && backup.data) {
          saveData(KEYS.PATIENTS, backup.data.patients || []);
          saveData(KEYS.SESSIONS, backup.data.sessions || []);
          saveData(KEYS.SCHEDULE, backup.data.schedule || { times: defaultTimes(), recurring: {} });
          saveData(KEYS.EVOLUTION, backup.data.evolution || {});
          saveData(KEYS.GOALS, backup.data.goals || {});
          
          alert("âœ… Backup restaurado com sucesso!");
          location.reload();
        } else {
          alert("âŒ Arquivo de backup invÃ¡lido");
        }
      } catch (err) {
        alert("âŒ Erro ao ler o arquivo");
      }
    };
    reader.readAsText(file);
  }

  // ========== PACIENTES ==========
  function loadPatients() { return loadData(KEYS.PATIENTS, []); }
  function savePatients(p) { saveData(KEYS.PATIENTS, p); }

  function getPatientById(id) {
    return loadPatients().find(p => p.id === id);
  }

  // ========== SESSÃ•ES ==========
  function loadSessions() { return loadData(KEYS.SESSIONS, []); }
  function saveSessions(s) { saveData(KEYS.SESSIONS, s); }

  // ========== EVOLUÃ‡ÃƒO ==========
  function loadEvolutions(patientId) {
    const all = loadData(KEYS.EVOLUTION, {});
    return all[patientId] || [];
  }

  function saveEvolution(patientId, evolutions) {
    const all = loadData(KEYS.EVOLUTION, {});
    all[patientId] = evolutions;
    saveData(KEYS.EVOLUTION, all);
  }

  function addEvolution(patientId, data) {
    const evos = loadEvolutions(patientId);
    evos.push({
      id: uid(),
      date: data.date || todayISO(),
      text: data.text,
      goalId: data.goalId,
      createdAt: new Date().toISOString()
    });
    evos.sort((a, b) => b.date.localeCompare(a.date));
    saveEvolution(patientId, evos);
  }

  // ========== METAS ==========
  function loadGoals(patientId) {
    const all = loadData(KEYS.GOALS, {});
    return all[patientId] || [];
  }

  function saveGoals(patientId, goals) {
    const all = loadData(KEYS.GOALS, {});
    all[patientId] = goals;
    saveData(KEYS.GOALS, all);
  }

  function addGoal(patientId, goal) {
    const goals = loadGoals(patientId);
    goals.push({
      id: uid(),
      description: goal.description,
      deadline: goal.deadline,
      status: goal.status || "em_andamento",
      createdAt: new Date().toISOString()
    });
    saveGoals(patientId, goals);
  }

  // ========== AGENDA ==========
  function loadSchedule() {
    return loadData(KEYS.SCHEDULE, { times: defaultTimes(), recurring: {} });
  }
  function saveSchedule(s) { saveData(KEYS.SCHEDULE, s); }

  function defaultTimes() {
    return ["07:00","07:40","08:20","09:00","09:40","10:20","11:00","13:20","14:00","14:40","15:20","16:00","16:40","17:20"];
  }

  // ========== RELATÃ“RIOS ==========
  function generateReports() {
    const sessions = loadSessions();
    const patients = loadPatients();
    const today = todayISO();
    const currentMonth = today.slice(0, 7);
    
    const monthSessions = sessions.filter(s => s.date.startsWith(currentMonth));
    const realizacoes = monthSessions.filter(s => s.did === "realizou");
    const faltas = monthSessions.filter(s => s.did === "nao");
    const faturamento = realizacoes.reduce((sum, s) => sum + (Number(s.value) || 0), 0);
    const aReceber = monthSessions.filter(s => s.paid !== "pago").reduce((sum, s) => sum + (Number(s.value) || 0), 0);
    
    $("monthSummary").innerHTML = `
      SessÃµes: ${monthSessions.length}<br>
      Realizadas: ${realizacoes.length}<br>
      Faltas: ${faltas.length}
    `;
    
    $("absenceRate").innerHTML = monthSessions.length ? 
      `${((faltas.length / monthSessions.length) * 100).toFixed(1)}%` : "0%";
    
    $("revenueStats").innerHTML = `
      Faturado: ${fmtMoney(faturamento)}<br>
      A receber: ${fmtMoney(aReceber)}
    `;
    
    $("activePatients").innerHTML = patients.length.toString();

    // Top devedores
    const debtors = patients.map(p => {
      const patientSessions = sessions.filter(s => s.patientId === p.id && s.paid !== "pago");
      const debt = patientSessions.reduce((sum, s) => sum + (Number(s.value) || 0), 0);
      return { name: p.name, debt };
    }).filter(d => d.debt > 0).sort((a, b) => b.debt - a.debt).slice(0, 5);

    $("topDebtors").innerHTML = debtors.length ? debtors.map(d => `
      <div class="item">
        <b>${escapeHtml(d.name)}</b>
        <div class="muted">DÃ©bito: ${fmtMoney(d.debt)}</div>
      </div>
    `).join("") : "<div class='muted'>Nenhum devedor</div>";
  }

  // ========== INICIALIZAÃ‡ÃƒO ==========
  function init() {
    // Configurar data atual
    $("date").value = todayISO();
    $("schedRef").value = todayISO();
    $("today").textContent = new Date().toLocaleDateString("pt-BR", { 
      weekday: "long", year: "numeric", month: "long", day: "numeric" 
    });

    // BotÃµes de backup
    $("backupNow").addEventListener("click", downloadBackup);
    $("restoreBackup").addEventListener("click", () => {
      $("backupModal").classList.remove("hidden");
    });
    $("cancelBackup").addEventListener("click", () => {
      $("backupModal").classList.add("hidden");
    });
    $("confirmRestore").addEventListener("click", () => {
      const file = $("backupFile").files[0];
      if (file) {
        restoreFromFile(file);
        $("backupModal").classList.add("hidden");
      }
    });
    
    $("autoBackupToggle").addEventListener("click", () => {
      autoBackup = !autoBackup;
      localStorage.setItem("autoBackup", autoBackup);
      $("autoBackupToggle").innerHTML = autoBackup ? "ğŸ”µ Auto: ON" : "âšª Auto: OFF";
    });

    // Tabs
    $("tabDaily").addEventListener("click", () => setTab("daily"));
    $("tabPatients").addEventListener("click", () => setTab("patients"));
    $("tabSchedule").addEventListener("click", () => { setTab("schedule"); renderSchedule(); });
    $("tabReports").addEventListener("click", () => { setTab("reports"); generateReports(); });

    // Carregar dados iniciais
    renderPatientSelect();
    renderDaily();
    renderPatientFolders();
    renderSchedule();

    // Backup automÃ¡tico ao sair
    window.addEventListener("beforeunload", () => {
      if (autoBackup) createAutoBackup();
    });
  }

  function setTab(tab) {
    $("viewDaily").classList.toggle("hidden", tab !== "daily");
    $("viewPatients").classList.toggle("hidden", tab !== "patients");
    $("viewSchedule").classList.toggle("hidden", tab !== "schedule");
    $("viewReports").classList.toggle("hidden", tab !== "reports");
    
    [$("tabDaily"), $("tabPatients"), $("tabSchedule"), $("tabReports")].forEach(t => 
      t.classList.remove("active")
    );
    $(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add("active");
  }

  // ========== FUNÃ‡Ã•ES EXISTENTES (adaptadas) ==========
  function renderPatientSelect() {
    const pats = loadPatients();
    const sel = $("pPatient");
    sel.innerHTML = pats.length ? 
      pats.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("") :
      `<option value="">(Cadastre pacientes)</option>`;
  }

  function renderDaily() {
    // ... (manter implementaÃ§Ã£o original do diÃ¡rio)
    // Por brevidade, mantive o cÃ³digo original, mas adaptei para usar as novas funÃ§Ãµes
    const date = $("date").value;
    const search = $("search").value.toLowerCase();
    const sessions = loadSessions().filter(s => s.date === date);
    
    const list = $("dayList");
    list.innerHTML = sessions.map(s => {
      const p = getPatientById(s.patientId);
      return `
        <div class="item">
          <div><b>${s.time || ""} - ${escapeHtml(p?.name || "?")}</b></div>
          <div class="muted">${s.did === "realizou" ? "âœ…" : "âŒ"} ${s.paid === "pago" ? "ğŸ’°" : "ğŸ’¸"}</div>
        </div>
      `;
    }).join("") || "<div class='muted'>Nenhuma sessÃ£o</div>";
    
    // Atualizar resumos
    $("sumDay").innerHTML = `Total: ${sessions.length}`;
    $("sumMoney").innerHTML = `Total: ${fmtMoney(sessions.reduce((s, r) => s + (Number(r.value)||0), 0))}`;
    $("sumAbsences").innerHTML = sessions.filter(s => s.did === "nao").length.toString();
  }

  function renderPatientFolders() {
    const pats = loadPatients();
    const container = $("patientFolders");
    container.innerHTML = pats.map(p => `
      <div class="item" onclick="openPatientFolder('${p.id}')">
        <b>${escapeHtml(p.name)}</b>
        <div class="muted">${p.serviceType || "Particular"}</div>
      </div>
    `).join("") || "<div class='muted'>Nenhum paciente</div>";
  }

 // ========== FUNÃ‡Ã•ES DO AGENDAMENTO COMPLETAS ==========

// FunÃ§Ã£o auxiliar para calcular a data da prÃ³xima ocorrÃªncia
function nextDateFrom(refISO, targetDayIndex) {
    const d = new Date(refISO + "T00:00:00");
    const currentDay = d.getDay(); // 0 Dom, 1 Seg, ... 6 SÃ¡b
    // Converter para nosso formato (0=Seg, 6=Dom)
    let currentIdx = currentDay === 0 ? 6 : currentDay - 1;
    
    let diff = targetDayIndex - currentIdx;
    if (diff < 0) diff += 7;
    
    d.setDate(d.getDate() + diff);
    return d.toISOString().split('T')[0];
}

// Contar sessÃµes realizadas desde uma data
function realizedCountSince(patientId, startISO) {
    return loadSessions().filter(s => 
        s.patientId === patientId && 
        s.did === "realizou" && 
        s.date >= startISO
    ).length;
}

// Calcular sessÃµes restantes
function remainingFor(entry) {
    if (!entry) return 0;
    const realized = realizedCountSince(entry.patientId, entry.startDate);
    const total = Number(entry.plannedTotal || 0);
    return Math.max(0, total - realized);
}

// Gerar chave do agendamento
function recurKey(dayIndex, time) {
    return `${dayIndex}|${time}`;
}

// Obter cor baseada no convÃªnio
function getServiceColor(serviceType) {
    const colors = {
        'cassems': 'slotGreen',
        'particular': 'slotAmber',
        'unimed': 'slotBlue',
        'outros': 'slotBlue'
    };
    return colors[serviceType] || 'slotAmber';
}

// Obter label do convÃªnio
function getServiceLabel(serviceType) {
    const labels = {
        'cassems': 'Cassems',
        'particular': 'Particular',
        'unimed': 'Unimed',
        'outros': 'Outros'
    };
    return labels[serviceType] || serviceType;
}

// FunÃ§Ã£o principal para renderizar a agenda
function renderSchedule() {
    const sch = loadSchedule();
    const pats = loadPatients();
    const ref = $("schedRef").value || todayISO();
    const view = $("schedView")?.value || "week";

    // Garantir que times existe
    if (!sch.times) sch.times = defaultTimes();
    if (!sch.recurring) sch.recurring = {};

    const times = [...sch.times].sort((a, b) => a.localeCompare(b));
    const table = $("schedTable");

    let html = "<thead><tr><th class='timeCell'>HorÃ¡rio</th>";

    // CabeÃ§alho com os dias da semana
    for (let d = 0; d < 7; d++) {
        // Calcular a data real para cada dia baseado na referÃªncia
        const dateStr = nextDateFrom(ref, d);
        const [year, month, day] = dateStr.split('-');
        html += `<th>${DAYS[d]}<br><small class="muted">${day}/${month}</small></th>`;
    }
    html += "</tr></thead><tbody>";

    // Para cada horÃ¡rio
    for (const time of times) {
        html += `<tr><td class="timeCell">${escapeHtml(time)}</td>`;

        // Para cada dia da semana
        for (let day = 0; day < 7; day++) {
            const key = recurKey(day, time);
            const entry = sch.recurring?.[key] || null;
            
            // Calcular a data real para este dia/horÃ¡rio
            const sessionDate = nextDateFrom(ref, day);

            if (!entry) {
                // HorÃ¡rio vago
                html += `<td data-day="${day}" data-time="${escapeHtml(time)}" data-date="${sessionDate}">
                    <div class="slotBox slotRed" style="min-height: 80px;">
                        <div class="slotEmpty">ğŸŸ¢ VAGO</div>
                        <div class="slotMeta muted" style="margin-top: 8px;">Clique para agendar</div>
                    </div>
                </td>`;
            } else {
                // HorÃ¡rio ocupado
                const patient = getPatientById(entry.patientId);
                if (!patient) {
                    // Paciente nÃ£o existe mais, limpar o slot
                    delete sch.recurring[key];
                    saveSchedule(sch);
                    html += `<td data-day="${day}" data-time="${escapeHtml(time)}" data-date="${sessionDate}">
                        <div class="slotBox slotRed">ğŸ”„ Remover</div>
                    </td>`;
                    continue;
                }

                const serviceType = entry.serviceType || patient.serviceType || 'particular';
                const colorClass = getServiceColor(serviceType);
                const serviceLabel = getServiceLabel(serviceType);
                
                // Calcular progresso do pacote
                const realized = realizedCountSince(entry.patientId, entry.startDate);
                const total = Number(entry.plannedTotal || 0);
                const remaining = Math.max(0, total - realized);
                
                // Verificar se esta sessÃ£o especÃ­fica jÃ¡ foi realizada
                const sessionDone = loadSessions().some(s => 
                    s.patientId === entry.patientId && 
                    s.date === sessionDate && 
                    s.time === time &&
                    s.did === "realizou"
                );

                // Ãcones de status
                let statusIcon = '';
                if (sessionDone) {
                    statusIcon = 'âœ… ';
                } else if (remaining === 1) {
                    statusIcon = 'âš ï¸ ';
                } else if (remaining === 0) {
                    statusIcon = 'ğŸ ';
                }

                // Calcular prÃ³ximas sessÃµes (para pacotes)
                let nextSessions = '';
                if (total > 1 && remaining > 0) {
                    const nextDates = [];
                    let nextDate = sessionDate;
                    for (let i = 0; i < Math.min(3, remaining); i++) {
                        if (i > 0) {
                            nextDate = nextDateFrom(addDays(nextDate, 1), day);
                        }
                        const [y, m, d] = nextDate.split('-');
                        nextDates.push(`${d}/${m}`);
                    }
                    if (nextDates.length) {
                        nextSessions = `<div class="slotNext">PrÃ³x: ${nextDates.join(' â€¢ ')}</div>`;
                    }
                }

                html += `<td data-day="${day}" data-time="${escapeHtml(time)}" data-date="${sessionDate}" data-patient="${patient.id}">
                    <div class="slotBox ${colorClass}" style="min-height: 80px; cursor: pointer;">
                        <div class="slotName">
                            ${statusIcon}${escapeHtml(patient.name)}
                        </div>
                        <div class="slotMeta">
                            ${serviceLabel}
                            ${total > 1 ? ` â€¢ ${realized}/${total}` : ''}
                        </div>
                        ${nextSessions}
                        <div class="slotMeta muted" style="margin-top: 5px; font-size: 0.8rem;">
                            ğŸ“… ${sessionDate.split('-').reverse().join('/')}
                        </div>
                    </div>
                </td>`;
            }
        }
        html += "</tr>";
    }
    html += "</tbody>";
    
    table.innerHTML = html;

    // Adicionar eventos de clique nas cÃ©lulas
    table.querySelectorAll("td[data-day]").forEach(td => {
        td.addEventListener("click", async (e) => {
            // NÃ£o abrir se clicou em algum botÃ£o dentro da cÃ©lula
            if (e.target.tagName === 'BUTTON') return;
            
            const day = Number(td.dataset.day);
            const time = td.dataset.time;
            const date = td.dataset.date;
            const currentPatientId = td.dataset.patient;

            await handleScheduleClick(day, time, date, currentPatientId);
        });
    });
}

// Manipular clique na agenda
async function handleScheduleClick(day, time, date, currentPatientId) {
    const sch = loadSchedule();
    const key = recurKey(day, time);
    const currentEntry = sch.recurring?.[key];
    const patients = loadPatients();

    if (currentPatientId) {
        // JÃ¡ tem paciente - perguntar o que fazer
        const action = prompt(
            `HorÃ¡rio ocupado por: ${getPatientById(currentPatientId)?.name}\n\n` +
            `OpÃ§Ãµes:\n` +
            `1 - Remover paciente\n` +
            `2 - Substituir paciente\n` +
            `3 - Cancelar\n\n` +
            `Digite 1, 2 ou 3:`,
            "3"
        );

        if (action === "1") {
            // Remover
            if (confirm("Remover este paciente do horÃ¡rio?")) {
                delete sch.recurring[key];
                saveSchedule(sch);
                renderSchedule();
            }
        } else if (action === "2") {
            // Substituir - vai para o fluxo de novo agendamento
            await scheduleNewPatient(day, time, date, sch, key, patients);
        }
    } else {
        // Vago - agendar novo paciente
        await scheduleNewPatient(day, time, date, sch, key, patients);
    }
}

// Agendar novo paciente
async function scheduleNewPatient(day, time, date, sch, key, patients) {
    // Mostrar lista de pacientes para escolher
    const patientList = patients.map((p, i) => `${i + 1} - ${p.name}`).join('\n');
    const choice = prompt(
        `Agendar para ${DAYS[day]} ${time}\nData: ${date}\n\n` +
        `Digite o NÃšMERO do paciente:\n\n${patientList}\n\n` +
        `Ou 0 para cancelar:`,
        "0"
    );

    if (!choice || choice === "0") return;

    const index = Number(choice) - 1;
    if (index >= 0 && index < patients.length) {
        const patient = patients[index];
        
        // Perguntar tipo de atendimento
        const serviceType = prompt(
            `Tipo de atendimento para ${patient.name}:\n` +
            `1 - Particular\n` +
            `2 - Cassems\n` +
            `3 - Unimed\n` +
            `4 - Outros\n\n` +
            `Digite 1, 2, 3 ou 4:`,
            patient.serviceType === 'cassems' ? '2' : '1'
        );

        let selectedService = 'particular';
        if (serviceType === '2') selectedService = 'cassems';
        else if (serviceType === '3') selectedService = 'unimed';
        else if (serviceType === '4') selectedService = 'outros';

        // Perguntar tipo de pacote
        const packageType = prompt(
            `Tipo de cobranÃ§a:\n` +
            `1 - Individual (avulso)\n` +
            `2 - Pacote 4 sessÃµes\n` +
            `3 - Pacote 8 sessÃµes\n\n` +
            `Digite 1, 2 ou 3:`,
            patient.billingType === 'pack4' ? '2' : 
            patient.billingType === 'pack8' ? '3' : '1'
        );

        let plannedTotal = 1;
        let billingType = 'individual';
        if (packageType === '2') {
            plannedTotal = 4;
            billingType = 'pack4';
        } else if (packageType === '3') {
            plannedTotal = 8;
            billingType = 'pack8';
        }

        // Atualizar o paciente com as novas configuraÃ§Ãµes
        const patientsList = loadPatients();
        const patientIndex = patientsList.findIndex(p => p.id === patient.id);
        if (patientIndex >= 0) {
            patientsList[patientIndex].serviceType = selectedService;
            patientsList[patientIndex].billingType = billingType;
            if (selectedService === 'cassems') {
                patientsList[patientIndex].defaultValue = 26;
            }
            savePatients(patientsList);
        }

        // Criar entrada na agenda
        sch.recurring = sch.recurring || {};
        sch.recurring[key] = {
            patientId: patient.id,
            serviceType: selectedService,
            startDate: date,
            plannedTotal: plannedTotal
        };

        // Adicionar o horÃ¡rio Ã  lista se nÃ£o existir
        if (!sch.times.includes(time)) {
            sch.times.push(time);
            sch.times.sort();
        }

        saveSchedule(sch);
        
        // Perguntar se quer criar a primeira sessÃ£o
        if (confirm(`Criar primeira sessÃ£o para ${patient.name} no dia ${date}?`)) {
            const sessions = loadSessions();
            sessions.push({
                id: uid(),
                date: date,
                patientId: patient.id,
                time: time,
                did: "realizou",
                just: "na",
                paid: "nao_pago",
                value: selectedService === 'cassems' ? 26 : (patient.defaultValue || 0)
            });
            saveSessions(sessions);
        }

        renderSchedule();
        alert(`âœ… ${patient.name} agendado para ${DAYS[day]} ${time}`);
    }
}

// FunÃ§Ã£o auxiliar para adicionar dias a uma data
function addDays(dateStr, days) {
    const d = new Date(dateStr + "T00:00:00");
    d.setDate(d.getDate() + days);
    return d.toISOString().split('T')[0];
}

// Atualizar o event listener do botÃ£o de adicionar horÃ¡rio
$("addTime").addEventListener("click", () => {
    const t = $("newTime").value.trim();
    if (!t) return;
    
    if (!/^\d{1,2}:\d{2}$/.test(t)) {
        alert("Use formato HH:MM (ex: 07:00)");
        return;
    }
    
    const sch = loadSchedule();
    if (!sch.times) sch.times = [];
    if (!sch.times.includes(t)) {
        sch.times.push(t);
        sch.times.sort();
        saveSchedule(sch);
        renderSchedule();
    }
    $("newTime").value = "";
});

// Resetar horÃ¡rios
$("resetTimes").addEventListener("click", () => {
    if (confirm("Zerar todos os horÃ¡rios? Isso nÃ£o afeta os pacientes cadastrados.")) {
        const sch = loadSchedule();
        sch.times = defaultTimes();
        sch.recurring = {};
        saveSchedule(sch);
        renderSchedule();
    }
});

// Atualizar quando mudar a data de referÃªncia
$("schedRef").addEventListener("change", renderSchedule);

// Atualizar quando mudar a visualizaÃ§Ã£o
if ($("schedView")) {
    $("schedView").addEventListener("change", renderSchedule);
}
