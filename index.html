<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Cl√≠nicaHub Ultra ‚Äî PC & iPad</title>
  
  <!-- FOR√áAR ATUALIZA√á√ÉO EM QUALQUER DISPOSITIVO -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <style>
    /* ===== VARI√ÅVEIS GLOBAIS ===== */
    :root {
      --bg: #0a0f1c;
      --card: #141b2b;
      --line: rgba(255, 255, 255, 0.12);
      --text: #e2eaff;
      --muted: #9aa9c7;
      --pri: #0ea5e9;
      --bad: #ef4444;
      --ok: #22c55e;
      --warn: #f59e0b;
      --info: #8b5cf6;
      --token: #a855f7;
      --r: 14px;
    }

    /* Modo claro */
    .light-mode {
      --bg: #f0f4fa;
      --card: #ffffff;
      --line: rgba(0, 0, 0, 0.12);
      --text: #1e293b;
      --muted: #64748b;
    }

    /* ===== RESET E ESTILOS BASE ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      transition: background-color 0.3s, color 0.3s;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .hidden {
      display: none !important;
    }

    .muted {
      color: var(--muted);
      font-size: 0.92rem;
    }

    /* ===== BADGES E PILLS ===== */
    .pill {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: 0.85rem;
      margin-right: 6px;
      margin-top: 6px;
      background: rgba(255, 255, 255, 0.03);
    }

    .pill.ok {
      border-color: rgba(34, 197, 94, 0.35);
      background: rgba(34, 197, 94, 0.12);
    }

    .pill.bad {
      border-color: rgba(239, 68, 68, 0.35);
      background: rgba(239, 68, 68, 0.12);
    }

    .pill.info {
      border-color: rgba(139, 92, 246, 0.35);
      background: rgba(139, 92, 246, 0.12);
    }

    .pill.warn {
      border-color: rgba(245, 158, 11, 0.35);
      background: rgba(245, 158, 11, 0.12);
    }

    .pill.pri {
      border-color: rgba(14, 165, 233, 0.35);
      background: rgba(14, 165, 233, 0.12);
    }

    .pill.token {
      border-color: rgba(168, 85, 247, 0.35);
      background: rgba(168, 85, 247, 0.12);
    }

    /* ===== BOT√ïES ===== */
    button {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.95rem;
      min-height: 44px;
      -webkit-appearance: none;
      appearance: none;
    }

    button:hover {
      background: rgba(255, 255, 255, 0.12);
    }

    button:active {
      transform: scale(0.98);
      background: rgba(255, 255, 255, 0.15);
    }

    button.primary {
      border-color: rgba(14, 165, 233, 0.5);
      background: rgba(14, 165, 233, 0.25);
    }

    button.primary:hover {
      background: rgba(14, 165, 233, 0.35);
    }

    button.danger {
      border-color: rgba(239, 68, 68, 0.5);
      background: rgba(239, 68, 68, 0.18);
    }

    button.danger:hover {
      background: rgba(239, 68, 68, 0.28);
    }

    button.small {
      padding: 8px 12px;
      font-size: 0.9rem;
      min-height: 36px;
    }

    /* ===== FORMUL√ÅRIOS ===== */
    input,
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      outline: none;
      font-family: inherit;
      font-size: 0.95rem;
      min-height: 44px;
      -webkit-appearance: none;
      appearance: none;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(14, 165, 233, 0.5);
      box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
    }

    select {
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .light-mode select {
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    label {
      display: block;
      margin: 0 0 6px;
      color: var(--muted);
      font-size: 0.9rem;
      font-weight: 500;
    }

    hr {
      border: none;
      border-top: 1px solid var(--line);
      margin: 16px 0;
    }

    /* ===== LAYOUT PRINCIPAL ===== */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      border-bottom: 1px solid var(--line);
      flex-wrap: wrap;
      background: rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    h1 {
      margin: 0;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    main {
      padding: 16px;
      display: grid;
      gap: 16px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r);
      padding: 18px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .row > * {
      flex: 1 1 200px;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    @media (max-width: 900px) {
      .grid2 {
        grid-template-columns: 1fr;
      }
    }

    .grid3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }

    @media (max-width: 900px) {
      .grid3 {
        grid-template-columns: 1fr;
      }
    }

    .sum {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .sum .cardMini {
      flex: 1 1 250px;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      background: rgba(255, 255, 255, 0.03);
    }

    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tab {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.04);
      padding: 10px 16px;
    }

    .tab.active {
      border-color: rgba(14, 165, 233, 0.45);
      background: rgba(14, 165, 233, 0.18);
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }

    .item {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.03);
      border-radius: 14px;
      padding: 15px;
    }

    .item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .itemTop {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .split {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 15px;
    }

    @media (max-width: 1000px) {
      .split {
        grid-template-columns: 1fr;
      }
    }

    /* ===== BARRA DE BACKUP ===== */
    .backup-bar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      background: rgba(14, 165, 233, 0.1);
      border: 1px solid rgba(14, 165, 233, 0.3);
      border-radius: 40px;
      padding: 6px 12px;
    }

    .backup-bar button {
      padding: 6px 10px;
      min-height: 32px;
    }

    /* ===== DASHBOARD ===== */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 18px;
      text-align: center;
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: bold;
      color: var(--pri);
      margin: 10px 0;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--pri);
      transition: width 0.3s ease;
    }

    /* ===== AGENDAMENTO ===== */
    .schedWrap {
      overflow-x: auto;
      overflow-y: auto;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.02);
      max-height: 600px;
      -webkit-overflow-scrolling: touch;
    }

    table.sched {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
    }

    .sched th,
    .sched td {
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px;
      vertical-align: top;
    }

    .sched th {
      background: rgba(255, 255, 255, 0.04);
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .sched td {
      min-width: 150px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .sched td:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .timeCell {
      position: sticky;
      left: 0;
      z-index: 1;
      background: rgba(255, 255, 255, 0.04);
      font-weight: 800;
    }

    .slotBox {
      border-radius: 10px;
      padding: 10px;
      height: 100%;
    }

    .slotGreen {
      background: rgba(34, 197, 94, 0.15);
      border-left: 4px solid #22c55e;
    }

    .slotAmber {
      background: rgba(245, 158, 11, 0.15);
      border-left: 4px solid #f59e0b;
    }

    .slotRed {
      background: rgba(239, 68, 68, 0.15);
      border-left: 4px solid #ef4444;
    }

    .slotBlue {
      background: rgba(14, 165, 233, 0.15);
      border-left: 4px solid #0ea5e9;
    }

    .slotPurple {
      background: rgba(139, 92, 246, 0.15);
      border-left: 4px solid #8b5cf6;
    }

    .iconAlert {
      font-size: 1.1rem;
      margin-right: 5px;
    }

    /* ===== SELETOR DE DIAS ===== */
    .weekday-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 10px 0;
    }

    .weekday-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.06);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .weekday-btn.selected {
      background: rgba(14, 165, 233, 0.3);
      border-color: var(--pri);
    }

    .weekday-btn:active {
      transform: scale(0.95);
    }

    /* ===== MODAIS ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }

    .modal-content {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* ===== ALERTAS ===== */
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: 12px;
      background: var(--card);
      border: 1px solid var(--pri);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 2000;
      animation: slideIn 0.3s ease;
      max-width: 90%;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* ===== ATALHOS ===== */
    .shortcuts-hint {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 40px;
      padding: 10px 18px;
      font-size: 0.9rem;
      cursor: pointer;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .shortcuts-panel {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 18px;
      width: 280px;
      z-index: 100;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .shortcut-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--line);
    }

    .shortcut-key {
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 8px;
      border-radius: 6px;
      font-family: monospace;
    }

    /* ===== UTILIT√ÅRIOS ===== */
    .text-center {
      text-align: center;
    }

    .mt-2 {
      margin-top: 8px;
    }

    .mt-4 {
      margin-top: 16px;
    }

    .mb-2 {
      margin-bottom: 8px;
    }

    .mb-4 {
      margin-bottom: 16px;
    }
  </style>
</head>

<body>
  <!-- CONTE√öDO SER√Å INSERIDO VIA JAVASCRIPT -->
  <div id="app"></div>

  <script>
    // ========== VERS√ÉO FOR√áADA PARA EVITAR CACHE ==========
    const APP_VERSION = '2.0.0';
    const BUILD_TIME = new Date().getTime();
    
    console.log('Cl√≠nicaHub Ultra v' + APP_VERSION + ' - Carregado em:', new Date().toLocaleString());

    // ========== CONFIGURA√á√ïES ==========
    const KEYS = {
      PATIENTS: "clinica_ultra_patients_v2",
      SESSIONS: "clinica_ultra_sessions_v2",
      SCHEDULE: "clinica_ultra_schedule_v2",
      TOKENS: "clinica_ultra_tokens_v2",
      PACKS: "clinica_ultra_packs_v2",
      BACKUP: "clinica_ultra_backup_v2",
      THEME: "clinica_ultra_theme_v2",
      VERSION: "clinica_ultra_version"
    };

    const DAYS = ["Seg", "Ter", "Qua", "Qui", "Sex", "S√°b", "Dom"];
    const DAYS_FULL = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado", "Domingo"];
    const SERVICE_COLORS = {
      "cassems": "slotGreen",
      "particular": "slotAmber",
      "unimed": "slotPurple",
      "outros": "slotBlue"
    };

    let autoBackup = true;
    let openedPatientId = null;
    let alertTimeout = null;
    let currentTokenSessionId = null;
    let currentPackPatientId = null;

    // ========== VERIFICAR VERS√ÉO E LIMPAR CACHE SE NECESS√ÅRIO ==========
    function checkVersion() {
      const lastVersion = localStorage.getItem(KEYS.VERSION);
      if (lastVersion !== APP_VERSION) {
        console.log('Nova vers√£o detectada. Limpando cache de dados...');
        // N√£o limpa os dados do usu√°rio, apenas marca a nova vers√£o
        localStorage.setItem(KEYS.VERSION, APP_VERSION);
      }
    }

    // ========== UTILIT√ÅRIOS ==========
    function $(id) {
      return document.getElementById(id);
    }

    function uid() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2) + BUILD_TIME;
    }

    function todayISO() {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
    }

    function nowTime() {
      const d = new Date();
      return `${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
    }

    function parseMoney(val) {
      if (!val) return 0;
      return Number(String(val).replace(/\./g, "").replace(",", ".")) || 0;
    }

    function fmtMoney(val) {
      return Number(val || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function escapeHtml(str) {
      return String(str || "")
        .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function saveData(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
        return true;
      } catch (e) {
        console.error('Erro ao salvar dados:', e);
        showAlert('‚ùå Erro ao salvar dados. Verifique o espa√ßo dispon√≠vel.', 'error');
        return false;
      }
    }

    function loadData(key, defaultValue = null) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
      } catch (e) {
        console.error('Erro ao carregar dados:', e);
        return defaultValue;
      }
    }

    // ========== SISTEMA DE PACOTES ==========
    function loadPacks() {
      return loadData(KEYS.PACKS, {});
    }

    function savePacks(packs) {
      saveData(KEYS.PACKS, packs);
    }

    function getPatientPack(patientId) {
      const packs = loadPacks();
      return packs[patientId] || null;
    }

    function savePatientPack(patientId, packData) {
      const packs = loadPacks();
      packs[patientId] = {
        ...packData,
        updatedAt: new Date().toISOString()
      };
      savePacks(packs);
      return packs[patientId];
    }

    function calculateSessionsProgress(patientId, startDate, totalSessions) {
      const sessions = loadSessions().filter(s => 
        s.patientId === patientId && 
        s.did === "realizou" &&
        s.date >= startDate
      );
      return {
        completed: sessions.length,
        remaining: Math.max(0, totalSessions - sessions.length),
        percent: totalSessions > 0 ? (sessions.length / totalSessions) * 100 : 0
      };
    }

    function generatePackSchedule(patientId, packConfig) {
      const schedule = loadSchedule();
      const startDate = new Date(packConfig.startDate);
      
      for (let i = 0; i < packConfig.totalSessions; i++) {
        let sessionDate = new Date(startDate);
        
        if (packConfig.frequency === 2 && packConfig.weekdays.length === 2) {
          // Duas vezes por semana - alternar entre os dois dias selecionados
          const weekOffset = Math.floor(i / 2);
          const dayIndex = i % 2;
          const targetDay = packConfig.weekdays[dayIndex];
          
          let daysToAdd = (targetDay - startDate.getDay() + 7) % 7;
          daysToAdd += weekOffset * 7;
          sessionDate.setDate(startDate.getDate() + daysToAdd);
        } else {
          // Uma vez por semana
          sessionDate.setDate(startDate.getDate() + (i * 7));
        }
        
        const dateStr = sessionDate.toISOString().split('T')[0];
        const key = recurKey(sessionDate.getDay(), packConfig.time);
        
        // Verificar se o hor√°rio est√° dispon√≠vel
        if (!schedule.recurring[key]) {
          schedule.recurring[key] = {
            patientId: patientId,
            serviceType: packConfig.serviceType,
            startDate: dateStr,
            plannedTotal: packConfig.totalSessions
          };
        }
      }
      
      saveSchedule(schedule);
    }

    // ========== SISTEMA DE TOKENS CASSEMS ==========
    function loadTokens() {
      return loadData(KEYS.TOKENS, {});
    }

    function saveTokens(tokens) {
      saveData(KEYS.TOKENS, tokens);
    }

    function getTokenForSession(sessionId) {
      const tokens = loadTokens();
      return tokens[sessionId] || null;
    }

    function registerToken(sessionId, tokenData) {
      const tokens = loadTokens();
      tokens[sessionId] = {
        ...tokenData,
        registeredAt: new Date().toISOString()
      };
      saveTokens(tokens);
      return tokens[sessionId];
    }

    // ========== PACIENTES ==========
    function loadPatients() { return loadData(KEYS.PATIENTS, []); }
    function savePatients(p) { saveData(KEYS.PATIENTS, p); }

    function getPatientById(id) {
      return loadPatients().find(p => p.id === id);
    }

    // ========== SESS√ïES ==========
    function loadSessions() { return loadData(KEYS.SESSIONS, []); }
    function saveSessions(s) { saveData(KEYS.SESSIONS, s); }

    // ========== AGENDA ==========
    function loadSchedule() {
      return loadData(KEYS.SCHEDULE, { times: defaultTimes(), recurring: {} });
    }
    function saveSchedule(s) { saveData(KEYS.SCHEDULE, s); }

    function defaultTimes() {
      return ["07:00", "07:40", "08:20", "09:00", "09:40", "10:20", "11:00", "13:20", "14:00", "14:40", "15:20", "16:00", "16:40", "17:20"];
    }

    function recurKey(day, time) { return `${day}|${time}`; }

    // ========== ALERTAS ==========
    function showAlert(message, type = "info") {
      if (alertTimeout) clearTimeout(alertTimeout);
      
      const alert = document.createElement("div");
      alert.className = `alert alert-${type}`;
      alert.innerHTML = message;
      alert.style.background = type === "success" ? "rgba(34,197,94,.2)" : 
                              type === "warning" ? "rgba(245,158,11,.2)" : 
                              "rgba(14,165,233,.2)";
      alert.style.borderColor = type === "success" ? "#22c55e" : 
                                type === "warning" ? "#f59e0b" : 
                                "#0ea5e9";
      document.body.appendChild(alert);
      
      alertTimeout = setTimeout(() => {
        if (alert.parentNode) {
          alert.remove();
        }
      }, 3000);
    }

    // ========== TEMA ==========
    function toggleTheme() {
      document.body.classList.toggle("light-mode");
      const isLight = document.body.classList.contains("light-mode");
      localStorage.setItem(KEYS.THEME, isLight ? "light" : "dark");
      const themeBtn = document.getElementById("themeToggle");
      if (themeBtn) {
        themeBtn.innerHTML = isLight ? "üåô Tema" : "‚òÄÔ∏è Tema";
      }
    }

    // ========== RENDERIZA√á√ÉO DO HTML ==========
    function renderApp() {
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <!-- Painel Principal -->
        <section id="appWrap">
          <header>
            <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
              <h1>üè• Cl√≠nicaHub Ultra</h1>
              <div id="today" class="muted"></div>
              <button id="themeToggle" class="small" style="border-radius:30px;">üåì Tema</button>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <!-- Barra de Backup -->
              <div class="backup-bar">
                <span class="muted">üíæ Backup:</span>
                <button id="backupNow" class="small" title="Baixar backup agora">‚¨áÔ∏è Baixar</button>
                <button id="restoreBackup" class="small" title="Restaurar de um arquivo">üìÇ Restaurar</button>
                <button id="autoBackupToggle" class="small pri">üîµ Auto: ON</button>
              </div>

              <div class="tabs">
                <button class="tab active" id="tabDashboard">üìä Dashboard</button>
                <button class="tab" id="tabDaily">üìÖ Di√°rio</button>
                <button class="tab" id="tabPatients">üë• Pacientes</button>
                <button class="tab" id="tabSchedule">üìÜ Agendamento</button>
                <button class="tab" id="tabReports">üìà Relat√≥rios</button>
              </div>
            </div>
          </header>

          <main>
            <!-- DASHBOARD -->
            <section id="viewDashboard" class="card">
              <h2>üìä Dashboard</h2>
              <div class="dashboard-grid">
                <div class="stat-card">
                  <div>Pacientes Hoje</div>
                  <div class="stat-value" id="dashHoje">0</div>
                  <div class="muted" id="dashHojeDetalhe"></div>
                </div>
                <div class="stat-card">
                  <div>Pr√≥ximos 15min</div>
                  <div class="stat-value" id="dashProximos">0</div>
                  <div class="muted" id="dashProximosNomes"></div>
                </div>
                <div class="stat-card">
                  <div>Faturamento Hoje</div>
                  <div class="stat-value" id="dashFaturamento">R$ 0</div>
                  <div class="muted" id="dashFaturamentoDetalhe"></div>
                </div>
                <div class="stat-card">
                  <div>Taxa de Faltas</div>
                  <div class="stat-value" id="dashTaxaFaltas">0%</div>
                  <div class="progress-bar">
                    <div class="progress-fill" id="dashProgresso" style="width:0%"></div>
                  </div>
                </div>
              </div>

              <!-- Cards de Token Cassems -->
              <div class="grid3" style="margin-top:20px;">
                <div class="cardMini">
                  <b>üé´ Tokens Cassems Hoje</b>
                  <div class="stat-value" id="tokensHoje">0</div>
                  <div class="muted" id="tokensHojeDetalhe"></div>
                </div>
                <div class="cardMini">
                  <b>‚úÖ Enviados</b>
                  <div class="stat-value" id="tokensEnviados">0</div>
                  <div class="muted" id="tokensEnviadosDetalhe"></div>
                </div>
                <div class="cardMini">
                  <b>‚è≥ Pendentes</b>
                  <div class="stat-value" id="tokensPendentes">0</div>
                  <div class="muted" id="tokensPendentesDetalhe"></div>
                </div>
              </div>

              <div style="margin-top:20px;">
                <h3>üéÇ Aniversariantes do M√™s</h3>
                <div id="aniversariantes" class="list"></div>
              </div>

              <div style="margin-top:20px;">
                <h3>‚è∞ Pr√≥ximos Atendimentos</h3>
                <div id="proximosAtendimentos" class="list"></div>
              </div>
            </section>

            <!-- Di√°rio -->
            <section id="viewDaily" class="card hidden">
              <div class="row">
                <div>
                  <label>Data do atendimento</label>
                  <input id="date" type="date" />
                </div>
                <div>
                  <label>Buscar paciente</label>
                  <input id="search" placeholder="Nome..." />
                </div>
                <div style="display:flex; gap:8px;">
                  <button id="findInDay" class="small primary">üîç Procurar</button>
                  <button id="clearDay" class="small danger">üóëÔ∏è Limpar dia</button>
                </div>
              </div>

              <div class="sum">
                <div class="cardMini">
                  <b>Resumo do dia</b>
                  <div class="muted" id="sumDay">‚Äî</div>
                </div>
                <div class="cardMini">
                  <b>Financeiro</b>
                  <div class="muted" id="sumMoney">‚Äî</div>
                </div>
                <div class="cardMini">
                  <b>Faltas hoje</b>
                  <div class="muted" id="sumAbsences">‚Äî</div>
                </div>
              </div>

              <!-- Resumo de Tokens do Dia -->
              <div class="grid3" style="margin:15px 0;">
                <div class="cardMini">
                  <b>üé´ Pacientes Cassems</b>
                  <div id="cassemsHoje" class="stat-value" style="font-size:1.5rem;">0</div>
                </div>
                <div class="cardMini">
                  <b>‚úÖ Tokens Enviados</b>
                  <div id="tokensEnviadosHoje" class="stat-value" style="font-size:1.5rem; color:#22c55e;">0</div>
                </div>
                <div class="cardMini">
                  <b>‚è≥ Pendentes</b>
                  <div id="tokensPendentesHoje" class="stat-value" style="font-size:1.5rem; color:#f59e0b;">0</div>
                </div>
              </div>

              <hr>

              <b>‚ûï Adicionar sess√£o</b>
              <div class="grid2">
                <div>
                  <label>Paciente</label>
                  <select id="pPatient"></select>
                </div>
                <div>
                  <label>Hor√°rio</label>
                  <input id="pTime" placeholder="14:30" />
                </div>
                <div>
                  <label>Sess√£o</label>
                  <select id="pDid">
                    <option value="realizou">‚úÖ Realizou</option>
                    <option value="nao">‚ùå N√£o realizou</option>
                  </select>
                </div>
                <div>
                  <label>Justificativa</label>
                  <select id="pJust">
                    <option value="na">‚Äî</option>
                    <option value="justificada">üìù Justificada</option>
                    <option value="nao_justificada">‚ö†Ô∏è N√£o justificada</option>
                  </select>
                </div>
                <div>
                  <label>Pagamento</label>
                  <select id="pPaid">
                    <option value="nao_pago">üí∏ N√£o pago</option>
                    <option value="pago">üí∞ Pago</option>
                  </select>
                </div>
                <div>
                  <label>Valor (R$)</label>
                  <input id="pValue" placeholder="80,00" />
                  <small id="hintDefault" class="muted"></small>
                </div>
              </div>

              <div class="row">
                <button id="addSession" class="primary">‚ûï Adicionar</button>
                <button id="resetAll" class="danger">‚ö†Ô∏è Zerar tudo</button>
              </div>

              <div class="list" id="dayList"></div>
            </section>

            <!-- Pacientes -->
            <section id="viewPatients" class="card hidden">
              <div class="split">
                <!-- Cadastro -->
                <div class="card">
                  <b>üë§ Cadastro de Paciente</b>
                  <div class="grid2" style="margin-top:15px;">
                    <div>
                      <label>Nome completo *</label>
                      <input id="cName" placeholder="Jo√£o Silva" />
                    </div>
                    <div>
                      <label>Data nascimento</label>
                      <input id="cBirth" type="date" />
                    </div>
                    <div>
                      <label>CPF</label>
                      <input id="cCpf" placeholder="000.000.000-00" />
                    </div>
                    <div>
                      <label>Respons√°vel</label>
                      <input id="cResp" placeholder="Nome do respons√°vel" />
                    </div>
                    <div>
                      <label>WhatsApp</label>
                      <input id="cPhone" placeholder="67999999999" />
                    </div>
                    <div>
                      <label>E-mail</label>
                      <input id="cEmail" type="email" placeholder="paciente@email.com" />
                    </div>
                    <div>
                      <label>Conv√™nio</label>
                      <select id="cServiceType">
                        <option value="particular">Particular</option>
                        <option value="cassems">Cassems</option>
                        <option value="unimed">Unimed</option>
                        <option value="outros">Outros</option>
                      </select>
                    </div>
                    <div>
                      <label>Valor padr√£o (R$)</label>
                      <input id="cDefaultValue" placeholder="80,00" />
                    </div>
                    <div>
                      <label>Tipo de cobran√ßa</label>
                      <select id="cBillingType">
                        <option value="pack4">üì¶ Pacote 4 sess√µes</option>
                        <option value="pack8">üì¶ Pacote 8 sess√µes</option>
                        <option value="individual">üí≥ Individual</option>
                      </select>
                    </div>
                    <div>
                      <label>Frequ√™ncia semanal</label>
                      <select id="cFrequency">
                        <option value="1">1x por semana</option>
                        <option value="2">2x por semana</option>
                      </select>
                      <small class="muted">Para pacotes de 8 sess√µes</small>
                    </div>
                    <div>
                      <label>Hor√°rio fixo</label>
                      <div style="display:flex; gap:8px;">
                        <select id="cFixDay" style="flex:1;">
                          <option value="">Dia</option>
                          <option value="0">Seg</option>
                          <option value="1">Ter</option>
                          <option value="2">Qua</option>
                          <option value="3">Qui</option>
                          <option value="4">Sex</option>
                          <option value="5">S√°b</option>
                          <option value="6">Dom</option>
                        </select>
                        <input id="cFixHour" placeholder="07:40" style="flex:1;" />
                      </div>
                      <small class="muted">Agenda autom√°tica</small>
                    </div>
                  </div>

                  <label style="margin-top:15px;">Observa√ß√µes iniciais</label>
                  <textarea id="cNotes" rows="2" placeholder="Observa√ß√µes relevantes..."></textarea>

                  <div class="row" style="margin-top:15px;">
                    <button id="addPatient" class="primary">üíæ Salvar paciente</button>
                  </div>
                </div>

                <!-- Pastas -->
                <div class="card">
                  <div id="foldersPane">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                      <b>üìÅ Pastas</b>
                      <div style="display:flex; gap:8px;">
                        <input id="pSearch" placeholder="Buscar paciente..." style="width:200px;" />
                        <button id="onlyDebtFolders" class="small">üí∏ Com d√©bito</button>
                      </div>
                    </div>
                    <div id="patientFolders" class="list"></div>
                  </div>

                  <div id="folderOpenPane" class="hidden">
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:15px;">
                      <button id="backToFolders" class="small">‚Üê Voltar</button>
                      <div style="flex:1;">
                        <b id="openPatientTitle">Paciente</b>
                        <div class="muted" id="openPatientMeta"></div>
                      </div>
                      <div style="display:flex; gap:8px;">
                        <button id="btnAnamnese" class="small info">üìã Anamnese</button>
                        <button id="openWhats" class="small">üì± WhatsApp</button>
                        <button id="renamePatient" class="small">‚úèÔ∏è Renomear</button>
                        <button id="deletePatient" class="small danger">üóëÔ∏è Excluir</button>
                      </div>
                    </div>

                    <!-- Barra de progresso do pacote -->
                    <div id="pacoteProgresso" style="margin:10px 0; padding:10px; background:rgba(255,255,255,.03); border-radius:10px;"></div>

                    <!-- Controle de Sess√µes do Pacote -->
                    <div id="packControl" class="pack-control"></div>

                    <div id="patientHistory" class="list"></div>
                  </div>
                </div>
              </div>
            </section>

            <!-- Agendamento -->
            <section id="viewSchedule" class="card hidden">
              <div class="row">
                <div>
                  <label>Data refer√™ncia</label>
                  <input id="schedRef" type="date" />
                </div>
                <div>
                  <label>Adicionar hor√°rio</label>
                  <div style="display:flex; gap:8px;">
                    <input id="newTime" placeholder="07:00" />
                    <button id="addTime" class="small primary">‚ûï</button>
                  </div>
                </div>
                <div>
                  <label>Filtro</label>
                  <div style="display:flex; gap:5px;">
                    <button id="filterHoje" class="small">Hoje</button>
                    <button id="filterAmanha" class="small">Amanh√£</button>
                    <button id="filterSemana" class="small">Semana</button>
                  </div>
                </div>
              </div>

              <div class="schedWrap">
                <table class="sched" id="schedTable"></table>
              </div>

              <div class="muted" style="margin-top:15px; padding:10px; background:rgba(255,255,255,.03); border-radius:12px;">
                <span class="pill ok">üü¢ Cassems</span>
                <span class="pill warn">üü° Particular</span>
                <span class="pill info">üü£ Unimed/Outros</span>
                <span class="pill bad">üî¥ Vago</span>
                <span class="pill">‚ö†Ô∏è Falta 1</span>
                <span class="pill">üèÅ √öltima</span>
                <span class="pill token">üé´ Token</span>
              </div>
            </section>

            <!-- Relat√≥rios -->
            <section id="viewReports" class="card hidden">
              <h2 style="margin-bottom:20px;">üìà Relat√≥rios</h2>

              <div class="grid2">
                <div class="cardMini">
                  <b>Resumo do M√™s</b>
                  <div id="monthSummary" class="muted" style="margin-top:10px;">Carregando...</div>
                </div>
                <div class="cardMini">
                  <b>Taxa de Faltas</b>
                  <div id="absenceRate" class="muted" style="margin-top:10px;">Carregando...</div>
                </div>
                <div class="cardMini">
                  <b>Faturamento</b>
                  <div id="revenueStats" class="muted" style="margin-top:10px;">Carregando...</div>
                </div>
                <div class="cardMini">
                  <b>Pacientes Ativos</b>
                  <div id="activePatients" class="muted" style="margin-top:10px;">Carregando...</div>
                </div>
              </div>

              <!-- Relat√≥rio de Tokens -->
              <div style="margin-top:20px;">
                <b>üé´ Controle de Tokens Cassems</b>
                <div class="grid3" style="margin-top:10px;">
                  <div class="cardMini">
                    <b>Total de sess√µes Cassems</b>
                    <div id="totalSessoesCassems" class="stat-value" style="font-size:1.5rem;">0</div>
                  </div>
                  <div class="cardMini">
                    <b>Tokens Enviados</b>
                    <div id="totalTokensEnviados" class="stat-value" style="font-size:1.5rem; color:#22c55e;">0</div>
                  </div>
                  <div class="cardMini">
                    <b>Tokens Pendentes</b>
                    <div id="totalTokensPendentes" class="stat-value" style="font-size:1.5rem; color:#f59e0b;">0</div>
                  </div>
                </div>
              </div>

              <div style="margin-top:20px;">
                <b>üìä Status dos Pacotes</b>
                <div id="packStatus" class="grid2" style="margin-top:10px;"></div>
              </div>

              <div style="margin-top:20px;">
                <b>Pacientes com maior d√©bito</b>
                <div id="topDebtors" class="list" style="margin-top:10px;"></div>
              </div>
            </section>
          </main>

          <!-- Atalhos -->
          <div class="shortcuts-hint" id="shortcutsHint">‚å®Ô∏è Atalhos</div>
          <div class="shortcuts-panel hidden" id="shortcutsPanel">
            <h4 style="margin-bottom:10px;">Atalhos de Teclado</h4>
            <div class="shortcut-item"><span>Novo paciente</span> <span class="shortcut-key">Ctrl+N</span></div>
            <div class="shortcut-item"><span>Buscar</span> <span class="shortcut-key">Ctrl+F</span></div>
            <div class="shortcut-item"><span>Dashboard</span> <span class="shortcut-key">Ctrl+1</span></div>
            <div class="shortcut-item"><span>Di√°rio</span> <span class="shortcut-key">Ctrl+2</span></div>
            <div class="shortcut-item"><span>Pacientes</span> <span class="shortcut-key">Ctrl+3</span></div>
            <div class="shortcut-item"><span>Agenda</span> <span class="shortcut-key">Ctrl+4</span></div>
          </div>
        </section>

        <!-- Modais -->
        <div id="backupModal" class="modal-overlay hidden">
          <div class="modal-content">
            <h3 style="margin-bottom:15px;">üíæ Restaurar Backup</h3>
            <p class="muted">Selecione um arquivo de backup (.json) para restaurar. Isso substituir√° todos os dados atuais.</p>
            <input type="file" id="backupFile" accept=".json" style="margin:15px 0;" />
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button id="cancelBackup" class="small">Cancelar</button>
              <button id="confirmRestore" class="danger small">Restaurar</button>
            </div>
          </div>
        </div>

        <div id="anamneseModal" class="modal-overlay hidden">
          <div class="modal-content">
            <h3>üìã Anamnese</h3>
            <div style="margin:15px 0;">
              <label>Queixa principal</label>
              <textarea id="aQueixa" rows="2"></textarea>
            </div>
            <div style="margin:15px 0;">
              <label>Hist√≥rico</label>
              <textarea id="aHistorico" rows="2"></textarea>
            </div>
            <div style="margin:15px 0;">
              <label>Observa√ß√µes</label>
              <textarea id="aObs" rows="3"></textarea>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button id="closeAnamnese" class="small">Fechar</button>
              <button id="saveAnamnese" class="primary small">Salvar</button>
            </div>
          </div>
        </div>

        <!-- Modal de Token -->
        <div id="tokenModal" class="modal-overlay hidden">
          <div class="modal-content">
            <h3>üé´ Registrar Token Cassems</h3>
            <p class="muted">Registre o token de autoriza√ß√£o enviado pelo paciente</p>
            
            <div style="margin:15px 0;">
              <label>Data da sess√£o</label>
              <input type="date" id="tokenDate" readonly />
            </div>
            
            <div style="margin:15px 0;">
              <label>Paciente</label>
              <input type="text" id="tokenPatient" readonly />
            </div>
            
            <div style="margin:15px 0;">
              <label>Token de autoriza√ß√£o</label>
              <input type="text" id="tokenCode" placeholder="Ex: CASS-123456" />
              <small class="muted">C√≥digo fornecido pelo paciente</small>
            </div>
            
            <div style="margin:15px 0;">
              <label>Status do token</label>
              <select id="tokenStatus">
                <option value="enviado">‚úÖ Enviado</option>
                <option value="pendente">‚è≥ Pendente</option>
                <option value="problema">‚ùå Problema no token</option>
              </select>
            </div>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button id="cancelToken" class="small">Cancelar</button>
              <button id="saveToken" class="primary small">Salvar Token</button>
            </div>
          </div>
        </div>

        <!-- Modal de Configura√ß√£o de Pacote -->
        <div id="packModal" class="modal-overlay hidden">
          <div class="modal-content">
            <h3>üì¶ Configurar Pacote de Sess√µes</h3>
            <p class="muted" id="packPatientName"></p>
            
            <div class="pack-info" id="packCurrentInfo"></div>
            
            <div style="margin:20px 0;">
              <label>Data de in√≠cio do pacote</label>
              <input type="date" id="packStartDate" />
            </div>
            
            <div style="margin:20px 0;">
              <label>Total de sess√µes</label>
              <select id="packTotal">
                <option value="4">4 sess√µes</option>
                <option value="8">8 sess√µes</option>
              </select>
            </div>
            
            <div style="margin:20px 0;">
              <label>Frequ√™ncia semanal</label>
              <select id="packFrequency">
                <option value="1">1x por semana</option>
                <option value="2">2x por semana</option>
              </select>
            </div>
            
            <div style="margin:20px 0;" id="weekdaysContainer">
              <label>Dias da semana (para 2x)</label>
              <div class="weekday-selector" id="weekdaySelector">
                <div class="weekday-btn" data-day="0">S</div>
                <div class="weekday-btn" data-day="1">T</div>
                <div class="weekday-btn" data-day="2">Q</div>
                <div class="weekday-btn" data-day="3">Q</div>
                <div class="weekday-btn" data-day="4">S</div>
                <div class="weekday-btn" data-day="5">S</div>
                <div class="weekday-btn" data-day="6">D</div>
              </div>
              <small class="muted">Selecione 2 dias para sess√µes 2x por semana</small>
            </div>
            
            <div style="margin:20px 0;">
              <label>Hor√°rio das sess√µes</label>
              <input type="time" id="packTime" step="600" />
            </div>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button id="cancelPack" class="small">Cancelar</button>
              <button id="savePack" class="primary small">Salvar Configura√ß√£o</button>
            </div>
          </div>
        </div>
      `;
    }

    // ========== FUN√á√ïES PRINCIPAIS ==========
    function renderDashboard() {
      const hoje = todayISO();
      const agora = nowTime();
      const sessions = loadSessions();
      const patients = loadPatients();
      const schedule = loadSchedule();
      const tokens = loadTokens();
      
      // Pacientes hoje
      const hojeSessions = sessions.filter(s => s.date === hoje);
      const dashHoje = document.getElementById("dashHoje");
      if (dashHoje) dashHoje.textContent = hojeSessions.length;
      
      const realizadasHoje = hojeSessions.filter(s => s.did === "realizou").length;
      const faltasHoje = hojeSessions.filter(s => s.did === "nao").length;
      const dashHojeDetalhe = document.getElementById("dashHojeDetalhe");
      if (dashHojeDetalhe) dashHojeDetalhe.innerHTML = `‚úÖ ${realizadasHoje} realizadas ‚Ä¢ ‚ùå ${faltasHoje} faltas`;
      
      // Pr√≥ximos 15 minutos
      const hojeDay = new Date().getDay();
      const proximos = [];
      
      Object.entries(schedule.recurring || {}).forEach(([key, entry]) => {
        const [day, time] = key.split("|");
        if (parseInt(day) === hojeDay) {
          const [h1, m1] = time.split(":").map(Number);
          const [h2, m2] = agora.split(":").map(Number);
          const diffMinutes = (h1 * 60 + m1) - (h2 * 60 + m2);
          
          if (diffMinutes > 0 && diffMinutes <= 15) {
            const patient = getPatientById(entry.patientId);
            proximos.push({ name: patient?.name || "?", time });
          }
        }
      });
      
      const dashProximos = document.getElementById("dashProximos");
      if (dashProximos) dashProximos.textContent = proximos.length;
      
      const dashProximosNomes = document.getElementById("dashProximosNomes");
      if (dashProximosNomes) {
        dashProximosNomes.innerHTML = proximos.map(p => `${p.time} - ${p.name}`).join("<br>") || "Nenhum";
      }
      
      // Faturamento hoje
      const faturamentoHoje = hojeSessions
        .filter(s => s.did === "realizou" && s.paid === "pago")
        .reduce((sum, s) => sum + (Number(s.value) || 0), 0);
      const aReceberHoje = hojeSessions
        .filter(s => s.did === "realizou" && s.paid !== "pago")
        .reduce((sum, s) => sum + (Number(s.value) || 0), 0);
      
      const dashFaturamento = document.getElementById("dashFaturamento");
      if (dashFaturamento) dashFaturamento.textContent = fmtMoney(faturamentoHoje);
      
      const dashFaturamentoDetalhe = document.getElementById("dashFaturamentoDetalhe");
      if (dashFaturamentoDetalhe) {
        dashFaturamentoDetalhe.innerHTML = `üí∞ Recebido: ${fmtMoney(faturamentoHoje)}<br>üí∏ A receber: ${fmtMoney(aReceberHoje)}`;
      }
      
      // Taxa de faltas do m√™s
      const currentMonth = hoje.slice(0, 7);
      const monthSessions = sessions.filter(s => s.date.startsWith(currentMonth));
      const monthFaltas = monthSessions.filter(s => s.did === "nao").length;
      const taxa = monthSessions.length ? (monthFaltas / monthSessions.length * 100).toFixed(1) : 0;
      
      const dashTaxaFaltas = document.getElementById("dashTaxaFaltas");
      if (dashTaxaFaltas) dashTaxaFaltas.textContent = `${taxa}%`;
      
      const dashProgresso = document.getElementById("dashProgresso");
      if (dashProgresso) dashProgresso.style.width = `${taxa}%`;

      // Estat√≠sticas de Tokens
      const cassemsHoje = hojeSessions.filter(s => {
        const p = getPatientById(s.patientId);
        return p?.serviceType === "cassems";
      });

      const tokensHoje = cassemsHoje.map(s => ({
        session: s,
        token: tokens[s.id]
      }));

      const tokensEnviados = tokensHoje.filter(t => t.token?.status === "enviado").length;
      const tokensPendentes = cassemsHoje.length - tokensEnviados;

      const tokensHojeEl = document.getElementById("tokensHoje");
      if (tokensHojeEl) tokensHojeEl.textContent = cassemsHoje.length;
      
      const tokensHojeDetalhe = document.getElementById("tokensHojeDetalhe");
      if (tokensHojeDetalhe) tokensHojeDetalhe.innerHTML = `${cassemsHoje.length} pacientes Cassems hoje`;
      
      const tokensEnviadosEl = document.getElementById("tokensEnviados");
      if (tokensEnviadosEl) tokensEnviadosEl.textContent = tokensEnviados;
      
      const tokensEnviadosDetalhe = document.getElementById("tokensEnviadosDetalhe");
      if (tokensEnviadosDetalhe) tokensEnviadosDetalhe.innerHTML = `${tokensEnviados} tokens registrados`;
      
      const tokensPendentesEl = document.getElementById("tokensPendentes");
      if (tokensPendentesEl) tokensPendentesEl.textContent = tokensPendentes;
      
      const tokensPendentesDetalhe = document.getElementById("tokensPendentesDetalhe");
      if (tokensPendentesDetalhe) tokensPendentesDetalhe.innerHTML = `${tokensPendentes} aguardando token`;
      
      // Aniversariantes
      const currentMonthNum = new Date().getMonth() + 1;
      const aniversariantes = patients.filter(p => {
        if (!p.birth) return false;
        const month = parseInt(p.birth.split("-")[1]);
        return month === currentMonthNum;
      });
      
      const aniversariantesEl = document.getElementById("aniversariantes");
      if (aniversariantesEl) {
        aniversariantesEl.innerHTML = aniversariantes.length ? 
          aniversariantes.map(p => `
            <div class="item">
              <b>üéÇ ${escapeHtml(p.name)}</b>
              <div class="muted">${new Date(p.birth).toLocaleDateString("pt-BR")}</div>
              <button class="small" onclick="window.sendBirthdayMessage('${p.id}')">üì± Enviar mensagem</button>
            </div>
          `).join("") : 
          "<div class='muted'>Nenhum aniversariante este m√™s</div>";
      }
      
      // Pr√≥ximos atendimentos
      const proximosAtendimentos = [];
      const refDay = new Date().getDay();
      
      Object.entries(schedule.recurring || {}).forEach(([key, entry]) => {
        const [day, time] = key.split("|");
        const dayNum = parseInt(day);
        
        let daysToAdd = dayNum - refDay;
        if (daysToAdd < 0) daysToAdd += 7;
        if (daysToAdd === 0 && time < agora) daysToAdd += 7;
        
        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + daysToAdd);
        
        const patient = getPatientById(entry.patientId);
        proximosAtendimentos.push({
          date: nextDate,
          time,
          patient: patient?.name || "?",
          days: daysToAdd
        });
      });
      
      proximosAtendimentos.sort((a, b) => a.days - b.days);
      
      const proximosAtendimentosEl = document.getElementById("proximosAtendimentos");
      if (proximosAtendimentosEl) {
        proximosAtendimentosEl.innerHTML = proximosAtendimentos.slice(0, 5).map(p => `
          <div class="item">
            <b>${escapeHtml(p.patient)}</b>
            <div class="muted">${p.time} - ${p.days === 0 ? "Hoje" : p.days === 1 ? "Amanh√£" : `Em ${p.days} dias`}</div>
          </div>
        `).join("") || "<div class='muted'>Nenhum agendamento</div>";
      }
    }

    window.sendBirthdayMessage = (patientId) => {
      const p = getPatientById(patientId);
      if (p?.phone) {
        const msg = encodeURIComponent(`üéÇ Feliz anivers√°rio! Desejo um dia maravilhoso e muitas realiza√ß√µes!`);
        window.open(`https://wa.me/55${p.phone}?text=${msg}`, "_blank");
      }
    };

    function renderSchedule() {
      const sch = loadSchedule();
      const patients = loadPatients();
      const times = (sch.times || []).sort();
      const refDate = document.getElementById("schedRef")?.value || todayISO();
      const table = document.getElementById("schedTable");
      
      if (!table) return;

      let html = "<thead><tr><th class='timeCell'>Hor√°rio</th>";
      DAYS.forEach(day => html += `<th>${day}</th>`);
      html += "</tr></thead><tbody>";

      for (const time of times) {
        html += `<tr><td class="timeCell">${escapeHtml(time)}</td>`;

        for (let day = 0; day < 7; day++) {
          const key = recurKey(day, time);
          const entry = sch.recurring?.[key];

          if (entry) {
            const patient = getPatientById(entry.patientId);
            const colorClass = SERVICE_COLORS[entry.serviceType] || "slotAmber";
            const serviceLabel = entry.serviceType === "cassems" ? "Cassems" :
              entry.serviceType === "unimed" ? "Unimed" :
                entry.serviceType === "outros" ? "Outros" : "Particular";

            const tokenIcon = entry.serviceType === "cassems" ? '<span class="pill token" style="margin-top:0;">üé´</span>' : '';

            // Calcular progresso do pacote
            let progressHtml = "";
            let warningIcon = "";
            if (entry.plannedTotal > 1) {
              const sessions = loadSessions().filter(s =>
                s.patientId === entry.patientId &&
                s.did === "realizou" &&
                s.date >= entry.startDate
              ).length;
              const remaining = Math.max(0, entry.plannedTotal - sessions);

              const percent = (sessions / entry.plannedTotal) * 100;
              progressHtml = `
                <div style="margin-top:8px;">
                  <div class="progress-bar" style="height:4px;">
                    <div class="progress-fill" style="width:${percent}%; background:#22c55e;"></div>
                  </div>
                  <div style="font-size:0.8rem; display:flex; justify-content:space-between; margin-top:4px;">
                    <span>${sessions}/${entry.plannedTotal}</span>
                    <span>${remaining} restam</span>
                  </div>
                </div>
              `;

              if (remaining === 1) warningIcon = `<span class="iconAlert">‚ö†Ô∏è</span>`;
              if (remaining === 0) warningIcon = `<span class="iconAlert">üèÅ</span>`;
            }

            html += `<td data-day="${day}" data-time="${time}" class="slotBox ${colorClass}">
              <div style="font-weight:600;">${warningIcon} ${escapeHtml(patient?.name || "?")} ${tokenIcon}</div>
              <div class="muted" style="font-size:0.85rem;">${serviceLabel}</div>
              ${progressHtml}
            </td>`;
          } else {
            html += `<td data-day="${day}" data-time="${time}" class="slotBox slotRed" style="cursor:pointer;">
              <div style="opacity:0.7;">üü• Vago</div>
              <div class="muted" style="font-size:0.8rem;">Clique para agendar</div>
            </td>`;
          }
        }
        html += "</tr>";
      }

      html += "</tbody>";
      table.innerHTML = html;

      document.querySelectorAll("td[data-day]").forEach(td => {
        td.addEventListener("click", (e) => {
          const day = td.dataset.day;
          const time = td.dataset.time;
          scheduleClickHandler(parseInt(day), time);
        });
      });
    }

    function scheduleClickHandler(day, time) {
      const sch = loadSchedule();
      const key = recurKey(day, time);
      const current = sch.recurring?.[key];
      const patients = loadPatients();

      if (current) {
        const patient = getPatientById(current.patientId);
        if (confirm(`Remover ${patient?.name} deste hor√°rio?`)) {
          delete sch.recurring[key];
          saveSchedule(sch);
          renderSchedule();
          renderDashboard();
          showAlert("‚úÖ Hor√°rio liberado!", "success");
        }
      } else {
        const patientList = patients.map((p, i) => `${i + 1} - ${p.name}`).join("\n");
        const choice = prompt(
          `Agendar em ${DAYS[day]} √†s ${time}\n\n` +
          `Digite o N√öMERO do paciente:\n${patientList}\n\n` +
          `Ou 0 para cancelar`
        );

        if (choice && choice !== "0") {
          const idx = parseInt(choice) - 1;
          if (idx >= 0 && idx < patients.length) {
            const patient = patients[idx];
            const finalService = patient.serviceType || "particular";
            
            let plannedTotal = 1;
            if (patient.billingType === "pack4") plannedTotal = 4;
            else if (patient.billingType === "pack8") plannedTotal = 8;

            sch.recurring = sch.recurring || {};
            sch.recurring[key] = {
              patientId: patient.id,
              serviceType: finalService,
              startDate: todayISO(),
              plannedTotal: plannedTotal
            };

            saveSchedule(sch);
            renderSchedule();
            renderDashboard();
            showAlert(`‚úÖ ${patient.name} agendado!`, "success");
          }
        }
      }
    }

    // ========== INICIALIZA√á√ÉO ==========
    function init() {
      checkVersion();
      renderApp();
      
      // Verificar tema salvo
      const savedTheme = localStorage.getItem(KEYS.THEME);
      if (savedTheme === "light") {
        document.body.classList.add("light-mode");
        const themeBtn = document.getElementById("themeToggle");
        if (themeBtn) themeBtn.innerHTML = "üåô Tema";
      }

      // Configurar data
      const dateInput = document.getElementById("date");
      if (dateInput) dateInput.value = todayISO();
      
      const schedRef = document.getElementById("schedRef");
      if (schedRef) schedRef.value = todayISO();
      
      const todayEl = document.getElementById("today");
      if (todayEl) {
        todayEl.innerHTML = new Date().toLocaleDateString("pt-BR", {
          weekday: "long", year: "numeric", month: "long", day: "numeric"
        });
      }

      // Carregar configura√ß√£o de auto backup
      autoBackup = localStorage.getItem("autoBackup") !== "false";
      const autoBackupBtn = document.getElementById("autoBackupToggle");
      if (autoBackupBtn) {
        autoBackupBtn.innerHTML = autoBackup ? "üîµ Auto: ON" : "‚ö™ Auto: OFF";
      }

      // ========== EVENT LISTENERS ==========
      
      // Backup
      document.getElementById("backupNow")?.addEventListener("click", downloadBackup);
      document.getElementById("restoreBackup")?.addEventListener("click", () => {
        document.getElementById("backupModal").classList.remove("hidden");
      });
      document.getElementById("cancelBackup")?.addEventListener("click", () => {
        document.getElementById("backupModal").classList.add("hidden");
      });
      document.getElementById("confirmRestore")?.addEventListener("click", () => {
        const file = document.getElementById("backupFile").files[0];
        if (file) {
          restoreFromFile(file);
          document.getElementById("backupModal").classList.add("hidden");
        }
      });

      document.getElementById("autoBackupToggle")?.addEventListener("click", () => {
        autoBackup = !autoBackup;
        localStorage.setItem("autoBackup", autoBackup);
        const btn = document.getElementById("autoBackupToggle");
        if (btn) {
          btn.innerHTML = autoBackup ? "üîµ Auto: ON" : "‚ö™ Auto: OFF";
        }
        showAlert(autoBackup ? "‚úÖ Backup autom√°tico ativado" : "‚ö™ Backup autom√°tico desativado");
      });

      // Tabs
      document.getElementById("tabDashboard")?.addEventListener("click", () => setTab("dashboard"));
      document.getElementById("tabDaily")?.addEventListener("click", () => setTab("daily"));
      document.getElementById("tabPatients")?.addEventListener("click", () => setTab("patients"));
      document.getElementById("tabSchedule")?.addEventListener("click", () => { setTab("schedule"); renderSchedule(); });
      document.getElementById("tabReports")?.addEventListener("click", () => { setTab("reports"); generateReports(); });

      // A√ß√µes
      document.getElementById("addPatient")?.addEventListener("click", addPatient);
      document.getElementById("addSession")?.addEventListener("click", addSession);
      document.getElementById("findInDay")?.addEventListener("click", findInDay);
      document.getElementById("clearDay")?.addEventListener("click", clearDay);
      document.getElementById("resetAll")?.addEventListener("click", resetAll);
      document.getElementById("date")?.addEventListener("change", renderDaily);
      document.getElementById("search")?.addEventListener("input", renderDaily);
      document.getElementById("pPatient")?.addEventListener("change", updateDefaultHint);
      document.getElementById("pSearch")?.addEventListener("input", renderPatientFolders);
      document.getElementById("backToFolders")?.addEventListener("click", () => {
        openedPatientId = null;
        document.getElementById("folderOpenPane").classList.add("hidden");
        document.getElementById("foldersPane").classList.remove("hidden");
      });
      document.getElementById("schedRef")?.addEventListener("change", renderSchedule);
      document.getElementById("addTime")?.addEventListener("click", addTime);
      document.getElementById("resetTimes")?.addEventListener("click", resetTimes);
      document.getElementById("btnAnamnese")?.addEventListener("click", openAnamnese);
      document.getElementById("closeAnamnese")?.addEventListener("click", () => {
        document.getElementById("anamneseModal").classList.add("hidden");
      });
      document.getElementById("saveAnamnese")?.addEventListener("click", saveAnamnese);
      document.getElementById("openWhats")?.addEventListener("click", openWhatsApp);
      document.getElementById("renamePatient")?.addEventListener("click", renamePatient);
      document.getElementById("deletePatient")?.addEventListener("click", deletePatient);
      document.getElementById("onlyDebtFolders")?.addEventListener("click", toggleDebtFilter);
      document.getElementById("themeToggle")?.addEventListener("click", toggleTheme);

      // Filtros da agenda
      document.getElementById("filterHoje")?.addEventListener("click", filterHoje);
      document.getElementById("filterAmanha")?.addEventListener("click", () => {
        const amanha = (new Date().getDay() + 1) % 7;
        const rows = document.querySelectorAll("#schedTable tbody tr");
        rows.forEach(row => {
          const cells = row.querySelectorAll("td:not(.timeCell)");
          cells.forEach((cell, idx) => {
            if (idx === amanha) {
              cell.style.background = "rgba(14,165,233,.2)";
            }
          });
        });
      });
      document.getElementById("filterSemana")?.addEventListener("click", () => {
        const rows = document.querySelectorAll("#schedTable tbody tr");
        rows.forEach(row => {
          const cells = row.querySelectorAll("td:not(.timeCell)");
          cells.forEach(cell => {
            cell.style.background = "";
          });
        });
      });

      // Modais
      document.getElementById("cancelToken")?.addEventListener("click", () => {
        document.getElementById("tokenModal").classList.add("hidden");
        currentTokenSessionId = null;
      });

      document.getElementById("saveToken")?.addEventListener("click", () => {
        if (!currentTokenSessionId) return;
        
        const tokenData = {
          sessionId: currentTokenSessionId,
          date: document.getElementById("tokenDate").value,
          patientName: document.getElementById("tokenPatient").value,
          code: document.getElementById("tokenCode").value,
          status: document.getElementById("tokenStatus").value
        };
        
        registerToken(currentTokenSessionId, tokenData);
        document.getElementById("tokenModal").classList.add("hidden");
        renderDaily();
        renderDashboard();
        generateReports();
        showAlert("‚úÖ Token registrado com sucesso!", "success");
      });

      // Configurar seletores de dia
      document.querySelectorAll('.weekday-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const freq = document.getElementById("packFrequency")?.value;
          if (freq !== "2") return;
          
          const selected = document.querySelectorAll('.weekday-btn.selected').length;
          if (btn.classList.contains('selected')) {
            btn.classList.remove('selected');
          } else if (selected < 2) {
            btn.classList.add('selected');
          } else {
            showAlert("Selecione apenas 2 dias para 2x por semana", "warning");
          }
        });
      });

      document.getElementById("packFrequency")?.addEventListener("change", toggleWeekdaySelector);

      document.getElementById("cancelPack")?.addEventListener("click", () => {
        document.getElementById("packModal").classList.add("hidden");
        currentPackPatientId = null;
      });

      document.getElementById("savePack")?.addEventListener("click", () => {
        if (!currentPackPatientId) return;
        
        const patient = getPatientById(currentPackPatientId);
        const startDate = document.getElementById("packStartDate").value;
        const totalSessions = parseInt(document.getElementById("packTotal").value);
        const frequency = parseInt(document.getElementById("packFrequency").value);
        const time = document.getElementById("packTime").value;
        
        let weekdays = [];
        if (frequency === 2) {
          weekdays = Array.from(document.querySelectorAll('.weekday-btn.selected'))
            .map(btn => parseInt(btn.dataset.day));
          
          if (weekdays.length !== 2) {
            showAlert("Selecione exatamente 2 dias para 2x por semana", "warning");
            return;
          }
        } else {
          weekdays = [new Date(startDate).getDay()];
        }
        
        const packConfig = {
          patientId: currentPackPatientId,
          patientName: patient.name,
          serviceType: patient.serviceType,
          startDate: startDate,
          totalSessions: totalSessions,
          frequency: frequency,
          weekdays: weekdays,
          time: time,
          createdAt: new Date().toISOString()
        };
        
        savePatientPack(currentPackPatientId, packConfig);
        
        // Gerar agenda autom√°tica
        generatePackSchedule(currentPackPatientId, packConfig);
        
        document.getElementById("packModal").classList.add("hidden");
        
        if (openedPatientId === currentPackPatientId) {
          openPatientFolder(currentPackPatientId);
        }
        
        renderSchedule();
        renderDashboard();
        generateReports();
        showAlert("‚úÖ Configura√ß√£o do pacote salva com sucesso!", "success");
        
        currentPackPatientId = null;
      });

      // Atalhos
      document.getElementById("shortcutsHint")?.addEventListener("click", () => {
        document.getElementById("shortcutsPanel").classList.toggle("hidden");
      });

      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey) {
          switch (e.key) {
            case "n":
              e.preventDefault();
              setTab("patients");
              document.getElementById("cName")?.focus();
              break;
            case "f":
              e.preventDefault();
              if (document.getElementById("viewDaily").classList.contains("hidden")) {
                setTab("daily");
              }
              document.getElementById("search")?.focus();
              break;
            case "1":
              e.preventDefault();
              setTab("dashboard");
              break;
            case "2":
              e.preventDefault();
              setTab("daily");
              break;
            case "3":
              e.preventDefault();
              setTab("patients");
              break;
            case "4":
              e.preventDefault();
              setTab("schedule");
              renderSchedule();
              break;
          }
        }
      });

      // Carregar dados iniciais
      renderPatientSelect();
      renderDaily();
      renderPatientFolders();
      renderSchedule();
      renderDashboard();
      generateReports();

      // Backup autom√°tico a cada 5 minutos
      if (autoBackup) {
        setInterval(() => {
          createAutoBackup();
        }, 5 * 60 * 1000);
      }
    }

    // ========== FUN√á√ïES AUXILIARES (ser√£o definidas aqui) ==========
    // ... (todas as outras fun√ß√µes do sistema)

    // Iniciar quando a p√°gina carregar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
