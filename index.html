<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ClÃ­nicaHub â€” Sistema Completo</title>
  <style>
    :root {
      --bg: #0a0f1c;
      --card: #141b2b;
      --line: rgba(255, 255, 255, 0.12);
      --text: #e2eaff;
      --muted: #9aa9c7;
      --pri: #0ea5e9;
      --bad: #ef4444;
      --ok: #22c55e;
      --warn: #f59e0b;
      --info: #8b5cf6;
      --r: 14px;
    }

    .light-mode {
      --bg: #f0f4fa;
      --card: #ffffff;
      --line: rgba(0, 0, 0, 0.12);
      --text: #1e293b;
      --muted: #64748b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      transition: .3s;
    }

    .hidden {
      display: none !important;
    }

    .muted {
      color: var(--muted);
      font-size: .92rem;
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: .85rem;
      margin-right: 6px;
      margin-top: 6px;
    }

    .pill.ok {
      border-color: rgba(34, 197, 94, .35);
      background: rgba(34, 197, 94, .12);
    }

    .pill.bad {
      border-color: rgba(239, 68, 68, .35);
      background: rgba(239, 68, 68, .12);
    }

    button {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .06);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: .2s;
      font-size: .95rem;
    }

    button:hover {
      background: rgba(255, 255, 255, .12);
    }

    button.primary {
      border-color: rgba(14, 165, 233, .5);
      background: rgba(14, 165, 233, .25);
    }

    button.danger {
      border-color: rgba(239, 68, 68, .5);
      background: rgba(239, 68, 68, .18);
    }

    button.small {
      padding: 8px 12px;
      font-size: .9rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .06);
      color: var(--text);
      outline: none;
      font-family: inherit;
      font-size: .95rem;
    }

    input:focus, select:focus, textarea:focus {
      border-color: rgba(14, 165, 233, .5);
      box-shadow: 0 0 0 2px rgba(14, 165, 233, .2);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    label {
      display: block;
      margin: 0 0 6px;
      color: var(--muted);
      font-size: .9rem;
    }

    hr {
      border: none;
      border-top: 1px solid var(--line);
      margin: 14px 0;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 16px 24px;
      border-bottom: 1px solid var(--line);
      flex-wrap: wrap;
      background: rgba(0, 0, 0, .2);
    }

    h1 {
      margin: 0;
      font-size: 1.3rem;
    }

    main {
      padding: 20px;
      display: grid;
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r);
      padding: 18px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: end;
    }

    .row>* {
      flex: 1 1 200px;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    @media(max-width:900px) {
      .grid2 {
        grid-template-columns: 1fr;
      }
    }

    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tab {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .04);
      padding: 10px 16px;
    }

    .tab.active {
      border-color: rgba(14, 165, 233, .45);
      background: rgba(14, 165, 233, .18);
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }

    .item {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .03);
      border-radius: 14px;
      padding: 15px;
    }

    .item.clickable {
      cursor: pointer;
    }

    .item.clickable:hover {
      background: rgba(255, 255, 255, .08);
      border-color: var(--pri);
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .split {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 15px;
    }

    @media(max-width:1000px) {
      .split {
        grid-template-columns: 1fr;
      }
    }

    .backup-bar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      background: rgba(14, 165, 233, .1);
      border: 1px solid rgba(14, 165, 233, .3);
      border-radius: 40px;
      padding: 8px 15px;
      margin-right: 10px;
    }

    .folder-header {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--line);
    }

    .folder-actions {
      display: flex;
      gap: 8px;
      margin-left: auto;
      flex-wrap: wrap;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .info-item {
      background: rgba(255, 255, 255, .03);
      border-radius: 10px;
      padding: 10px;
    }

    .info-label {
      font-size: .8rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .info-value {
      font-weight: 600;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, .1);
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--pri);
      transition: width .3s;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, .7);
      backdrop-filter: blur(3px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 25px;
      max-width: 500px;
      width: 90%;
    }

    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 12px;
      background: var(--card);
      border: 1px solid var(--pri);
      z-index: 2000;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .schedWrap {
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 14px;
      max-height: 600px;
    }

    table.sched {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
    }

    .sched th, .sched td {
      border: 1px solid rgba(255, 255, 255, .10);
      padding: 12px;
    }

    .timeCell {
      position: sticky;
      left: 0;
      background: rgba(255, 255, 255, .04);
      font-weight: 800;
    }

    .slotGreen { background: rgba(34, 197, 94, .15); }
    .slotAmber { background: rgba(245, 158, 11, .15); }
    .slotRed { background: rgba(239, 68, 68, .15); }
  </style>
</head>

<body>
  <section id="appWrap">
    <header>
      <div style="display:flex; align-items:center; gap:15px;">
        <h1>ğŸ¥ ClÃ­nicaHub</h1>
        <div id="today" class="muted"></div>
        <button id="themeToggle" class="small">ğŸŒ“ Tema</button>
      </div>

      <div style="display:flex; gap:10px;">
        <div class="backup-bar">
          <button id="backupNow" class="small">â¬‡ï¸ Backup</button>
          <button id="restoreBackup" class="small">ğŸ“‚ Restaurar</button>
        </div>

        <div class="tabs">
          <button class="tab active" id="tabDashboard">ğŸ“Š Dashboard</button>
          <button class="tab" id="tabDaily">ğŸ“… DiÃ¡rio</button>
          <button class="tab" id="tabPatients">ğŸ‘¥ Pacientes</button>
          <button class="tab" id="tabSchedule">ğŸ“† Agenda</button>
        </div>
      </div>
    </header>

    <main>
      <!-- DASHBOARD -->
      <section id="viewDashboard" class="card">
        <h2>ğŸ“Š Dashboard</h2>
        <div id="dashContent">Carregando...</div>
      </section>

      <!-- DIÃRIO -->
      <section id="viewDaily" class="card hidden">
        <div class="row">
          <div>
            <label>Data</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label>Buscar</label>
            <input id="search" placeholder="Nome..." />
          </div>
          <button id="findInDay" class="small primary">ğŸ”</button>
          <button id="clearDay" class="small danger">ğŸ—‘ï¸</button>
        </div>

        <div class="row">
          <div>
            <label>Paciente</label>
            <select id="pPatient"></select>
          </div>
          <div>
            <label>HorÃ¡rio</label>
            <input id="pTime" placeholder="14:30" />
          </div>
          <div>
            <label>SessÃ£o</label>
            <select id="pDid">
              <option value="realizou">âœ… Realizou</option>
              <option value="nao">âŒ NÃ£o realizou</option>
            </select>
          </div>
          <div>
            <label>Pagamento</label>
            <select id="pPaid">
              <option value="nao_pago">ğŸ’¸ NÃ£o pago</option>
              <option value="pago">ğŸ’° Pago</option>
            </select>
          </div>
        </div>

        <button id="addSession" class="primary" style="margin:10px 0;">â• Adicionar</button>
        <div id="dayList" class="list"></div>
      </section>

      <!-- PACIENTES -->
      <section id="viewPatients" class="card hidden">
        <div class="split">
          <!-- Cadastro -->
          <div class="card">
            <h3>ğŸ‘¤ Cadastro</h3>
            <input id="cName" placeholder="Nome completo" style="margin-bottom:10px;" />
            <input id="cPhone" placeholder="WhatsApp" style="margin-bottom:10px;" />
            <select id="cServiceType" style="margin-bottom:10px;">
              <option value="particular">Particular</option>
              <option value="cassems">Cassems</option>
            </select>
            <input id="cDefaultValue" placeholder="Valor padrÃ£o" style="margin-bottom:10px;" />
            <textarea id="cNotes" placeholder="ObservaÃ§Ãµes" rows="3"></textarea>
            <button id="addPatient" class="primary" style="margin-top:10px;">ğŸ’¾ Salvar</button>
          </div>

          <!-- Lista -->
          <div class="card">
            <div id="foldersPane">
              <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input id="pSearch" placeholder="Buscar paciente..." style="flex:1;" />
                <button id="onlyDebtFolders" class="small">ğŸ’¸ Com dÃ©bito</button>
              </div>
              <div id="patientFolders" class="list"></div>
            </div>

            <!-- PASTA DO PACIENTE -->
            <div id="folderOpenPane" class="hidden">
              <div class="folder-header">
                <button id="backToFolders" class="small">â† Voltar</button>
                <h3 id="openPatientTitle">Paciente</h3>
                <div class="folder-actions">
                  <button id="btnAnamnese" class="small info">ğŸ“‹ Anamnese</button>
                  <button id="btnEvolucao" class="small primary">ğŸ“ˆ EvoluÃ§Ã£o</button>
                  <button id="btnMetas" class="small warn">ğŸ¯ Metas</button>
                  <button id="openWhats" class="small">ğŸ“± WhatsApp</button>
                  <button id="deletePatient" class="small danger">ğŸ—‘ï¸</button>
                </div>
              </div>

              <div id="patientInfo" class="info-grid"></div>
              <div id="pacoteProgresso" style="margin:15px 0;"></div>

              <div style="display:flex; gap:10px; margin:15px 0;">
                <button class="tab active" id="tabHistory">ğŸ“‹ HistÃ³rico</button>
                <button class="tab" id="tabEvolution">ğŸ“ˆ EvoluÃ§Ã£o</button>
                <button class="tab" id="tabGoals">ğŸ¯ Metas</button>
              </div>

              <div id="tabHistoryContent">
                <div id="patientHistory" class="list"></div>
              </div>
              <div id="tabEvolutionContent" class="hidden">
                <button id="addEvolucao" class="primary small">â• Nova EvoluÃ§Ã£o</button>
                <div id="evolutionList" class="list" style="margin-top:10px;"></div>
              </div>
              <div id="tabGoalsContent" class="hidden">
                <button id="addMeta" class="primary small">â• Nova Meta</button>
                <div id="goalsList" class="list" style="margin-top:10px;"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- AGENDA -->
      <section id="viewSchedule" class="card hidden">
        <div class="row">
          <div>
            <label>Data</label>
            <input id="schedRef" type="date" />
          </div>
          <div>
            <label>Novo horÃ¡rio</label>
            <div style="display:flex; gap:8px;">
              <input id="newTime" placeholder="07:00" />
              <button id="addTime" class="small primary">â•</button>
            </div>
          </div>
        </div>
        <div class="schedWrap">
          <table class="sched" id="schedTable"></table>
        </div>
      </section>
    </main>
  </section>

  <!-- MODAIS -->
  <div id="anamneseModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3>ğŸ“‹ Anamnese</h3>
      <textarea id="aQueixa" placeholder="Queixa principal" rows="2" style="margin:10px 0;"></textarea>
      <textarea id="aHistorico" placeholder="HistÃ³rico" rows="3" style="margin:10px 0;"></textarea>
      <textarea id="aObs" placeholder="ObservaÃ§Ãµes" rows="3" style="margin:10px 0;"></textarea>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="closeAnamnese" class="small">Fechar</button>
        <button id="saveAnamnese" class="primary small">Salvar</button>
      </div>
    </div>
  </div>

  <div id="evolucaoModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3>ğŸ“ˆ Nova EvoluÃ§Ã£o</h3>
      <input type="date" id="evoData" style="margin:10px 0;" />
      <textarea id="evoTexto" placeholder="Descreva a evoluÃ§Ã£o..." rows="4" style="margin:10px 0;"></textarea>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="cancelEvo" class="small">Cancelar</button>
        <button id="saveEvo" class="primary small">Salvar</button>
      </div>
    </div>
  </div>

  <div id="metaModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3>ğŸ¯ Nova Meta</h3>
      <input id="metaDesc" placeholder="DescriÃ§Ã£o da meta" style="margin:10px 0;" />
      <input type="date" id="metaPrazo" style="margin:10px 0;" />
      <select id="metaStatus" style="margin:10px 0;">
        <option value="em_andamento">â³ Em andamento</option>
        <option value="concluida">âœ… ConcluÃ­da</option>
      </select>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="cancelMeta" class="small">Cancelar</button>
        <button id="saveMeta" class="primary small">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIGURAÃ‡Ã•ES ==========
    const KEYS = {
      PATIENTS: "clinica_patients",
      SESSIONS: "clinica_sessions",
      SCHEDULE: "clinica_schedule",
      EVOLUTIONS: "clinica_evolutions",
      GOALS: "clinica_goals"
    };

    const DAYS = ["Seg", "Ter", "Qua", "Qui", "Sex", "SÃ¡b", "Dom"];
    let openedPatientId = null;

    const $ = id => document.getElementById(id);

    // ========== UTILITÃRIOS ==========
    function uid() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function todayISO() {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function fmtMoney(val) {
      return Number(val || 0).toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
    }

    function escapeHtml(str) {
      return String(str || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function saveData(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }

    function loadData(key, def = null) {
      try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; }
    }

    function showAlert(msg, type = "info") {
      const alert = document.createElement("div");
      alert.className = "alert";
      alert.innerHTML = msg;
      alert.style.background = type === "success" ? "rgba(34,197,94,.2)" : "rgba(14,165,233,.2)";
      document.body.appendChild(alert);
      setTimeout(() => alert.remove(), 2000);
    }

    // ========== PACIENTES ==========
    function loadPatients() { return loadData(KEYS.PATIENTS, []); }
    function savePatients(p) { saveData(KEYS.PATIENTS, p); }

    function getPatientById(id) {
      return loadPatients().find(p => p.id === id);
    }

    // ========== SESSÃ•ES ==========
    function loadSessions() { return loadData(KEYS.SESSIONS, []); }
    function saveSessions(s) { saveData(KEYS.SESSIONS, s); }

    // ========== EVOLUÃ‡Ã•ES ==========
    function loadEvolutions(pid) {
      const all = loadData(KEYS.EVOLUTIONS, {});
      return all[pid] || [];
    }

    function saveEvolutions(pid, evos) {
      const all = loadData(KEYS.EVOLUTIONS, {});
      all[pid] = evos;
      saveData(KEYS.EVOLUTIONS, all);
    }

    // ========== METAS ==========
    function loadGoals(pid) {
      const all = loadData(KEYS.GOALS, {});
      return all[pid] || [];
    }

    function saveGoals(pid, goals) {
      const all = loadData(KEYS.GOALS, {});
      all[pid] = goals;
      saveData(KEYS.GOALS, all);
    }

    // ========== AGENDA ==========
    function loadSchedule() {
      return loadData(KEYS.SCHEDULE, { times: ["07:00","08:00","09:00","10:00","11:00","13:00","14:00","15:00","16:00"], recurring: {} });
    }
    function saveSchedule(s) { saveData(KEYS.SCHEDULE, s); }
    function recurKey(day, time) { return `${day}|${time}`; }

    // ========== RENDERIZAÃ‡ÃƒO ==========
    function renderPatientSelect() {
      const pats = loadPatients();
      const sel = $("pPatient");
      sel.innerHTML = pats.length ? pats.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("") : '<option value="">(Nenhum)</option>';
    }

    function renderDaily() {
      const date = $("date").value;
      const search = $("search").value.toLowerCase();
      const sessions = loadSessions().filter(s => s.date === date);
      
      $("dayList").innerHTML = sessions.filter(s => {
        const p = getPatientById(s.patientId);
        return !search || (p?.name || "").toLowerCase().includes(search);
      }).map(s => {
        const p = getPatientById(s.patientId);
        return `<div class="item">
          <b>${s.time || "â€”"} - ${escapeHtml(p?.name || "?")}</b>
          <div class="muted">${s.did === "realizou" ? "âœ…" : "âŒ"} ${s.paid === "pago" ? "ğŸ’°" : "ğŸ’¸"}</div>
          <div class="actions">
            <button class="small" onclick="toggleSessionDid('${s.id}')">ğŸ”„</button>
            <button class="small" onclick="toggleSessionPaid('${s.id}')">ğŸ’°</button>
            <button class="small danger" onclick="deleteSession('${s.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>`;
      }).join("") || "<div class='muted'>Nenhuma sessÃ£o</div>";
    }

    window.toggleSessionDid = (id) => {
      const sessions = loadSessions();
      const idx = sessions.findIndex(s => s.id === id);
      if (idx >= 0) {
        sessions[idx].did = sessions[idx].did === "realizou" ? "nao" : "realizou";
        saveSessions(sessions);
        renderDaily();
        showAlert("âœ… Atualizado", "success");
      }
    };

    window.toggleSessionPaid = (id) => {
      const sessions = loadSessions();
      const idx = sessions.findIndex(s => s.id === id);
      if (idx >= 0) {
        sessions[idx].paid = sessions[idx].paid === "pago" ? "nao_pago" : "pago";
        saveSessions(sessions);
        renderDaily();
        showAlert("ğŸ’° Atualizado", "success");
      }
    };

    window.deleteSession = (id) => {
      if (confirm("Excluir?")) {
        saveSessions(loadSessions().filter(s => s.id !== id));
        renderDaily();
        showAlert("ğŸ—‘ï¸ ExcluÃ­do", "success");
      }
    };

    function renderPatientFolders() {
      const search = $("pSearch").value.toLowerCase();
      const pats = loadPatients().filter(p => !search || p.name.toLowerCase().includes(search));
      
      $("patientFolders").innerHTML = pats.map(p => {
        const sessions = loadSessions().filter(s => s.patientId === p.id);
        const debt = sessions.filter(s => s.paid !== "pago").reduce((s, r) => s + (Number(r.value)||0), 0);
        return `<div class="item clickable" onclick="openPatientFolder('${p.id}')">
          <b>ğŸ“ ${escapeHtml(p.name)}</b>
          <div class="muted">${sessions.length} sessÃµes</div>
          ${debt > 0 ? `<span class="pill bad">ğŸ’° ${fmtMoney(debt)}</span>` : ''}
        </div>`;
      }).join("") || "<div class='muted'>Nenhum paciente</div>";
    }

    // FUNÃ‡ÃƒO PRINCIPAL - Abre a pasta do paciente
    window.openPatientFolder = (id) => {
      openedPatientId = id;
      const p = getPatientById(id);
      
      // Mostrar pasta
      $("foldersPane").classList.add("hidden");
      $("folderOpenPane").classList.remove("hidden");
      $("openPatientTitle").textContent = `ğŸ“ ${p?.name || "Paciente"}`;

      // InformaÃ§Ãµes bÃ¡sicas
      const sessions = loadSessions().filter(s => s.patientId === id);
      $("patientInfo").innerHTML = `
        <div class="info-item"><span class="info-label">ConvÃªnio</span><span class="info-value">${p?.serviceType || "Particular"}</span></div>
        <div class="info-item"><span class="info-label">WhatsApp</span><span class="info-value">${p?.phone || "â€”"}</span></div>
        <div class="info-item"><span class="info-label">SessÃµes</span><span class="info-value">${sessions.length}</span></div>
        <div class="info-item"><span class="info-label">DÃ©bito</span><span class="info-value">${fmtMoney(sessions.filter(s => s.paid !== "pago").reduce((s,r)=>s+(Number(r.value)||0),0))}</span></div>
      `;

      // HistÃ³rico
      renderPatientHistory();

      // EvoluÃ§Ãµes
      renderEvolucoes();

      // Metas
      renderMetas();

      // Progresso do pacote
      const schedule = loadSchedule();
      let pacoteHtml = "Sem pacote ativo";
      Object.entries(schedule.recurring || {}).forEach(([key, entry]) => {
        if (entry.patientId === id && entry.plannedTotal > 1) {
          const realizadas = sessions.filter(s => s.did === "realizou" && s.date >= entry.startDate).length;
          const percent = (realizadas / entry.plannedTotal) * 100;
          pacoteHtml = `
            <b>ğŸ“¦ Pacote ${entry.plannedTotal}</b>
            <div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div>
            <div>${realizadas}/${entry.plannedTotal} realizadas</div>
          `;
        }
      });
      $("pacoteProgresso").innerHTML = pacoteHtml;
    };

    function renderPatientHistory() {
      if (!openedPatientId) return;
      const sessions = loadSessions().filter(s => s.patientId === openedPatientId).sort((a,b) => b.date.localeCompare(a.date));
      $("patientHistory").innerHTML = sessions.map(s => `
        <div class="item">
          <b>${s.date} ${s.time || ""}</b>
          <div class="muted">${s.did === "realizou" ? "âœ…" : "âŒ"} ${s.paid === "pago" ? "ğŸ’°" : "ğŸ’¸"} ${fmtMoney(s.value)}</div>
        </div>
      `).join("") || "<div class='muted'>Nenhuma sessÃ£o</div>";
    }

    function renderEvolucoes() {
      if (!openedPatientId) return;
      const evos = loadEvolutions(openedPatientId).sort((a,b) => b.date.localeCompare(a.date));
      $("evolutionList").innerHTML = evos.map(e => `
        <div class="item">
          <b>${e.date}</b>
          <div class="muted">${escapeHtml(e.text)}</div>
          <button class="small danger" onclick="deleteEvolucao('${e.id}')">ğŸ—‘ï¸</button>
        </div>
      `).join("") || "<div class='muted'>Nenhuma evoluÃ§Ã£o</div>";
    }

    window.deleteEvolucao = (id) => {
      if (!openedPatientId) return;
      saveEvolutions(openedPatientId, loadEvolutions(openedPatientId).filter(e => e.id !== id));
      renderEvolucoes();
      showAlert("âœ… Removida", "success");
    };

    function renderMetas() {
      if (!openedPatientId) return;
      const goals = loadGoals(openedPatientId);
      $("goalsList").innerHTML = goals.map(g => `
        <div class="item">
          <b>${escapeHtml(g.description)}</b>
          <div class="muted">${g.status === "concluida" ? "âœ…" : "â³"} Prazo: ${g.deadline || "â€”"}</div>
          <div class="actions">
            <button class="small" onclick="toggleMetaStatus('${g.id}')">â†»</button>
            <button class="small danger" onclick="deleteMeta('${g.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join("") || "<div class='muted'>Nenhuma meta</div>";
    }

    window.toggleMetaStatus = (id) => {
      if (!openedPatientId) return;
      const goals = loadGoals(openedPatientId);
      const idx = goals.findIndex(g => g.id === id);
      if (idx >= 0) {
        goals[idx].status = goals[idx].status === "em_andamento" ? "concluida" : "em_andamento";
        saveGoals(openedPatientId, goals);
        renderMetas();
        showAlert("âœ… Status atualizado", "success");
      }
    };

    window.deleteMeta = (id) => {
      if (!openedPatientId) return;
      saveGoals(openedPatientId, loadGoals(openedPatientId).filter(g => g.id !== id));
      renderMetas();
      showAlert("âœ… Removida", "success");
    };

    // ========== AÃ‡Ã•ES DOS BOTÃ•ES ==========
    $("backToFolders").addEventListener("click", () => {
      openedPatientId = null;
      $("folderOpenPane").classList.add("hidden");
      $("foldersPane").classList.remove("hidden");
    });

    $("btnAnamnese").addEventListener("click", () => {
      const p = getPatientById(openedPatientId);
      if (p) {
        $("aQueixa").value = p.anamnese?.queixa || "";
        $("aHistorico").value = p.anamnese?.historico || "";
        $("aObs").value = p.anamnese?.obs || "";
        $("anamneseModal").classList.remove("hidden");
      }
    });

    $("closeAnamnese").addEventListener("click", () => {
      $("anamneseModal").classList.add("hidden");
    });

    $("saveAnamnese").addEventListener("click", () => {
      const patients = loadPatients();
      const idx = patients.findIndex(p => p.id === openedPatientId);
      if (idx >= 0) {
        patients[idx].anamnese = {
          queixa: $("aQueixa").value,
          historico: $("aHistorico").value,
          obs: $("aObs").value
        };
        savePatients(patients);
        $("anamneseModal").classList.add("hidden");
        showAlert("âœ… Anamnese salva", "success");
      }
    });

    $("btnEvolucao").addEventListener("click", () => {
      $("evoData").value = todayISO();
      $("evolucaoModal").classList.remove("hidden");
    });

    $("cancelEvo").addEventListener("click", () => {
      $("evolucaoModal").classList.add("hidden");
    });

    $("saveEvo").addEventListener("click", () => {
      if (!openedPatientId) return;
      const data = $("evoData").value;
      const texto = $("evoTexto").value.trim();
      if (!data || !texto) {
        showAlert("âŒ Preencha todos os campos", "error");
        return;
      }
      const evos = loadEvolutions(openedPatientId);
      evos.push({ id: uid(), date: data, text: texto });
      saveEvolutions(openedPatientId, evos);
      $("evolucaoModal").classList.add("hidden");
      $("evoTexto").value = "";
      renderEvolucoes();
      showAlert("âœ… EvoluÃ§Ã£o salva", "success");
    });

    $("btnMetas").addEventListener("click", () => {
      $("metaModal").classList.remove("hidden");
    });

    $("cancelMeta").addEventListener("click", () => {
      $("metaModal").classList.add("hidden");
    });

    $("saveMeta").addEventListener("click", () => {
      if (!openedPatientId) return;
      const desc = $("metaDesc").value.trim();
      if (!desc) {
        showAlert("âŒ DescriÃ§Ã£o obrigatÃ³ria", "error");
        return;
      }
      const goals = loadGoals(openedPatientId);
      goals.push({
        id: uid(),
        description: desc,
        deadline: $("metaPrazo").value,
        status: "em_andamento"
      });
      saveGoals(openedPatientId, goals);
      $("metaModal").classList.add("hidden");
      $("metaDesc").value = "";
      renderMetas();
      showAlert("âœ… Meta salva", "success");
    });

    $("openWhats").addEventListener("click", () => {
      const p = getPatientById(openedPatientId);
      if (p?.phone) {
        window.open(`https://wa.me/55${p.phone}`, "_blank");
      } else {
        showAlert("âŒ Sem WhatsApp", "error");
      }
    });

    $("deletePatient").addEventListener("click", () => {
      if (!openedPatientId || !confirm("Excluir paciente?")) return;
      
      savePatients(loadPatients().filter(p => p.id !== openedPatientId));
      saveSessions(loadSessions().filter(s => s.patientId !== openedPatientId));
      
      const sch = loadSchedule();
      if (sch.recurring) {
        Object.keys(sch.recurring).forEach(key => {
          if (sch.recurring[key].patientId === openedPatientId) delete sch.recurring[key];
        });
        saveSchedule(sch);
      }
      
      openedPatientId = null;
      $("folderOpenPane").classList.add("hidden");
      $("foldersPane").classList.remove("hidden");
      renderPatientFolders();
      renderPatientSelect();
      showAlert("ğŸ—‘ï¸ Paciente excluÃ­do", "success");
    });

    // ========== ABAS ==========
    $("tabHistory").addEventListener("click", () => {
      $("tabHistory").classList.add("active");
      $("tabEvolution").classList.remove("active");
      $("tabGoals").classList.remove("active");
      $("tabHistoryContent").classList.remove("hidden");
      $("tabEvolutionContent").classList.add("hidden");
      $("tabGoalsContent").classList.add("hidden");
    });

    $("tabEvolution").addEventListener("click", () => {
      $("tabHistory").classList.remove("active");
      $("tabEvolution").classList.add("active");
      $("tabGoals").classList.remove("active");
      $("tabHistoryContent").classList.add("hidden");
      $("tabEvolutionContent").classList.remove("hidden");
      $("tabGoalsContent").classList.add("hidden");
      renderEvolucoes();
    });

    $("tabGoals").addEventListener("click", () => {
      $("tabHistory").classList.remove("active");
      $("tabEvolution").classList.remove("active");
      $("tabGoals").classList.add("active");
      $("tabHistoryContent").classList.add("hidden");
      $("tabEvolutionContent").classList.add("hidden");
      $("tabGoalsContent").classList.remove("hidden");
      renderMetas();
    });

    // ========== AÃ‡Ã•ES DIVERSAS ==========
    $("addPatient").addEventListener("click", () => {
      const name = $("cName").value.trim();
      if (!name) return showAlert("âŒ Nome obrigatÃ³rio", "error");

      const patient = {
        id: uid(),
        name,
        phone: $("cPhone").value,
        serviceType: $("cServiceType").value,
        defaultValue: parseFloat($("cDefaultValue").value.replace(",", ".")) || 0,
        notes: $("cNotes").value,
        anamnese: { queixa: "", historico: "", obs: "" }
      };

      const patients = loadPatients();
      patients.push(patient);
      savePatients(patients);

      $("cName").value = "";
      $("cPhone").value = "";
      $("cDefaultValue").value = "";
      $("cNotes").value = "";

      renderPatientSelect();
      renderPatientFolders();
      showAlert("âœ… Paciente cadastrado", "success");
    });

    $("addSession").addEventListener("click", () => {
      const date = $("date").value;
      const patientId = $("pPatient").value;
      const time = $("pTime").value;

      if (!date || !patientId) return showAlert("âŒ Preencha data e paciente", "error");

      const sessions = loadSessions();
      sessions.push({
        id: uid(),
        date, patientId, time,
        did: $("pDid").value,
        paid: $("pPaid").value,
        value: 80
      });
      saveSessions(sessions);
      renderDaily();
      showAlert("âœ… SessÃ£o adicionada", "success");
    });

    $("findInDay").addEventListener("click", renderDaily);
    $("clearDay").addEventListener("click", () => {
      if (confirm("Limpar dia?")) {
        saveSessions(loadSessions().filter(s => s.date !== $("date").value));
        renderDaily();
      }
    });
    $("date").addEventListener("change", renderDaily);
    $("search").addEventListener("input", renderDaily);
    $("pSearch").addEventListener("input", renderPatientFolders);
    $("onlyDebtFolders").addEventListener("click", () => {
      // Implementar filtro se desejar
    });

    // ========== AGENDA ==========
    function renderSchedule() {
      const sch = loadSchedule();
      const times = sch.times.sort();
      let html = "<thead><tr><th>HorÃ¡rio</th>" + DAYS.map(d => `<th>${d}</th>`).join("") + "</tr></thead><tbody>";
      
      for (const time of times) {
        html += `<tr><td class="timeCell">${time}</td>`;
        for (let day = 0; day < 7; day++) {
          const entry = sch.recurring?.[recurKey(day, time)];
          if (entry) {
            const p = getPatientById(entry.patientId);
            html += `<td class="slotGreen">${escapeHtml(p?.name || "?")}</td>`;
          } else {
            html += `<td class="slotRed">ğŸŸ¥ Vago</td>`;
          }
        }
        html += "</tr>";
      }
      $("schedTable").innerHTML = html;
    }

    $("addTime").addEventListener("click", () => {
      const t = $("newTime").value.trim();
      if (!t || !/^\d{1,2}:\d{2}$/.test(t)) return showAlert("âŒ Use HH:MM", "error");
      
      const sch = loadSchedule();
      if (!sch.times.includes(t)) {
        sch.times.push(t);
        sch.times.sort();
        saveSchedule(sch);
        renderSchedule();
      }
      $("newTime").value = "";
    });

    $("schedRef").addEventListener("change", renderSchedule);

    // ========== DASHBOARD ==========
    function renderDashboard() {
      const hoje = todayISO();
      const sessions = loadSessions().filter(s => s.date === hoje);
      $("dashContent").innerHTML = `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
          <div class="cardMini">Pacientes hoje: ${sessions.length}</div>
          <div class="cardMini">Realizadas: ${sessions.filter(s => s.did === "realizou").length}</div>
          <div class="cardMini">Faltas: ${sessions.filter(s => s.did === "nao").length}</div>
          <div class="cardMini">Faturamento: ${fmtMoney(sessions.filter(s => s.paid === "pago").reduce((s,r)=>s+(Number(r.value)||0),0))}</div>
        </div>
      `;
    }

    // ========== TABS PRINCIPAIS ==========
    function setTab(tab) {
      $("viewDashboard").classList.toggle("hidden", tab !== "dashboard");
      $("viewDaily").classList.toggle("hidden", tab !== "daily");
      $("viewPatients").classList.toggle("hidden", tab !== "patients");
      $("viewSchedule").classList.toggle("hidden", tab !== "schedule");

      [$("tabDashboard"), $("tabDaily"), $("tabPatients"), $("tabSchedule")].forEach(t => t.classList.remove("active"));
      $(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add("active");

      if (tab === "dashboard") renderDashboard();
      if (tab === "schedule") renderSchedule();
    }

    $("tabDashboard").addEventListener("click", () => setTab("dashboard"));
    $("tabDaily").addEventListener("click", () => setTab("daily"));
    $("tabPatients").addEventListener("click", () => setTab("patients"));
    $("tabSchedule").addEventListener("click", () => setTab("schedule"));

    // ========== TEMA ==========
    $("themeToggle").addEventListener("click", () => {
      document.body.classList.toggle("light-mode");
    });

    // ========== BACKUP ==========
    $("backupNow").addEventListener("click", () => {
      const backup = {
        patients: loadPatients(),
        sessions: loadSessions(),
        schedule: loadSchedule(),
        evolutions: loadData(KEYS.EVOLUTIONS, {}),
        goals: loadData(KEYS.GOALS, {})
      };
      const blob = new Blob([JSON.stringify(backup)], {type: "application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `backup_${todayISO()}.json`;
      a.click();
    });

    // ========== INICIALIZAÃ‡ÃƒO ==========
    function init() {
      $("date").value = todayISO();
      $("schedRef").value = todayISO();
      $("today").textContent = new Date().toLocaleDateString("pt-BR", { dateStyle: "full" });
      
      renderPatientSelect();
      renderDaily();
      renderPatientFolders();
      renderDashboard();
      renderSchedule();
    }

    init();
  </script>
</body>
</html>
