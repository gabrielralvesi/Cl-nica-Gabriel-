<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Gabriel Alves - Fonoaudiologia Infantil</title>
    
    <style>
        /* ===== PALETA DE CORES ===== */
        :root {
            --primary: #2C7A5A;
            --primary-dark: #1E5F43;
            --primary-light: #4CAF7A;
            --secondary: #162B32;
            --accent: #E8C66A;
            --bg: #0F1A1F;
            --card: #1E2E36;
            --line: rgba(255, 255, 255, 0.1);
            --text: #FFFFFF;
            --muted: #B0C4CE;
            --bad: #EF4444;
            --ok: #2C7A5A;
            --warn: #E8C66A;
            --info: #4A90E2;
            --token: #E8C66A;
            --r: 14px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        .hidden {
            display: none !important;
        }

        .muted {
            color: var(--muted);
            font-size: 0.92rem;
        }

        .pill {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 999px;
            border: 1px solid var(--line);
            font-size: 0.85rem;
            margin-right: 6px;
            margin-top: 6px;
            background: rgba(255, 255, 255, 0.03);
        }

        .pill.ok {
            border-color: var(--primary);
            background: rgba(44, 122, 90, 0.15);
        }

        .pill.bad {
            border-color: var(--bad);
            background: rgba(239, 68, 68, 0.15);
        }

        .pill.token {
            border-color: var(--accent);
            background: rgba(232, 198, 106, 0.15);
        }

        .pill.warn {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.15);
        }

        button {
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            min-height: 44px;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        button:active {
            transform: scale(0.98);
        }

        button.primary {
            border-color: var(--primary);
            background: rgba(44, 122, 90, 0.25);
        }

        button.danger {
            border-color: var(--bad);
            background: rgba(239, 68, 68, 0.18);
        }

        button.small {
            padding: 8px 12px;
            font-size: 0.9rem;
            min-height: 36px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            outline: none;
            font-family: inherit;
            font-size: 0.95rem;
            min-height: 44px;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(44, 122, 90, 0.2);
        }

        label {
            display: block;
            margin: 0 0 6px;
            color: var(--muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        hr {
            border: none;
            border-top: 1px solid var(--line);
            margin: 16px 0;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--line);
            flex-wrap: wrap;
            background: var(--card);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .logo-text h2 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--primary-light);
        }

        .logo-text p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--muted);
        }

        .backup-bar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            background: rgba(44, 122, 90, 0.1);
            border: 1px solid rgba(44, 122, 90, 0.3);
            border-radius: 40px;
            padding: 6px 12px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tab {
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.04);
            padding: 10px 16px;
        }

        .tab.active {
            border-color: var(--primary);
            background: rgba(44, 122, 90, 0.18);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--r);
            padding: 18px;
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .row > * {
            flex: 1 1 200px;
        }

        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        @media (max-width: 900px) {
            .grid2 {
                grid-template-columns: 1fr;
            }
        }

        .grid3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        @media (max-width: 900px) {
            .grid3 {
                grid-template-columns: 1fr;
            }
        }

        .sum {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .sum .cardMini {
            flex: 1 1 250px;
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 14px;
            background: rgba(255, 255, 255, 0.03);
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .item {
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.03);
            border-radius: 14px;
            padding: 15px;
        }

        .item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .split {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 15px;
        }

        @media (max-width: 1000px) {
            .split {
                grid-template-columns: 1fr;
            }
        }

        .photo-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .photo-preview {
            width: 120px;
            height: 120px;
            border-radius: 60px;
            border: 3px solid var(--primary);
            object-fit: cover;
        }

        .photo-preview.small {
            width: 40px;
            height: 40px;
            border-width: 2px;
        }

        .photo-placeholder {
            width: 120px;
            height: 120px;
            border-radius: 60px;
            background: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            border: 3px solid var(--primary);
        }

        .time-list {
            margin-top: 10px;
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 10px;
        }

        .time-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid var(--line);
        }

        .time-item:last-child {
            border-bottom: none;
        }

        .time-item input, .time-item select {
            min-height: 36px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 18px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .circular-progress {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(var(--primary) 0deg, var(--card) 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .circular-progress::before {
            content: "";
            position: absolute;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--card);
        }

        .progress-value {
            position: relative;
            z-index: 1;
            font-weight: bold;
            color: var(--primary);
        }

        .token-counter {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 10px;
            background: rgba(232, 198, 106, 0.1);
            border-radius: 10px;
            margin: 10px 0;
        }

        .token-badge {
            padding: 5px 10px;
            border-radius: 20px;
            background: var(--accent);
            color: var(--secondary);
            font-weight: bold;
        }

        .token-progress {
            flex: 1;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .token-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .schedWrap {
            overflow-x: auto;
            overflow-y: auto;
            border: 1px solid var(--line);
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.02);
            max-height: 600px;
            -webkit-overflow-scrolling: touch;
        }

        table.sched {
            border-collapse: collapse;
            width: 100%;
            min-width: 900px;
        }

        .sched th, .sched td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px;
            vertical-align: top;
        }

        .sched th {
            background: rgba(255, 255, 255, 0.04);
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .sched td {
            min-width: 150px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .sched td:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .timeCell {
            position: sticky;
            left: 0;
            z-index: 1;
            background: rgba(255, 255, 255, 0.04);
            font-weight: 800;
        }

        .slotBox {
            border-radius: 10px;
            padding: 10px;
            height: 100%;
        }

        .slotGreen {
            background: rgba(44, 122, 90, 0.15);
            border-left: 4px solid var(--primary);
        }

        .slotAmber {
            background: rgba(232, 198, 106, 0.15);
            border-left: 4px solid var(--accent);
        }

        .slotRed {
            background: rgba(239, 68, 68, 0.15);
            border-left: 4px solid var(--bad);
        }

        .slotBlue {
            background: rgba(74, 144, 226, 0.15);
            border-left: 4px solid var(--info);
        }

        .slotPurple {
            background: rgba(139, 92, 246, 0.15);
            border-left: 4px solid #8b5cf6;
        }

        .slot-counter {
            font-size: 0.8rem;
            margin-top: 5px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .slot-counter span {
            padding: 2px 5px;
            border-radius: 4px;
            background: rgba(0,0,0,0.2);
        }

        .weekday-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .weekday-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.06);
            cursor: pointer;
            font-weight: 600;
        }

        .weekday-btn.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }

        .modal-content {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 20px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 12px;
            background: var(--card);
            border: 1px solid var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            max-width: 90%;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .shortcuts-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 40px;
            padding: 10px 18px;
            font-size: 0.9rem;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .shortcuts-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 18px;
            width: 280px;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--line);
        }

        .shortcut-key {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: monospace;
        }

        .timeline-item {
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }

        .timeline-date {
            color: var(--primary-light);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .timeline-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Input oculto para importar arquivo -->
    <input type="file" id="importFile" accept=".json" style="display:none">

    <!-- MODAIS -->
    <div id="notificationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="margin-bottom:15px;">üîî Ativar Notifica√ß√µes</h3>
            <p class="muted">Quer receber lembretes dos pr√≥ximos atendimentos?</p>
            <p class="muted" style="margin:10px 0;">Voc√™ ser√° avisado 15 minutos antes de cada sess√£o.</p>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                <button id="cancelNotification" class="small">Agora n√£o</button>
                <button id="enableNotifications" class="primary small">üîî Ativar</button>
            </div>
        </div>
    </div>

    <div id="anamneseModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>üìã Anamnese</h3>
            <div style="margin:15px 0;">
                <label>Queixa principal</label>
                <textarea id="aQueixa" rows="2"></textarea>
            </div>
            <div style="margin:15px 0;">
                <label>Hist√≥rico</label>
                <textarea id="aHistorico" rows="2"></textarea>
            </div>
            <div style="margin:15px 0;">
                <label>Observa√ß√µes</label>
                <textarea id="aObs" rows="3"></textarea>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button id="closeAnamnese" class="small">Fechar</button>
                <button id="saveAnamnese" class="primary small">Salvar</button>
            </div>
        </div>
    </div>

    <div id="tokenModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>üé´ Registrar Token Cassems</h3>
            <p class="muted">Registre o token de autoriza√ß√£o enviado pelo paciente</p>
            
            <div style="margin:15px 0;">
                <label>Data da sess√£o</label>
                <input type="date" id="tokenDate" readonly />
            </div>
            <div style="margin:15px 0;">
                <label>Paciente</label>
                <input type="text" id="tokenPatient" readonly />
            </div>
            <div style="margin:15px 0;">
                <label>Token de autoriza√ß√£o</label>
                <input type="text" id="tokenCode" placeholder="Ex: CASS-123456" />
            </div>
            <div style="margin:15px 0;">
                <label>Status do token</label>
                <select id="tokenStatus">
                    <option value="enviado">‚úÖ Enviado</option>
                    <option value="pendente">‚è≥ Pendente</option>
                    <option value="problema">‚ùå Problema no token</option>
                </select>
            </div>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button id="cancelToken" class="small">Cancelar</button>
                <button id="saveToken" class="primary small">Salvar Token</button>
            </div>
        </div>
    </div>

    <div id="evolucaoModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="margin-bottom:15px;">üìù Registrar Evolu√ß√£o</h3>
            <div style="margin:15px 0;">
                <label>Data</label>
                <input type="date" id="evolucaoData" />
            </div>
            <div style="margin:15px 0;">
                <label>Evolu√ß√£o do paciente</label>
                <textarea id="evolucaoTexto" rows="5" placeholder="Descreva a evolu√ß√£o..."></textarea>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button id="cancelEvolucao" class="small">Cancelar</button>
                <button id="saveEvolucao" class="primary small">Salvar</button>
            </div>
        </div>
    </div>

    <div id="editEvolucaoModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="margin-bottom:15px;">‚úèÔ∏è Editar Evolu√ß√£o</h3>
            <div style="margin:15px 0;">
                <label>Data</label>
                <input type="date" id="editEvolucaoData" />
            </div>
            <div style="margin:15px 0;">
                <label>Evolu√ß√£o do paciente</label>
                <textarea id="editEvolucaoTexto" rows="5" placeholder="Descreva a evolu√ß√£o..."></textarea>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button id="cancelEditEvolucao" class="small">Cancelar</button>
                <button id="saveEditEvolucao" class="primary small">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURA√á√ïES ==========
        const APP_VERSION = '10.0.0';
        const CLINIC_NAME = "Gabriel Alves";
        const CLINIC_SUBTITLE = "Fonoaudiologia Infantil";
        const CLINIC_CRFA = "CRFa 5-13766";
        
        const KEYS = {
            PATIENTS: "gabriel_fono_patients_v10",
            SESSIONS: "gabriel_fono_sessions_v10",
            SCHEDULE: "gabriel_fono_schedule_v10",
            TOKENS: "gabriel_fono_tokens_v10",
            BACKUP: "gabriel_fono_backup_v10",
            THEME: "gabriel_fono_theme_v10",
            VERSION: "gabriel_fono_version",
            NOTIFICATIONS: "gabriel_fono_notifications",
            PHOTOS: "gabriel_fono_photos",
            EVOLUCOES: "gabriel_fono_evolucoes",
            ULTIMO_RESET: "gabriel_fono_ultimo_reset"
        };

        const DAYS = ["Seg", "Ter", "Qua", "Qui", "Sex", "S√°b", "Dom"];
        const DAYS_FULL = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado", "Domingo"];
        const SERVICE_COLORS = {
            "cassems": "slotGreen",
            "particular": "slotAmber",
            "unimed": "slotBlue",
            "outros": "slotPurple"
        };

        // ========== VARI√ÅVEIS GLOBAIS ==========
        let autoBackup = true;
        let openedPatientId = null;
        let alertTimeout = null;
        let currentTokenSessionId = null;
        let debtFilterActive = false;
        let notificationsEnabled = false;
        let notificationInterval = null;
        let currentPhotoFile = null;
        let deferredPrompt = null;
        let currentEvolucaoId = null;

        // ========== FUN√á√ïES UTILIT√ÅRIAS ==========
        function $(id) {
            return document.getElementById(id);
        }

        function uid() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function todayISO() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
        }

        function nowTime() {
            const d = new Date();
            return `${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
        }

        function parseMoney(val) {
            if (!val) return 0;
            return Number(String(val).replace(/\./g, "").replace(",", ".")) || 0;
        }

        function fmtMoney(val) {
            return Number(val || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        }

        function escapeHtml(str) {
            return String(str || "")
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function saveData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (e) {
                showAlert('‚ùå Erro ao salvar dados. Verifique o espa√ßo dispon√≠vel.', 'error');
                return false;
            }
        }

        function loadData(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch {
                return defaultValue;
            }
        }

        function showAlert(message, type = "info") {
            if (alertTimeout) clearTimeout(alertTimeout);
            
            const alert = document.createElement("div");
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alert.style.background = type === "success" ? "rgba(44,122,90,.2)" : 
                                    type === "warning" ? "rgba(232,198,106,.2)" : 
                                    "rgba(44,122,90,.2)";
            alert.style.borderColor = type === "success" ? "#2C7A5A" : 
                                      type === "warning" ? "#E8C66A" : 
                                      "#2C7A5A";
            document.body.appendChild(alert);
            
            alertTimeout = setTimeout(() => {
                if (alert.parentNode) alert.remove();
            }, 3000);
        }

        function recurKey(day, time) { return `${day}|${time}`; }

        function defaultTimes() {
            return [
                "07:00", "07:40", "08:20", "09:00", "09:40", "10:20", "11:00",
                "13:00", "13:40", "14:20", "15:00", "15:40", "16:20", "17:00", "17:40"
            ];
        }

        function addDays(dateStr, days) {
            const date = new Date(dateStr + 'T12:00:00');
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        }

        // ========== FUN√á√ïES DE TOKENS ==========
        
        // Verificar se √© dia 01 e zerar tokens se necess√°rio
        function verificarZerarTokens() {
            const hoje = new Date();
            const dia = hoje.getDate();
            const mes = hoje.getMonth();
            const ano = hoje.getFullYear();
            
            // Verificar se j√° zerou esse m√™s
            const ultimoReset = localStorage.getItem(KEYS.ULTIMO_RESET);
            const chaveReset = `${ano}-${mes}`;
            
            if (dia === 1 && ultimoReset !== chaveReset) {
                // √â dia 01 e ainda n√£o zerou esse m√™s
                const tokens = loadTokens();
                const tokensReset = {};
                
                // Manter apenas tokens com status 'problema' (n√£o zerar esses)
                Object.entries(tokens).forEach(([sessionId, token]) => {
                    if (token.status === 'problema') {
                        tokensReset[sessionId] = token;
                    }
                });
                
                saveTokens(tokensReset);
                localStorage.setItem(KEYS.ULTIMO_RESET, chaveReset);
                
                showAlert('üîÑ Tokens zerados para o novo m√™s!', 'info');
                return true;
            }
            return false;
        }

        // Fun√ß√£o para contar tokens de um paciente espec√≠fico no m√™s atual
        function contarTokensPaciente(patientId, mesReferencia = null) {
            const tokens = loadTokens();
            const sessions = loadSessions();
            let total = 0;
            
            // Se n√£o especificar m√™s, usa o m√™s atual
            const hoje = new Date();
            const mesAlvo = mesReferencia || `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
            
            Object.entries(tokens).forEach(([sessionId, token]) => {
                if (token.status === 'enviado') {
                    // Buscar a sess√£o para verificar o paciente
                    const session = sessions.find(s => s.id === sessionId);
                    if (session && session.patientId === patientId) {
                        // Verificar se √© do m√™s atual
                        const dataToken = new Date(token.date + 'T12:00:00');
                        const mesToken = `${dataToken.getFullYear()}-${String(dataToken.getMonth() + 1).padStart(2, '0')}`;
                        
                        if (mesToken === mesAlvo) {
                            total++;
                        }
                    }
                }
            });
            
            return total;
        }

        // Fun√ß√£o para contar tokens pendentes de um paciente
        function contarTokensPendentesPaciente(patientId) {
            const tokens = loadTokens();
            const sessions = loadSessions();
            let total = 0;
            
            Object.entries(tokens).forEach(([sessionId, token]) => {
                if (token.status === 'pendente') {
                    const session = sessions.find(s => s.id === sessionId);
                    if (session && session.patientId === patientId) {
                        total++;
                    }
                }
            });
            
            return total;
        }

        // Fun√ß√£o para contar tokens com problema de um paciente
        function contarTokensProblemaPaciente(patientId) {
            const tokens = loadTokens();
            const sessions = loadSessions();
            let total = 0;
            
            Object.entries(tokens).forEach(([sessionId, token]) => {
                if (token.status === 'problema') {
                    const session = sessions.find(s => s.id === sessionId);
                    if (session && session.patientId === patientId) {
                        total++;
                    }
                }
            });
            
            return total;
        }

        // Fun√ß√£o para contar total de tokens de todos os pacientes (para relat√≥rio)
        function contarTotalTokens(mesReferencia = null) {
            const tokens = loadTokens();
            const hoje = new Date();
            const mesAlvo = mesReferencia || `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
            
            return Object.values(tokens).filter(t => {
                if (t.status === 'enviado') {
                    const dataToken = new Date(t.date + 'T12:00:00');
                    const mesToken = `${dataToken.getFullYear()}-${String(dataToken.getMonth() + 1).padStart(2, '0')}`;
                    return mesToken === mesAlvo;
                }
                return false;
            }).length;
        }

        // ========== FUN√á√ïES DE DADOS ==========
        function loadPatients() { return loadData(KEYS.PATIENTS, []); }
        function savePatients(p) { saveData(KEYS.PATIENTS, p); }

        function loadSessions() { return loadData(KEYS.SESSIONS, []); }
        function saveSessions(s) { saveData(KEYS.SESSIONS, s); }

        function loadSchedule() {
            return loadData(KEYS.SCHEDULE, { times: defaultTimes(), recurring: {} });
        }
        function saveSchedule(s) { saveData(KEYS.SCHEDULE, s); }

        function loadTokens() { return loadData(KEYS.TOKENS, {}); }
        function saveTokens(tokens) { saveData(KEYS.TOKENS, tokens); }

        function loadPhotos() { return loadData(KEYS.PHOTOS, {}); }
        function savePhotos(photos) { saveData(KEYS.PHOTOS, photos); }

        function loadEvolucoes() { return loadData(KEYS.EVOLUCOES, {}); }
        function saveEvolucoes(evolucoes) { saveData(KEYS.EVOLUCOES, evolucoes); }

        function getPatientById(id) {
            return loadPatients().find(p => p.id === id);
        }

        function getTokenForSession(sessionId) {
            const tokens = loadTokens();
            return tokens[sessionId] || null;
        }

        function registerToken(sessionId, tokenData) {
            const tokens = loadTokens();
            tokens[sessionId] = {
                ...tokenData,
                registeredAt: new Date().toISOString()
            };
            saveTokens(tokens);
            return tokens[sessionId];
        }

        // ========== NOTIFICA√á√ïES ==========
        window.requestNotificationPermission = async function() {
            if (!("Notification" in window)) {
                showAlert("‚ùå Seu navegador n√£o suporta notifica√ß√µes", "error");
                return false;
            }
            
            const permission = await Notification.requestPermission();
            notificationsEnabled = permission === "granted";
            
            if (notificationsEnabled) {
                localStorage.setItem(KEYS.NOTIFICATIONS, "granted");
                startNotificationChecker();
                showAlert("‚úÖ Notifica√ß√µes ativadas com sucesso!", "success");
                $("notificationModal")?.classList.add("hidden");
            }
            
            return notificationsEnabled;
        };

        function startNotificationChecker() {
            if (notificationInterval) clearInterval(notificationInterval);
            
            notificationInterval = setInterval(() => {
                checkUpcomingSessions();
            }, 60000);
        }

        function checkUpcomingSessions() {
            if (!notificationsEnabled) return;
            
            const agora = nowTime();
            const hoje = new Date().getDay();
            const schedule = loadSchedule();
            
            Object.entries(schedule.recurring || {}).forEach(([key, entry]) => {
                const [day, time] = key.split("|");
                if (parseInt(day) === hoje) {
                    const [h1, m1] = time.split(":").map(Number);
                    const [h2, m2] = agora.split(":").map(Number);
                    const diffMinutes = (h1 * 60 + m1) - (h2 * 60 + m2);
                    
                    if (diffMinutes === 15) {
                        const patient = getPatientById(entry.patientId);
                        if (patient) {
                            new Notification("üîî Pr√≥ximo atendimento!", {
                                body: `${patient.name} em 15 minutos (${time})`,
                                icon: "/icon-192.png",
                                silent: false
                            });
                        }
                    }
                }
            });
        }

        // ========== FOTO DO PACIENTE ==========
        window.handlePhotoUpload = function(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentPhotoFile = e.target.result;
                const preview = $("photoPreview");
                const placeholder = $("photoPlaceholder");
                if (preview) {
                    preview.src = e.target.result;
                    preview.classList.remove("hidden");
                }
                if (placeholder) {
                    placeholder.classList.add("hidden");
                }
            };
            reader.readAsDataURL(file);
        };

        function savePatientPhoto(patientId, photoData) {
            const photos = loadPhotos();
            photos[patientId] = photoData;
            savePhotos(photos);
        }

        function getPatientPhoto(patientId) {
            const photos = loadPhotos();
            return photos[patientId] || null;
        }

        // ========== EXPORTAR/IMPORTAR ==========
        window.exportarDados = function() {
            try {
                const dados = {
                    pacientes: loadPatients(),
                    sessoes: loadSessions(),
                    agenda: loadSchedule(),
                    tokens: loadTokens(),
                    fotos: loadPhotos(),
                    evolucoes: loadEvolucoes(),
                    dataExport: new Date().toISOString(),
                    versao: APP_VERSION
                };
                
                const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_clinica_${todayISO()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showAlert('‚úÖ Dados exportados com sucesso!', 'success');
            } catch (erro) {
                console.error('Erro ao exportar:', erro);
                showAlert('‚ùå Erro ao exportar dados', 'error');
            }
        };

        window.importarDados = function() {
            document.getElementById('importFile').click();
        };

        window.carregarArquivo = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    
                    if (dados.pacientes) savePatients(dados.pacientes);
                    if (dados.sessoes) saveSessions(dados.sessoes);
                    if (dados.agenda) saveSchedule(dados.agenda);
                    if (dados.tokens) saveTokens(dados.tokens);
                    if (dados.fotos) savePhotos(dados.fotos);
                    if (dados.evolucoes) saveEvolucoes(dados.evolucoes);
                    
                    showAlert('‚úÖ Dados importados com sucesso!', 'success');
                    
                    setTimeout(() => location.reload(), 1500);
                    
                } catch (erro) {
                    console.error('Erro ao importar:', erro);
                    showAlert('‚ùå Arquivo inv√°lido', 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        };

        // ========== TEMA ==========
        window.toggleTheme = function() {
            document.body.classList.toggle("light-mode");
            const isLight = document.body.classList.contains("light-mode");
            localStorage.setItem(KEYS.THEME, isLight ? "light" : "dark");
            const themeBtn = $("themeToggle");
            if (themeBtn) themeBtn.innerHTML = isLight ? "üåô Tema" : "‚òÄÔ∏è Tema";
        };

        // ========== NAVEGA√á√ÉO ==========
        window.setTab = function(tab) {
            $("viewDashboard")?.classList.toggle("hidden", tab !== "dashboard");
            $("viewDaily")?.classList.toggle("hidden", tab !== "daily");
            $("viewPatients")?.classList.toggle("hidden", tab !== "patients");
            $("viewSchedule")?.classList.toggle("hidden", tab !== "schedule");
            $("viewReports")?.classList.toggle("hidden", tab !== "reports");

            [$("tabDashboard"), $("tabDaily"), $("tabPatients"), $("tabSchedule"), $("tabReports")].forEach(t => {
                if (t) t.classList.remove("active");
            });
            
            const activeTab = $(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            if (activeTab) activeTab.classList.add("active");

            if (tab === "dashboard") renderDashboard();
            if (tab === "schedule") renderSchedule();
            if (tab === "reports") generateReports();
        };

        // ========== FUN√á√ïES DO DI√ÅRIO ==========
        function renderPatientSelect() {
            const pats = loadPatients();
            const sel = $("pPatient");
            if (!sel) return;
            
            sel.innerHTML = pats.length ?
                pats.map(p => `<option value="${p.id}">${escapeHtml(p.name)}${p.serviceType === 'cassems' ? ' (Cassems)' : ''}</option>`).join("") :
                `<option value="">(Cadastre pacientes)</option>`;
            
            updateDefaultHint();
        }

        function updateDefaultHint() {
            const pid = $("pPatient")?.value;
            const p = getPatientById(pid);
            const hint = $("hintDefault");
            if (!hint) return;
            if (!p) {
                hint.textContent = "";
                return;
            }
            hint.textContent = `${p.serviceType || "Particular"} ‚Ä¢ Valor: ${fmtMoney(p.defaultValue || 0)}`;
        }

        function renderDaily() {
            // Verificar se precisa zerar tokens (todo dia 01)
            verificarZerarTokens();
            
            const date = $("date")?.value || todayISO();
            const search = $("search")?.value.toLowerCase() || "";
            const sessions = loadSessions().filter(s => s.date === date);
            const tokens = loadTokens();

            const filtered = sessions.filter(s => {
                const p = getPatientById(s.patientId);
                return !search || (p?.name || "").toLowerCase().includes(search);
            });

            const cassemsHoje = filtered.filter(s => {
                const p = getPatientById(s.patientId);
                return p?.serviceType === "cassems";
            });

            const tokensHojeEnviados = cassemsHoje.filter(s => tokens[s.id]?.status === "enviado").length;
            const tokensHojePendentes = cassemsHoje.length - tokensHojeEnviados;

            const cassemsEl = $("cassemsHoje");
            if (cassemsEl) cassemsEl.textContent = cassemsHoje.length;
            
            const tokensEnviadosEl = $("tokensEnviadosHoje");
            if (tokensEnviadosEl) tokensEnviadosEl.textContent = tokensHojeEnviados;
            
            const tokensPendentesEl = $("tokensPendentesHoje");
            if (tokensPendentesEl) tokensPendentesEl.textContent = tokensHojePendentes;

            const list = $("dayList");
            if (!list) return;
            
            list.innerHTML = filtered.map(s => {
                const p = getPatientById(s.patientId);
                const token = tokens[s.id];
                const photo = getPatientPhoto(s.patientId);
                
                let tokenIndicator = '';
                if (p?.serviceType === 'cassems') {
                    if (token?.status === 'enviado') {
                        tokenIndicator = `<span class="pill token" style="background:rgba(44,122,90,.15);">‚úÖ Token: ${token.code || 'Enviado'}</span>`;
                    } else if (token?.status === 'problema') {
                        tokenIndicator = `<span class="pill token" style="background:rgba(239,68,68,.15);">‚ùå Problema no token</span>`;
                    } else if (token?.status === 'pendente') {
                        tokenIndicator = `<span class="pill token" style="background:rgba(232,198,106,.15);">‚è≥ Token pendente</span>`;
                    } else {
                        tokenIndicator = `<span class="pill token" style="background:rgba(245,158,11,.15);">üìù Registrar token</span>`;
                    }
                }

                return `
                <div class="item" id="session-${s.id}">
                    <div style="display:flex; gap:10px;">
                        ${photo ? `<img src="${photo}" class="photo-preview small" style="width:40px; height:40px;" />` : ''}
                        <div style="flex:1;">
                            <div style="display:flex; justify-content:space-between;">
                                <div>
                                    <b>${s.time || "‚Äî"} - ${escapeHtml(p?.name || "?")}</b>
                                    <div class="muted">
                                        ${s.did === "realizou" ? "‚úÖ Realizou" : "‚ùå N√£o realizou"}
                                        ${s.just === "justificada" ? "(Justificada)" : s.just === "nao_justificada" ? "(Sem just.)" : ""}
                                    </div>
                                    <div style="margin-top:5px;">
                                        ${tokenIndicator}
                                    </div>
                                </div>
                                <div>
                                    <span class="pill ${s.paid === "pago" ? "ok" : "bad"}">${s.paid === "pago" ? "üí∞ Pago" : "üí∏ N√£o pago"}</span>
                                    <span class="pill">${fmtMoney(s.value)}</span>
                                </div>
                            </div>
                            <div class="actions" style="margin-top:10px;">
                                <button class="small" onclick="toggleSessionDid('${s.id}')">üîÑ Alternar</button>
                                <button class="small" onclick="toggleSessionPaid('${s.id}')">üí∞ Pagamento</button>
                                <button class="small" onclick="editSessionValue('${s.id}')">‚úèÔ∏è Editar valor</button>
                                ${p?.serviceType === 'cassems' ? `<button class="small token-btn" onclick="openTokenModal('${s.id}', '${p.name}', '${s.date}')">üé´ Token</button>` : ''}
                                <button class="small danger" onclick="deleteSession('${s.id}')">üóëÔ∏è Excluir</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join("") || "<div class='muted'>Nenhuma sess√£o neste dia</div>";

            const sumDay = $("sumDay");
            if (sumDay) sumDay.innerHTML = `Total: ${filtered.length}`;
            
            const sumMoney = $("sumMoney");
            if (sumMoney) sumMoney.innerHTML = `Total: ${fmtMoney(filtered.reduce((s, r) => s + (Number(r.value) || 0), 0))}`;
            
            const sumAbsences = $("sumAbsences");
            if (sumAbsences) sumAbsences.innerHTML = filtered.filter(s => s.did === "nao").length.toString();
        }

        // ========== A√á√ïES DE SESS√ÉO ==========
        window.toggleSessionDid = function(id) {
            const sessions = loadSessions();
            const idx = sessions.findIndex(s => s.id === id);
            if (idx >= 0) {
                sessions[idx].did = sessions[idx].did === "realizou" ? "nao" : "realizou";
                if (sessions[idx].did === "nao" && !sessions[idx].just) {
                    sessions[idx].just = "nao_justificada";
                }
                saveSessions(sessions);
                
                renderDaily();
                renderDashboard();
                renderSchedule();
                if (openedPatientId) openPatientFolder(openedPatientId);
                showAlert("‚úÖ Sess√£o atualizada!", "success");
            }
        };

        window.toggleSessionPaid = function(id) {
            const sessions = loadSessions();
            const idx = sessions.findIndex(s => s.id === id);
            if (idx >= 0) {
                sessions[idx].paid = sessions[idx].paid === "pago" ? "nao_pago" : "pago";
                saveSessions(sessions);
                renderDaily();
                renderDashboard();
                if (openedPatientId) openPatientFolder(openedPatientId);
                showAlert("üí∞ Status de pagamento atualizado!", "success");
            }
        };

        window.editSessionValue = function(id) {
            const sessions = loadSessions();
            const idx = sessions.findIndex(s => s.id === id);
            if (idx >= 0) {
                const newValue = prompt("Novo valor (R$):", sessions[idx].value);
                if (newValue !== null) {
                    sessions[idx].value = parseMoney(newValue);
                    saveSessions(sessions);
                    renderDaily();
                    showAlert("‚úÖ Valor atualizado!", "success");
                }
            }
        };

        window.deleteSession = function(id) {
            if (confirm("Excluir esta sess√£o?")) {
                const sessions = loadSessions().filter(s => s.id !== id);
                saveSessions(sessions);
                
                const tokens = loadTokens();
                delete tokens[id];
                saveTokens(tokens);
                
                renderDaily();
                renderSchedule();
                if (openedPatientId) openPatientFolder(openedPatientId);
                showAlert("üóëÔ∏è Sess√£o exclu√≠da!", "success");
            }
        };

        window.sendBirthdayMessage = function(patientId) {
            const p = getPatientById(patientId);
            if (p?.phone) {
                const msg = encodeURIComponent(`üéÇ Feliz anivers√°rio! Desejo um dia maravilhoso e muitas realiza√ß√µes!`);
                window.open(`https://wa.me/55${p.phone}?text=${msg}`, "_blank");
            }
        };

        window.openTokenModal = function(sessionId, patientName, sessionDate) {
            currentTokenSessionId = sessionId;
            const token = getTokenForSession(sessionId);
            
            const tokenDate = $("tokenDate");
            const tokenPatient = $("tokenPatient");
            const tokenCode = $("tokenCode");
            const tokenStatus = $("tokenStatus");
            
            if (tokenDate) tokenDate.value = sessionDate;
            if (tokenPatient) tokenPatient.value = patientName;
            if (tokenCode) tokenCode.value = token?.code || '';
            if (tokenStatus) tokenStatus.value = token?.status || 'pendente';
            
            $("tokenModal")?.classList.remove("hidden");
        };

        window.saveToken = function() {
            if (!currentTokenSessionId) return;
            
            registerToken(currentTokenSessionId, {
                sessionId: currentTokenSessionId,
                date: $("tokenDate")?.value,
                patientName: $("tokenPatient")?.value,
                code: $("tokenCode")?.value,
                status: $("tokenStatus")?.value
            });
            
            $("tokenModal")?.classList.add("hidden");
            renderDaily();
            renderDashboard();
            renderSchedule();
            generateReports();
            if (openedPatientId) openPatientFolder(openedPatientId);
            showAlert("‚úÖ Token registrado com sucesso!", "success");
        };

        // ========== FUN√á√ïES DE AGENDAMENTO ==========
        function renderSchedule() {
            // Verificar se precisa zerar tokens (todo dia 01)
            verificarZerarTokens();
            
            const sch = loadSchedule();
            const patients = loadPatients();
            const sessions = loadSessions();
            const times = (sch.times || []).sort();
            const table = $("schedTable");
            
            if (!table) return;

            // Contar sess√µes por paciente
            const sessoesPorPaciente = {};
            sessions.forEach(s => {
                if (!sessoesPorPaciente[s.patientId]) {
                    sessoesPorPaciente[s.patientId] = {
                        realizadas: 0,
                        faltas: 0,
                        total: 0
                    };
                }
                if (s.did === 'realizou') sessoesPorPaciente[s.patientId].realizadas++;
                else if (s.did === 'nao') sessoesPorPaciente[s.patientId].faltas++;
                sessoesPorPaciente[s.patientId].total++;
            });

            // Mapear hor√°rios recorrentes
            const horariosRecorrentes = {};
            Object.entries(sch.recurring || {}).forEach(([key, entry]) => {
                horariosRecorrentes[key] = entry;
            });

            let html = "<thead><tr><th class='timeCell'>Hor√°rio</th>";
            DAYS.forEach(day => html += `<th>${day}</th>`);
            html += "</tr></thead><tbody>";

            for (const time of times) {
                html += `<tr><td class="timeCell">${escapeHtml(time)}</td>`;

                for (let day = 0; day < 7; day++) {
                    const key = recurKey(day, time);
                    
                    // Verificar se tem hor√°rio recorrente
                    if (horariosRecorrentes[key]) {
                        const entry = horariosRecorrentes[key];
                        const patient = getPatientById(entry.patientId);
                        const colorClass = patient?.serviceType === "cassems" ? "slotGreen" : 
                                          patient?.serviceType === "particular" ? "slotAmber" :
                                          patient?.serviceType === "unimed" ? "slotBlue" : "slotPurple";
                        
                        const serviceLabel = patient?.serviceType === "cassems" ? "Cassems" :
                                            patient?.serviceType === "unimed" ? "Unimed" :
                                            patient?.serviceType === "outros" ? "Outros" : "Particular";

                        const tokenIcon = patient?.serviceType === "cassems" ? '<span class="pill token" style="margin-top:0;">üé´</span>' : '';
                        
                        // Contar tokens espec√≠ficos deste paciente
                        const tokensPaciente = contarTokensPaciente(patient?.id);
                        const tokensPendentesPaciente = contarTokensPendentesPaciente(patient?.id);
                        const tokensProblemaPaciente = contarTokensProblemaPaciente(patient?.id);
                        
                        const stats = sessoesPorPaciente[patient?.id] || { realizadas: 0, faltas: 0, total: 0 };
                        
                        html += `<td data-day="${day}" data-time="${time}" class="slotBox ${colorClass}">
                            <div style="font-weight:600;">${escapeHtml(patient?.name || "?")} ${tokenIcon}</div>
                            <div class="muted" style="font-size:0.85rem;">${serviceLabel}</div>
                            <div class="slot-counter">
                                <span title="Sess√µes realizadas">‚úÖ ${stats.realizadas}</span>
                                <span title="Faltas">‚ùå ${stats.faltas}</span>
                                <span title="Total">üìä ${stats.total}</span>
                            </div>
                            ${patient?.serviceType === 'cassems' ? `
                                <div class="slot-counter" style="margin-top:5px; justify-content:space-around;">
                                    <span class="pill token" style="font-size:0.7rem; background:rgba(232,198,106,0.3);">üé´ Enviados: ${tokensPaciente}</span>
                                    ${tokensPendentesPaciente > 0 ? `
                                        <span class="pill warn" style="font-size:0.7rem;">‚è≥ Pend: ${tokensPendentesPaciente}</span>
                                    ` : ''}
                                    ${tokensProblemaPaciente > 0 ? `
                                        <span class="pill bad" style="font-size:0.7rem;">‚ùå Prob: ${tokensProblemaPaciente}</span>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </td>`;
                    } else {
                        html += `<td data-day="${day}" data-time="${time}" class="slotBox slotRed" style="cursor:pointer;">
                            <div style="opacity:0.7;">üü• Vago</div>
                            <div class="muted" style="font-size:0.8rem;">Clique para agendar</div>
                        </td>`;
                    }
                }
                html += "</tr>";
            }

            html += "</tbody>";
            table.innerHTML = html;

            document.querySelectorAll("td[data-day]").forEach(td => {
                td.addEventListener("click", (e) => {
                    const day = td.dataset.day;
                    const time = td.dataset.time;
                    scheduleClickHandler(parseInt(day), time);
                });
            });
        }

        function scheduleClickHandler(day, time) {
            const sch = loadSchedule();
            const key = recurKey(day, time);
            const current = sch.recurring?.[key];
            const patients = loadPatients();

            if (current) {
                const patient = getPatientById(current.patientId);
                if (confirm(`Remover ${patient?.name} deste hor√°rio?`)) {
                    delete sch.recurring[key];
                    saveSchedule(sch);
                    renderSchedule();
                    renderDashboard();
                    showAlert("‚úÖ Hor√°rio liberado!", "success");
                }
            } else {
                const patientList = patients.map((p, i) => `${i + 1} - ${p.name}`).join("\n");
                const choice = prompt(
                    `Agendar em ${DAYS[day]} √†s ${time}\n\n` +
                    `Digite o N√öMERO do paciente:\n${patientList}\n\n` +
                    `Ou 0 para cancelar`
                );

                if (choice && choice !== "0") {
                    const idx = parseInt(choice) - 1;
                    if (idx >= 0 && idx < patients.length) {
                        const patient = patients[idx];
                        const finalService = patient.serviceType || "particular";
                        
                        sch.recurring = sch.recurring || {};
                        sch.recurring[key] = {
                            patientId: patient.id,
                            serviceType: finalService,
                            startDate: todayISO()
                        };

                        saveSchedule(sch);
                        renderSchedule();
                        renderDashboard();
                        showAlert(`‚úÖ ${patient.name} agendado!`, "success");
                    }
                }
            }
        }

        // ========== FILTROS DA AGENDA ==========
        window.filterHoje = function() {
            const hoje = new Date().getDay();
            const rows = document.querySelectorAll("#schedTable tbody tr");
            rows.forEach(row => {
                const cells = row.querySelectorAll("td:not(.timeCell)");
                cells.forEach((cell, idx) => {
                    if (idx === hoje) {
                        cell.style.background = "rgba(44,122,90,.2)";
                    }
                });
            });
        };

        window.filterAmanha = function() {
            const amanha = (new Date().getDay() + 1) % 7;
            const rows = document.querySelectorAll("#schedTable tbody tr");
            rows.forEach(row => {
                const cells = row.querySelectorAll("td:not(.timeCell)");
                cells.forEach((cell, idx) => {
                    if (idx === amanha) {
                        cell.style.background = "rgba(44,122,90,.2)";
                    }
                });
            });
        };

        window.filterSemana = function() {
            document.querySelectorAll("#schedTable tbody tr td:not(.timeCell)").forEach(cell => {
                cell.style.background = "";
            });
        };

        // ========== DASHBOARD ==========
        function renderDashboard() {
            // Verificar se precisa zerar tokens (todo dia 01)
            verificarZerarTokens();
            
            const hoje = todayISO();
            const agora = nowTime();
            const sessions = loadSessions();
            const patients = loadPatients();
            const schedule = loadSchedule();
            const tokens = loadTokens();
            
            const hojeSessions = sessions.filter(s => s.date === hoje);
            const dashHoje = $("dashHoje");
            if (dashHoje) dashHoje.textContent = hojeSessions.length;
            
            const realizadasHoje = hojeSessions.filter(s => s.did === "realizou").length;
            const faltasHoje = hojeSessions.filter(s => s.did === "nao").length;
            const dashHojeDetalhe = $("dashHojeDetalhe");
            if (dashHojeDetalhe) dashHojeDetalhe.innerHTML = `‚úÖ ${realizadasHoje} realizadas ‚Ä¢ ‚ùå ${faltasHoje} faltas`;
            
            const hojeDay = new Date().getDay();
            const proximos = [];
            
            Object.entries(schedule.recurring || {}).forEach(([key, entry]) => {
                const [day, time] = key.split("|");
                if (parseInt(day) === hojeDay) {
                    const [h1, m1] = time.split(":").map(Number);
                    const [h2, m2] = agora.split(":").map(Number);
                    const diffMinutes = (h1 * 60 + m1) - (h2 * 60 + m2);
                    
                    if (diffMinutes > 0 && diffMinutes <= 15) {
                        const patient = getPatientById(entry.patientId);
                        proximos.push({ name: patient?.name || "?", time });
                    }
                }
            });
            
            const dashProximos = $("dashProximos");
            if (dashProximos) dashProximos.textContent = proximos.length;
            
            const dashProximosNomes = $("dashProximosNomes");
            if (dashProximosNomes) {
                dashProximosNomes.innerHTML = proximos.map(p => `${p.time} - ${p.name}`).join("<br>") || "Nenhum";
            }
            
            const faturamentoHoje = hojeSessions
                .filter(s => s.did === "realizou" && s.paid === "pago")
                .reduce((sum, s) => sum + (Number(s.value) || 0), 0);
            const aReceberHoje = hojeSessions
                .filter(s => s.did === "realizou" && s.paid !== "pago")
                .reduce((sum, s) => sum + (Number(s.value) || 0), 0);
            
            const dashFaturamento = $("dashFaturamento");
            if (dashFaturamento) dashFaturamento.textContent = fmtMoney(faturamentoHoje);
            
            const dashFaturamentoDetalhe = $("dashFaturamentoDetalhe");
            if (dashFaturamentoDetalhe) {
                dashFaturamentoDetalhe.innerHTML = `üí∞ Recebido: ${fmtMoney(faturamentoHoje)}<br>üí∏ A receber: ${fmtMoney(aReceberHoje)}`;
            }
            
            const currentMonth = hoje.slice(0, 7);
            const monthSessions = sessions.filter(s => s.date.startsWith(currentMonth));
            const monthFaltas = monthSessions.filter(s => s.did === "nao").length;
            const taxa = monthSessions.length ? (monthFaltas / monthSessions.length * 100).toFixed(1) : 0;
            
            const dashTaxaFaltas = $("dashTaxaFaltas");
            if (dashTaxaFaltas) dashTaxaFaltas.textContent = `${taxa}%`;
            
            const dashProgresso = $("dashProgresso");
            if (dashProgresso) dashProgresso.style.width = `${taxa}%`;

            const cassemsHoje = hojeSessions.filter(s => {
                const p = getPatientById(s.patientId);
                return p?.serviceType === "cassems";
            });

            const tokensHoje = cassemsHoje.map(s => ({
                session: s,
                token: tokens[s.id]
            }));

            const tokensEnviados = tokensHoje.filter(t => t.token?.status === "enviado").length;
            const tokensPendentes = cassemsHoje.length - tokensEnviados;

            const tokensHojeEl = $("tokensHoje");
            if (tokensHojeEl) tokensHojeEl.textContent = cassemsHoje.length;
            
            const tokensHojeDetalhe = $("tokensHojeDetalhe");
            if (tokensHojeDetalhe) tokensHojeDetalhe.innerHTML = `${cassemsHoje.length} pacientes Cassems hoje`;
            
            const tokensEnviadosEl = $("tokensEnviados");
            if (tokensEnviadosEl) tokensEnviadosEl.textContent = tokensEnviados;
            
            const tokensEnviadosDetalhe = $("tokensEnviadosDetalhe");
            if (tokensEnviadosDetalhe) tokensEnviadosDetalhe.innerHTML = `${tokensEnviados} tokens registrados`;
            
            const tokensPendentesEl = $("tokensPendentes");
            if (tokensPendentesEl) tokensPendentesEl.textContent = tokensPendentes;
            
            const tokensPendentesDetalhe = $("tokensPendentesDetalhe");
            if (tokensPendentesDetalhe) tokensPendentesDetalhe.innerHTML = `${tokensPendentes} aguardando token`;
            
            const currentMonthNum = new Date().getMonth() + 1;
            const aniversariantes = patients.filter(p => {
                if (!p.birth) return false;
                const month = parseInt(p.birth.split("-")[1]);
                return month === currentMonthNum;
            });
            
            const aniversariantesEl = $("aniversariantes");
            if (aniversariantesEl) {
                aniversariantesEl.innerHTML = aniversariantes.length ? 
                    aniversariantes.map(p => {
                        const photo = getPatientPhoto(p.id);
                        return `
                        <div class="item">
                            <div style="display:flex; gap:10px; align-items:center;">
                                ${photo ? `<img src="${photo}" class="photo-preview small" style="width:40px; height:40px;" />` : ''}
                                <div>
                                    <b>üéÇ ${escapeHtml(p.name)}</b>
                                    <div class="muted">${new Date(p.birth).toLocaleDateString("pt-BR")}</div>
                                    <button class="small" onclick="sendBirthdayMessage('${p.id}')">üì± Enviar mensagem</button>
                                </div>
                            </div>
                        </div>
                    `}).join("") : 
                    "<div class='muted'>Nenhum aniversariante este m√™s</div>";
            }
            
            const proximosAtendimentos = [];
            const refDay = new Date().getDay();
            
            Object.entries(schedule.recurring || {}).forEach(([key, entry]) => {
                const [day, time] = key.split("|");
                const dayNum = parseInt(day);
                
                let daysToAdd = dayNum - refDay;
                if (daysToAdd < 0) daysToAdd += 7;
                if (daysToAdd === 0 && time < agora) daysToAdd += 7;
                
                const nextDate = new Date();
                nextDate.setDate(nextDate.getDate() + daysToAdd);
                
                const patient = getPatientById(entry.patientId);
                proximosAtendimentos.push({
                    date: nextDate,
                    time,
                    patient: patient?.name || "?",
                    days: daysToAdd
                });
            });
            
            proximosAtendimentos.sort((a, b) => a.days - b.days);
            
            const proximosAtendimentosEl = $("proximosAtendimentos");
            if (proximosAtendimentosEl) {
                proximosAtendimentosEl.innerHTML = proximosAtendimentos.slice(0, 5).map(p => `
                    <div class="item">
                        <b>${escapeHtml(p.patient)}</b>
                        <div class="muted">${p.time} - ${p.days === 0 ? "Hoje" : p.days === 1 ? "Amanh√£" : `Em ${p.days} dias`}</div>
                    </div>
                `).join("") || "<div class='muted'>Nenhum agendamento</div>";
            }
        }

        // ========== FUN√á√ïES DE PACIENTES ==========
        function renderPatientFolders() {
            // Verificar se precisa zerar tokens (todo dia 01)
            verificarZerarTokens();
            
            const search = $("pSearch")?.value.toLowerCase() || "";
            let pats = loadPatients().filter(p => !search || p.name.toLowerCase().includes(search));

            if (debtFilterActive) {
                const sessions = loadSessions();
                pats = pats.filter(p => {
                    const patientSessions = sessions.filter(s => s.patientId === p.id && s.paid !== "pago");
                    return patientSessions.length > 0;
                });
            }

            const container = $("patientFolders");
            if (!container) return;

            container.innerHTML = pats.map(p => {
                const sessions = loadSessions().filter(s => s.patientId === p.id);
                const debt = sessions.filter(s => s.paid !== "pago").reduce((sum, s) => sum + (Number(s.value) || 0), 0);
                const totalSessoes = sessions.length;
                const realizadas = sessions.filter(s => s.did === "realizou").length;
                const faltas = sessions.filter(s => s.did === "nao").length;
                const cassemsIcon = p.serviceType === 'cassems' ? 'üé´' : '';
                const photo = getPatientPhoto(p.id);
                const evolucoes = getPatientEvolucoes(p.id);
                const evolucoesCount = evolucoes.length;
                
                // Contar tokens espec√≠ficos deste paciente
                const tokensPaciente = contarTokensPaciente(p.id);
                const tokensPendentes = contarTokensPendentesPaciente(p.id);
                const tokensProblema = contarTokensProblemaPaciente(p.id);

                const percent = totalSessoes > 0 ? (realizadas / totalSessoes) * 100 : 0;

                return `
                <div class="item" onclick="openPatientFolder('${p.id}')" style="cursor:pointer;">
                    <div style="display:flex; gap:10px;">
                        ${photo ? `<img src="${photo}" class="photo-preview small" style="width:50px; height:50px;" />` : ''}
                        <div style="flex:1;">
                            <div style="display:flex; justify-content:space-between;">
                                <div>
                                    <b>üìÅ ${escapeHtml(p.name)} ${cassemsIcon}</b>
                                    <div class="muted">
                                        ${p.serviceType || "Particular"} ‚Ä¢ ${totalSessoes} sess√µes
                                    </div>
                                    <div style="display:flex; gap:10px; margin-top:5px; flex-wrap:wrap;">
                                        <span class="pill ok">‚úÖ ${realizadas}</span>
                                        <span class="pill bad">‚ùå ${faltas}</span>
                                        ${p.serviceType === 'cassems' ? `
                                            <span class="pill token">üé´ ${tokensPaciente}</span>
                                            ${tokensPendentes > 0 ? `<span class="pill warn">‚è≥ ${tokensPendentes}</span>` : ''}
                                            ${tokensProblema > 0 ? `<span class="pill bad">‚ùå ${tokensProblema}</span>` : ''}
                                        ` : ''}
                                    </div>
                                    <div class="progress-bar" style="margin-top:5px; width:100%;">
                                        <div class="progress-fill" style="width:${percent}%;"></div>
                                    </div>
                                </div>
                                <div>
                                    ${debt > 0 ? `<span class="pill bad">üí∞ ${fmtMoney(debt)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join("") || "<div class='muted'>Nenhum paciente</div>";
        }

        window.openPatientFolder = function(id) {
            openedPatientId = id;
            const p = getPatientById(id);
            const photo = getPatientPhoto(id);
            const evolucoes = getPatientEvolucoes(id);
            
            const foldersPane = $("foldersPane");
            const folderOpenPane = $("folderOpenPane");
            const openPatientTitle = $("openPatientTitle");
            const folderPatientPhoto = $("folderPatientPhoto");
            const openPatientMeta = $("openPatientMeta");
            const pacoteProgresso = $("pacoteProgresso");
            
            if (foldersPane) foldersPane.classList.add("hidden");
            if (folderOpenPane) folderOpenPane.classList.remove("hidden");
            if (openPatientTitle) openPatientTitle.textContent = `üìÅ ${p?.name || "Paciente"}`;
            
            if (folderPatientPhoto) {
                if (photo) {
                    folderPatientPhoto.src = photo;
                    folderPatientPhoto.classList.remove("hidden");
                } else {
                    folderPatientPhoto.classList.add("hidden");
                }
            }

            // Contador de sess√µes do paciente
            const sessions = loadSessions().filter(s => s.patientId === id);
            const realizadas = sessions.filter(s => s.did === "realizou").length;
            const faltas = sessions.filter(s => s.did === "nao").length;
            const pendentes = sessions.length - realizadas - faltas;
            
            // Contar tokens espec√≠ficos deste paciente
            const tokensPaciente = contarTokensPaciente(id);
            const tokensPendentes = contarTokensPendentesPaciente(id);
            const tokensProblema = contarTokensProblemaPaciente(id);

            const percent = sessions.length > 0 ? (realizadas / sessions.length) * 100 : 0;

            $("pacoteProgresso").innerHTML = `
                <div class="info-box" style="margin:10px 0;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <div>
                            <h3 style="margin:0;">üìä Progresso do Paciente</h3>
                        </div>
                        ${p?.serviceType === 'cassems' ? `
                            <div class="token-badge">
                                üé´ Tokens m√™s: ${tokensPaciente}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="display:flex; gap:20px; align-items:center; margin-bottom:15px; flex-wrap:wrap;">
                        <div class="circular-progress" style="background: conic-gradient(var(--primary) ${percent * 3.6}deg, var(--card) 0deg);">
                            <span class="progress-value">${Math.round(percent)}%</span>
                        </div>
                        <div>
                            <div><span class="pill ok">‚úÖ Realizadas: ${realizadas}</span></div>
                            <div><span class="pill bad">‚ùå Faltas: ${faltas}</span></div>
                            <div><span class="pill warn">‚è≥ Pendentes: ${pendentes}</span></div>
                            <div><span class="pill">üìä Total: ${sessions.length}</span></div>
                        </div>
                    </div>
                    
                    ${p?.serviceType === 'cassems' ? `
                        <div class="token-counter">
                            <span>üé´ Tokens do m√™s:</span>
                            <div style="flex:1;">
                                <div class="token-progress">
                                    <div class="token-progress-fill" style="width: ${sessions.length > 0 ? (tokensPaciente / sessions.length) * 100 : 0}%"></div>
                                </div>
                            </div>
                            <span style="color:var(--accent); font-weight:bold;">${tokensPaciente} enviados</span>
                            ${tokensPendentes > 0 ? `
                                <span class="pill warn" style="margin-left:10px;">‚è≥ ${tokensPendentes} pend</span>
                            ` : ''}
                            ${tokensProblema > 0 ? `
                                <span class="pill bad" style="margin-left:10px;">‚ùå ${tokensProblema} prob</span>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${p?.startDate && p?.endDate ? `
                        <div class="muted" style="margin-top:10px;">
                            Per√≠odo: ${new Date(p.startDate).toLocaleDateString()} a ${new Date(p.endDate).toLocaleDateString()}
                        </div>
                    ` : ''}
                </div>
            `;

            // Hist√≥rico de sess√µes
            const patientSessions = sessions.sort((a, b) => b.date.localeCompare(a.date));
            const tokens = loadTokens();

            const patientHistory = $("patientHistory");
            if (patientHistory) {
                patientHistory.innerHTML = patientSessions.map(s => {
                    const token = tokens[s.id];
                    const tokenInfo = token ? 
                        `<div class="muted" style="font-size:0.85rem;">üé´ Token: ${token.code || '‚Äî'} (${token.status})</div>` : 
                        (p?.serviceType === 'cassems' ? '<div class="muted" style="font-size:0.85rem; color:#E8C66A;">‚è≥ Token pendente</div>' : '');
                    
                    return `
                    <div class="item">
                        <div style="display:flex; justify-content:space-between;">
                            <div>
                                <b>${new Date(s.date).toLocaleDateString()} ${s.time ? "√†s " + s.time : ""}</b>
                                <div class="muted">
                                    ${s.did === "realizou" ? "‚úÖ Realizou" : "‚ùå N√£o realizou"} ‚Ä¢ 
                                    ${s.paid === "pago" ? "üí∞ Pago" : "üí∏ N√£o pago"} ‚Ä¢ 
                                    ${fmtMoney(s.value)}
                                </div>
                                ${tokenInfo}
                            </div>
                            <div>
                                <button class="small" onclick="event.stopPropagation(); toggleSessionPaid('${s.id}')">üí∞</button>
                                ${p?.serviceType === 'cassems' ? `
                                    <button class="small token-btn" onclick="event.stopPropagation(); openTokenModal('${s.id}', '${p.name}', '${s.date}')">üé´</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `}).join("") || "<div class='muted'>Nenhum hist√≥rico</div>";
            }

            // Se√ß√£o de Evolu√ß√£o
            const evolucoesSection = $("evolucoesSection");
            if (evolucoesSection) {
                if (evolucoes.length === 0) {
                    evolucoesSection.innerHTML = `
                        <div style="text-align:center; padding:20px;">
                            <p class="muted">Nenhuma evolu√ß√£o registrada</p>
                            <button class="small primary" onclick="openEvolucaoModal()">‚ûï Registrar Primeira Evolu√ß√£o</button>
                        </div>
                    `;
                } else {
                    evolucoesSection.innerHTML = `
                        <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin:0;">üìù Evolu√ß√µes do Caso</h3>
                            <button class="small primary" onclick="openEvolucaoModal()">‚ûï Nova Evolu√ß√£o</button>
                        </div>
                        <div id="evolucoesList" class="timeline"></div>
                    `;
                    renderEvolucoes();
                }
            }

            if (openPatientMeta) {
                openPatientMeta.innerHTML = `
                    ${p?.serviceType || "Particular"} ‚Ä¢ 
                    ${p?.phone ? `üì± ${p.phone}` : ""} ‚Ä¢ 
                    ${p?.email ? `üìß ${p.email}` : ""}
                `;
            }
        };

        window.closePatientFolder = function() {
            openedPatientId = null;
            $("folderOpenPane")?.classList.add("hidden");
            $("foldersPane")?.classList.remove("hidden");
        };

        // ========== FUN√á√ïES DE HOR√ÅRIOS POR DIA ==========
        window.atualizarDiasSemana = function() {
            const tipo = $("cBillingType")?.value;
            const container = document.getElementById('horariosContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (tipo === "pack4") {
                for (let i = 0; i < 1; i++) {
                    const div = document.createElement('div');
                    div.className = 'grid2';
                    div.style.marginBottom = '10px';
                    div.innerHTML = `
                        <div>
                            <select class="dia-semana-${i}" style="width:100%;">
                                <option value="">Dia</option>
                                <option value="0">Segunda</option>
                                <option value="1">Ter√ßa</option>
                                <option value="2">Quarta</option>
                                <option value="3">Quinta</option>
                                <option value="4">Sexta</option>
                                <option value="5">S√°bado</option>
                                <option value="6">Domingo</option>
                            </select>
                        </div>
                        <div>
                            <input type="time" class="horario-${i}" value="08:00" step="600" style="width:100%;">
                        </div>
                    `;
                    container.appendChild(div);
                }
            } else if (tipo === "pack8") {
                for (let i = 0; i < 2; i++) {
                    const div = document.createElement('div');
                    div.className = 'grid2';
                    div.style.marginBottom = '10px';
                    div.innerHTML = `
                        <div>
                            <select class="dia-semana-${i}" style="width:100%;">
                                <option value="">Dia</option>
                                <option value="0">Segunda</option>
                                <option value="1">Ter√ßa</option>
                                <option value="2">Quarta</option>
                                <option value="3">Quinta</option>
                                <option value="4">Sexta</option>
                                <option value="5">S√°bado</option>
                                <option value="6">Domingo</option>
                            </select>
                        </div>
                        <div>
                            <input type="time" class="horario-${i}" value="08:00" step="600" style="width:100%;">
                        </div>
                    `;
                    container.appendChild(div);
                }
            } else {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div id="horariosIndividuais">
                        <div class="grid2" style="margin-bottom:10px;">
                            <div>
                                <select class="dia-individual" style="width:100%;">
                                    <option value="">Dia</option>
                                    <option value="0">Segunda</option>
                                    <option value="1">Ter√ßa</option>
                                    <option value="2">Quarta</option>
                                    <option value="3">Quinta</option>
                                    <option value="4">Sexta</option>
                                    <option value="5">S√°bado</option>
                                    <option value="6">Domingo</option>
                                </select>
                            </div>
                            <div>
                                <input type="time" class="hora-individual" value="08:00" step="600" style="width:100%;">
                            </div>
                        </div>
                    </div>
                    <button class="small" onclick="adicionarHorarioIndividual()" style="margin-top:5px;">‚ûï Adicionar</button>
                `;
                container.appendChild(div);
            }
        };

        window.adicionarHorarioIndividual = function() {
            const container = document.getElementById('horariosIndividuais');
            if (!container) return;
            const div = document.createElement('div');
            div.className = 'grid2';
            div.style.marginBottom = '10px';
            div.innerHTML = `
                <div>
                    <select class="dia-individual" style="width:100%;">
                        <option value="">Dia</option>
                        <option value="0">Segunda</option>
                        <option value="1">Ter√ßa</option>
                        <option value="2">Quarta</option>
                        <option value="3">Quinta</option>
                        <option value="4">Sexta</option>
                        <option value="5">S√°bado</option>
                        <option value="6">Domingo</option>
                    </select>
                </div>
                <div>
                    <input type="time" class="hora-individual" value="08:00" step="600" style="width:100%;">
                </div>
            `;
            container.appendChild(div);
        };

        function coletarHorarios() {
            const tipo = $("cBillingType")?.value;
            const horarios = [];
            
            if (tipo === "pack4" || tipo === "pack8") {
                const quantidade = tipo === "pack4" ? 1 : 2;
                for (let i = 0; i < quantidade; i++) {
                    const diaSelect = document.querySelector(`.dia-semana-${i}`);
                    const horarioInput = document.querySelector(`.horario-${i}`);
                    if (diaSelect && horarioInput && diaSelect.value) {
                        horarios.push({
                            dia: parseInt(diaSelect.value),
                            horario: horarioInput.value
                        });
                    }
                }
            } else {
                const dias = document.querySelectorAll('.dia-individual');
                const horas = document.querySelectorAll('.hora-individual');
                for (let i = 0; i < dias.length; i++) {
                    if (dias[i].value) {
                        horarios.push({
                            dia: parseInt(dias[i].value),
                            horario: horas[i].value
                        });
                    }
                }
            }
            return horarios;
        }

        // ========== ADD PACIENTE ==========
        window.addPatient = function() {
            const name = $("cName")?.value.trim();
            if (!name) return showAlert("‚ùå Nome √© obrigat√≥rio", "error");

            const phone = $("cPhone")?.value || "";
            const serviceType = $("cServiceType")?.value || "particular";
            const value = parseMoney($("cValue")?.value);
            
            const startDate = $("cStartDate")?.value || todayISO();
            const endDate = $("cEndDate")?.value || addDays(todayISO(), 30);

            const horarios = coletarHorarios();
            
            const patient = {
                id: uid(),
                name,
                phone,
                serviceType,
                defaultValue: value,
                horarios: horarios,
                startDate,
                endDate,
                notes: $("cNotes")?.value || "",
                anamnese: { queixa: "", historico: "", obs: "" },
                createdAt: new Date().toISOString()
            };

            const patients = loadPatients();
            patients.push(patient);
            savePatients(patients);

            // Adicionar √† agenda automaticamente se tiver hor√°rios
            if (horarios.length > 0) {
                const sch = loadSchedule();
                sch.recurring = sch.recurring || {};
                
                horarios.forEach(h => {
                    const key = recurKey(h.dia, h.horario);
                    sch.recurring[key] = {
                        patientId: patient.id,
                        serviceType: patient.serviceType,
                        startDate: startDate
                    };
                    
                    // Adicionar hor√°rio √† lista se n√£o existir
                    if (!sch.times.includes(h.horario)) {
                        sch.times.push(h.horario);
                        sch.times.sort();
                    }
                });
                
                saveSchedule(sch);
            }

            if (currentPhotoFile) {
                savePatientPhoto(patient.id, currentPhotoFile);
            }

            $("cName").value = "";
            $("cPhone").value = "";
            $("cValue").value = "";
            $("cNotes").value = "";
            $("cStartDate").value = todayISO();
            $("cEndDate").value = addDays(todayISO(), 30);
            
            currentPhotoFile = null;
            const photoPreview = $("photoPreview");
            const photoPlaceholder = $("photoPlaceholder");
            if (photoPreview) photoPreview.classList.add("hidden");
            if (photoPlaceholder) photoPlaceholder.classList.remove("hidden");

            const container = document.getElementById('horariosContainer');
            if (container) container.innerHTML = '';

            renderPatientSelect();
            renderPatientFolders();
            renderSchedule();
            renderDashboard();
            
            showAlert(`‚úÖ Paciente ${name} cadastrado!`, "success");
        };

        window.openAnamnese = function() {
            const p = getPatientById(openedPatientId);
            if (p) {
                $("aQueixa").value = p.anamnese?.queixa || "";
                $("aHistorico").value = p.anamnese?.historico || "";
                $("aObs").value = p.anamnese?.obs || "";
                $("anamneseModal").classList.remove("hidden");
            }
        };

        window.saveAnamnese = function() {
            const patients = loadPatients();
            const idx = patients.findIndex(p => p.id === openedPatientId);
            if (idx >= 0) {
                patients[idx].anamnese = {
                    queixa: $("aQueixa")?.value || "",
                    historico: $("aHistorico")?.value || "",
                    obs: $("aObs")?.value || ""
                };
                savePatients(patients);
                $("anamneseModal").classList.add("hidden");
                showAlert("‚úÖ Anamnese salva!", "success");
            }
        };

        window.openWhatsApp = function() {
            const p = getPatientById(openedPatientId);
            if (p?.phone) {
                window.open(`https://wa.me/55${p.phone}`, "_blank");
            } else {
                showAlert("‚ùå Sem WhatsApp", "error");
            }
        };

        window.renamePatient = function() {
            const patients = loadPatients();
            const idx = patients.findIndex(p => p.id === openedPatientId);
            if (idx >= 0) {
                const newName = prompt("Novo nome:", patients[idx].name);
                if (newName) {
                    patients[idx].name = newName.trim();
                    savePatients(patients);
                    openPatientFolder(openedPatientId);
                    renderPatientFolders();
                    renderPatientSelect();
                    showAlert("‚úÖ Nome atualizado!", "success");
                }
            }
        };

        window.deletePatient = function() {
            if (!confirm("Excluir paciente e todo hist√≥rico?")) return;
            
            const patients = loadPatients().filter(p => p.id !== openedPatientId);
            const sessions = loadSessions().filter(s => s.patientId !== openedPatientId);

            const sch = loadSchedule();
            if (sch.recurring) {
                Object.keys(sch.recurring).forEach(key => {
                    if (sch.recurring[key].patientId === openedPatientId) {
                        delete sch.recurring[key];
                    }
                });
            }

            const photos = loadPhotos();
            delete photos[openedPatientId];

            const evolucoes = loadEvolucoes();
            delete evolucoes[openedPatientId];

            savePatients(patients);
            saveSessions(sessions);
            saveSchedule(sch);
            savePhotos(photos);
            saveEvolucoes(evolucoes);

            $("foldersPane").classList.remove("hidden");
            $("folderOpenPane").classList.add("hidden");
            
            openedPatientId = null;
            renderPatientFolders();
            renderPatientSelect();
            renderSchedule();
            renderDashboard();
            showAlert("üóëÔ∏è Paciente exclu√≠do!", "success");
        };

        window.toggleDebtFilter = function() {
            debtFilterActive = !debtFilterActive;
            const btn = $("onlyDebtFolders");
            if (btn) btn.classList.toggle("primary", debtFilterActive);
            renderPatientFolders();
        };

        // ========== FUN√á√ïES DE EVOLU√á√ÉO ==========
        function getPatientEvolucoes(patientId) {
            const evolucoes = loadEvolucoes();
            return evolucoes[patientId] || [];
        }

        function savePatientEvolucao(patientId, evolucaoData) {
            const evolucoes = loadEvolucoes();
            if (!evolucoes[patientId]) {
                evolucoes[patientId] = [];
            }
            
            if (evolucaoData.id) {
                const index = evolucoes[patientId].findIndex(e => e.id === evolucaoData.id);
                if (index !== -1) {
                    evolucoes[patientId][index] = {
                        ...evolucaoData,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                evolucaoData.id = uid();
                evolucaoData.createdAt = new Date().toISOString();
                evolucoes[patientId].push(evolucaoData);
            }
            
            evolucoes[patientId].sort((a, b) => b.date.localeCompare(a.date));
            saveEvolucoes(evolucoes);
            return evolucaoData;
        }

        function deletePatientEvolucao(patientId, evolucaoId) {
            const evolucoes = loadEvolucoes();
            if (evolucoes[patientId]) {
                evolucoes[patientId] = evolucoes[patientId].filter(e => e.id !== evolucaoId);
                if (evolucoes[patientId].length === 0) {
                    delete evolucoes[patientId];
                }
                saveEvolucoes(evolucoes);
            }
        }

        window.openEvolucaoModal = function() {
            if (!openedPatientId) return;
            $("evolucaoData").value = todayISO();
            $("evolucaoTexto").value = "";
            $("evolucaoModal").classList.remove("hidden");
        };

        window.saveEvolucao = function() {
            if (!openedPatientId) return;
            const data = $("evolucaoData").value;
            const texto = $("evolucaoTexto").value.trim();
            if (!texto) return showAlert("‚ùå Escreva a evolu√ß√£o", "error");
            
            savePatientEvolucao(openedPatientId, { date: data, text: texto });
            $("evolucaoModal").classList.add("hidden");
            openPatientFolder(openedPatientId);
            showAlert("‚úÖ Evolu√ß√£o registrada!", "success");
        };

        window.editEvolucao = function(evolucaoId) {
            if (!openedPatientId) return;
            const evolucoes = getPatientEvolucoes(openedPatientId);
            const evolucao = evolucoes.find(e => e.id === evolucaoId);
            if (!evolucao) return;
            
            currentEvolucaoId = evolucaoId;
            $("editEvolucaoData").value = evolucao.date;
            $("editEvolucaoTexto").value = evolucao.text;
            $("editEvolucaoModal").classList.remove("hidden");
        };

        window.saveEditEvolucao = function() {
            if (!openedPatientId || !currentEvolucaoId) return;
            const data = $("editEvolucaoData").value;
            const texto = $("editEvolucaoTexto").value.trim();
            if (!texto) return showAlert("‚ùå Escreva a evolu√ß√£o", "error");
            
            savePatientEvolucao(openedPatientId, {
                id: currentEvolucaoId,
                date: data,
                text: texto
            });
            
            $("editEvolucaoModal").classList.add("hidden");
            currentEvolucaoId = null;
            openPatientFolder(openedPatientId);
            showAlert("‚úÖ Evolu√ß√£o atualizada!", "success");
        };

        window.deleteEvolucao = function(evolucaoId) {
            if (!openedPatientId) return;
            if (!confirm("Excluir esta evolu√ß√£o?")) return;
            deletePatientEvolucao(openedPatientId, evolucaoId);
            openPatientFolder(openedPatientId);
            showAlert("üóëÔ∏è Evolu√ß√£o exclu√≠da!", "success");
        };

        function renderEvolucoes() {
            const container = $("evolucoesList");
            if (!container || !openedPatientId) return;
            const evolucoes = getPatientEvolucoes(openedPatientId);
            container.innerHTML = evolucoes.map(ev => `
                <div class="timeline-item">
                    <div class="timeline-date">üìÖ ${new Date(ev.date).toLocaleDateString()}</div>
                    <div class="timeline-content">${escapeHtml(ev.text)}</div>
                    <div class="timeline-actions">
                        <button class="small" onclick="editEvolucao('${ev.id}')">‚úèÔ∏è</button>
                        <button class="small danger" onclick="deleteEvolucao('${ev.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        // ========== RELAT√ìRIOS ==========
        function generateReports() {
            const sessions = loadSessions();
            const patients = loadPatients();
            const tokens = loadTokens();
            const currentMonth = todayISO().slice(0, 7);

            const monthSessions = sessions.filter(s => s.date.startsWith(currentMonth));
            const realizacoes = monthSessions.filter(s => s.did === "realizou");
            const faltas = monthSessions.filter(s => s.did === "nao");
            const faturamento = realizacoes.reduce((sum, s) => sum + (Number(s.value) || 0), 0);
            const aReceber = monthSessions.filter(s => s.paid !== "pago").reduce((sum, s) => sum + (Number(s.value) || 0), 0);

            $("monthSummary").innerHTML = `Sess√µes: ${monthSessions.length}<br>Realizadas: ${realizacoes.length}<br>Faltas: ${faltas.length}`;
            $("absenceRate").innerHTML = monthSessions.length ? `${((faltas.length / monthSessions.length) * 100).toFixed(1)}%` : "0%";
            $("revenueStats").innerHTML = `Faturado: ${fmtMoney(faturamento)}<br>A receber: ${fmtMoney(aReceber)}`;
            $("activePatients").innerHTML = patients.length.toString();

            const sessoesCassems = sessions.filter(s => {
                const p = getPatientById(s.patientId);
                return p?.serviceType === "cassems";
            });

            const tokensEnviados = contarTotalTokens();
            const tokensPendentes = Object.values(tokens).filter(t => t.status === "pendente").length;
            const tokensProblema = Object.values(tokens).filter(t => t.status === "problema").length;

            $("totalSessoesCassems").textContent = sessoesCassems.length;
            $("totalTokensEnviados").textContent = tokensEnviados;
            $("totalTokensPendentes").textContent = tokensPendentes;

            // Top devedores
            const debtors = patients.map(p => {
                const debt = sessions.filter(s => s.patientId === p.id && s.paid !== "pago")
                    .reduce((sum, s) => sum + (Number(s.value) || 0), 0);
                return { name: p.name, debt };
            }).filter(d => d.debt > 0).sort((a, b) => b.debt - a.debt).slice(0, 5);

            $("topDebtors").innerHTML = debtors.map(d => `
                <div class="item">
                    <b>${escapeHtml(d.name)}</b>
                    <div class="muted">${fmtMoney(d.debt)}</div>
                </div>
            `).join("") || "<div class='muted'>Nenhum devedor</div>";
        }

        // ========== RENDERIZA√á√ÉO DO HTML ==========
        function renderApp() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <section id="appWrap">
                    <header>
                        <div class="logo-container">
                            <div class="logo-icon">GA</div>
                            <div class="logo-text">
                                <h2>${CLINIC_NAME}</h2>
                                <p>${CLINIC_SUBTITLE}</p>
                                <small>${CLINIC_CRFA}</small>
                            </div>
                        </div>

                        <div style="display:flex; align-items:center; gap:10px;">
                            <div id="today" class="muted"></div>
                            <button id="themeToggle" class="small" style="border-radius:30px;" onclick="toggleTheme()">üåì Tema</button>
                            <button id="installPWA" class="small primary" style="display:none;" onclick="installPWA()">üì± Instalar App</button>
                        </div>

                        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                            <div class="backup-bar">
                                <span class="muted">üíæ Backup:</span>
                                <button class="small primary" onclick="exportarDados()">üì§ Exportar</button>
                                <button class="small" onclick="importarDados()">üì• Importar</button>
                            </div>

                            <div class="tabs">
                                <button class="tab active" id="tabDashboard" onclick="setTab('dashboard')">üìä Dashboard</button>
                                <button class="tab" id="tabDaily" onclick="setTab('daily')">üìÖ Di√°rio</button>
                                <button class="tab" id="tabPatients" onclick="setTab('patients')">üë• Pacientes</button>
                                <button class="tab" id="tabSchedule" onclick="setTab('schedule')">üìÜ Agendamento</button>
                                <button class="tab" id="tabReports" onclick="setTab('reports')">üìà Relat√≥rios</button>
                            </div>
                        </div>
                    </header>

                    <main>
                        <!-- DASHBOARD -->
                        <section id="viewDashboard" class="card">
                            <h2>üìä Dashboard</h2>
                            <div class="dashboard-grid">
                                <div class="stat-card">
                                    <div>Pacientes Hoje</div>
                                    <div class="stat-value" id="dashHoje">0</div>
                                    <div class="muted" id="dashHojeDetalhe"></div>
                                </div>
                                <div class="stat-card">
                                    <div>Pr√≥ximos 15min</div>
                                    <div class="stat-value" id="dashProximos">0</div>
                                    <div class="muted" id="dashProximosNomes"></div>
                                </div>
                                <div class="stat-card">
                                    <div>Faturamento Hoje</div>
                                    <div class="stat-value" id="dashFaturamento">R$ 0</div>
                                    <div class="muted" id="dashFaturamentoDetalhe"></div>
                                </div>
                                <div class="stat-card">
                                    <div>Taxa de Faltas</div>
                                    <div class="stat-value" id="dashTaxaFaltas">0%</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="dashProgresso" style="width:0%"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid3" style="margin-top:20px;">
                                <div class="cardMini">
                                    <b>üé´ Tokens Cassems Hoje</b>
                                    <div class="stat-value" id="tokensHoje">0</div>
                                    <div class="muted" id="tokensHojeDetalhe"></div>
                                </div>
                                <div class="cardMini">
                                    <b>‚úÖ Enviados</b>
                                    <div class="stat-value" id="tokensEnviados">0</div>
                                    <div class="muted" id="tokensEnviadosDetalhe"></div>
                                </div>
                                <div class="cardMini">
                                    <b>‚è≥ Pendentes</b>
                                    <div class="stat-value" id="tokensPendentes">0</div>
                                    <div class="muted" id="tokensPendentesDetalhe"></div>
                                </div>
                            </div>

                            <div style="margin-top:20px;">
                                <h3>üéÇ Aniversariantes do M√™s</h3>
                                <div id="aniversariantes" class="list"></div>
                            </div>

                            <div style="margin-top:20px;">
                                <h3>‚è∞ Pr√≥ximos Atendimentos</h3>
                                <div id="proximosAtendimentos" class="list"></div>
                            </div>
                        </section>

                        <!-- Di√°rio -->
                        <section id="viewDaily" class="card hidden">
                            <div class="row">
                                <div>
                                    <label>Data do atendimento</label>
                                    <input id="date" type="date" onchange="renderDaily()" />
                                </div>
                                <div>
                                    <label>Buscar paciente</label>
                                    <input id="search" placeholder="Nome..." oninput="renderDaily()" />
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <button id="findInDay" class="small primary" onclick="findInDay()">üîç Procurar</button>
                                    <button id="clearDay" class="small danger" onclick="clearDay()">üóëÔ∏è Limpar dia</button>
                                </div>
                            </div>

                            <div class="sum">
                                <div class="cardMini">
                                    <b>Resumo do dia</b>
                                    <div class="muted" id="sumDay">‚Äî</div>
                                </div>
                                <div class="cardMini">
                                    <b>Financeiro</b>
                                    <div class="muted" id="sumMoney">‚Äî</div>
                                </div>
                                <div class="cardMini">
                                    <b>Faltas hoje</b>
                                    <div class="muted" id="sumAbsences">‚Äî</div>
                                </div>
                            </div>

                            <div class="grid3" style="margin:15px 0;">
                                <div class="cardMini">
                                    <b>üé´ Pacientes Cassems</b>
                                    <div id="cassemsHoje" class="stat-value" style="font-size:1.5rem;">0</div>
                                </div>
                                <div class="cardMini">
                                    <b>‚úÖ Tokens Enviados</b>
                                    <div id="tokensEnviadosHoje" class="stat-value" style="font-size:1.5rem; color:#2C7A5A;">0</div>
                                </div>
                                <div class="cardMini">
                                    <b>‚è≥ Pendentes</b>
                                    <div id="tokensPendentesHoje" class="stat-value" style="font-size:1.5rem; color:#E8C66A;">0</div>
                                </div>
                            </div>

                            <hr>

                            <b>‚ûï Adicionar sess√£o</b>
                            <div class="grid2">
                                <div>
                                    <label>Paciente</label>
                                    <select id="pPatient" onchange="updateDefaultHint()"></select>
                                </div>
                                <div>
                                    <label>Hor√°rio</label>
                                    <input id="pTime" placeholder="14:30" />
                                </div>
                                <div>
                                    <label>Sess√£o</label>
                                    <select id="pDid">
                                        <option value="realizou">‚úÖ Realizou</option>
                                        <option value="nao">‚ùå N√£o realizou</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Justificativa</label>
                                    <select id="pJust">
                                        <option value="na">‚Äî</option>
                                        <option value="justificada">üìù Justificada</option>
                                        <option value="nao_justificada">‚ö†Ô∏è N√£o justificada</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Pagamento</label>
                                    <select id="pPaid">
                                        <option value="nao_pago">üí∏ N√£o pago</option>
                                        <option value="pago">üí∞ Pago</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Valor (R$)</label>
                                    <input id="pValue" placeholder="80,00" />
                                    <small id="hintDefault" class="muted"></small>
                                </div>
                            </div>

                            <div class="row">
                                <button id="addSession" class="primary" onclick="addSession()">‚ûï Adicionar</button>
                                <button id="resetAll" class="danger" onclick="resetAll()">‚ö†Ô∏è Zerar tudo</button>
                            </div>

                            <div class="list" id="dayList"></div>
                        </section>

                        <!-- Pacientes -->
                        <section id="viewPatients" class="card hidden">
                            <div class="split">
                                <div class="card">
                                    <h3 style="margin-top:0;">üë§ Cadastro de Paciente</h3>
                                    
                                    <div class="photo-upload">
                                        <img id="photoPreview" class="photo-preview hidden" src="" alt="Foto do paciente" />
                                        <div id="photoPlaceholder" class="photo-placeholder">üì∑</div>
                                        <input type="file" id="patientPhoto" accept="image/*" style="display:none;" onchange="handlePhotoUpload(this)" />
                                        <button class="small" onclick="document.getElementById('patientPhoto').click()">üì∏ Escolher foto</button>
                                    </div>

                                    <div class="grid2">
                                        <div>
                                            <label>Nome completo *</label>
                                            <input id="cName" placeholder="Jo√£o Silva" />
                                        </div>
                                        <div>
                                            <label>WhatsApp</label>
                                            <input id="cPhone" placeholder="67999999999" />
                                        </div>
                                    </div>

                                    <div class="grid2">
                                        <div>
                                            <label>Conv√™nio</label>
                                            <select id="cServiceType">
                                                <option value="particular">Particular</option>
                                                <option value="cassems">Cassems</option>
                                                <option value="unimed">Unimed</option>
                                                <option value="outros">Outros</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>Valor padr√£o (R$)</label>
                                            <input id="cValue" placeholder="80,00" />
                                        </div>
                                    </div>

                                    <div class="grid2">
                                        <div>
                                            <label>Pacote</label>
                                            <select id="cBillingType" onchange="atualizarDiasSemana()">
                                                <option value="pack4">4 sess√µes</option>
                                                <option value="pack8">8 sess√µes</option>
                                                <option value="individual">Individual</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>&nbsp;</label>
                                            <input type="text" readonly style="background:transparent; border:none;" />
                                        </div>
                                    </div>

                                    <div style="margin:15px 0;">
                                        <label>üìÖ Per√≠odo</label>
                                        <div class="grid2">
                                            <div>
                                                <input type="date" id="cStartDate" />
                                                <small class="muted">In√≠cio</small>
                                            </div>
                                            <div>
                                                <input type="date" id="cEndDate" />
                                                <small class="muted">T√©rmino</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div style="margin:15px 0;">
                                        <label>üìÜ Hor√°rios das sess√µes</label>
                                        <div id="horariosContainer"></div>
                                        <small class="muted">Esses hor√°rios ser√£o automaticamente agendados</small>
                                    </div>

                                    <label style="margin-top:15px;">Observa√ß√µes</label>
                                    <textarea id="cNotes" rows="2" placeholder="Observa√ß√µes relevantes..."></textarea>

                                    <div style="margin-top:15px;">
                                        <button class="primary" onclick="addPatient()" style="width:100%;">üíæ Salvar Paciente</button>
                                    </div>
                                </div>

                                <div class="card">
                                    <div id="foldersPane">
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                            <b>üìÅ Pastas de Pacientes</b>
                                            <div style="display:flex; gap:8px;">
                                                <input id="pSearch" placeholder="Buscar..." style="width:200px;" oninput="renderPatientFolders()" />
                                                <button id="onlyDebtFolders" class="small" onclick="toggleDebtFilter()">üí∏ Com d√©bito</button>
                                            </div>
                                        </div>
                                        <div id="patientFolders" class="list"></div>
                                    </div>

                                    <div id="folderOpenPane" class="hidden">
                                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:15px;">
                                            <button id="backToFolders" class="small" onclick="closePatientFolder()">‚Üê Voltar</button>
                                            <img id="folderPatientPhoto" class="photo-preview small hidden" src="" alt="" />
                                            <div style="flex:1;">
                                                <b id="openPatientTitle">Paciente</b>
                                                <div class="muted" id="openPatientMeta"></div>
                                            </div>
                                            <div style="display:flex; gap:8px;">
                                                <button id="btnAnamnese" class="small info" onclick="openAnamnese()">üìã Anamnese</button>
                                                <button id="openWhats" class="small" onclick="openWhatsApp()">üì± WhatsApp</button>
                                                <button id="renamePatient" class="small" onclick="renamePatient()">‚úèÔ∏è Renomear</button>
                                                <button id="deletePatient" class="small danger" onclick="deletePatient()">üóëÔ∏è Excluir</button>
                                            </div>
                                        </div>

                                        <div id="pacoteProgresso" style="margin:10px 0;"></div>
                                        
                                        <div style="margin-top:20px;">
                                            <h3>üìã Hist√≥rico de Sess√µes</h3>
                                            <div id="patientHistory" class="list"></div>
                                        </div>

                                        <div style="margin-top:30px;" id="evolucoesSection"></div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Agendamento -->
                        <section id="viewSchedule" class="card hidden">
                            <div class="row">
                                <div>
                                    <label>Data refer√™ncia</label>
                                    <input id="schedRef" type="date" onchange="renderSchedule()" />
                                </div>
                                <div>
                                    <label>Adicionar hor√°rio</label>
                                    <div style="display:flex; gap:8px;">
                                        <input id="newTime" placeholder="07:00" />
                                        <button id="addTime" class="small primary" onclick="addTime()">‚ûï</button>
                                    </div>
                                </div>
                                <div>
                                    <label>Filtro</label>
                                    <div style="display:flex; gap:5px;">
                                        <button id="filterHoje" class="small" onclick="filterHoje()">Hoje</button>
                                        <button id="filterAmanha" class="small" onclick="filterAmanha()">Amanh√£</button>
                                        <button id="filterSemana" class="small" onclick="filterSemana()">Semana</button>
                                    </div>
                                </div>
                            </div>

                            <div class="schedWrap">
                                <table class="sched" id="schedTable"></table>
                            </div>

                            <div class="muted" style="margin-top:15px; padding:10px; background:rgba(255,255,255,.03); border-radius:12px;">
                                <span class="pill ok">üü¢ Cassems</span>
                                <span class="pill warn">üü° Particular</span>
                                <span class="pill info">üîµ Unimed/Outros</span>
                                <span class="pill bad">üî¥ Vago</span>
                                <span class="pill token">üé´ Token</span>
                                <span class="pill">üìä Contador de sess√µes</span>
                            </div>
                        </section>

                        <!-- Relat√≥rios -->
                        <section id="viewReports" class="card hidden">
                            <h2 style="margin-bottom:20px;">üìà Relat√≥rios</h2>

                            <div class="grid2">
                                <div class="cardMini">
                                    <b>Resumo do M√™s</b>
                                    <div id="monthSummary" class="muted" style="margin-top:10px;">Carregando...</div>
                                </div>
                                <div class="cardMini">
                                    <b>Taxa de Faltas</b>
                                    <div id="absenceRate" class="muted" style="margin-top:10px;">Carregando...</div>
                                </div>
                                <div class="cardMini">
                                    <b>Faturamento</b>
                                    <div id="revenueStats" class="muted" style="margin-top:10px;">Carregando...</div>
                                </div>
                                <div class="cardMini">
                                    <b>Pacientes Ativos</b>
                                    <div id="activePatients" class="muted" style="margin-top:10px;">Carregando...</div>
                                </div>
                            </div>

                            <div style="margin-top:20px;">
                                <b>üé´ Controle de Tokens Cassems</b>
                                <div class="grid3" style="margin-top:10px;">
                                    <div class="cardMini">
                                        <b>Total de sess√µes Cassems</b>
                                        <div id="totalSessoesCassems" class="stat-value" style="font-size:1.5rem;">0</div>
                                    </div>
                                    <div class="cardMini">
                                        <b>Tokens Enviados</b>
                                        <div id="totalTokensEnviados" class="stat-value" style="font-size:1.5rem; color:#2C7A5A;">0</div>
                                    </div>
                                    <div class="cardMini">
                                        <b>Tokens Pendentes</b>
                                        <div id="totalTokensPendentes" class="stat-value" style="font-size:1.5rem; color:#E8C66A;">0</div>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top:20px;">
                                <b>Pacientes com maior d√©bito</b>
                                <div id="topDebtors" class="list" style="margin-top:10px;"></div>
                            </div>
                        </section>
                    </main>

                    <div class="shortcuts-hint" id="shortcutsHint" onclick="toggleShortcuts()">‚å®Ô∏è Atalhos</div>
                    <div class="shortcuts-panel hidden" id="shortcutsPanel">
                        <h4 style="margin-bottom:10px;">Atalhos de Teclado</h4>
                        <div class="shortcut-item"><span>Novo paciente</span> <span class="shortcut-key">Ctrl+N</span></div>
                        <div class="shortcut-item"><span>Buscar</span> <span class="shortcut-key">Ctrl+F</span></div>
                        <div class="shortcut-item"><span>Dashboard</span> <span class="shortcut-key">Ctrl+1</span></div>
                        <div class="shortcut-item"><span>Di√°rio</span> <span class="shortcut-key">Ctrl+2</span></div>
                        <div class="shortcut-item"><span>Pacientes</span> <span class="shortcut-key">Ctrl+3</span></div>
                        <div class="shortcut-item"><span>Agenda</span> <span class="shortcut-key">Ctrl+4</span></div>
                        <div class="shortcut-item"><span>Relat√≥rios</span> <span class="shortcut-key">Ctrl+5</span></div>
                    </div>
                </section>
            `;
        }

        // ========== FUN√á√ïES ADICIONAIS ==========
        window.toggleShortcuts = function() {
            $("shortcutsPanel")?.classList.toggle("hidden");
        };

        window.installPWA = function() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showAlert("‚úÖ App instalado com sucesso!", "success");
                    }
                    deferredPrompt = null;
                });
            }
        };

        window.findInDay = function() {
            const term = $("search")?.value.toLowerCase() || "";
            const patient = loadPatients().find(p => p.name.toLowerCase().includes(term));
            if (patient) {
                $("pPatient").value = patient.id;
                updateDefaultHint();
                showAlert(`üîç ${patient.name} selecionado`, "success");
            }
            renderDaily();
        };

        window.clearDay = function() {
            const date = $("date")?.value;
            if (!date) return;
            
            if (confirm(`Limpar todas as sess√µes de ${date}?`)) {
                const sessions = loadSessions().filter(s => s.date !== date);
                saveSessions(sessions);
                
                const tokens = loadTokens();
                const sessionsToRemove = loadSessions().filter(s => s.date === date);
                sessionsToRemove.forEach(s => delete tokens[s.id]);
                saveTokens(tokens);
                
                renderDaily();
                renderDashboard();
                renderSchedule();
                showAlert("üóëÔ∏è Dia limpo!", "success");
            }
        };

        window.resetAll = function() {
            if (confirm("‚ö†Ô∏è Isso apagar√° TODOS os dados! Continuar?")) {
                localStorage.removeItem(KEYS.PATIENTS);
                localStorage.removeItem(KEYS.SESSIONS);
                localStorage.removeItem(KEYS.SCHEDULE);
                localStorage.removeItem(KEYS.TOKENS);
                localStorage.removeItem(KEYS.PHOTOS);
                localStorage.removeItem(KEYS.EVOLUCOES);
                localStorage.removeItem(KEYS.ULTIMO_RESET);
                location.reload();
            }
        };

        window.addTime = function() {
            const time = $("newTime")?.value.trim();
            if (!time) return;
            if (!/^\d{1,2}:\d{2}$/.test(time)) {
                return showAlert("‚ùå Formato inv√°lido. Use HH:MM", "error");
            }

            const sch = loadSchedule();
            if (!sch.times.includes(time)) {
                sch.times.push(time);
                sch.times.sort();
                saveSchedule(sch);
                renderSchedule();
                showAlert(`‚úÖ Hor√°rio ${time} adicionado!`, "success");
            }
            $("newTime").value = "";
        };

        window.resetTimes = function() {
            if (confirm("Restaurar hor√°rios padr√£o?")) {
                const sch = loadSchedule();
                sch.times = defaultTimes();
                saveSchedule(sch);
                renderSchedule();
                showAlert("‚úÖ Hor√°rios restaurados!", "success");
            }
        };

        // ========== INICIALIZA√á√ÉO ==========
        function init() {
            const lastVersion = localStorage.getItem(KEYS.VERSION);
            if (lastVersion !== APP_VERSION) {
                localStorage.setItem(KEYS.VERSION, APP_VERSION);
            }

            renderApp();
            
            const savedTheme = localStorage.getItem(KEYS.THEME);
            if (savedTheme === "light") {
                document.body.classList.add("light-mode");
                $("themeToggle").innerHTML = "üåô Tema";
            }

            $("date").value = todayISO();
            $("schedRef").value = todayISO();
            $("cStartDate").value = todayISO();
            $("cEndDate").value = addDays(todayISO(), 30);
            
            $("today").innerHTML = new Date().toLocaleDateString("pt-BR", {
                weekday: "long", year: "numeric", month: "long", day: "numeric"
            });

            autoBackup = localStorage.getItem("autoBackup") !== "false";
            
            // Verificar se precisa zerar tokens ao iniciar
            verificarZerarTokens();
            
            const notificationStatus = localStorage.getItem(KEYS.NOTIFICATIONS);
            if (notificationStatus === "granted") {
                notificationsEnabled = true;
                startNotificationChecker();
            } else if (window.Notification && Notification.permission === "granted") {
                notificationsEnabled = true;
                localStorage.setItem(KEYS.NOTIFICATIONS, "granted");
                startNotificationChecker();
            } else if (window.Notification && Notification.permission !== "denied") {
                setTimeout(() => $("notificationModal")?.classList.remove("hidden"), 30000);
            }

            $("importFile")?.addEventListener('change', carregarArquivo);

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                $("installPWA").style.display = "inline-block";
            });

            document.addEventListener("keydown", (e) => {
                if (e.ctrlKey) {
                    switch (e.key) {
                        case "n": e.preventDefault(); setTab("patients"); $("cName")?.focus(); break;
                        case "f": e.preventDefault(); 
                            if ($("viewDaily")?.classList.contains("hidden")) setTab("daily");
                            $("search")?.focus(); 
                            break;
                        case "1": e.preventDefault(); setTab("dashboard"); break;
                        case "2": e.preventDefault(); setTab("daily"); break;
                        case "3": e.preventDefault(); setTab("patients"); break;
                        case "4": e.preventDefault(); setTab("schedule"); renderSchedule(); break;
                        case "5": e.preventDefault(); setTab("reports"); generateReports(); break;
                    }
                }
            });

            $("cancelNotification")?.addEventListener("click", () => $("notificationModal")?.classList.add("hidden"));
            $("enableNotifications")?.addEventListener("click", requestNotificationPermission);
            $("closeAnamnese")?.addEventListener("click", () => $("anamneseModal")?.classList.add("hidden"));
            $("saveAnamnese")?.addEventListener("click", saveAnamnese);
            $("cancelToken")?.addEventListener("click", () => {
                $("tokenModal")?.classList.add("hidden");
                currentTokenSessionId = null;
            });
            $("saveToken")?.addEventListener("click", saveToken);
            $("cancelEvolucao")?.addEventListener("click", () => $("evolucaoModal")?.classList.add("hidden"));
            $("saveEvolucao")?.addEventListener("click", saveEvolucao);
            $("cancelEditEvolucao")?.addEventListener("click", () => $("editEvolucaoModal")?.classList.add("hidden"));
            $("saveEditEvolucao")?.addEventListener("click", saveEditEvolucao);

            renderPatientSelect();
            renderDaily();
            renderPatientFolders();
            renderSchedule();
            renderDashboard();
            generateReports();

            setTimeout(atualizarDiasSemana, 100);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
