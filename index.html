<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cl√≠nicaHub ‚Äî Pacientes</title>
  <style>
    :root {
      --bg: #0a0f1c;
      --card: #141b2b;
      --line: rgba(255, 255, 255, 0.12);
      --text: #e2eaff;
      --muted: #9aa9c7;
      --pri: #0ea5e9;
      --bad: #ef4444;
      --ok: #22c55e;
      --warn: #f59e0b;
      --info: #8b5cf6;
      --r: 14px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    .hidden {
      display: none !important;
    }

    .muted {
      color: var(--muted);
      font-size: .92rem;
    }

    /* Cards e badges */
    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: .85rem;
      margin-right: 6px;
      margin-top: 6px;
    }

    .pill.ok {
      border-color: rgba(34, 197, 94, .35);
      background: rgba(34, 197, 94, .12);
    }

    .pill.bad {
      border-color: rgba(239, 68, 68, .35);
      background: rgba(239, 68, 68, .12);
    }

    .pill.info {
      border-color: rgba(139, 92, 246, .35);
      background: rgba(139, 92, 246, .12);
    }

    .pill.warn {
      border-color: rgba(245, 158, 11, .35);
      background: rgba(245, 158, 11, .12);
    }

    .pill.pri {
      border-color: rgba(14, 165, 233, .35);
      background: rgba(14, 165, 233, .12);
    }

    /* Bot√µes */
    button {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .06);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: .2s;
      font-size: .95rem;
    }

    button:hover {
      background: rgba(255, 255, 255, .12);
    }

    button.primary {
      border-color: rgba(14, 165, 233, .5);
      background: rgba(14, 165, 233, .25);
    }

    button.primary:hover {
      background: rgba(14, 165, 233, .35);
    }

    button.danger {
      border-color: rgba(239, 68, 68, .5);
      background: rgba(239, 68, 68, .18);
    }

    button.danger:hover {
      background: rgba(239, 68, 68, .28);
    }

    button.small {
      padding: 8px 12px;
      font-size: .9rem;
    }

    /* Formul√°rios */
    input,
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .06);
      color: var(--text);
      outline: none;
      font-family: inherit;
      font-size: .95rem;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(14, 165, 233, .5);
      box-shadow: 0 0 0 2px rgba(14, 165, 233, .2);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    label {
      display: block;
      margin: 0 0 6px;
      color: var(--muted);
      font-size: .9rem;
    }

    hr {
      border: none;
      border-top: 1px solid var(--line);
      margin: 14px 0;
    }

    /* Layout principal */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 16px 24px;
      border-bottom: 1px solid var(--line);
      flex-wrap: wrap;
      background: rgba(0, 0, 0, .2);
    }

    h1 {
      margin: 0;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    main {
      padding: 20px;
      display: grid;
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r);
      padding: 18px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: end;
    }

    .row>* {
      flex: 1 1 200px;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    @media(max-width:900px) {
      .grid2 {
        grid-template-columns: 1fr;
      }
    }

    .sum {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .sum .cardMini {
      flex: 1 1 250px;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      background: rgba(255, 255, 255, .03);
    }

    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tab {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .04);
      padding: 10px 16px;
    }

    .tab.active {
      border-color: rgba(14, 165, 233, .45);
      background: rgba(14, 165, 233, .18);
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
      max-height: 600px;
      overflow-y: auto;
    }

    .item {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .03);
      border-radius: 14px;
      padding: 15px;
    }

    .item:hover {
      background: rgba(255, 255, 255, .05);
    }

    .itemTop {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .split {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 15px;
    }

    @media(max-width:1000px) {
      .split {
        grid-template-columns: 1fr;
      }
    }

    /* Progress bar */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, .1);
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--pri);
      transition: width .3s;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, .7);
      backdrop-filter: blur(3px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 25px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    /* Alertas */
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 12px;
      background: var(--card);
      border: 1px solid var(--pri);
      box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
      z-index: 2000;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>

<body>

  <!-- Painel Principal -->
  <section id="appWrap">
    <header>
      <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
        <h1>üè• Cl√≠nicaHub ‚Äî Pacientes</h1>
        <div id="today" class="muted"></div>
      </div>

      <div class="tabs">
        <button class="tab" id="tabDaily">üìÖ Di√°rio</button>
        <button class="tab active" id="tabPatients">üë• Pacientes</button>
        <button class="tab" id="tabSchedule">üìÜ Agendamento</button>
      </div>
    </header>

    <main>
      <!-- Di√°rio (simplificado) -->
      <section id="viewDaily" class="card hidden">
        <div class="row">
          <div>
            <label>Data</label>
            <input id="date" type="date" />
          </div>
          <div>
            <button id="goToPatients" class="small">üë• Ir para Pacientes</button>
          </div>
        </div>
        <div class="list" id="dayList"></div>
      </section>

      <!-- PACIENTES - TOTALMENTE CORRIGIDO -->
      <section id="viewPatients" class="card">
        <div class="split">
          <!-- Cadastro de Paciente -->
          <div class="card">
            <b>üë§ Cadastro de Paciente</b>
            <div class="grid2" style="margin-top:15px;">
              <div>
                <label>Nome completo *</label>
                <input id="cName" placeholder="Jo√£o Silva" />
              </div>
              <div>
                <label>Data nascimento</label>
                <input id="cBirth" type="date" />
              </div>
              <div>
                <label>CPF</label>
                <input id="cCpf" placeholder="000.000.000-00" />
              </div>
              <div>
                <label>Respons√°vel</label>
                <input id="cResp" placeholder="Nome do respons√°vel" />
              </div>
              <div>
                <label>WhatsApp</label>
                <input id="cPhone" placeholder="67999999999" />
              </div>
              <div>
                <label>E-mail</label>
                <input id="cEmail" type="email" placeholder="paciente@email.com" />
              </div>
              <div>
                <label>Conv√™nio</label>
                <select id="cServiceType">
                  <option value="particular">Particular</option>
                  <option value="cassems">Cassems</option>
                  <option value="unimed">Unimed</option>
                  <option value="outros">Outros</option>
                </select>
              </div>
              <div>
                <label>Valor padr√£o (R$)</label>
                <input id="cDefaultValue" placeholder="80,00" />
              </div>
              <div>
                <label>Tipo de cobran√ßa</label>
                <select id="cBillingType">
                  <option value="pack4">üì¶ Pacote 4 sess√µes</option>
                  <option value="pack8">üì¶ Pacote 8 sess√µes</option>
                  <option value="individual">üí≥ Individual</option>
                </select>
              </div>
              <div>
                <label>Hor√°rio fixo</label>
                <div style="display:flex; gap:8px;">
                  <select id="cFixDay" style="flex:1;">
                    <option value="">Dia</option>
                    <option value="0">Seg</option>
                    <option value="1">Ter</option>
                    <option value="2">Qua</option>
                    <option value="3">Qui</option>
                    <option value="4">Sex</option>
                    <option value="5">S√°b</option>
                    <option value="6">Dom</option>
                  </select>
                  <input id="cFixHour" placeholder="07:40" style="flex:1;" />
                </div>
                <small class="muted">Agenda autom√°tica</small>
              </div>
            </div>

            <label style="margin-top:15px;">Observa√ß√µes</label>
            <textarea id="cNotes" rows="2" placeholder="Observa√ß√µes..."></textarea>

            <div class="row" style="margin-top:15px;">
              <button id="addPatient" class="primary">üíæ Salvar paciente</button>
            </div>
          </div>

          <!-- LISTA DE PACIENTES (CORRIGIDA - APARECE SEMPRE) -->
          <div class="card">
            <div id="foldersPane">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <b>üìÅ Lista de Pacientes</b>
                <div style="display:flex; gap:8px;">
                  <input id="pSearch" placeholder="Filtrar por nome..." style="width:200px;" />
                  <button id="onlyDebtFolders" class="small">üí∏ Com d√©bito</button>
                </div>
              </div>
              
              <!-- LISTA DE PACIENTES - SEMPRE VIS√çVEL -->
              <div id="patientFolders" class="list"></div>
            </div>

            <!-- PASTA ABERTA DO PACIENTE -->
            <div id="folderOpenPane" class="hidden">
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:15px;">
                <button id="backToFolders" class="small">‚Üê Voltar para lista</button>
                <div style="flex:1;">
                  <b id="openPatientTitle">Paciente</b>
                  <div class="muted" id="openPatientMeta"></div>
                </div>
                <div style="display:flex; gap:8px;">
                  <button id="btnAnamnese" class="small info">üìã Anamnese</button>
                  <button id="openWhats" class="small">üì± WhatsApp</button>
                  <button id="renamePatient" class="small">‚úèÔ∏è Renomear</button>
                  <button id="deletePatient" class="small danger">üóëÔ∏è Excluir</button>
                </div>
              </div>

              <!-- Progresso do pacote -->
              <div id="pacoteProgresso" style="margin:10px 0; padding:10px; background:rgba(255,255,255,.03); border-radius:10px;"></div>

              <!-- Hist√≥rico do paciente -->
              <div id="patientHistory" class="list" style="max-height:400px;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Agendamento (simplificado) -->
      <section id="viewSchedule" class="card hidden">
        <div class="row">
          <div>
            <label>Data</label>
            <input id="schedRef" type="date" />
          </div>
          <div>
            <button id="goToPatientsFromSchedule" class="small">üë• Ir para Pacientes</button>
          </div>
        </div>
        <div class="schedWrap" id="schedTable"></div>
      </section>
    </main>
  </section>

  <!-- Modal Anamnese -->
  <div id="anamneseModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3>üìã Anamnese</h3>
      <div style="margin:15px 0;">
        <label>Queixa principal</label>
        <textarea id="aQueixa" rows="2"></textarea>
      </div>
      <div style="margin:15px 0;">
        <label>Hist√≥rico</label>
        <textarea id="aHistorico" rows="2"></textarea>
      </div>
      <div style="margin:15px 0;">
        <label>Observa√ß√µes</label>
        <textarea id="aObs" rows="3"></textarea>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="closeAnamnese" class="small">Fechar</button>
        <button id="saveAnamnese" class="primary small">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIGURA√á√ïES ==========
    const KEYS = {
      PATIENTS: "clinica_patients_main",
      SESSIONS: "clinica_sessions_main",
      SCHEDULE: "clinica_schedule_main"
    };

    const DAYS = ["Seg", "Ter", "Qua", "Qui", "Sex", "S√°b", "Dom"];

    let openedPatientId = null;
    let alertTimeout = null;
    let debtFilterActive = false;

    const $ = id => document.getElementById(id);

    // ========== UTILIT√ÅRIOS ==========
    function uid() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function todayISO() {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
    }

    function parseMoney(val) {
      if (!val) return 0;
      return Number(String(val).replace(/\./g, "").replace(",", ".")) || 0;
    }

    function fmtMoney(val) {
      return Number(val || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function escapeHtml(str) {
      return String(str || "")
        .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function saveData(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }

    function loadData(key, defaultValue = null) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
      } catch {
        return defaultValue;
      }
    }

    // ========== ALERTAS ==========
    function showAlert(message, type = "info") {
      if (alertTimeout) clearTimeout(alertTimeout);
      
      const alert = document.createElement("div");
      alert.className = `alert`;
      alert.innerHTML = message;
      alert.style.background = type === "success" ? "rgba(34,197,94,.2)" : 
                              type === "warning" ? "rgba(245,158,11,.2)" : 
                              "rgba(14,165,233,.2)";
      alert.style.borderColor = type === "success" ? "#22c55e" : 
                                type === "warning" ? "#f59e0b" : 
                                "#0ea5e9";
      document.body.appendChild(alert);
      
      alertTimeout = setTimeout(() => {
        alert.remove();
      }, 3000);
    }

    // ========== PACIENTES ==========
    function loadPatients() { return loadData(KEYS.PATIENTS, []); }
    function savePatients(p) { saveData(KEYS.PATIENTS, p); }

    function getPatientById(id) {
      return loadPatients().find(p => p.id === id);
    }

    // ========== SESS√ïES ==========
    function loadSessions() { return loadData(KEYS.SESSIONS, []); }
    function saveSessions(s) { saveData(KEYS.SESSIONS, s); }

    // ========== AGENDA ==========
    function loadSchedule() { return loadData(KEYS.SCHEDULE, { times: [], recurring: {} }); }
    function saveSchedule(s) { saveData(KEYS.SCHEDULE, s); }

    function recurKey(day, time) { return `${day}|${time}`; }

    // ========== FUN√á√ÉO PRINCIPAL - LISTA DE PACIENTES (CORRIGIDA) ==========
    function renderPatientFolders() {
      console.log("Renderizando lista de pacientes...");
      const search = $("pSearch")?.value?.toLowerCase() || "";
      const allPatients = loadPatients();
      
      console.log("Total de pacientes:", allPatients.length);
      
      // Filtrar por busca
      let filteredPatients = allPatients.filter(p => 
        !search || (p.name || "").toLowerCase().includes(search)
      );

      // Filtrar por d√©bito
      if (debtFilterActive) {
        const sessions = loadSessions();
        filteredPatients = filteredPatients.filter(p => {
          const patientSessions = sessions.filter(s => s.patientId === p.id && s.paid !== "pago");
          return patientSessions.length > 0;
        });
      }

      const container = $("patientFolders");
      if (!container) return;

      if (filteredPatients.length === 0) {
        container.innerHTML = '<div class="item muted">Nenhum paciente cadastrado. Clique em "Salvar paciente" para adicionar.</div>';
        return;
      }

      // Ordenar por nome
      filteredPatients.sort((a, b) => (a.name || "").localeCompare(b.name || ""));

      container.innerHTML = filteredPatients.map(p => {
        const sessions = loadSessions().filter(s => s.patientId === p.id);
        const debt = sessions.filter(s => s.paid !== "pago").reduce((sum, s) => sum + (Number(s.value) || 0), 0);
        const totalSessoes = sessions.length;
        const realizadas = sessions.filter(s => s.did === "realizou").length;

        // Determinar cor do conv√™nio
        const convenioClass = p.serviceType === "cassems" ? "ok" : 
                             p.serviceType === "unimed" ? "info" : 
                             p.serviceType === "outros" ? "pri" : "warn";

        return `
          <div class="item" data-patient-id="${p.id}" style="cursor:pointer;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <b>üìÅ ${escapeHtml(p.name)}</b>
                <div class="muted" style="margin-top:5px;">
                  <span class="pill ${convenioClass}">${p.serviceType || "particular"}</span>
                  <span class="pill">${totalSessoes} sess√µes</span>
                  <span class="pill ok">${realizadas} realizadas</span>
                  ${debt > 0 ? `<span class="pill bad">üí∞ ${fmtMoney(debt)}</span>` : ''}
                </div>
              </div>
              <div>
                <button class="small primary" onclick="event.stopPropagation(); openPatientFolder('${p.id}')">Abrir</button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      // Adicionar evento de clique em cada item
      document.querySelectorAll('#patientFolders .item[data-patient-id]').forEach(item => {
        item.addEventListener('click', (e) => {
          const patientId = item.dataset.patientId;
          if (patientId) openPatientFolder(patientId);
        });
      });
    }

    // ========== ABRIR PASTA DO PACIENTE (CORRIGIDA) ==========
    window.openPatientFolder = function(id) {
      console.log("Abrindo pasta do paciente:", id);
      openedPatientId = id;
      const p = getPatientById(id);
      
      if (!p) {
        showAlert("Paciente n√£o encontrado", "error");
        return;
      }

      // Mostrar painel da pasta
      $("foldersPane").classList.add("hidden");
      $("folderOpenPane").classList.remove("hidden");
      
      // T√≠tulo e meta
      $("openPatientTitle").textContent = `üìÅ ${p.name}`;
      $("openPatientMeta").innerHTML = `
        ${p.serviceType || "Particular"} ‚Ä¢ 
        ${p.phone ? `üì± ${p.phone}` : "üì± N√£o cadastrado"} ‚Ä¢ 
        ${p.email ? `üìß ${p.email}` : ""}
      `;

      // Progresso do pacote
      const schedule = loadSchedule();
      let pacoteHtml = '<div class="muted">Nenhum pacote ativo</div>';
      
      Object.entries(schedule.recurring || {}).forEach(([key, entry]) => {
        if (entry.patientId === id && entry.plannedTotal > 1) {
          const sessions = loadSessions().filter(s =>
            s.patientId === id &&
            s.did === "realizou" &&
            s.date >= entry.startDate
          ).length;
          const remaining = entry.plannedTotal - sessions;
          const percent = (sessions / entry.plannedTotal) * 100;
          
          pacoteHtml = `
            <b>üì¶ Pacote de ${entry.plannedTotal} sess√µes</b>
            <div class="progress-bar" style="margin:10px 0;">
              <div class="progress-fill" style="width:${percent}%; background:#22c55e;"></div>
            </div>
            <div style="display:flex; justify-content:space-between;">
              <span>‚úÖ ${sessions} realizadas</span>
              <span>‚è≥ ${remaining} restantes</span>
            </div>
          `;
        }
      });
      $("pacoteProgresso").innerHTML = pacoteHtml;

      // Hist√≥rico de sess√µes
      const sessions = loadSessions()
        .filter(s => s.patientId === id)
        .sort((a, b) => b.date.localeCompare(a.date));

      $("patientHistory").innerHTML = sessions.length ? sessions.map(s => `
        <div class="item">
          <div style="display:flex; justify-content:space-between;">
            <div>
              <b>${s.date} ${s.time ? "√†s " + s.time : ""}</b>
              <div class="muted">
                ${s.did === "realizou" ? "‚úÖ Realizou" : "‚ùå N√£o realizou"}
                ${s.just === "justificada" ? "(Justificada)" : s.just === "nao_justificada" ? "(Sem just.)" : ""}
              </div>
            </div>
            <div>
              <span class="pill ${s.paid === "pago" ? "ok" : "bad"}">${s.paid === "pago" ? "üí∞ Pago" : "üí∏ N√£o pago"}</span>
              <span class="pill">${fmtMoney(s.value)}</span>
            </div>
          </div>
        </div>
      `).join("") : "<div class='muted'>Nenhuma sess√£o registrada</div>";
    };

    // ========== BOT√ïES DA PASTA (CORRIGIDOS) ==========
    $("backToFolders").addEventListener("click", () => {
      openedPatientId = null;
      $("folderOpenPane").classList.add("hidden");
      $("foldersPane").classList.remove("hidden");
      renderPatientFolders(); // Atualizar lista ao voltar
    });

    // Anamnese
    $("btnAnamnese").addEventListener("click", () => {
      const p = getPatientById(openedPatientId);
      if (p) {
        $("aQueixa").value = p.anamnese?.queixa || "";
        $("aHistorico").value = p.anamnese?.historico || "";
        $("aObs").value = p.anamnese?.obs || "";
        $("anamneseModal").classList.remove("hidden");
      }
    });

    $("closeAnamnese").addEventListener("click", () => {
      $("anamneseModal").classList.add("hidden");
    });

    $("saveAnamnese").addEventListener("click", () => {
      const patients = loadPatients();
      const idx = patients.findIndex(p => p.id === openedPatientId);
      if (idx >= 0) {
        patients[idx].anamnese = {
          queixa: $("aQueixa").value,
          historico: $("aHistorico").value,
          obs: $("aObs").value
        };
        savePatients(patients);
        $("anamneseModal").classList.add("hidden");
        showAlert("‚úÖ Anamnese salva!", "success");
      }
    });

    // WhatsApp
    $("openWhats").addEventListener("click", () => {
      const p = getPatientById(openedPatientId);
      if (p?.phone) {
        window.open(`https://wa.me/55${p.phone}`, "_blank");
      } else {
        showAlert("‚ùå Paciente sem WhatsApp", "error");
      }
    });

    // Renomear
    $("renamePatient").addEventListener("click", () => {
      const patients = loadPatients();
      const idx = patients.findIndex(p => p.id === openedPatientId);
      if (idx >= 0) {
        const newName = prompt("Novo nome:", patients[idx].name);
        if (newName && newName.trim()) {
          patients[idx].name = newName.trim();
          savePatients(patients);
          openPatientFolder(openedPatientId);
          renderPatientFolders();
          showAlert("‚úÖ Nome atualizado!", "success");
        }
      }
    });

    // Excluir
    $("deletePatient").addEventListener("click", () => {
      if (confirm("Excluir paciente e todo seu hist√≥rico?")) {
        const patients = loadPatients().filter(p => p.id !== openedPatientId);
        const sessions = loadSessions().filter(s => s.patientId !== openedPatientId);
        
        // Remover da agenda
        const sch = loadSchedule();
        if (sch.recurring) {
          Object.keys(sch.recurring).forEach(key => {
            if (sch.recurring[key].patientId === openedPatientId) {
              delete sch.recurring[key];
            }
          });
        }

        savePatients(patients);
        saveSessions(sessions);
        saveSchedule(sch);

        $("folderOpenPane").classList.add("hidden");
        $("foldersPane").classList.remove("hidden");
        renderPatientFolders();
        showAlert("üóëÔ∏è Paciente exclu√≠do!", "success");
      }
    });

    // ========== ADICIONAR PACIENTE ==========
    $("addPatient").addEventListener("click", () => {
      const name = $("cName").value.trim();
      if (!name) {
        showAlert("‚ùå Nome √© obrigat√≥rio", "error");
        return;
      }

      const patient = {
        id: uid(),
        name,
        birth: $("cBirth").value,
        cpf: $("cCpf").value,
        resp: $("cResp").value,
        phone: $("cPhone").value,
        email: $("cEmail").value,
        serviceType: $("cServiceType").value,
        defaultValue: parseMoney($("cDefaultValue").value),
        billingType: $("cBillingType").value,
        fixedDay: $("cFixDay").value,
        fixedHour: $("cFixHour").value,
        notes: $("cNotes").value,
        anamnese: { queixa: "", historico: "", obs: "" },
        createdAt: new Date().toISOString()
      };

      const patients = loadPatients();
      patients.push(patient);
      savePatients(patients);

      // Se tiver hor√°rio fixo, agendar automaticamente
      if (patient.fixedDay && patient.fixedHour) {
        const sch = loadSchedule();
        sch.recurring = sch.recurring || {};
        const key = recurKey(parseInt(patient.fixedDay), patient.fixedHour);

        if (!sch.recurring[key]) {
          sch.recurring[key] = {
            patientId: patient.id,
            serviceType: patient.serviceType,
            startDate: todayISO(),
            plannedTotal: patient.billingType === "pack4" ? 4 :
                         patient.billingType === "pack8" ? 8 : 1
          };

          if (!sch.times.includes(patient.fixedHour)) {
            sch.times.push(patient.fixedHour);
            sch.times.sort();
          }
          saveSchedule(sch);
        }
      }

      // Limpar formul√°rio
      $("cName").value = "";
      $("cBirth").value = "";
      $("cCpf").value = "";
      $("cResp").value = "";
      $("cPhone").value = "";
      $("cEmail").value = "";
      $("cDefaultValue").value = "";
      $("cFixHour").value = "";
      $("cNotes").value = "";

      // Atualizar lista
      renderPatientFolders();
      showAlert("‚úÖ Paciente cadastrado!", "success");
    });

    // ========== FILTROS ==========
    $("pSearch").addEventListener("input", () => {
      renderPatientFolders();
    });

    $("onlyDebtFolders").addEventListener("click", () => {
      debtFilterActive = !debtFilterActive;
      $("onlyDebtFolders").classList.toggle("primary", debtFilterActive);
      $("onlyDebtFolders").textContent = debtFilterActive ? "üí∏ Todos" : "üí∏ Com d√©bito";
      renderPatientFolders();
    });

    // ========== NAVEGA√á√ÉO ENTRE ABAS ==========
    function setTab(tab) {
      $("viewDaily").classList.toggle("hidden", tab !== "daily");
      $("viewPatients").classList.toggle("hidden", tab !== "patients");
      $("viewSchedule").classList.toggle("hidden", tab !== "schedule");
      
      $("tabDaily").classList.toggle("active", tab === "daily");
      $("tabPatients").classList.toggle("active", tab === "patients");
      $("tabSchedule").classList.toggle("active", tab === "schedule");

      if (tab === "patients") {
        renderPatientFolders();
      }
    }

    $("tabDaily").addEventListener("click", () => setTab("daily"));
    $("tabPatients").addEventListener("click", () => setTab("patients"));
    $("tabSchedule").addEventListener("click", () => setTab("schedule"));

    $("goToPatients").addEventListener("click", () => setTab("patients"));
    $("goToPatientsFromSchedule").addEventListener("click", () => setTab("patients"));

    // ========== INICIALIZA√á√ÉO ==========
    function init() {
      console.log("Inicializando sistema...");
      
      // Data atual
      $("today").textContent = new Date().toLocaleDateString("pt-BR", {
        weekday: "long", year: "numeric", month: "long", day: "numeric"
      });

      // CARREGAR LISTA DE PACIENTES IMEDIATAMENTE
      renderPatientFolders();

      // Di√°rio b√°sico
      $("date").value = todayISO();
      
      // Schedule b√°sico
      $("schedRef").value = todayISO();
    }

    // Iniciar
    init();
  </script>
</body>
</html>
