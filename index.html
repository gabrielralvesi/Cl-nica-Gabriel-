<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ClÃ­nicaHub Pro â€” Sistema Completo</title>
  <style>
    :root{
      --bg:#0a0f1c; --card:#141b2b; --line:rgba(255,255,255,.12);
      --text:#e2eaff; --muted:#9aa9c7; --pri:#0ea5e9; --bad:#ef4444; --ok:#22c55e;
      --warn:#f59e0b; --info:#8b5cf6;
      --r:14px;
    }
    *{box-sizing:border-box; margin:0; padding:0;}
    body{
      margin:0; font-family:system-ui, -apple-system, 'Segoe UI', Roboto; 
      background:var(--bg); color:var(--text); line-height:1.5;
    }
    a{color:inherit}
    .hidden{display:none !important;}
    .muted{color:var(--muted); font-size:.92rem;}
    small.muted{color:var(--muted);}
    
    /* Cards e badges */
    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px; 
      border:1px solid var(--line); font-size:.85rem; margin-right:6px; margin-top:6px;
    }
    .pill.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.12);}
    .pill.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12);}
    .pill.info{border-color:rgba(139,92,246,.35); background:rgba(139,92,246,.12);}
    .pill.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.12);}
    .pill.pri{border-color:rgba(14,165,233,.35); background:rgba(14,165,233,.12);}

    /* BotÃµes */
    button{
      padding:12px 16px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); font-weight:600; 
      cursor:pointer; transition:.2s; font-size:.95rem;
    }
    button:hover{background:rgba(255,255,255,.12);}
    button.primary{
      border-color:rgba(14,165,233,.5); background:rgba(14,165,233,.25);
    }
    button.primary:hover{background:rgba(14,165,233,.35);}
    button.danger{
      border-color:rgba(239,68,68,.5); background:rgba(239,68,68,.18);
    }
    button.danger:hover{background:rgba(239,68,68,.28);}
    button.small{padding:8px 12px; font-size:.9rem;}

    /* FormulÃ¡rios */
    input, select, textarea{
      width:100%; padding:12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); outline:none;
      font-family:inherit; font-size:.95rem;
    }
    input:focus, select:focus, textarea:focus{
      border-color:rgba(14,165,233,.5); box-shadow:0 0 0 2px rgba(14,165,233,.2);
    }
    textarea{resize:vertical; min-height:80px;}
    label{display:block; margin:0 0 6px; color:var(--muted); font-size:.9rem;}
    hr{border:none; border-top:1px solid var(--line); margin:14px 0;}

    /* Layout principal */
    header{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:16px 24px; border-bottom:1px solid var(--line); flex-wrap:wrap;
      background:rgba(0,0,0,.2);
    }
    h1{margin:0; font-size:1.3rem; display:flex; align-items:center; gap:8px;}
    main{padding:20px; display:grid; gap:20px; max-width:1400px; margin:0 auto;}
    
    .card{
      background:var(--card); border:1px solid var(--line); 
      border-radius:var(--r); padding:18px;
    }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:end;}
    .row > *{flex:1 1 200px;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;}
    @media(max-width:900px){ .grid2{grid-template-columns:1fr;} }
    
    .sum{
      display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;
    }
    .sum .cardMini{
      flex:1 1 250px; border:1px solid var(--line); border-radius:14px; 
      padding:14px; background:rgba(255,255,255,.03);
    }
    
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      padding:10px 16px;
    }
    .tab.active{
      border-color:rgba(14,165,233,.45); background:rgba(14,165,233,.18);
    }
    
    .list{display:flex; flex-direction:column; gap:10px; margin-top:15px;}
    .item{
      border:1px solid var(--line); background:rgba(255,255,255,.03); 
      border-radius:14px; padding:15px;
    }
    .item:hover{background:rgba(255,255,255,.05);}
    .itemTop{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .actions{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;
    }
    .split{
      display:grid; grid-template-columns: 1fr 1.2fr; gap:15px;
    }
    @media(max-width:1000px){ .split{grid-template-columns:1fr;} }

    /* Backup bar */
    .backup-bar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      background:rgba(14,165,233,.1); border:1px solid rgba(14,165,233,.3);
      border-radius:40px; padding:8px 15px; margin-right:10px;
    }
    .backup-bar button{padding:6px 12px; background:rgba(255,255,255,.08);}

    /* Scheduler */
    .schedWrap{overflow:auto; border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.02); max-height:600px;}
    table.sched{border-collapse:collapse; width:100%; min-width:900px;}
    .sched th, .sched td{border:1px solid rgba(255,255,255,.10); padding:12px; vertical-align:top;}
    .sched th{background:rgba(255,255,255,.04); position:sticky; top:0; z-index:2;}
    .sched td{min-width:160px; cursor:pointer; transition:.2s;}
    .sched td:hover{background:rgba(255,255,255,.08);}
    .timeCell{position:sticky; left:0; z-index:1; background:rgba(255,255,255,.04); font-weight:800;}
    .slotBox{border-radius:10px; padding:12px; height:100%;}
    .slotGreen{background:rgba(34,197,94,.15); border-left:4px solid #22c55e;}
    .slotAmber{background:rgba(245,158,11,.15); border-left:4px solid #f59e0b;}
    .slotRed{background:rgba(239,68,68,.15); border-left:4px solid #ef4444;}
    .slotBlue{background:rgba(14,165,233,.15); border-left:4px solid #0ea5e9;}
    .slotPurple{background:rgba(139,92,246,.15); border-left:4px solid #8b5cf6;}
    .iconAlert{font-size:1.1rem; margin-right:5px;}

    /* Timeline */
    .timeline{
      border-left:2px solid var(--pri); margin-left:10px; padding-left:20px;
    }
    .timeline-item{
      border-left:2px solid var(--line); padding:15px; margin-bottom:15px;
      background:rgba(255,255,255,.02); border-radius:0 12px 12px 0;
    }
    .timeline-date{color:var(--pri); font-weight:600; margin-bottom:5px;}

    /* Modal */
    .modal-overlay{
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,.7); backdrop-filter:blur(3px);
      display:flex; align-items:center; justify-content:center; z-index:1000;
    }
    .modal-content{
      background:var(--card); border:1px solid var(--line);
      border-radius:20px; padding:25px; max-width:600px; width:90%;
      max-height:80vh; overflow-y:auto;
    }
  </style>
</head>

<body>

<!-- Painel Principal -->
<section id="appWrap">
  <header>
    <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
      <h1>ğŸ¥ ClÃ­nicaHub Pro</h1>
      <div id="today" class="muted"></div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <!-- Barra de Backup -->
      <div class="backup-bar">
        <span class="muted">ğŸ’¾ Backup:</span>
        <button id="backupNow" class="small" title="Baixar backup agora">â¬‡ï¸ Baixar</button>
        <button id="restoreBackup" class="small" title="Restaurar de um arquivo">ğŸ“‚ Restaurar</button>
        <button id="autoBackupToggle" class="small pri">ğŸ”µ Auto: ON</button>
      </div>

      <div class="tabs">
        <button class="tab active" id="tabDaily">ğŸ“… DiÃ¡rio</button>
        <button class="tab" id="tabPatients">ğŸ‘¥ Pacientes</button>
        <button class="tab" id="tabSchedule">ğŸ“† Agendamento</button>
        <button class="tab" id="tabReports">ğŸ“Š RelatÃ³rios</button>
      </div>
    </div>
  </header>

  <main>
    <!-- DiÃ¡rio -->
    <section id="viewDaily" class="card">
      <div class="row">
        <div>
          <label>Data do atendimento</label>
          <input id="date" type="date"/>
        </div>
        <div>
          <label>Buscar paciente</label>
          <input id="search" placeholder="Nome..." />
        </div>
        <div style="display:flex; gap:8px;">
          <button id="findInDay" class="small primary">ğŸ” Procurar</button>
          <button id="clearDay" class="small danger">ğŸ—‘ï¸ Limpar dia</button>
        </div>
      </div>

      <div class="sum">
        <div class="cardMini">
          <b>Resumo do dia</b>
          <div class="muted" id="sumDay">â€”</div>
        </div>
        <div class="cardMini">
          <b>Financeiro</b>
          <div class="muted" id="sumMoney">â€”</div>
        </div>
        <div class="cardMini">
          <b>Faltas hoje</b>
          <div class="muted" id="sumAbsences">â€”</div>
        </div>
      </div>

      <hr>

      <b>â• Adicionar sessÃ£o</b>
      <div class="grid2">
        <div>
          <label>Paciente</label>
          <select id="pPatient"></select>
        </div>
        <div>
          <label>HorÃ¡rio</label>
          <input id="pTime" placeholder="14:30" />
        </div>
        <div>
          <label>SessÃ£o</label>
          <select id="pDid">
            <option value="realizou">âœ… Realizou</option>
            <option value="nao">âŒ NÃ£o realizou</option>
          </select>
        </div>
        <div>
          <label>Justificativa</label>
          <select id="pJust">
            <option value="na">â€”</option>
            <option value="justificada">ğŸ“ Justificada</option>
            <option value="nao_justificada">âš ï¸ NÃ£o justificada</option>
          </select>
        </div>
        <div>
          <label>Pagamento</label>
          <select id="pPaid">
            <option value="nao_pago">ğŸ’¸ NÃ£o pago</option>
            <option value="pago">ğŸ’° Pago</option>
          </select>
        </div>
        <div>
          <label>Valor (R$)</label>
          <input id="pValue" placeholder="80,00" />
          <small id="hintDefault" class="muted"></small>
        </div>
      </div>

      <div class="row">
        <button id="addSession" class="primary">â• Adicionar</button>
        <button id="resetAll" class="danger">âš ï¸ Zerar tudo</button>
      </div>

      <div class="list" id="dayList"></div>
    </section>

    <!-- Pacientes -->
    <section id="viewPatients" class="card hidden">
      <div class="split">
        <!-- Cadastro -->
        <div class="card">
          <b>ğŸ‘¤ Cadastro de Paciente</b>
          <div class="grid2" style="margin-top:15px;">
            <div>
              <label>Nome completo *</label>
              <input id="cName" placeholder="JoÃ£o Silva" />
            </div>
            <div>
              <label>Data nascimento</label>
              <input id="cBirth" type="date" />
            </div>
            <div>
              <label>CPF</label>
              <input id="cCpf" placeholder="000.000.000-00" />
            </div>
            <div>
              <label>ResponsÃ¡vel</label>
              <input id="cResp" placeholder="Nome do responsÃ¡vel" />
            </div>
            <div>
              <label>WhatsApp</label>
              <input id="cPhone" placeholder="67999999999" />
            </div>
            <div>
              <label>E-mail</label>
              <input id="cEmail" type="email" placeholder="paciente@email.com" />
            </div>
            <div>
              <label>ConvÃªnio</label>
              <select id="cServiceType">
                <option value="particular">Particular</option>
                <option value="cassems">Cassems</option>
                <option value="unimed">Unimed</option>
                <option value="outros">Outros</option>
              </select>
            </div>
            <div>
              <label>Valor padrÃ£o (R$)</label>
              <input id="cDefaultValue" placeholder="80,00" />
            </div>
            <div>
              <label>Tipo de cobranÃ§a</label>
              <select id="cBillingType">
                <option value="pack4">ğŸ“¦ Pacote 4 sessÃµes</option>
                <option value="pack8">ğŸ“¦ Pacote 8 sessÃµes</option>
                <option value="individual">ğŸ’³ Individual</option>
              </select>
            </div>
            <div>
              <label>HorÃ¡rio fixo</label>
              <div style="display:flex; gap:8px;">
                <select id="cFixDay" style="flex:1;">
                  <option value="">Dia</option>
                  <option value="0">Seg</option>
                  <option value="1">Ter</option>
                  <option value="2">Qua</option>
                  <option value="3">Qui</option>
                  <option value="4">Sex</option>
                  <option value="5">SÃ¡b</option>
                  <option value="6">Dom</option>
                </select>
                <input id="cFixHour" placeholder="07:40" style="flex:1;" />
              </div>
              <small class="muted">Agenda automÃ¡tica</small>
            </div>
          </div>

          <label style="margin-top:15px;">ObservaÃ§Ãµes iniciais</label>
          <textarea id="cNotes" rows="2" placeholder="ObservaÃ§Ãµes relevantes..."></textarea>

          <div class="row" style="margin-top:15px;">
            <button id="addPatient" class="primary">ğŸ’¾ Salvar paciente</button>
          </div>
        </div>

        <!-- Pastas -->
        <div class="card">
          <div id="foldersPane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
              <b>ğŸ“ Pastas</b>
              <div style="display:flex; gap:8px;">
                <input id="pSearch" placeholder="Buscar paciente..." style="width:200px;" />
                <button id="onlyDebtFolders" class="small">ğŸ’¸ Com dÃ©bito</button>
              </div>
            </div>
            <div id="patientFolders" class="list"></div>
          </div>

          <div id="folderOpenPane" class="hidden">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:15px;">
              <button id="backToFolders" class="small">â† Voltar</button>
              <div style="flex:1;">
                <b id="openPatientTitle">Paciente</b>
                <div class="muted" id="openPatientMeta"></div>
              </div>
              <div style="display:flex; gap:8px;">
                <button id="btnAnamnese" class="small info">ğŸ“‹ Anamnese</button>
                <button id="openWhats" class="small">ğŸ“± WhatsApp</button>
                <button id="renamePatient" class="small">âœï¸ Renomear</button>
                <button id="deletePatient" class="small danger">ğŸ—‘ï¸ Excluir</button>
              </div>
            </div>

            <div id="patientHistory" class="list"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Agendamento CORRIGIDO -->
    <section id="viewSchedule" class="card hidden">
      <div class="row">
        <div>
          <label>Data referÃªncia</label>
          <input id="schedRef" type="date" />
        </div>
        <div>
          <label>Adicionar horÃ¡rio</label>
          <div style="display:flex; gap:8px;">
            <input id="newTime" placeholder="07:00" />
            <button id="addTime" class="small primary">â•</button>
          </div>
        </div>
        <div>
          <label>HorÃ¡rios padrÃ£o</label>
          <button id="resetTimes" class="small">ğŸ”„ Resetar horÃ¡rios</button>
        </div>
      </div>

      <div class="schedWrap">
        <table class="sched" id="schedTable"></table>
      </div>

      <div class="muted" style="margin-top:15px; padding:10px; background:rgba(255,255,255,.03); border-radius:12px;">
        <span class="pill ok">ğŸŸ¢ Cassems</span>
        <span class="pill warn">ğŸŸ¡ Particular</span>
        <span class="pill info">ğŸŸ£ Unimed/Outros</span>
        <span class="pill bad">ğŸ”´ Vago</span>
        <span class="pill">âš ï¸ Falta 1</span>
        <span class="pill">ğŸ Ãšltima</span>
        <span class="pill pri">â„¹ï¸ Clique para agendar</span>
      </div>
    </section>

    <!-- RelatÃ³rios -->
    <section id="viewReports" class="card hidden">
      <h2 style="margin-bottom:20px;">ğŸ“Š RelatÃ³rios e EstatÃ­sticas</h2>
      
      <div class="grid2">
        <div class="cardMini">
          <b>Resumo do MÃªs</b>
          <div id="monthSummary" class="muted" style="margin-top:10px;">Carregando...</div>
        </div>
        <div class="cardMini">
          <b>Taxa de Faltas</b>
          <div id="absenceRate" class="muted" style="margin-top:10px;">Carregando...</div>
        </div>
        <div class="cardMini">
          <b>Faturamento</b>
          <div id="revenueStats" class="muted" style="margin-top:10px;">Carregando...</div>
        </div>
        <div class="cardMini">
          <b>Pacientes Ativos</b>
          <div id="activePatients" class="muted" style="margin-top:10px;">Carregando...</div>
        </div>
      </div>

      <div style="margin-top:20px;">
        <b>Pacientes com maior dÃ©bito</b>
        <div id="topDebtors" class="list" style="margin-top:10px;"></div>
      </div>
    </section>
  </main>
</section>

<!-- Modal de Backup -->
<div id="backupModal" class="modal-overlay hidden">
  <div class="modal-content">
    <h3 style="margin-bottom:15px;">ğŸ’¾ Restaurar Backup</h3>
    <p class="muted">Selecione um arquivo de backup (.json) para restaurar. Isso substituirÃ¡ todos os dados atuais.</p>
    <input type="file" id="backupFile" accept=".json" style="margin:15px 0;" />
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button id="cancelBackup" class="small">Cancelar</button>
      <button id="confirmRestore" class="danger small">Restaurar</button>
    </div>
  </div>
</div>

<!-- Modal Anamnese -->
<div id="anamneseModal" class="modal-overlay hidden">
  <div class="modal-content">
    <h3>ğŸ“‹ Anamnese</h3>
    <div style="margin:15px 0;">
      <label>Queixa principal</label>
      <textarea id="aQueixa" rows="2"></textarea>
    </div>
    <div style="margin:15px 0;">
      <label>HistÃ³rico</label>
      <textarea id="aHistorico" rows="2"></textarea>
    </div>
    <div style="margin:15px 0;">
      <label>ObservaÃ§Ãµes</label>
      <textarea id="aObs" rows="3"></textarea>
    </div>
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button id="closeAnamnese" class="small">Fechar</button>
      <button id="saveAnamnese" class="primary small">Salvar</button>
    </div>
  </div>
</div>

<script>
  // ========== CONFIGURAÃ‡Ã•ES ==========
  const KEYS = {
    PATIENTS: "clinica_pro_patients",
    SESSIONS: "clinica_pro_sessions",
    SCHEDULE: "clinica_pro_schedule",
    BACKUP: "clinica_pro_backup"
  };

  const DAYS = ["Seg", "Ter", "Qua", "Qui", "Sex", "SÃ¡b", "Dom"];
  const SERVICE_COLORS = {
    "cassems": "slotGreen",
    "particular": "slotAmber",
    "unimed": "slotPurple",
    "outros": "slotBlue"
  };

  let autoBackup = localStorage.getItem("autoBackup") !== "false";
  let openedPatientId = null;

  const $ = id => document.getElementById(id);

  // ========== UTILITÃRIOS ==========
  function uid() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }

  function todayISO() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function parseMoney(val) {
    if (!val) return 0;
    return Number(String(val).replace(/\./g, "").replace(",", ".")) || 0;
  }

  function fmtMoney(val) {
    return Number(val || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  function escapeHtml(str) {
    return String(str || "")
      .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }

  function saveData(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
  }

  function loadData(key, defaultValue = null) {
    try {
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : defaultValue;
    } catch {
      return defaultValue;
    }
  }

  // ========== BACKUP ==========
  function createBackup() {
    return {
      version: "1.0",
      date: new Date().toISOString(),
      data: {
        patients: loadData(KEYS.PATIENTS, []),
        sessions: loadData(KEYS.SESSIONS, []),
        schedule: loadData(KEYS.SCHEDULE, { times: defaultTimes(), recurring: {} })
      }
    };
  }

  function downloadBackup() {
    const backup = createBackup();
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `clinica_backup_${todayISO()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function restoreFromFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const backup = JSON.parse(e.target.result);
        if (backup.version && backup.data) {
          saveData(KEYS.PATIENTS, backup.data.patients || []);
          saveData(KEYS.SESSIONS, backup.data.sessions || []);
          saveData(KEYS.SCHEDULE, backup.data.schedule || { times: defaultTimes(), recurring: {} });
          
          alert("âœ… Backup restaurado com sucesso!");
          location.reload();
        } else {
          alert("âŒ Arquivo de backup invÃ¡lido");
        }
      } catch (err) {
        alert("âŒ Erro ao ler o arquivo");
      }
    };
    reader.readAsText(file);
  }

  // ========== PACIENTES ==========
  function loadPatients() { return loadData(KEYS.PATIENTS, []); }
  function savePatients(p) { saveData(KEYS.PATIENTS, p); }

  function getPatientById(id) {
    return loadPatients().find(p => p.id === id);
  }

  // ========== SESSÃ•ES ==========
  function loadSessions() { return loadData(KEYS.SESSIONS, []); }
  function saveSessions(s) { saveData(KEYS.SESSIONS, s); }

  // ========== AGENDA ==========
  function loadSchedule() {
    return loadData(KEYS.SCHEDULE, { times: defaultTimes(), recurring: {} });
  }
  function saveSchedule(s) { saveData(KEYS.SCHEDULE, s); }

  function defaultTimes() {
    return ["07:00","07:40","08:20","09:00","09:40","10:20","11:00","13:20","14:00","14:40","15:20","16:00","16:40","17:20"];
  }

  function recurKey(day, time) { return `${day}|${time}`; }

  // ========== FUNÃ‡Ã•ES DE AGENDAMENTO CORRIGIDAS ==========
  function renderSchedule() {
    const sch = loadSchedule();
    const patients = loadPatients();
    const times = (sch.times || []).sort();
    const refDate = $("schedRef").value || todayISO();
    
    let html = "<thead><tr><th class='timeCell'>HorÃ¡rio</th>";
    DAYS.forEach(day => html += `<th>${day}</th>`);
    html += "</tr></thead><tbody>";
    
    for (const time of times) {
      html += `<tr><td class="timeCell">${escapeHtml(time)}</td>`;
      
      for (let day = 0; day < 7; day++) {
        const key = recurKey(day, time);
        const entry = sch.recurring?.[key];
        
        if (entry) {
          const patient = getPatientById(entry.patientId);
          const colorClass = SERVICE_COLORS[entry.serviceType] || "slotAmber";
          const serviceLabel = entry.serviceType === "cassems" ? "Cassems" : 
                              entry.serviceType === "unimed" ? "Unimed" :
                              entry.serviceType === "outros" ? "Outros" : "Particular";
          
          // Calcular progresso do pacote
          let progressHtml = "";
          if (entry.plannedTotal > 1) {
            const sessions = loadSessions().filter(s => 
              s.patientId === entry.patientId && 
              s.did === "realizou" && 
              s.date >= entry.startDate
            ).length;
            const remaining = Math.max(0, entry.plannedTotal - sessions);
            progressHtml = `<div class="muted" style="font-size:0.8rem;">${sessions}/${entry.plannedTotal} â€¢ ${remaining} restam</div>`;
            
            if (remaining === 1) progressHtml += `<span class="iconAlert">âš ï¸</span>`;
            if (remaining === 0) progressHtml += `<span class="iconAlert">ğŸ</span>`;
          }
          
          html += `<td data-day="${day}" data-time="${time}" class="slotBox ${colorClass}">
            <div style="font-weight:600;">${escapeHtml(patient?.name || "?")}</div>
            <div class="muted" style="font-size:0.85rem;">${serviceLabel}</div>
            ${progressHtml}
          </td>`;
        } else {
          html += `<td data-day="${day}" data-time="${time}" class="slotBox slotRed" style="cursor:pointer;">
            <div style="opacity:0.7;">ğŸŸ¥ Vago</div>
            <div class="muted" style="font-size:0.8rem;">Clique para agendar</div>
          </td>`;
        }
      }
      html += "</tr>";
    }
    
    html += "</tbody>";
    $("schedTable").innerHTML = html;
    
    // Adicionar eventos de clique
    document.querySelectorAll("td[data-day]").forEach(td => {
      td.addEventListener("click", (e) => {
        const day = td.dataset.day;
        const time = td.dataset.time;
        scheduleClickHandler(parseInt(day), time);
      });
    });
  }

  function scheduleClickHandler(day, time) {
    const sch = loadSchedule();
    const key = recurKey(day, time);
    const current = sch.recurring?.[key];
    const patients = loadPatients();
    
    if (current) {
      // JÃ¡ tem paciente - perguntar se quer remover
      const patient = getPatientById(current.patientId);
      if (confirm(`Remover ${patient?.name} deste horÃ¡rio?`)) {
        delete sch.recurring[key];
        saveSchedule(sch);
        renderSchedule();
      }
    } else {
      // Vago - perguntar qual paciente agendar
      const patientList = patients.map((p, i) => `${i+1} - ${p.name}`).join("\n");
      const choice = prompt(
        `Agendar em ${DAYS[day]} Ã s ${time}\n\n` +
        `Digite o NÃšMERO do paciente:\n${patientList}\n\n` +
        `Ou 0 para cancelar`
      );
      
      if (choice && choice !== "0") {
        const idx = parseInt(choice) - 1;
        if (idx >= 0 && idx < patients.length) {
          const patient = patients[idx];
          
          // Perguntar tipo de atendimento
          const serviceType = prompt(
            `Tipo de atendimento para ${patient.name}:\n` +
            `1 - Particular\n2 - Cassems\n3 - Unimed\n4 - Outros`,
            patient.serviceType === "cassems" ? "2" : "1"
          );
          
          let finalService = "particular";
          if (serviceType === "2") finalService = "cassems";
          else if (serviceType === "3") finalService = "unimed";
          else if (serviceType === "4") finalService = "outros";
          
          // Perguntar pacote
          const packageType = prompt(
            `Tipo de pacote:\n` +
            `1 - Individual\n2 - Pacote 4\n3 - Pacote 8`,
            patient.billingType === "pack4" ? "2" : 
            patient.billingType === "pack8" ? "3" : "1"
          );
          
          let plannedTotal = 1;
          if (packageType === "2") plannedTotal = 4;
          else if (packageType === "3") plannedTotal = 8;
          
          sch.recurring = sch.recurring || {};
          sch.recurring[key] = {
            patientId: patient.id,
            serviceType: finalService,
            startDate: todayISO(),
            plannedTotal: plannedTotal
          };
          
          // Atualizar paciente
          patient.serviceType = finalService;
          if (finalService === "cassems") patient.defaultValue = 26;
          savePatients(patients);
          
          saveSchedule(sch);
          renderSchedule();
          alert(`âœ… ${patient.name} agendado para ${DAYS[day]} Ã s ${time}`);
        }
      }
    }
  }

  // ========== RELATÃ“RIOS ==========
  function generateReports() {
    const sessions = loadSessions();
    const patients = loadPatients();
    const currentMonth = todayISO().slice(0, 7);
    
    const monthSessions = sessions.filter(s => s.date.startsWith(currentMonth));
    const realizacoes = monthSessions.filter(s => s.did === "realizou");
    const faltas = monthSessions.filter(s => s.did === "nao");
    const faturamento = realizacoes.reduce((sum, s) => sum + (Number(s.value) || 0), 0);
    const aReceber = monthSessions.filter(s => s.paid !== "pago").reduce((sum, s) => sum + (Number(s.value) || 0), 0);
    
    $("monthSummary").innerHTML = `
      SessÃµes: ${monthSessions.length}<br>
      Realizadas: ${realizacoes.length}<br>
      Faltas: ${faltas.length}
    `;
    
    $("absenceRate").innerHTML = monthSessions.length ? 
      `${((faltas.length / monthSessions.length) * 100).toFixed(1)}%` : "0%";
    
    $("revenueStats").innerHTML = `
      Faturado: ${fmtMoney(faturamento)}<br>
      A receber: ${fmtMoney(aReceber)}
    `;
    
    $("activePatients").innerHTML = patients.length.toString();

    // Top devedores
    const debtors = patients.map(p => {
      const patientSessions = sessions.filter(s => s.patientId === p.id && s.paid !== "pago");
      const debt = patientSessions.reduce((sum, s) => sum + (Number(s.value) || 0), 0);
      return { name: p.name, debt };
    }).filter(d => d.debt > 0).sort((a, b) => b.debt - a.debt).slice(0, 5);

    $("topDebtors").innerHTML = debtors.length ? debtors.map(d => `
      <div class="item">
        <b>${escapeHtml(d.name)}</b>
        <div class="muted">DÃ©bito: ${fmtMoney(d.debt)}</div>
      </div>
    `).join("") : "<div class='muted'>Nenhum devedor</div>";
  }

  // ========== DIÃRIO ==========
  function renderPatientSelect() {
    const pats = loadPatients();
    const sel = $("pPatient");
    sel.innerHTML = pats.length ? 
      pats.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("") :
      `<option value="">(Cadastre pacientes)</option>`;
  }

  function renderDaily() {
    const date = $("date").value;
    const search = $("search").value.toLowerCase();
    const sessions = loadSessions().filter(s => s.date === date);
    
    const filtered = sessions.filter(s => {
      const p = getPatientById(s.patientId);
      return !search || (p?.name || "").toLowerCase().includes(search);
    });
    
    const list = $("dayList");
    list.innerHTML = filtered.map(s => {
      const p = getPatientById(s.patientId);
      return `
        <div class="item" id="session-${s.id}">
          <div style="display:flex; justify-content:space-between;">
            <div>
              <b>${s.time || "â€”"} - ${escapeHtml(p?.name || "?")}</b>
              <div class="muted">
                ${s.did === "realizou" ? "âœ… Realizou" : "âŒ NÃ£o realizou"}
                ${s.just === "justificada" ? "(Justificada)" : s.just === "nao_justificada" ? "(Sem just.)" : ""}
              </div>
            </div>
            <div>
              <span class="pill ${s.paid === "pago" ? "ok" : "bad"}">${s.paid === "pago" ? "ğŸ’° Pago" : "ğŸ’¸ NÃ£o pago"}</span>
              <span class="pill">${fmtMoney(s.value)}</span>
            </div>
          </div>
          <div class="actions" style="margin-top:10px;">
            <button class="small" onclick="toggleSessionDid('${s.id}')">ğŸ”„ Alternar</button>
            <button class="small" onclick="toggleSessionPaid('${s.id}')">ğŸ’° Pagamento</button>
            <button class="small danger" onclick="deleteSession('${s.id}')">ğŸ—‘ï¸ Excluir</button>
          </div>
        </div>
      `;
    }).join("") || "<div class='muted'>Nenhuma sessÃ£o neste dia</div>";
    
    // Atualizar resumos
    $("sumDay").innerHTML = `Total: ${filtered.length}`;
    $("sumMoney").innerHTML = `Total: ${fmtMoney(filtered.reduce((s, r) => s + (Number(r.value)||0), 0))}`;
    $("sumAbsences").innerHTML = filtered.filter(s => s.did === "nao").length.toString();
  }

  // ========== AÃ‡Ã•ES DE SESSÃƒO ==========
  window.toggleSessionDid = (id) => {
    const sessions = loadSessions();
    const idx = sessions.findIndex(s => s.id === id);
    if (idx >= 0) {
      sessions[idx].did = sessions[idx].did === "realizou" ? "nao" : "realizou";
      if (sessions[idx].did === "nao" && !sessions[idx].just) {
        sessions[idx].just = "nao_justificada";
      }
      saveSessions(sessions);
      renderDaily();
    }
  };

  window.toggleSessionPaid = (id) => {
    const sessions = loadSessions();
    const idx = sessions.findIndex(s => s.id === id);
    if (idx >= 0) {
      sessions[idx].paid = sessions[idx].paid === "pago" ? "nao_pago" : "pago";
      saveSessions(sessions);
      renderDaily();
    }
  };

  window.deleteSession = (id) => {
    if (confirm("Excluir esta sessÃ£o?")) {
      const sessions = loadSessions().filter(s => s.id !== id);
      saveSessions(sessions);
      renderDaily();
    }
  };

  // ========== PASTAS DE PACIENTES ==========
  function renderPatientFolders() {
    const search = $("pSearch").value.toLowerCase();
    const pats = loadPatients().filter(p => !search || p.name.toLowerCase().includes(search));
    const container = $("patientFolders");
    
    container.innerHTML = pats.map(p => {
      const sessions = loadSessions().filter(s => s.patientId === p.id);
      const debt = sessions.filter(s => s.paid !== "pago").reduce((sum, s) => sum + (Number(s.value)||0), 0);
      
      return `
        <div class="item" onclick="openPatientFolder('${p.id}')" style="cursor:pointer;">
          <div style="display:flex; justify-content:space-between;">
            <div>
              <b>ğŸ“ ${escapeHtml(p.name)}</b>
              <div class="muted">
                ${p.serviceType || "Particular"} â€¢ ${sessions.length} sessÃµes
              </div>
            </div>
            <div>
              ${debt > 0 ? `<span class="pill bad">ğŸ’° ${fmtMoney(debt)}</span>` : ''}
            </div>
          </div>
        </div>
      `;
    }).join("") || "<div class='muted'>Nenhum paciente</div>";
  }

  function openPatientFolder(id) {
    openedPatientId = id;
    const p = getPatientById(id);
    $("foldersPane").classList.add("hidden");
    $("folderOpenPane").classList.remove("hidden");
    $("openPatientTitle").textContent = `ğŸ“ ${p?.name || "Paciente"}`;
    
    // Mostrar histÃ³rico
    const sessions = loadSessions().filter(s => s.patientId === id).sort((a,b) => b.date.localeCompare(a.date));
    $("patientHistory").innerHTML = sessions.map(s => `
      <div class="item">
        <div><b>${s.date} ${s.time ? "Ã s " + s.time : ""}</b></div>
        <div class="muted">
          ${s.did === "realizou" ? "âœ… Realizou" : "âŒ NÃ£o realizou"} â€¢ 
          ${s.paid === "pago" ? "ğŸ’° Pago" : "ğŸ’¸ NÃ£o pago"} â€¢ 
          ${fmtMoney(s.value)}
        </div>
      </div>
    `).join("") || "<div class='muted'>Nenhum histÃ³rico</div>";
    
    $("openPatientMeta").innerHTML = `
      ${p.serviceType || "Particular"} â€¢ 
      ${p.phone ? `ğŸ“± ${p.phone}` : ""} â€¢ 
      ${p.email ? `ğŸ“§ ${p.email}` : ""}
    `;
  }

  // ========== INICIALIZAÃ‡ÃƒO ==========
  function init() {
    // Configurar data
    $("date").value = todayISO();
    $("schedRef").value = todayISO();
    $("today").innerHTML = new Date().toLocaleDateString("pt-BR", { 
      weekday: "long", year: "numeric", month: "long", day: "numeric" 
    });

    // Backup
    $("backupNow").addEventListener("click", downloadBackup);
    $("restoreBackup").addEventListener("click", () => {
      $("backupModal").classList.remove("hidden");
    });
    $("cancelBackup").addEventListener("click", () => {
      $("backupModal").classList.add("hidden");
    });
    $("confirmRestore").addEventListener("click", () => {
      const file = $("backupFile").files[0];
      if (file) {
        restoreFromFile(file);
        $("backupModal").classList.add("hidden");
      }
    });
    
    $("autoBackupToggle").addEventListener("click", () => {
      autoBackup = !autoBackup;
      localStorage.setItem("autoBackup", autoBackup);
      $("autoBackupToggle").innerHTML = autoBackup ? "ğŸ”µ Auto: ON" : "âšª Auto: OFF";
    });

    // Tabs
    $("tabDaily").addEventListener("click", () => setTab("daily"));
    $("tabPatients").addEventListener("click", () => setTab("patients"));
    $("tabSchedule").addEventListener("click", () => { setTab("schedule"); renderSchedule(); });
    $("tabReports").addEventListener("click", () => { setTab("reports"); generateReports(); });

    // AÃ§Ãµes
    $("addPatient").addEventListener("click", addPatient);
    $("addSession").addEventListener("click", addSession);
    $("findInDay").addEventListener("click", findInDay);
    $("clearDay").addEventListener("click", clearDay);
    $("resetAll").addEventListener("click", resetAll);
    $("date").addEventListener("change", renderDaily);
    $("search").addEventListener("input", renderDaily);
    $("pSearch").addEventListener("input", renderPatientFolders);
    $("backToFolders").addEventListener("click", () => {
      openedPatientId = null;
      $("folderOpenPane").classList.add("hidden");
      $("foldersPane").classList.remove("hidden");
    });
    $("schedRef").addEventListener("change", renderSchedule);
    $("addTime").addEventListener("click", addTime);
    $("resetTimes").addEventListener("click", resetTimes);
    $("btnAnamnese").addEventListener("click", openAnamnese);
    $("closeAnamnese").addEventListener("click", () => $("anamneseModal").classList.add("hidden"));
    $("saveAnamnese").addEventListener("click", saveAnamnese);
    $("openWhats").addEventListener("click", openWhatsApp);
    $("renamePatient").addEventListener("click", renamePatient);
    $("deletePatient").addEventListener("click", deletePatient);
    $("onlyDebtFolders").addEventListener("click", toggleDebtFilter);

    // Carregar dados
    renderPatientSelect();
    renderDaily();
    renderPatientFolders();
    renderSchedule();
  }

  function setTab(tab) {
    $("viewDaily").classList.toggle("hidden", tab !== "daily");
    $("viewPatients").classList.toggle("hidden", tab !== "patients");
    $("viewSchedule").classList.toggle("hidden", tab !== "schedule");
    $("viewReports").classList.toggle("hidden", tab !== "reports");
    
    [$("tabDaily"), $("tabPatients"), $("tabSchedule"), $("tabReports")].forEach(t => 
      t.classList.remove("active")
    );
    $(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add("active");
  }

  // ========== AÃ‡Ã•ES DE PACIENTE ==========
  function addPatient() {
    const name = $("cName").value.trim();
    if (!name) return alert("Nome Ã© obrigatÃ³rio");
    
    const patient = {
      id: uid(),
      name,
      birth: $("cBirth").value,
      cpf: $("cCpf").value,
      resp: $("cResp").value,
      phone: $("cPhone").value,
      email: $("cEmail").value,
      serviceType: $("cServiceType").value,
      defaultValue: parseMoney($("cDefaultValue").value),
      billingType: $("cBillingType").value,
      fixedDay: $("cFixDay").value,
      fixedHour: $("cFixHour").value,
      notes: $("cNotes").value,
      anamnese: { queixa: "", historico: "", obs: "" },
      createdAt: new Date().toISOString()
    };
    
    const patients = loadPatients();
    patients.push(patient);
    savePatients(patients);
    
    // Se tiver horÃ¡rio fixo, agendar automaticamente
    if (patient.fixedDay && patient.fixedHour) {
      const sch = loadSchedule();
      sch.recurring = sch.recurring || {};
      const key = recurKey(parseInt(patient.fixedDay), patient.fixedHour);
      
      if (!sch.recurring[key]) {
        sch.recurring[key] = {
          patientId: patient.id,
          serviceType: patient.serviceType,
          startDate: todayISO(),
          plannedTotal: patient.billingType === "pack4" ? 4 : 
                       patient.billingType === "pack8" ? 8 : 1
        };
        
        // Adicionar horÃ¡rio se nÃ£o existir
        if (!sch.times.includes(patient.fixedHour)) {
          sch.times.push(patient.fixedHour);
          sch.times.sort();
        }
        
        saveSchedule(sch);
      }
    }
    
    // Limpar formulÃ¡rio
    $("cName").value = "";
    $("cBirth").value = "";
    $("cCpf").value = "";
    $("cResp").value = "";
    $("cPhone").value = "";
    $("cEmail").value = "";
    $("cDefaultValue").value = "";
    $("cFixHour").value = "";
    $("cNotes").value = "";
    
    renderPatientSelect();
    renderPatientFolders();
    renderSchedule();
    alert("âœ… Paciente cadastrado!");
  }

  function openAnamnese() {
    const p = getPatientById(openedPatientId);
    if (p) {
      $("aQueixa").value = p.anamnese?.queixa || "";
      $("aHistorico").value = p.anamnese?.historico || "";
      $("aObs").value = p.anamnese?.obs || "";
      $("anamneseModal").classList.remove("hidden");
    }
  }

  function saveAnamnese() {
    const patients = loadPatients();
    const idx = patients.findIndex(p => p.id === openedPatientId);
    if (idx >= 0) {
      patients[idx].anamnese = {
        queixa: $("aQueixa").value,
        historico: $("aHistorico").value,
        obs: $("aObs").value
      };
      savePatients(patients);
      $("anamneseModal").classList.add("hidden");
      alert("âœ… Anamnese salva!");
    }
  }

  function openWhatsApp() {
    const p = getPatientById(openedPatientId);
    if (p?.phone) {
      window.open(`https://wa.me/55${p.phone}`, "_blank");
    } else {
      alert("Paciente sem WhatsApp cadastrado");
    }
  }

  function renamePatient() {
    const patients = loadPatients();
    const idx = patients.findIndex(p => p.id === openedPatientId);
    if (idx >= 0) {
      const newName = prompt("Novo nome:", patients[idx].name);
      if (newName) {
        patients[idx].name = newName.trim();
        savePatients(patients);
        openPatientFolder(openedPatientId);
        renderPatientFolders();
        renderPatientSelect();
      }
    }
  }

  function deletePatient() {
    if (confirm("Excluir paciente e todo seu histÃ³rico?")) {
      const patients = loadPatients().filter(p => p.id !== openedPatientId);
      const sessions = loadSessions().filter(s => s.patientId !== openedPatientId);
      
      // Remover da agenda
      const sch = loadSchedule();
      if (sch.recurring) {
        Object.keys(sch.recurring).forEach(key => {
          if (sch.recurring[key].patientId === openedPatientId) {
            delete sch.recurring[key];
          }
        });
      }
      
      savePatients(patients);
      saveSessions(sessions);
      saveSchedule(sch);
      
      $("folderOpenPane").classList.add("hidden");
      $("foldersPane").classList.remove("hidden");
      renderPatientFolders();
      renderPatientSelect();
      renderSchedule();
    }
  }

  let debtFilterActive = false;
  function toggleDebtFilter() {
    debtFilterActive = !debtFilterActive;
    $("onlyDebtFolders").classList.toggle("primary", debtFilterActive);
    renderPatientFolders();
  }

  // ========== AÃ‡Ã•ES DE SESSÃƒO ==========
  function addSession() {
    const date = $("date").value;
    const patientId = $("pPatient").value;
    const time = $("pTime").value;
    const did = $("pDid").value;
    const just = $("pJust").value;
    const paid = $("pPaid").value;
    const manualValue = $("pValue").value;
    
    if (!date || !patientId) return alert("Selecione data e paciente");
    
    const p = getPatientById(patientId);
    let value = manualValue ? parseMoney(manualValue) : (p?.defaultValue || 0);
    if (p?.serviceType === "cassems") value = 26;
    
    const session = {
      id: uid(),
      date, patientId, time,
      did: did,
      just: did === "nao" ? (just === "na" ? "nao_justificada" : just) : "na",
      paid, value
    };
    
    const sessions = loadSessions();
    sessions.push(session);
    saveSessions(sessions);
    
    $("pTime").value = "";
    $("pValue").value = "";
    renderDaily();
    if (openedPatientId) openPatientFolder(openedPatientId);
  }

  function findInDay() {
    const term = $("search").value.toLowerCase();
    const patient = loadPatients().find(p => p.name.toLowerCase().includes(term));
    if (patient) {
      $("pPatient").value = patient.id;
    }
    renderDaily();
  }

  function clearDay() {
    const date = $("date").value;
    if (confirm(`Limpar todas as sessÃµes de ${date}?`)) {
      const sessions = loadSessions().filter(s => s.date !== date);
      saveSessions(sessions);
      renderDaily();
    }
  }

  function resetAll() {
    if (confirm("âš ï¸ Isso apagarÃ¡ TODOS os dados! Continuar?")) {
      localStorage.removeItem(KEYS.PATIENTS);
      localStorage.removeItem(KEYS.SESSIONS);
      localStorage.removeItem(KEYS.SCHEDULE);
      location.reload();
    }
  }

  // ========== AÃ‡Ã•ES DE AGENDA ==========
  function addTime() {
    const time = $("newTime").value.trim();
    if (!time) return;
    if (!/^\d{1,2}:\d{2}$/.test(time)) {
      return alert("Formato invÃ¡lido. Use HH:MM");
    }
    
    const sch = loadSchedule();
    if (!sch.times.includes(time)) {
      sch.times.push(time);
      sch.times.sort();
      saveSchedule(sch);
      renderSchedule();
    }
    $("newTime").value = "";
  }

  function resetTimes() {
    if (confirm("Restaurar horÃ¡rios padrÃ£o?")) {
      const sch = loadSchedule();
      sch.times = defaultTimes();
      saveSchedule(sch);
      renderSchedule();
    }
  }

  // Iniciar
  init();
</script>
</body>
</html>
