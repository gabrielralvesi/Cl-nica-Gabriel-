<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cl√≠nicaHub ‚Äî Controle de Atendimentos</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111827; --line:rgba(255,255,255,.12);
      --text:#e7eefc; --muted:#aab7d6; --pri:#0ea5e9; --bad:#ef4444; --ok:#22c55e;
      --warn:#f59e0b;
      --r:14px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Arial; background:var(--bg); color:var(--text);}
    a{color:inherit}
    .hidden{display:none !important;}
    .muted{color:var(--muted); font-size:.92rem;}
    small.muted{color:var(--muted);}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--line); font-size:.85rem; margin-right:6px; margin-top:6px;}
    .pill.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.12);}
    .pill.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12);}
    .pill.info{border-color:rgba(14,165,233,.35); background:rgba(14,165,233,.10);}
    .pill.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.12);}

    button{
      padding:12px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); font-weight:700; cursor:pointer;
    }
    button.primary{border-color:rgba(14,165,233,.35); background:rgba(14,165,233,.18);}
    button.danger{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.18);}
    button.small{padding:8px 10px; font-size:.9rem;}
    input, select, textarea{
      width:100%; padding:12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); outline:none;
    }
    textarea{resize:vertical;}
    label{display:block; margin:0 0 6px; color:var(--muted); font-size:.9rem;}
    hr{border:none; border-top:1px solid var(--line); margin:14px 0;}
    #date{font-size:1.05rem; padding:14px 12px;}

    header{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:16px; border-bottom:1px solid var(--line); flex-wrap:wrap;
    }
    h1{margin:0; font-size:1.1rem;}
    main{padding:16px; display:grid; gap:14px; max-width:1200px; margin:0 auto;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--r); padding:14px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end;}
    .row > *{flex:1; min-width:160px;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    @media(max-width:900px){ .grid2{grid-template-columns:1fr;} }
    .sum{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .sum .cardMini{flex:1; min-width:220px; border:1px solid var(--line); border-radius:14px; padding:10px; background:rgba(255,255,255,.03);}
    .tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tab{border:1px solid var(--line); background:rgba(255,255,255,.04);}
    .tab.active{border-color:rgba(14,165,233,.45); background:rgba(14,165,233,.18);}
    .list{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    .item{border:1px solid var(--line); background:rgba(255,255,255,.03); border-radius:14px; padding:12px;}
    .itemTop{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .split{display:grid; grid-template-columns: 1fr 1.2fr; gap:12px;}
    @media(max-width:1000px){ .split{grid-template-columns:1fr;} }

    #loginWrap{ min-height:100vh; display:grid; place-items:center; padding:18px; }
    .loginBox{
      width:min(420px, 92vw); background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:18px;
    }
    .err{color:#fecaca; margin-top:10px; display:none;}

    /* Scheduler */
    .schedWrap{overflow:auto; border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.02);}
    table.sched{border-collapse:collapse; width:max(900px, 100%);}
    .sched th, .sched td{border:1px solid rgba(255,255,255,.10); padding:10px; vertical-align:top;}
    .sched th{background:rgba(255,255,255,.04); position:sticky; top:0; z-index:2;}
    .sched td{min-width:150px; cursor:pointer;}
    .timeCell{position:sticky; left:0; z-index:1; background:rgba(255,255,255,.04); font-weight:800;}
    .slotName{font-weight:900; display:flex; gap:8px; align-items:center;}
    .slotMeta{margin-top:6px; font-size:.9rem;}
    .slotNext{margin-top:6px; font-size:.85rem; color:rgba(255,255,255,.85);}
    .slotEmpty{color:#fff; font-weight:900;}
    .slotBox{border-radius:10px; padding:10px;}
    .slotGreen{background:rgba(34,197,94,.18); border:1px solid rgba(34,197,94,.35);}
    .slotAmber{background:rgba(245,158,11,.18); border:1px solid rgba(245,158,11,.35);}
    .slotRed{background:rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.35);}
    .iconAlert{font-size:1.05rem;}
  </style>
</head>

<body>

<section id="loginWrap" class="hidden">
  <div class="loginBox">
    <h2 style="margin:0 0 6px;">Acesso restrito</h2>
    <p class="muted" style="margin:0 0 12px;">Entre com usu√°rio e senha.</p>

    <label class="muted">Usu√°rio</label>
    <input id="loginUser" autocomplete="username" placeholder="ex: gabriel" />

    <label class="muted">Senha</label>
    <input id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

    <button id="loginBtn" class="primary" type="button">Entrar</button>
    <div id="loginErr" class="err">Usu√°rio ou senha inv√°lidos.</div>

    <p class="muted" style="margin-top:12px;">Dica: no GitHub Pages, salve como <b>index.html</b>.</p>
  </div>
</section>

<section id="appWrap" class="hidden">
  <header>
    <div>
      <h1>Cl√≠nicaHub ‚Äî Controle de Atendimentos</h1>
      <div id="today" class="muted"></div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabDaily" type="button">Di√°rio</button>
      <button class="tab" id="tabPatients" type="button">Pacientes</button>
      <button class="tab" id="tabSchedule" type="button">Agendamento</button>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button id="exportCsv">Exportar CSV (m√™s)</button>
      <button id="exportJson">Exportar JSON</button>
      <button id="logout" class="danger">Sair</button>
    </div>
  </header>

  <main>
    <!-- Di√°rio -->
    <section id="viewDaily" class="card">
      <div class="row">
        <div>
          <label>Data do atendimento</label>
          <input id="date" type="date"/>
        </div>
        <div>
          <label>Buscar (nome)</label>
          <input id="search" placeholder="Ex: Jo√£o..." />
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button id="findInDay" class="small primary" type="button">Procurar</button>
          <button id="clearDay" class="small danger" type="button">Limpar dia</button>
        </div>
      </div>

      <div class="sum">
        <div class="cardMini">
          <b>Resumo do dia</b>
          <div class="muted" id="sumDay">‚Äî</div>
        </div>
        <div class="cardMini">
          <b>Cobran√ßa do dia</b>
          <div class="muted" id="sumMoney">‚Äî</div>
        </div>
      </div>

      <hr>

      <b>Adicionar sess√£o do dia</b>

      <div class="grid2">
        <div>
          <label>Paciente (cadastro)</label>
          <select id="pPatient"></select>
          <small class="muted">Dica: use <b>Procurar</b> acima para selecionar e descer no paciente do dia.</small>
        </div>

        <div>
          <label>Hor√°rio (opcional, mas recomendado)</label>
          <input id="pTime" placeholder="Ex: 14:30" />
          <small class="muted">Para ‚Äúempurrar‚Äù sess√£o no agendamento em caso de falta, o hor√°rio precisa estar preenchido.</small>
        </div>

        <div>
          <label>Sess√£o</label>
          <select id="pDid">
            <option value="realizou">Realizou</option>
            <option value="nao">N√£o realizou</option>
          </select>
        </div>

        <div>
          <label>Se n√£o realizou: justificativa</label>
          <select id="pJust">
            <option value="na">‚Äî</option>
            <option value="justificada">Justificada</option>
            <option value="nao_justificada">N√£o justificada</option>
          </select>
        </div>

        <div>
          <label>Pagamento</label>
          <select id="pPaid">
            <option value="nao_pago">N√£o pago</option>
            <option value="pago">Pago</option>
          </select>
        </div>

        <div>
          <label>Valor (manual ‚Äî se deixar vazio usa o padr√£o do paciente)</label>
          <input id="pValue" inputmode="decimal" placeholder="Ex: 80,00" />
          <small id="hintDefault" class="muted"></small>
        </div>
      </div>

      <div class="row">
        <button id="addSession" class="primary" type="button">Adicionar sess√£o</button>
        <button id="resetAll" class="danger" type="button">Zerar tudo (cuidado)</button>
      </div>

      <div class="list" id="dayList"></div>
    </section>

    <!-- Pacientes -->
    <section id="viewPatients" class="card hidden">
      <div class="split">
        <div class="card">
          <b>Cadastrar paciente</b>

          <div class="grid2">
            <div>
              <label>Nome do paciente</label>
              <input id="cName" placeholder="Ex: Jo√£o Miguel" />
            </div>
            <div>
              <label>Respons√°vel (opcional)</label>
              <input id="cResp" placeholder="Nome do respons√°vel" />
            </div>
            <div>
              <label>WhatsApp (opcional)</label>
              <input id="cPhone" placeholder="Ex: 67999999999" />
              <small class="muted">Sem espa√ßos, s√≥ n√∫meros.</small>
            </div>

            <div>
              <label>Tipo de atendimento</label>
              <select id="cServiceType">
                <option value="particular">Particular</option>
                <option value="cassems">Cassems (R$ 26 fixo)</option>
              </select>
              <small class="muted">No agendamento: Cassems = verde ‚Ä¢ Particular = amarelo.</small>
            </div>

            <div>
              <label>Valor padr√£o</label>
              <input id="cDefaultValue" inputmode="decimal" placeholder="Ex: 80,00" />
              <small class="muted">Se for Cassems, o sistema fixa em <b>26,00</b>.</small>
            </div>

            <div>
              <label>Tipo de cobran√ßa</label>
              <select id="cBillingType">
                <option value="pack4">Pacote 4 sess√µes</option>
                <option value="pack8">Pacote 8 sess√µes</option>
                <option value="individual">Individual (por sess√£o)</option>
              </select>
              <small class="muted">Pacote conta s√≥ sess√µes <b>Realizou</b>. Se faltar, o pacote ‚Äúempurra‚Äù 1 sess√£o pra frente automaticamente no agendamento.</small>
            </div>

            
            <div>
              <label>Hor√°rio fixo (opcional)</label>
              <div class="split" style="grid-template-columns:1fr 1fr; gap:10px;">
                <div>
                  <select id="cFixDay">
                    <option value="">(sem hor√°rio fixo)</option>
                    <option value="0">Seg</option>
                    <option value="1">Ter</option>
                    <option value="2">Qua</option>
                    <option value="3">Qui</option>
                    <option value="4">Sex</option>
                    <option value="5">S√°b</option>
                    <option value="6">Dom</option>
                  </select>
                  <small class="muted">Escolha o dia.</small>
                </div>
                <div>
                  <input id="cFixHour" placeholder="Ex: 07:40" />
                  <small class="muted">Formato HH:MM.</small>
                </div>
              </div>
              <small class="muted">Ao salvar, se o hor√°rio estiver vago ele entra automaticamente na agenda (e bloqueia se estiver ocupado).</small>
            </div>

          </div>

          <label style="margin-top:10px;">Observa√ß√µes (opcional)</label>
          <textarea id="cNotes" rows="3" placeholder="Ex: foco /s/ e /z/, ceceio..."></textarea>

          <div class="row">
            <button id="addPatient" class="primary" type="button">Adicionar paciente</button>
          </div>

          <small class="muted">Depois clique no paciente na lista para abrir a ‚Äúpasta‚Äù.</small>
        </div>

        <div class="card">
          <div id="foldersPane">
            <b>Pastas de pacientes</b>
            <div class="row" style="margin-top:10px;">
              <div>
                <label>Pesquisar</label>
                <input id="pSearch" placeholder="Digite parte do nome..." />
              </div>
              <div style="display:flex; gap:8px; justify-content:flex-end; align-items:end;">
                <button id="onlyDebtFolders" class="small" type="button">Mostrar s√≥ com d√©bito</button>
              </div>
            </div>
            <div id="patientFolders" class="list"></div>
          </div>

          <div id="folderOpenPane" class="hidden">
            <div class="row" style="align-items:center;">
              <button id="backToFolders" type="button">‚Üê Voltar</button>
              <div style="flex:3;">
                <b id="openPatientTitle">Paciente</b>
                <div class="muted" id="openPatientMeta"></div>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                <button id="btnAnamnese" class="small primary" type="button">Anamnese</button>
                <button id="openWhats" class="small" type="button">WhatsApp</button>
                <button id="exportPatient" class="small" type="button">Exportar</button>
                <button id="renamePatient" class="small" type="button">Renomear</button>
                <button id="deletePatient" class="small danger" type="button">Excluir</button>
              </div>
            </div>

            <div class="sum">
              <div class="cardMini">
                <b>Resumo</b>
                <div class="muted" id="patientSummary">‚Äî</div>
              </div>
              <div class="cardMini">
                <b>Filtros</b>
                <div class="muted" id="filterLabel">Todos</div>
                <div class="actions" style="margin-top:8px;">
                  <button id="toggleOnlyUnpaid" class="small" type="button">S√≥ n√£o pagos: OFF</button>
                </div>
              </div>
            </div>

            <div style="margin-top:12px;">
              <b>Ano</b>
              <div class="actions" id="yearButtons" style="margin-top:8px;"></div>
            </div>

            <div style="margin-top:12px;">
              <b>M√™s</b>
              <div class="actions" id="monthButtons" style="margin-top:8px;"></div>
            </div>

            <div class="list" id="patientHistory"></div>

            <div id="anamneseModal" class="hidden" style="margin-top:12px;">
              <div class="item">
                <div class="itemTop">
                  <div>
                    <b>üìã Anamnese (do paciente)</b>
                    <div class="muted">Fica salva dentro da pasta do paciente. Voc√™ pode editar quando quiser.</div>
                  </div>
                  <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button id="closeAnamnese" class="small" type="button">Fechar</button>
                    <button id="saveAnamnese" class="small primary" type="button">Salvar</button>
                  </div>
                </div>

                <div class="grid2" style="margin-top:10px;">
                  <div>
                    <label>Queixa principal</label>
                    <textarea id="aQueixa" rows="2"></textarea>
                  </div>
                  <div>
                    <label>Hist√≥rico (resumo)</label>
                    <textarea id="aHistorico" rows="2"></textarea>
                  </div>
                  <div>
                    <label>Gesta√ß√£o/parto</label>
                    <textarea id="aGestacao" rows="2"></textarea>
                  </div>
                  <div>
                    <label>Sa√∫de / intercorr√™ncias</label>
                    <textarea id="aSaude" rows="2"></textarea>
                  </div>
                  <div>
                    <label>Escola / rotina</label>
                    <textarea id="aEscola" rows="2"></textarea>
                  </div>
                  <div>
                    <label>Observa√ß√µes fono</label>
                    <textarea id="aObs" rows="2"></textarea>
                  </div>
                </div>

                <div style="margin-top:10px;">
                  <label>Anexos (fotos / PDFs ‚Äî opcional)</label>
                  <input id="aFiles" type="file" multiple />
                  <small class="muted">Por enquanto, os anexos ficam s√≥ listados (nome). Quando voc√™ mandar as fotos, eu deixo o modelo igual ao seu.</small>
                  <div id="aFileList" class="muted" style="margin-top:8px;"></div>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </section>

    <!-- Agendamento -->
    <section id="viewSchedule" class="card hidden">
      <div class="row">
        <div>
          <label>Refer√™ncia (hoje)</label>
          <input id="schedRef" type="date" />
          <small class="muted">O sistema calcula as pr√≥ximas sess√µes a partir desta data.</small>
        </div>

        <div>
          <label>Adicionar hor√°rio</label>
          <input id="newTime" placeholder="Ex: 07:00 ou 15:40" />
          <button id="addTime" class="small primary" type="button" style="margin-top:8px;">Adicionar</button>
          <button id="resetTimes" class="small danger" type="button" style="margin-top:8px;">Zerar hor√°rios</button>
        </div>

        <div>
          <label>Legenda de cores</label>
          <div class="muted">
            <span class="pill ok">Verde = Cassems</span>
            <span class="pill warn">Amarelo = Particular</span>
            <span class="pill bad">Vermelho = Vago</span><br/>
            ‚ö†Ô∏è Falta 1 sess√£o ‚Ä¢ üèÅ √öltima sess√£o
          </div>
        </div>
      </div>

      <div class="schedWrap" style="margin-top:12px;">
        <table class="sched" id="schedTable"></table>
      </div>

      <div class="muted" style="margin-top:10px;">
        Dica: clique no hor√°rio ‚Üí escolha paciente e informe o tipo (Cassems/Particular). O sistema cria ‚Äúas pr√≥ximas 4/8 sess√µes‚Äù automaticamente e vai empurrando quando houver falta.
      </div>
    </section>

  </main>
</section>

<script>
  // ===== Login =====
  const USER_OK = "gabriel";
  const PASS_OK = "1234";
  const AUTH_KEY = "clinica_auth_v1";
  const AUTH_HOURS = 8;

  // ===== Storage keys (est√°veis) =====
  const KEY_PAT  = "clinica_patients_main";
  const KEY_SESS = "clinica_sessions_main";
  // NOVO: schedule recorrente (por dia da semana + hor√°rio)
  const KEY_SCHED = "clinica_schedule_main_v2";

  // Migra√ß√£o autom√°tica de chaves antigas (pacientes/sess√µes)
  const OLD_PAT_KEYS = ["clinica_patients_v2","clinica_patients_v1"];
  const OLD_SESS_KEYS = ["clinica_sessions_v4","clinica_sessions_v3","clinica_sessions_v2","clinica_sessions_v1"];
  // Migra√ß√£o schedule antigo
  const OLD_SCHED_KEYS = ["clinica_schedule_main","clinica_schedule_v1","clinica_schedule_main_v1"];

  // Dias da semana (0=Seg ... 6=Dom)
  const DAYS = ["Seg","Ter","Qua","Qui","Sex","S√°b","Dom"];

  const $ = (id) => document.getElementById(id);

  // ===== Utils =====
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function parseMoney(txt){
    if(!txt) return 0;
    const s = String(txt).trim().replace(/\./g,"").replace(",","."); 
    const n = Number(s);
    return Number.isNaN(n) ? 0 : n;
  }

  function fmtBRL(value){
    const n = Number(value);
    if(Number.isNaN(n)) return "‚Äî";
    return n.toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
  }

  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function safeParse(key){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch{ return null; }
  }

  function dateToObj(iso){ return new Date(iso + "T00:00:00"); }
  function objToISO(d){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function addDays(iso, days){
    const d = dateToObj(iso);
    d.setDate(d.getDate() + days);
    return objToISO(d);
  }
  function dayIndexFromISO(iso){
    // 0=Seg .. 6=Dom
    const d = dateToObj(iso);
    const js = d.getDay(); // 0 Dom .. 6 Sab
    return (js === 0) ? 6 : (js - 1);
  }
  function nextDateFrom(refISO, targetDayIndex){
    // devolve a pr√≥xima data (>= refISO) que cai naquele dia da semana
    const refIdx = dayIndexFromISO(refISO);
    let delta = targetDayIndex - refIdx;
    if(delta < 0) delta += 7;
    return addDays(refISO, delta);
  }
  function formatDateBR(iso){
    try{
      const d = dateToObj(iso);
      return d.toLocaleDateString("pt-BR");
    }catch{ return iso; }
  }

  // ===== Data access =====
  function migrateStorage(){
    // pacientes
    const curP = safeParse(KEY_PAT);
    if(!Array.isArray(curP) || curP.length === 0){
      for(const k of OLD_PAT_KEYS){
        const old = safeParse(k);
        if(Array.isArray(old) && old.length){
          localStorage.setItem(KEY_PAT, JSON.stringify(old));
          break;
        }
      }
    }

    // sess√µes
    const curS = safeParse(KEY_SESS);
    if(!Array.isArray(curS) || curS.length === 0){
      for(const k of OLD_SESS_KEYS){
        const old = safeParse(k);
        if(Array.isArray(old) && old.length){
          localStorage.setItem(KEY_SESS, JSON.stringify(old));
          break;
        }
      }
    }

    // schedule v2 (recorrente)
    const curSch = safeParse(KEY_SCHED);
    if(!curSch){
      // tenta migrar do antigo
      let migrated = null;
      for(const k of OLD_SCHED_KEYS){
        const old = safeParse(k);
        if(old && (old.times || old.slots)){
          // Antigo era por semana; agora virar√° "recorrente" vazio (mant√©m hor√°rios pelo menos)
          migrated = {
            times: Array.isArray(old.times) && old.times.length ? old.times : defaultTimes(),
            recurring: {} // { key: {patientId, serviceType, startDate, plannedTotal, completedRealized} }
          };
          break;
        }
      }
      if(!migrated){
        migrated = { times: defaultTimes(), recurring: {} };
      }
      localStorage.setItem(KEY_SCHED, JSON.stringify(migrated));
    }
  }

  function defaultTimes(){
    return ["07:00","07:40","08:20","09:00","09:40","10:20","11:00","13:20","14:00","14:40","15:20","16:00","16:40","17:20"];
  }

  function loadPatients(){ try{ return JSON.parse(localStorage.getItem(KEY_PAT) || "[]"); } catch { return []; } }
  function savePatients(p){ localStorage.setItem(KEY_PAT, JSON.stringify(p)); }

  function loadSessions(){ try{ return JSON.parse(localStorage.getItem(KEY_SESS) || "[]"); } catch { return []; } }
  function saveSessions(s){ localStorage.setItem(KEY_SESS, JSON.stringify(s)); }

  function loadSchedule(){ try{ return JSON.parse(localStorage.getItem(KEY_SCHED) || "{}"); } catch { return {times:[], recurring:{}}; } }
  function saveSchedule(s){ localStorage.setItem(KEY_SCHED, JSON.stringify(s)); }

  function getPatientById(id){ return loadPatients().find(p => p.id === id); }

  // ===== Auth =====
  function setSession(){
    const until = Date.now() + (AUTH_HOURS * 60 * 60 * 1000);
    localStorage.setItem(AUTH_KEY, JSON.stringify({ ok:true, until }));
  }
  function clearSession(){ localStorage.removeItem(AUTH_KEY); }
  function hasSession(){
    try{
      const data = JSON.parse(localStorage.getItem(AUTH_KEY) || "{}");
      return !!(data.ok && Date.now() <= data.until);
    }catch{ return false; }
  }
  function showLogin(){
    $("appWrap").classList.add("hidden");
    $("loginWrap").classList.remove("hidden");
    $("loginErr").style.display = "none";
    $("loginUser").value = "";
    $("loginPass").value = "";
    setTimeout(()=> $("loginUser").focus(), 50);
  }
  function showApp(){
    $("loginWrap").classList.add("hidden");
    $("appWrap").classList.remove("hidden");
  }
  function loginAttempt(){
    $("loginErr").style.display = "none";
    const u = $("loginUser").value.trim().toLowerCase();
    const p = $("loginPass").value;
    if(u === USER_OK && p === PASS_OK){
      setSession();
      bootApp();
    }else{
      $("loginErr").style.display = "block";
    }
  }
  $("loginBtn").addEventListener("click", loginAttempt);
  document.addEventListener("keydown", (e)=>{
    if(!$("loginWrap").classList.contains("hidden") && e.key === "Enter") loginAttempt();
  });
  $("logout").addEventListener("click", ()=>{ clearSession(); showLogin(); });

  // ===== Tabs =====
  function setTab(tab){
    const isDaily = tab === "daily";
    const isPatients = tab === "patients";
    const isSchedule = tab === "schedule";
    $("viewDaily").classList.toggle("hidden", !isDaily);
    $("viewPatients").classList.toggle("hidden", !isPatients);
    $("viewSchedule").classList.toggle("hidden", !isSchedule);
    $("tabDaily").classList.toggle("active", isDaily);
    $("tabPatients").classList.toggle("active", isPatients);
    $("tabSchedule").classList.toggle("active", isSchedule);
  }
  $("tabDaily").addEventListener("click", ()=> setTab("daily"));
  $("tabPatients").addEventListener("click", ()=> setTab("patients"));
  $("tabSchedule").addEventListener("click", ()=> { setTab("schedule"); renderSchedule(); });

  // ===== Billing / package =====
  function getBilling(patientId){
    const p = getPatientById(patientId);
    const billingType = p?.billingType || "pack4";
    if(billingType === "pack8") return { type:"pack", size:8 };
    if(billingType === "pack4") return { type:"pack", size:4 };
    return { type:"individual", size:1 };
  }

  function billingBadge(patientId){
    const b = getBilling(patientId);
    if(b.type === "individual") return `<span class="pill info">üí≥ Individual</span>`;
    return `<span class="pill info">üì¶ Pacote ${b.size}</span>`;
  }

  // ===== Schedule recurring model =====
  // key = dayIndex|time  (dayIndex: 0=Seg..6=Dom)
  function recurKey(dayIndex, time){ return `${dayIndex}|${time}`; }

  function getRecurEntry(dayIndex, time){
    const sch = loadSchedule();
    const k = recurKey(dayIndex, time);
    return sch.recurring?.[k] || null;
  }

  function setRecurEntry(dayIndex, time, entry){
    const sch = loadSchedule();
    sch.recurring = sch.recurring || {};
    const k = recurKey(dayIndex, time);
    if(entry === null) delete sch.recurring[k];
    else sch.recurring[k] = entry;
    saveSchedule(sch);
  }

  function realizedCountSince(patientId, startISO){
    return loadSessions().filter(s => s.patientId === patientId && s.did === "realizou" && (s.date||"") >= startISO).length;
  }

  function plannedTotalFor(entry){
    // entry.plannedTotal pode aumentar quando houver falta
    return Number(entry?.plannedTotal || 0);
  }

  function remainingFor(entry){
    const b = getBilling(entry.patientId);
    if(b.type !== "pack") return null; // individual -> sem controle de pacote no agendamento
    const realized = realizedCountSince(entry.patientId, entry.startDate);
    const total = plannedTotalFor(entry);
    return Math.max(0, total - realized);
  }

  function nextOccurrences(entry, refISO, maxN=4){
    // devolve datas das pr√≥ximas sess√µes planejadas (at√© maxN) considerando recorr√™ncia semanal
    const b = getBilling(entry.patientId);
    if(b.type !== "pack") return [];
    const total = plannedTotalFor(entry);
    const realized = realizedCountSince(entry.patientId, entry.startDate);
    const remaining = Math.max(0, total - realized);
    if(remaining <= 0) return [];

    const [dayIndexStr, time] = entry.slot.split("|"); // slot stored as "day|time"
    const dayIndex = Number(dayIndexStr);
    const start = (refISO < entry.startDate) ? entry.startDate : refISO;
    let d = nextDateFrom(start, dayIndex);
    const dates = [];
    for(let i=0; i<remaining && dates.length < maxN; i++){
      dates.push(d);
      d = addDays(d, 7);
    }
    return dates;
  }

  function serviceColorClass(serviceType){
    return serviceType === "cassems" ? "slotGreen" : "slotAmber";
  }

  function serviceLabel(serviceType){
    return serviceType === "cassems" ? "Cassems" : "Particular";
  }

  // ===== Di√°rio UI =====
  function renderPatientSelectDaily(){
    const pats = loadPatients().sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    const sel = $("pPatient");
    sel.innerHTML = "";
    if(!pats.length){
      sel.innerHTML = `<option value="">(Cadastre pacientes)</option>`;
      $("hintDefault").textContent = "";
      return;
    }
    pats.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id; opt.textContent = p.name;
      sel.appendChild(opt);
    });
    updateDefaultHint();
  }

  function updateDefaultHint(){
    const pid = $("pPatient").value;
    const p = getPatientById(pid);
    if(!p){ $("hintDefault").textContent=""; return; }
    const parts = [];
    parts.push(`Atendimento: ${p.serviceType === "cassems" ? "Cassems" : "Particular"}`);
    if(p.defaultValue && Number(p.defaultValue) > 0) parts.push(`Padr√£o: ${fmtBRL(p.defaultValue)}`);
    const b = getBilling(pid);
    parts.push(b.type === "individual" ? "Cobran√ßa: Individual" : `Cobran√ßa: Pacote ${b.size}`);
    $("hintDefault").textContent = parts.join(" ‚Ä¢ ");
  }
  $("pPatient").addEventListener("change", updateDefaultHint);

  function badgeFor(r){
    if(r.did === "realizou") return `<span class="pill ok">‚úÖ Realizou</span>`;
    if(r.did === "nao"){
      if(r.just === "justificada") return `<span class="pill">‚ö†Ô∏è N√£o realizou (Just.)</span>`;
      if(r.just === "nao_justificada") return `<span class="pill bad">‚ùå N√£o realizou (Sem just.)</span>`;
      return `<span class="pill bad">‚ùå N√£o realizou</span>`;
    }
    return `<span class="pill">‚Äî</span>`;
  }
  function payBadge(r){
    return r.paid === "pago" ? `<span class="pill ok">üí∞ Pago</span>` : `<span class="pill bad">üí∏ N√£o pago</span>`;
  }

  function daySessions(){
    const date = $("date").value;
    const q = $("search").value.trim().toLowerCase();
    const all = loadSessions().filter(s => s.date === date);
    return all
      .map(s => ({...s, patient: getPatientById(s.patientId)}))
      .filter(s => !q || ((s.patient?.name||"").toLowerCase().includes(q)))
      .sort((a,b)=> (a.time||"").localeCompare(b.time||""));
  }

  function updateDaySummary(rows){
    const total = rows.length;
    const realizou = rows.filter(r => r.did === "realizou").length;
    const faltou = rows.filter(r => r.did === "nao").length;
    const semJust = rows.filter(r => r.did === "nao" && r.just === "nao_justificada").length;

    const pagos = rows.filter(r => r.paid === "pago").length;
    const naoPagos = rows.filter(r => r.paid !== "pago").length;

    const totalPago = rows.filter(r => r.paid === "pago").reduce((s,r)=> s + (Number(r.value)||0), 0);
    const totalAberto = rows.filter(r => r.paid !== "pago").reduce((s,r)=> s + (Number(r.value)||0), 0);

    $("sumDay").textContent = `Total: ${total} | Realizou: ${realizou} | N√£o realizou: ${faltou} | Sem justificativa: ${semJust}`;
    $("sumMoney").textContent = `Pagos: ${pagos} (${fmtBRL(totalPago)}) | Em aberto: ${naoPagos} (${fmtBRL(totalAberto)})`;
  }

  function renderDaily(){
    const list = $("dayList");
    list.innerHTML = "";
    const rows = daySessions();

    if(!rows.length){
      list.innerHTML = `<div class="item"><b>Sem sess√µes cadastradas para este dia.</b><div class="muted">Adicione acima.</div></div>`;
      updateDaySummary([]);
      return;
    }

    rows.forEach(r=>{
      const pName = r.patient?.name || "(Paciente removido)";
      const div = document.createElement("div");
      div.className = "item";
      div.id = `dayitem-${r.patientId}-${r.id}`;
      div.innerHTML = `
        <div class="itemTop">
          <div>
            <b>${r.time ? escapeHtml(r.time) + " ‚Äî " : ""}${escapeHtml(pName)}</b>
            <div class="muted">
              ${badgeFor(r)} ${payBadge(r)}
              <span class="pill">Valor: ${fmtBRL(r.value)}</span>
              ${billingBadge(r.patientId)}
            </div>
          </div>
          <div class="muted">ID: ${escapeHtml(r.id)}</div>
        </div>

        <div class="actions">
          <button data-act="toggleDid" data-id="${r.id}">Alternar realizou/n√£o</button>
          <button data-act="toggleJust" data-id="${r.id}">Justificada/N√£o</button>
          <button data-act="togglePaid" data-id="${r.id}">Pago/N√£o pago</button>
          <button data-act="editValue" data-id="${r.id}">Editar valor</button>
          <button data-act="del" data-id="${r.id}" class="danger">Excluir</button>
        </div>
      `;
      list.appendChild(div);
    });

    list.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=> sessionAction(btn.dataset.act, btn.dataset.id));
    });

    updateDaySummary(rows);
  }

  // ===== Procurar no dia =====
  function findAndScroll(){
    const term = $("search").value.trim().toLowerCase();
    if(!term) return;

    const pats = loadPatients().sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    const match = pats.find(p => (p.name||"").toLowerCase().includes(term));
    if(match){
      $("pPatient").value = match.id;
      updateDefaultHint();
    }

    const date = $("date").value;
    const rows = loadSessions()
      .filter(s => s.date === date)
      .map(s => ({...s, patient: getPatientById(s.patientId)}))
      .filter(s => ((s.patient?.name||"").toLowerCase().includes(term)))
      .sort((a,b)=> (a.time||"").localeCompare(b.time||""));

    if(rows.length){
      renderDaily();
      setTimeout(()=>{
        const first = rows[0];
        const el = document.getElementById(`dayitem-${first.patientId}-${first.id}`);
        if(el){
          el.scrollIntoView({behavior:"smooth", block:"start"});
          el.style.outline = "2px solid rgba(14,165,233,.6)";
          setTimeout(()=> el.style.outline = "", 1200);
        }
      }, 30);
    }else{
      setTimeout(()=>{ $("pPatient").scrollIntoView({behavior:"smooth", block:"center"}); }, 30);
    }
  }
  $("findInDay").addEventListener("click", findAndScroll);
  $("search").addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){ e.preventDefault(); findAndScroll(); }
  });

  // ===== Session actions (inclui empurrar pacote no agendamento) =====
  function adjustRecurringOnSessionChange(sessionRow, prevRow=null){
    // Se a sess√£o for vinculada a um slot recorrente (dia+hora), atualiza plannedTotal:
    // - Se "n√£o realizou": plannedTotal++ (s√≥ para pacote) para manter 4/8 realiza√ß√µes
    // - Se completar pacote: remove do agendamento
    if(!sessionRow?.time) return; // sem hor√°rio, n√£o tem como localizar slot
    const dayIdx = dayIndexFromISO(sessionRow.date);
    const time = sessionRow.time.trim();
    const key = recurKey(dayIdx, time);
    const sch = loadSchedule();
    const entry = sch.recurring?.[key];
    if(!entry) return;
    if(entry.patientId !== sessionRow.patientId) return;

    const billing = getBilling(entry.patientId);
    if(billing.type !== "pack") return;

    // Se mudou de "nao" <-> "realizou", precisamos considerar o estado anterior.
    const prevDid = prevRow?.did;
    const newDid = sessionRow.did;

    // Se estava "nao" e virou "realizou": tira 1 do plannedTotal (desfaz empurr√£o), mas sem passar do m√≠nimo (package size)
    // Se estava "realizou" e virou "nao": adiciona 1 no plannedTotal (empurra)
    const minTotal = billing.size;

    if(prevDid && prevDid !== newDid){
      if(prevDid === "nao" && newDid === "realizou"){
        entry.plannedTotal = Math.max(minTotal, Number(entry.plannedTotal||minTotal) - 1);
      }
      if(prevDid === "realizou" && newDid === "nao"){
        entry.plannedTotal = Number(entry.plannedTotal||minTotal) + 1;
      }
    }else if(!prevDid){
      // caso de cria√ß√£o: se "nao", empurra
      if(newDid === "nao"){
        entry.plannedTotal = Number(entry.plannedTotal||minTotal) + 1;
      }
    }

    // Verifica se completou
    const remaining = remainingFor(entry);
    if(remaining === 0){
      delete sch.recurring[key];
    }else{
      sch.recurring[key] = entry;
    }
    saveSchedule(sch);
  }

  function sessionAction(act, id){
    const all = loadSessions();
    const idx = all.findIndex(x => x.id === id);
    if(idx < 0) return;
    const prev = {...all[idx]};
    const r = all[idx];

    if(act === "del"){
      // Se deletar uma falta (que empurrou), precisamos desfazer empurr√£o se ela era "nao"
      all.splice(idx,1);
      saveSessions(all);
      // desfaz empurr√£o apenas se era pacote e tinha slot
      if(prev.did === "nao"){
        // simulando mudan√ßa para "removido": reduz plannedTotal em 1, mas respeita m√≠nimo
        const dayIdx = dayIndexFromISO(prev.date);
        const time = (prev.time||"").trim();
        if(time){
          const key = recurKey(dayIdx, time);
          const sch = loadSchedule();
          const entry = sch.recurring?.[key];
          if(entry && entry.patientId === prev.patientId){
            const billing = getBilling(entry.patientId);
            if(billing.type === "pack"){
              const minTotal = billing.size;
              entry.plannedTotal = Math.max(minTotal, Number(entry.plannedTotal||minTotal) - 1);
              sch.recurring[key] = entry;
              saveSchedule(sch);
            }
          }
        }
      }
      renderDaily(); renderPatientFolders();
      if(openedPatientId) renderPatientHistoryFolder();
      renderSchedule();
      return;
    }

    if(act === "toggleDid"){
      if(r.did === "realizou"){
        r.did = "nao";
        if(!r.just || r.just === "na") r.just = "nao_justificada";
      }else{
        r.did = "realizou";
        r.just = "na";
      }
    }
    if(act === "toggleJust"){
      if(r.did !== "nao") r.did = "nao";
      r.just = (r.just === "justificada") ? "nao_justificada" : "justificada";
    }
    if(act === "togglePaid"){
      r.paid = (r.paid === "pago") ? "nao_pago" : "pago";
    }
    if(act === "editValue"){
      const cur = (Number(r.value)||0).toFixed(2).replace(".",",");
      const nv = prompt("Digite o valor (ex: 80,00):", cur);
      if(nv !== null) r.value = parseMoney(nv);
    }

    all[idx] = r;
    saveSessions(all);

    adjustRecurringOnSessionChange(r, prev);

    renderDaily(); renderPatientFolders();
    if(openedPatientId) renderPatientHistoryFolder();
    renderSchedule();
  }

  // ===== Add session =====
  $("addSession").addEventListener("click", ()=>{
    const date = $("date").value;
    const patientId = $("pPatient").value;
    const time = $("pTime").value.trim();
    const did = $("pDid").value;
    const just = $("pJust").value;
    const paid = $("pPaid").value;
    const manualValue = $("pValue").value.trim();

    if(!date || !patientId){ alert("Selecione a data e o paciente."); return; }

    const p = getPatientById(patientId);
    let value = manualValue ? parseMoney(manualValue) : (Number(p?.defaultValue) || 0);
    if((p?.serviceType || "particular") === "cassems") value = 26; // fixo Cassems

    const row = {
      id: uid(),
      date, patientId, time,
      did: (did === "nao" ? "nao" : "realizou"),
      just: (did === "nao" ? (just === "na" ? "nao_justificada" : just) : "na"),
      paid, value
    };

    const all = loadSessions(); all.push(row); saveSessions(all);

    // Ajusta agendamento (empurrar faltas / remover quando finaliza)
    adjustRecurringOnSessionChange(row, null);

    $("pTime").value = "";
    $("pValue").value = "";
    $("pDid").value = "realizou";
    $("pJust").value = "na";
    $("pPaid").value = "nao_pago";

    renderDaily(); renderPatientFolders();
    if(openedPatientId) renderPatientHistoryFolder();
    renderSchedule();

    // alertas visuais do pacote (no agendamento)
    if(row.did === "realizou" && time){
      const dayIdx = dayIndexFromISO(row.date);
      const entry = getRecurEntry(dayIdx, time);
      if(entry && entry.patientId === patientId){
        const rem = remainingFor(entry);
        if(rem === 1) alert("‚ö†Ô∏è Falta 1 sess√£o para finalizar o pacote desse paciente.");
        if(rem === 0) alert("üèÅ Pacote finalizado (√∫ltima sess√£o conclu√≠da).");
      }
    }
  });

  $("date").addEventListener("change", renderDaily);

  $("clearDay").addEventListener("click", ()=>{
    const date = $("date").value;
    if(!confirm("Apagar TODAS as sess√µes deste dia?")) return;

    // antes de apagar, coletar sess√µes do dia para ajustar o empurr√£o do agendamento
    const all = loadSessions();
    const removed = all.filter(s => s.date === date);
    const kept = all.filter(s => s.date !== date);
    saveSessions(kept);

    // desfaz empurr√µes que vieram de faltas removidas
    removed.filter(r => r.did === "nao").forEach(prev=>{
      const time = (prev.time||"").trim();
      if(!time) return;
      const dayIdx = dayIndexFromISO(prev.date);
      const key = recurKey(dayIdx, time);
      const sch = loadSchedule();
      const entry = sch.recurring?.[key];
      if(entry && entry.patientId === prev.patientId){
        const billing = getBilling(entry.patientId);
        if(billing.type === "pack"){
          const minTotal = billing.size;
          entry.plannedTotal = Math.max(minTotal, Number(entry.plannedTotal||minTotal) - 1);
          sch.recurring[key] = entry;
          saveSchedule(sch);
        }
      }
    });

    renderDaily(); renderPatientFolders();
    if(openedPatientId) renderPatientHistoryFolder();
    renderSchedule();
  });

  $("resetAll").addEventListener("click", ()=>{
    if(!confirm("Isso apaga TODOS os pacientes e registros. Tem certeza?")) return;
    localStorage.removeItem(KEY_SESS);
    localStorage.removeItem(KEY_PAT);
    localStorage.removeItem(KEY_SCHED);
    migrateStorage();
    openedPatientId = null;
    renderPatientSelectDaily();
    renderDaily();
    renderPatientFolders();
    closePatientFolder(true);
    renderSchedule();
  });

  // ===== Exports =====
  function getMonthPrefix(dateISO){ return dateISO.slice(0,7); }
  function toCsv(rows){
    const header = ["date","time","patient","did","just","paid","value"].join(",");
    const lines = rows.map(r=>{
      const p = getPatientById(r.patientId);
      return [
        r.date,
        (r.time||"").replaceAll(","," "),
        ((p?.name)||"").replaceAll(","," "),
        r.did, r.just, r.paid,
        String(Number(r.value)||0),
      ].join(",");
    });
    return [header, ...lines].join("\n");
  }

  $("exportJson").addEventListener("click", ()=>{
    const data = { patients: loadPatients(), sessions: loadSessions(), schedule: loadSchedule() };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "clinica_backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $("exportCsv").addEventListener("click", ()=>{
    const month = getMonthPrefix($("date").value);
    const rows = loadSessions().filter(r => (r.date||"").startsWith(month));
    const csv = toCsv(rows);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `clinica_${month}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // ===== Pacientes: cadastro =====
  $("cServiceType").addEventListener("change", ()=>{
    const t = $("cServiceType").value;
    if(t === "cassems"){
      $("cDefaultValue").value = "26,00";
    }
  });

  $("addPatient").addEventListener("click", ()=>{
    const name = $("cName").value.trim();
    if(!name){ alert("Digite o nome do paciente."); return; }

    const serviceType = $("cServiceType").value;
    let defaultValue = parseMoney($("cDefaultValue").value);
    if(serviceType === "cassems") defaultValue = 26;

    const billingType = $("cBillingType").value; // pack4 | pack8 | individual

    // Hor√°rio fixo (opcional) -> entra automaticamente na agenda
    const fixDayStr = ($("cFixDay")?.value ?? "").trim();
    const fixHour = ($("cFixHour")?.value ?? "").trim();

    const hasFix = (fixDayStr !== "" || fixHour !== "");
    if(hasFix){
      if(fixDayStr === "" || !fixHour){
        alert("Para usar hor√°rio fixo, selecione DIA e preencha HORA (HH:MM).");
        return;
      }
      if(!/^\d{1,2}:\d{2}$/.test(fixHour)){
        alert("Hora fixa inv√°lida. Use HH:MM (ex: 07:40).");
        return;
      }
    }

    const p = {
      id: uid(),
      name,
      resp: $("cResp").value.trim(),
      phone: $("cPhone").value.trim(),
      serviceType, // cassems | particular
      defaultValue,
      billingType, // pack4 | pack8 | individual
      fixedSlot: hasFix ? { day: Number(fixDayStr), time: fixHour } : null,
      fixedTime: hasFix ? `${DAYS[Number(fixDayStr)]} ${fixHour}` : "",
      notes: $("cNotes").value.trim(),
      anamnese: { queixa:"", historico:"", gestacao:"", saude:"", escola:"", obs:"", files: [] },
      createdAt: Date.now()
    };

    // Se tiver hor√°rio fixo: checa conflito e grava na agenda recorrente
    if(hasFix){
      const sch = loadSchedule();
      sch.times = sch.times || [];
      if(!sch.times.includes(fixHour)) sch.times.push(fixHour);

      sch.recurring = sch.recurring || {};
      const key = recurKey(Number(fixDayStr), fixHour);

      if(sch.recurring[key] && sch.recurring[key].patientId){
        alert(`Esse hor√°rio j√° est√° ocupado: ${DAYS[Number(fixDayStr)]} ${fixHour}. Escolha outro.`);
        return;
      }

      const plannedTotal =
        billingType === "pack4" ? 4 :
        billingType === "pack8" ? 8 : 1;

      sch.recurring[key] = {
        patientId: p.id,
        serviceType,
        startDate: todayISO(),
        plannedTotal
      };
      saveSchedule(sch);
    }

    const pats = loadPatients();
    pats.push(p);
    savePatients(pats);

    $("cName").value = "";
    $("cResp").value = "";
    $("cPhone").value = "";
    $("cServiceType").value = "particular";
    $("cDefaultValue").value = "";
    $("cBillingType").value = "pack4";
    if($("cFixDay")) $("cFixDay").value = "";
    if($("cFixHour")) $("cFixHour").value = "";
    $("cNotes").value = "";

    renderPatientSelectDaily();
    renderPatientFolders();
    renderSchedule();
    alert("Paciente cadastrado!");
  });


  // ===== Pastas =====
  const MONTHS = [
    {m:"01", t:"Jan"}, {m:"02", t:"Fev"}, {m:"03", t:"Mar"}, {m:"04", t:"Abr"},
    {m:"05", t:"Mai"}, {m:"06", t:"Jun"}, {m:"07", t:"Jul"}, {m:"08", t:"Ago"},
    {m:"09", t:"Set"}, {m:"10", t:"Out"}, {m:"11", t:"Nov"}, {m:"12", t:"Dez"},
  ];

  let openedPatientId = null;
  let openedMonth = "ALL";
  let openedYear = "ALL";
  let onlyUnpaid = false;
  let onlyDebtFolders = false;

  $("pSearch").addEventListener("input", renderPatientFolders);
  $("onlyDebtFolders").addEventListener("click", ()=>{
    onlyDebtFolders = !onlyDebtFolders;
    $("onlyDebtFolders").textContent = onlyDebtFolders ? "Mostrar todos" : "Mostrar s√≥ com d√©bito";
    $("onlyDebtFolders").classList.toggle("primary", onlyDebtFolders);
    renderPatientFolders();
  });

  function yearsAvailableForPatient(pid){
    const years = new Set(loadSessions().filter(s=>s.patientId===pid).map(s => (s.date||"").slice(0,4)));
    const arr = Array.from(years).filter(Boolean).sort((a,b)=> b.localeCompare(a));
    const cur = String(new Date().getFullYear());
    if(!arr.includes(cur)) arr.unshift(cur);
    return arr;
  }

  function renderPatientFolders(){
    const q = $("pSearch").value.trim().toLowerCase();
    const pats = loadPatients()
      .filter(p => !q || (p.name||"").toLowerCase().includes(q))
      .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

    const box = $("patientFolders");
    box.innerHTML = "";

    if(!pats.length){
      box.innerHTML = `<div class="item"><b>Nenhum paciente.</b><div class="muted">Cadastre ao lado.</div></div>`;
      return;
    }

    const allSess = loadSessions();
    const filtered = pats.filter(p=>{
      if(!onlyDebtFolders) return true;
      const rows = allSess.filter(s => s.patientId === p.id);
      const aberto = rows.filter(r => r.paid !== "pago").reduce((s,r)=> s + (Number(r.value)||0), 0);
      return aberto > 0;
    });

    if(!filtered.length){
      box.innerHTML = `<div class="item"><b>Sem pacientes com d√©bito.</b><div class="muted">Desative o filtro para ver todos.</div></div>`;
      return;
    }

    filtered.forEach(p=>{
      const rows = allSess.filter(s => s.patientId === p.id);
      const aberto = rows.filter(r => r.paid !== "pago").reduce((s,r)=> s + (Number(r.value)||0), 0);
      const faltasSemJust = rows.filter(r => r.did==="nao" && r.just==="nao_justificada").length;

      const div = document.createElement("div");
      div.className = "item";
      div.style.cursor = "pointer";
      div.innerHTML = `
        <div class="itemTop">
          <div>
            <b>üìÅ ${escapeHtml(p.name)}</b>
            <div class="muted">
              <span class="pill bad">Em aberto: ${fmtBRL(aberto)}</span>
              <span class="pill bad">Sem just.: ${faltasSemJust}</span>
              <span class="pill ${p.serviceType==='cassems'?'ok':'warn'}">${p.serviceType==='cassems'?'Cassems':'Particular'}</span>
              ${billingBadge(p.id)}
            </div>
          </div>
          <div class="muted">${rows.length} registros</div>
        </div>
        <div class="muted" style="margin-top:8px;">Toque para abrir a pasta</div>
      `;
      div.addEventListener("click", ()=> openPatientFolder(p.id));
      box.appendChild(div);
    });
  }

  function openPatientFolder(pid){
    openedPatientId = pid;
    openedMonth = "ALL";
    openedYear = "ALL";
    onlyUnpaid = false;
    $("toggleOnlyUnpaid").textContent = "S√≥ n√£o pagos: OFF";
    $("toggleOnlyUnpaid").classList.remove("primary");
    $("foldersPane").classList.add("hidden");
    $("folderOpenPane").classList.remove("hidden");
    $("anamneseModal").classList.add("hidden");
    renderOpenPatientHeader();
    renderYearButtons();
    renderMonthButtons();
    renderPatientHistoryFolder();
  }

  function closePatientFolder(silent=false){
    openedPatientId = null;
    openedMonth = "ALL";
    openedYear = "ALL";
    onlyUnpaid = false;
    $("anamneseModal").classList.add("hidden");
    $("folderOpenPane").classList.add("hidden");
    $("foldersPane").classList.remove("hidden");
    if(!silent) renderPatientFolders();
  }
  $("backToFolders").addEventListener("click", ()=> closePatientFolder());

  function renderOpenPatientHeader(){
    const p = getPatientById(openedPatientId);
    if(!p) return closePatientFolder();
    $("openPatientTitle").textContent = `üìÅ ${p.name}`;
    const meta = [];
    meta.push(`Atendimento: ${p.serviceType === "cassems" ? "Cassems" : "Particular"}`);
    if(p.defaultValue) meta.push(`Valor padr√£o: ${fmtBRL(p.defaultValue)}`);
    meta.push(p.billingType === "individual" ? "Cobran√ßa: Individual" : `Cobran√ßa: ${p.billingType === "pack8" ? "Pacote 8" : "Pacote 4"}`);
    if(p.fixedTime) meta.push(`Hor√°rio: ${p.fixedTime}`);
    if(p.notes) meta.push(`Obs.: ${p.notes}`);
    $("openPatientMeta").textContent = meta.join(" ‚Ä¢ ") || "‚Äî";
  }

  function renderYearButtons(){
    const box = $("yearButtons"); box.innerHTML = "";
    const btnAll = document.createElement("button");
    btnAll.textContent = "Todos";
    btnAll.className = (openedYear==="ALL") ? "primary small" : "small";
    btnAll.addEventListener("click", ()=>{ openedYear="ALL"; updateFilterLabel(); renderYearButtons(); renderPatientHistoryFolder(); });
    box.appendChild(btnAll);
    yearsAvailableForPatient(openedPatientId).forEach(y=>{
      const b = document.createElement("button");
      b.textContent = y;
      b.className = (openedYear===y) ? "primary small" : "small";
      b.addEventListener("click", ()=>{ openedYear=y; updateFilterLabel(); renderYearButtons(); renderPatientHistoryFolder(); });
      box.appendChild(b);
    });
  }

  function renderMonthButtons(){
    const box = $("monthButtons"); box.innerHTML = "";
    const btnAll = document.createElement("button");
    btnAll.textContent = "Todos";
    btnAll.className = (openedMonth==="ALL") ? "primary small" : "small";
    btnAll.addEventListener("click", ()=>{ openedMonth="ALL"; updateFilterLabel(); renderMonthButtons(); renderPatientHistoryFolder(); });
    box.appendChild(btnAll);
    MONTHS.forEach(x=>{
      const b = document.createElement("button");
      b.textContent = x.t;
      b.className = (openedMonth===x.m) ? "primary small" : "small";
      b.addEventListener("click", ()=>{ openedMonth=x.m; updateFilterLabel(); renderMonthButtons(); renderPatientHistoryFolder(); });
      box.appendChild(b);
    });
  }

  function updateFilterLabel(){
    const parts = [];
    if(openedYear !== "ALL") parts.push(`Ano ${openedYear}`);
    if(openedMonth !== "ALL") parts.push(`M√™s ${MONTHS.find(m=>m.m===openedMonth)?.t || openedMonth}`);
    if(onlyUnpaid) parts.push("S√≥ n√£o pagos");
    $("filterLabel").textContent = parts.length ? parts.join(" ‚Ä¢ ") : "Todos";
  }

  $("toggleOnlyUnpaid").addEventListener("click", ()=>{
    onlyUnpaid = !onlyUnpaid;
    $("toggleOnlyUnpaid").textContent = onlyUnpaid ? "S√≥ n√£o pagos: ON" : "S√≥ n√£o pagos: OFF";
    $("toggleOnlyUnpaid").classList.toggle("primary", onlyUnpaid);
    updateFilterLabel();
    renderPatientHistoryFolder();
  });

  function renderPatientHistoryFolder(){
    const hist = $("patientHistory"); hist.innerHTML = "";
    const p = getPatientById(openedPatientId);
    if(!p) return closePatientFolder();

    let rows = loadSessions().filter(s => s.patientId === openedPatientId);
    if(openedYear !== "ALL") rows = rows.filter(r => (r.date||"").slice(0,4) === openedYear);
    if(openedMonth !== "ALL") rows = rows.filter(r => (r.date||"").slice(5,7) === openedMonth);
    if(onlyUnpaid) rows = rows.filter(r => r.paid !== "pago");
    rows.sort((a,b)=> (b.date||"").localeCompare(a.date||""));

    const total = rows.length;
    const faltasSemJust = rows.filter(r => r.did==="nao" && r.just==="nao_justificada").length;
    const pago = rows.filter(r => r.paid==="pago").reduce((s,r)=> s + (Number(r.value)||0), 0);
    const aberto = rows.filter(r => r.paid!=="pago").reduce((s,r)=> s + (Number(r.value)||0), 0);

    $("patientSummary").textContent =
      `Registros: ${total} | Sem justificativa: ${faltasSemJust} | Pago: ${fmtBRL(pago)} | Em aberto: ${fmtBRL(aberto)}`;

    updateFilterLabel();

    if(!rows.length){
      hist.innerHTML = `<div class="item"><b>Sem registros neste filtro.</b><div class="muted">Tente outro m√™s/ano ou ‚ÄúTodos‚Äù.</div></div>`;
      return;
    }

    rows.slice(0, 120).forEach(r=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="itemTop">
          <div>
            <b>${escapeHtml(r.date)}${r.time ? " ‚Äî " + escapeHtml(r.time) : ""}</b>
            <div class="muted">
              ${badgeFor(r)} ${payBadge(r)}
              <span class="pill">Valor: ${fmtBRL(r.value)}</span>
            </div>
          </div>
          <div class="muted">ID: ${escapeHtml(r.id)}</div>
        </div>
        <div class="actions">
          <button data-act="togglePaid" data-id="${r.id}">Pago/N√£o pago</button>
          <button data-act="editValue" data-id="${r.id}">Editar valor</button>
          <button data-act="del" data-id="${r.id}" class="danger">Excluir</button>
        </div>
      `;
      div.querySelectorAll("button[data-act]").forEach(btn=> btn.addEventListener("click", ()=> sessionAction(btn.dataset.act, btn.dataset.id)));
      hist.appendChild(div);
    });
  }

  $("openWhats").addEventListener("click", ()=>{
    const p = getPatientById(openedPatientId);
    if(!p || !p.phone) return alert("Esse paciente n√£o tem WhatsApp cadastrado.");
    const msg = encodeURIComponent("Ol√°, tudo bem?");
    window.open(`https://wa.me/55${p.phone}?text=${msg}`, "_blank");
  });

  $("exportPatient").addEventListener("click", ()=>{
    const p = getPatientById(openedPatientId);
    if(!p) return;
    const sessions = loadSessions().filter(s => s.patientId === openedPatientId);
    const data = { patient: p, sessions };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `paciente_${(p.name||"").replace(/\s+/g,"_")}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $("renamePatient").addEventListener("click", ()=>{
    const pats = loadPatients();
    const idx = pats.findIndex(x => x.id === openedPatientId);
    if(idx < 0) return;
    const nv = prompt("Novo nome do paciente:", pats[idx].name || "");
    if(!nv) return;
    pats[idx].name = nv.trim();
    savePatients(pats);
    renderPatientSelectDaily();
    renderPatientFolders();
    renderOpenPatientHeader();
  });

  $("deletePatient").addEventListener("click", ()=>{
    if(!confirm("Excluir paciente? (os registros dele tamb√©m ser√£o removidos)")) return;
    savePatients(loadPatients().filter(p => p.id !== openedPatientId));
    saveSessions(loadSessions().filter(s => s.patientId !== openedPatientId));
    // Remove de qualquer slot recorrente
    const sch = loadSchedule();
    const rec = sch.recurring || {};
    for(const k of Object.keys(rec)){
      if(rec[k]?.patientId === openedPatientId) delete rec[k];
    }
    sch.recurring = rec;
    saveSchedule(sch);

    renderPatientSelectDaily();
    closePatientFolder();
    renderSchedule();
  });

  // ===== Anamnese =====
  function openAnamnese(){
    const p = getPatientById(openedPatientId);
    if(!p) return;
    const a = p.anamnese || {queixa:"", historico:"", gestacao:"", saude:"", escola:"", obs:"", files:[]};
    $("aQueixa").value = a.queixa || "";
    $("aHistorico").value = a.historico || "";
    $("aGestacao").value = a.gestacao || "";
    $("aSaude").value = a.saude || "";
    $("aEscola").value = a.escola || "";
    $("aObs").value = a.obs || "";
    renderAFileList(a.files || []);
    $("anamneseModal").classList.remove("hidden");
    $("anamneseModal").scrollIntoView({behavior:"smooth", block:"start"});
  }
  function closeAnamnese(){ $("anamneseModal").classList.add("hidden"); }
  function renderAFileList(files){
    $("aFileList").innerHTML = files.length ? ("Arquivos: " + files.map(f=> `‚Ä¢ ${escapeHtml(f.name)}`).join(" ")) : "Nenhum arquivo anexado.";
  }
  $("btnAnamnese").addEventListener("click", openAnamnese);
  $("closeAnamnese").addEventListener("click", closeAnamnese);

  $("saveAnamnese").addEventListener("click", ()=>{
    const pats = loadPatients();
    const idx = pats.findIndex(x => x.id === openedPatientId);
    if(idx < 0) return;

    const existing = (pats[idx].anamnese?.files || []).slice();
    const newFiles = Array.from($("aFiles").files || []).map(f=>({name:f.name, size:f.size, type:f.type}));
    const files = [...existing, ...newFiles].slice(0, 30);

    pats[idx].anamnese = {
      queixa: $("aQueixa").value.trim(),
      historico: $("aHistorico").value.trim(),
      gestacao: $("aGestacao").value.trim(),
      saude: $("aSaude").value.trim(),
      escola: $("aEscola").value.trim(),
      obs: $("aObs").value.trim(),
      files
    };
    savePatients(pats);
    renderOpenPatientHeader();
    renderAFileList(files);
    $("aFiles").value = "";
    alert("Anamnese salva!");
  });

  // ===== Schedule UI (recorrente) =====

  function renderSchedule(){
    const sch = loadSchedule();
    const pats = loadPatients().sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    const ref = $("schedRef").value || todayISO();

    const times = (sch.times || []).slice().sort();
    const table = $("schedTable");

    let html = "<thead><tr><th class='timeCell'>Hor√°rio</th>";
    for(let d=0; d<7; d++) html += `<th>${DAYS[d]}</th>`;
    html += "</tr></thead><tbody>";

    for(const t of times){
      html += `<tr><td class="timeCell">${escapeHtml(t)}</td>`;
      for(let d=0; d<7; d++){
        const k = recurKey(d, t);
        const entry = sch.recurring?.[k] || null;

        if(!entry){
          html += `<td data-day="${d}" data-time="${escapeHtml(t)}">
            <div class="slotBox slotRed">
              <div class="slotEmpty">VAGO</div>
              <div class="slotMeta muted">Clique para agendar</div>
            </div>
          </td>`;
        }else{
          const p = getPatientById(entry.patientId);
          const name = p?.name || "(Paciente removido)";
          const billing = getBilling(entry.patientId);
          const rem = remainingFor(entry);
          const realized = realizedCountSince(entry.patientId, entry.startDate);
          const total = plannedTotalFor(entry);

          let icon = "";
          if(billing.type === "pack"){
            if(rem === 1) icon = `<span class="iconAlert">‚ö†Ô∏è</span>`;
            if(rem === 0) icon = `<span class="iconAlert">üèÅ</span>`;
          }

          // pr√≥ximas sess√µes (at√© 4)
          entry.slot = `${d}|${t}`; // para nextOccurrences
          const next = nextOccurrences(entry, ref, 4);
          const nextTxt = next.length ? `Pr√≥ximas: ${next.map(formatDateBR).join(" ‚Ä¢ ")}` : (billing.type==="pack" ? "Pacote finalizado" : "Individual");

          const cls = serviceColorClass(entry.serviceType);
          const service = serviceLabel(entry.serviceType);

          const metaLine = billing.type==="pack"
            ? `Pacote: ${realized}/${total} ‚Ä¢ Restam: ${rem}`
            : `Individual ‚Ä¢ ${service}`;

          html += `<td data-day="${d}" data-time="${escapeHtml(t)}">
            <div class="slotBox ${cls}">
              <div class="slotName">${icon}<span>${escapeHtml(name)}</span></div>
              <div class="slotMeta muted">${escapeHtml(service)} ‚Ä¢ ${metaLine}</div>
              <div class="slotNext">${escapeHtml(nextTxt)}</div>
            </div>
          </td>`;
        }
      }
      html += "</tr>";
    }
    html += "</tbody>";
    table.innerHTML = html;

    // click handler
    table.querySelectorAll("td[data-day]").forEach(td=>{
      td.addEventListener("click", ()=>{
        const day = Number(td.dataset.day);
        const time = td.dataset.time;
        const key = recurKey(day, time);
        const sch2 = loadSchedule();
        const current = sch2.recurring?.[key] || null;

        const patientsList = pats.map(p=>p.name).slice(0, 50).join(", ");
        const promptTxt =
          "Digite o NOME do paciente para ocupar este hor√°rio.\n" +
          "Ou deixe vazio para limpar (vago).\n\n" +
          `Hor√°rio: ${time} | ${DAYS[day]}\n\n` +
          "Dica: digite parte do nome (ex: 'jo√£o').";

        const input = prompt(promptTxt, current ? (getPatientById(current.patientId)?.name || "") : "");
        if(input === null) return;

        const val = input.trim().toLowerCase();
        if(!val){
          // limpar
          if(sch2.recurring?.[key]) delete sch2.recurring[key];
          saveSchedule(sch2);
          renderSchedule();
          return;
        }

        const match = pats.find(p => (p.name||"").toLowerCase().includes(val));
        if(!match){
          alert("N√£o encontrei esse paciente. Cadastre em Pacientes ou digite um nome existente.");
          return;
        }

        // escolher tipo (cassems/particular) direto no agendamento
        const st = prompt("Tipo de atendimento: digite 'cassems' ou 'particular'", (match.serviceType || "particular"));
        if(st === null) return;
        const serviceType = (st.trim().toLowerCase() === "cassems") ? "cassems" : "particular";

        // inicia pacote a partir da data de refer√™ncia (ou hoje) com as pr√≥ximas 4/8 automaticamente
        const refISO = $("schedRef").value || todayISO();
        const billing = getBilling(match.id);

        // plannedTotal inicial:
        // - pacote: 4/8
        // - individual: 1 (mas n√£o remove automaticamente)
        const plannedTotal = billing.type === "pack" ? billing.size : 1;

        sch2.recurring = sch2.recurring || {};
        sch2.recurring[key] = {
          patientId: match.id,
          serviceType,
          startDate: refISO,
          plannedTotal
        };
        saveSchedule(sch2);

        // Atualiza tamb√©m o paciente (serviceType + defaultValue) se necess√°rio
        const ps = loadPatients();
        const idx = ps.findIndex(x => x.id === match.id);
        if(idx >= 0){
          ps[idx].serviceType = serviceType;
          if(serviceType === "cassems"){
            ps[idx].defaultValue = 26;
          }
          savePatients(ps);
          renderPatientSelectDaily();
          if(openedPatientId) renderOpenPatientHeader();
        }

        renderSchedule();
      });
    });
  }

  $("schedRef").addEventListener("change", renderSchedule);

  $("addTime").addEventListener("click", ()=>{
    const t = $("newTime").value.trim();
    if(!t) return;
    if(!/^\d{1,2}:\d{2}$/.test(t)){ alert("Use formato HH:MM (ex: 07:00 ou 15:40)."); return; }
    const sch = loadSchedule();
    sch.times = sch.times || [];
    if(!sch.times.includes(t)) sch.times.push(t);
    saveSchedule(sch);
    $("newTime").value = "";
    renderSchedule();
  });

  $("resetTimes").addEventListener("click", ()=>{
    if(!confirm("Zerar a lista de hor√°rios do agendamento? (n√£o apaga pacientes)")) return;
    const sch = loadSchedule();
    sch.times = [];
    sch.recurring = {};
    saveSchedule(sch);
    renderSchedule();
  });

  // ===== Boot =====
  function bootApp(){
    migrateStorage();
    if(!hasSession()){ showLogin(); return; }
    showApp();
    $("date").value = todayISO();
    $("schedRef").value = todayISO();
    $("today").textContent = new Intl.DateTimeFormat("pt-BR", { dateStyle:"full" }).format(new Date());
    renderPatientSelectDaily();
    renderDaily();
    renderPatientFolders();
    renderSchedule();
    setTab("daily");
  }

  bootApp();
</script>
</body>
</html>
